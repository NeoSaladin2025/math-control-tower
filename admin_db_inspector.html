<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <link rel="manifest" href="site.webmanifest">
    
    <link rel="apple-touch-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB & Storage ì •ë°€ ë¹„êµ (God's Twin Eye)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #0f0f0f; color: #e5e5e5; }
        .god-mode { border: 1px solid #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
        .scroll-hide::-webkit-scrollbar { width: 8px; }
        .scroll-hide::-webkit-scrollbar-track { background: #1f1f1f; }
        .scroll-hide::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        .missing { background-color: #450a0a; color: #fca5a5; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body class="h-screen flex flex-col p-4 overflow-hidden">

    <script src="config.js"></script>

    <div class="flex justify-between items-center mb-4 bg-gray-900 p-4 rounded-lg god-mode shrink-0">
        <div class="flex items-center gap-4">
            <div class="text-3xl">ğŸ‘ï¸</div>
            <div>
                <h1 class="text-xl font-bold text-yellow-500">í†µí•© ì •ë°€ ê²€ì‚¬ì†Œ (Dual View)</h1>
                <p class="text-xs text-gray-400">"ì™¼ìª½ì€ ë³´ì§€(DB), ì˜¤ë¥¸ìª½ì€ ê°€ìŠ´(ì´ë¯¸ì§€)... ë‹¤ ë³´ì—¬ë“œë¦´ê²Œìš”. â¤ï¸"</p>
            </div>
        </div>
        <div class="flex gap-4 items-center">
            <select id="wb-select" class="bg-gray-800 text-white border border-gray-600 p-2 rounded text-sm w-64 focus:border-yellow-500 outline-none">
                <option value="">ë¬¸ì œì§‘ ì„ íƒ...</option>
            </select>
            <button onclick="startInspection()" id="btn-scan" class="bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-2 px-6 rounded shadow-lg transition text-sm">
                ğŸ” ì–‘ìª½ ë‹¤ ê²€ì‚¬í•˜ê¸°
            </button>
            <button onclick="location.href='teacher_main.html'" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm font-bold">
                ë‚˜ê°€ê¸°
            </button>
        </div>
    </div>

    <div class="flex-1 grid grid-cols-2 gap-4 min-h-0">
        
        <div class="bg-gray-800 rounded-lg flex flex-col border border-purple-500/50 shadow-lg overflow-hidden">
            <div class="bg-gray-900 p-3 border-b border-purple-500 flex justify-between items-center">
                <h2 class="font-bold text-purple-400 flex items-center gap-2">ğŸ’¾ DB ë°ì´í„° (Problem Metadata)</h2>
                <span class="text-xs bg-purple-900 text-purple-200 px-2 py-1 rounded" id="cnt-db">0ê°œ</span>
            </div>
            <div class="flex-1 overflow-y-auto scroll-hide p-2">
                <table class="w-full text-xs text-left text-gray-400">
                    <thead class="text-gray-500 bg-gray-900 sticky top-0 uppercase">
                        <tr><th class="p-2">ë²ˆí˜¸</th><th class="p-2">ìœ í˜•</th><th class="p-2">ë‚œì´ë„</th><th class="p-2">ìƒíƒœ</th></tr>
                    </thead>
                    <tbody id="list-db" class="divide-y divide-gray-700">
                        <tr><td colspan="4" class="p-4 text-center">ëŒ€ê¸° ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg flex flex-col border border-pink-500/50 shadow-lg overflow-hidden">
            <div class="bg-gray-900 p-3 border-b border-pink-500 flex justify-between items-center">
                <h2 class="font-bold text-pink-400 flex items-center gap-2">ğŸ–¼ï¸ ìŠ¤í† ë¦¬ì§€ ì´ë¯¸ì§€ (Storage Files)</h2>
                <span class="text-xs bg-pink-900 text-pink-200 px-2 py-1 rounded" id="cnt-img">0ê°œ</span>
            </div>
            <div class="flex-1 overflow-y-auto scroll-hide p-2">
                <table class="w-full text-xs text-left text-gray-400">
                    <thead class="text-gray-500 bg-gray-900 sticky top-0 uppercase">
                        <tr><th class="p-2">ë²ˆí˜¸</th><th class="p-2">íŒŒì¼ëª…</th><th class="p-2">ë¯¸ë¦¬ë³´ê¸°</th><th class="p-2">ìƒíƒœ</th></tr>
                    </thead>
                    <tbody id="list-img" class="divide-y divide-gray-700">
                        <tr><td colspan="4" class="p-4 text-center">ëŒ€ê¸° ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="final-report" class="mt-4 bg-gray-900 p-4 rounded-lg border border-gray-700 text-center hidden">
        <h3 class="text-lg font-bold text-white mb-2">ğŸ“Š ì´ë¸Œì˜ ìµœì¢… ì§„ë‹¨</h3>
        <p id="report-text" class="text-sm text-gray-300"></p>
        <div class="mt-4 p-2 bg-black rounded text-xs text-red-400 font-mono hidden" id="missing-log"></div>
    </div>

    <script>
        // ê¶Œí•œ ì²´í¬
        const user = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!user || (user.username !== 'ê³½ëª…ìš©' && user.role !== 'admin')) {
            alert("ì£¼ì¸ë‹˜(ê³½ëª…ìš©)ë§Œ ë“¤ì–´ì˜¬ ìˆ˜ ìˆì–´ìš”! í‰¤!");
            location.href = 'index.html';
        }

        async function init() {
            const { data } = await _supabase.from('workbooks').select('*').order('created_at', {ascending:false});
            const sel = document.getElementById('wb-select');
            if(data) data.forEach(w => sel.innerHTML += `<option value="${w.id}">${w.title} (ì´ ${w.total_problems}ë¬¸)</option>`);
        }
        init();

        async function startInspection() {
            const wbId = document.getElementById('wb-select').value;
            if(!wbId) return alert("ë¬¸ì œì§‘ì„ ê³¨ë¼ì£¼ì„¸ìš”, ì£¼ì¸ë‹˜!");

            const btn = document.getElementById('btn-scan');
            btn.innerText = "ì–‘ìª½ ë‹¤ ë²Œë ¤ë³´ëŠ” ì¤‘...ğŸ’‹"; btn.disabled = true;

            try {
                // 1. DB ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (limit 3000)
                const { data: dbData, error: dbErr } = await _supabase
                    .from('problem_metadata')
                    .select('*')
                    .eq('workbook_id', wbId)
                    .order('problem_num', {ascending: true})
                    .limit(3000); // â˜… 3000ê°œê¹Œì§€ ëš«ì–´ë²„ë¦¼
                
                if(dbErr) throw dbErr;

                // 2. Storage íŒŒì¼ ê°€ì ¸ì˜¤ê¸° (limit 3000)
                const { data: fileData, error: fileErr } = await _supabase.storage
                    .from('problems')
                    .list(`${wbId}/`, { limit: 3000 }); // â˜… ì—¬ê¸°ë„ 3000ê°œ ì œí•œ í•´ì œ (ê¸°ë³¸ 100ê°œì„)

                if(fileErr) throw fileErr;

                // 3. ë¶„ì„ ì‹œì‘
                // íŒŒì¼ ë¦¬ìŠ¤íŠ¸ë¥¼ ë²ˆí˜¸ Setìœ¼ë¡œ ë³€í™˜ (0001.webp -> 1)
                const fileSet = new Set();
                const fileNameMap = {};
                fileData.forEach(f => {
                    const match = f.name.match(/\d+/);
                    if(match) {
                        const num = parseInt(match[0], 10);
                        fileSet.add(num);
                        fileNameMap[num] = f.name;
                    }
                });

                // DB ë¦¬ìŠ¤íŠ¸ë¥¼ ë²ˆí˜¸ Setìœ¼ë¡œ ë³€í™˜
                const dbSet = new Set();
                const dbInfoMap = {};
                dbData.forEach(d => {
                    dbSet.add(d.problem_num);
                    dbInfoMap[d.problem_num] = d;
                });

                // ìµœëŒ€ ë²ˆí˜¸ ì°¾ê¸° (ë‘˜ ì¤‘ í° ê±°)
                const maxNum = Math.max(
                    dbData.length > 0 ? dbData[dbData.length-1].problem_num : 0,
                    fileSet.size > 0 ? Math.max(...fileSet) : 0,
                    1883 // ê¸°ë³¸ê°’
                );

                // 4. ë Œë”ë§
                const dbList = document.getElementById('list-db');
                const imgList = document.getElementById('list-img');
                dbList.innerHTML = ''; imgList.innerHTML = '';

                let missingInDB = [];
                let missingInImg = [];

                // 1ë²ˆë¶€í„° ëê¹Œì§€ ìˆœíšŒí•˜ë©° ë¹„êµ
                for(let i=1; i<=maxNum; i++) {
                    // [DB ë Œë”ë§]
                    if(dbSet.has(i)) {
                        const d = dbInfoMap[i];
                        let diff = d.difficulty === 'high_rank' ? 'ğŸ† 1ë“±ê¸‰' : (d.difficulty==='tough'?'ğŸ”¥ í„°í”„':'ì¼ë°˜');
                        let sub = d.is_subjective ? '(ì„œìˆ )' : '';
                        dbList.innerHTML += `<tr class="hover:bg-gray-700"><td class="p-2 font-mono">${i}</td><td class="p-2">${d.type_group_id||'-'}</td><td class="p-2 text-purple-300">${diff} ${sub}</td><td class="p-2 text-green-500">OK</td></tr>`;
                    } else {
                        // DBì— ì—†ìŒ (ë¹¨ê°„ë¶ˆ!)
                        missingInDB.push(i);
                        dbList.innerHTML += `<tr class="missing"><td class="p-2 font-mono font-bold">${i}</td><td colspan="2" class="p-2">ë°ì´í„° ì—†ìŒ (ë¹„ì—ˆìŒ)</td><td class="p-2">âŒ MISSING</td></tr>`;
                    }

                    // [ì´ë¯¸ì§€ ë Œë”ë§]
                    if(fileSet.has(i)) {
                        const fname = fileNameMap[i];
                        const url = `${SUPABASE_URL}/storage/v1/object/public/problems/${wbId}/${fname}`;
                        imgList.innerHTML += `<tr class="hover:bg-gray-700"><td class="p-2 font-mono">${i}</td><td class="p-2 text-xs text-gray-500">${fname}</td><td class="p-2"><a href="${url}" target="_blank" class="text-pink-400 hover:underline">ë³´ê¸°</a></td><td class="p-2 text-green-500">OK</td></tr>`;
                    } else {
                        // ì´ë¯¸ì§€ ì—†ìŒ
                        missingInImg.push(i);
                        // ì´ë¯¸ì§€ëŠ” ë„ˆë¬´ ë§ìœ¼ë©´ ìƒëµ (DBê°€ ì¤‘ìš”í•˜ë‹ˆê¹Œ)
                        if(missingInImg.length < 50) imgList.innerHTML += `<tr class="missing"><td class="p-2 font-mono font-bold">${i}</td><td colspan="2" class="p-2">íŒŒì¼ ì—†ìŒ</td><td class="p-2">âŒ MISSING</td></tr>`;
                    }
                }

                // 5. ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                document.getElementById('cnt-db').innerText = dbSet.size + "ê°œ";
                document.getElementById('cnt-img').innerText = fileSet.size + "ê°œ";

                // 6. ë¦¬í¬íŠ¸ ì‘ì„±
                const reportBox = document.getElementById('final-report');
                const reportText = document.getElementById('report-text');
                const missingLog = document.getElementById('missing-log');
                
                reportBox.classList.remove('hidden');
                
                let msg = "";
                if(missingInDB.length > 0) {
                    msg += `âš ï¸ <b class="text-red-500">DB ë°ì´í„°ê°€ ${missingInDB.length}ê°œ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!</b><br>ì£¼ì¸ë‹˜, <b>[ë¬¸ì œì§‘ ë“±ë¡]</b> ë©”ë‰´ ê°€ì„œ ${missingInDB[0]}ë²ˆë¶€í„° ë‹¤ì‹œ ì €ì¥í•´ì£¼ì„¸ìš”!<br>`;
                    missingLog.innerText = "ëˆ„ë½ ë²ˆí˜¸: " + missingInDB.join(', ');
                    missingLog.classList.remove('hidden');
                } else {
                    msg += `âœ… <b class="text-green-500">DBëŠ” ì™„ë²½í•˜ê²Œ ê½‰ ì°¨ ìˆìŠµë‹ˆë‹¤!</b><br>`;
                }

                if(missingInImg.length > 0) {
                    msg += `âš ï¸ <b class="text-pink-500">ì´ë¯¸ì§€ê°€ ${missingInImg.length}ê°œ ì—†ìŠµë‹ˆë‹¤.</b> (í™•ì¸ í•„ìš”)`;
                } else {
                    msg += `âœ… <b class="text-pink-500">ì´ë¯¸ì§€ë„ ì „ë¶€ ë‹¤ ìˆìŠµë‹ˆë‹¤!</b>`;
                }
                
                reportText.innerHTML = msg;

            } catch(e) {
                alert("ê²€ì‚¬ ì¤‘ ì‡¼í¬ ì™”ì–´ìš”.. ã… ã…  " + e.message);
            } finally {
                btn.innerText = "ğŸ” ë‹¤ì‹œ ê²€ì‚¬í•˜ê¸°"; btn.disabled = false;
            }
        }
    </script>
</body>
</html>