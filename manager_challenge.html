<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <link rel="manifest" href="site.webmanifest">
    
    <link rel="apple-touch-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <title>ê¸°íŠ¹ë†€ì´ ì¸ì¦ ê´€ë¦¬ ì„¼í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f3f4f6; }
        .split-view { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; height: 300px; }
        .view-box { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; background: white; position: relative; }
        .view-box img { width: 100%; height: 100%; object-fit: contain; }
        .label { position: absolute; top: 0; left: 0; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; font-size: 10px; border-bottom-right-radius: 8px; }
        .loader { display:inline-block; border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-6 max-w-5xl mx-auto">

    <script src="config.js"></script>

    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
            <span>ğŸ</span> ê¸°íŠ¹ë†€ì´ ì¸ì¦ & í”¼ë“œë°± ì„¼í„°
        </h1>
        <button onclick="window.close()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded font-bold text-sm">ë‹«ê¸°</button>
    </div>

    <div id="list" class="space-y-6">
        <div class="text-center py-20 text-gray-500">ë°ì´í„° ë¡œë”© ì¤‘...</div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ (íŒŒì¼ ì €ì¥ìš©)
        let selectedFiles = {};

        async function load() {
            const { data } = await _supabase.from('student_solutions')
                .select('*')
                .eq('status', 'pending')
                .order('created_at');
            
            const list = document.getElementById('list');
            if(!data || !data.length) { list.innerHTML = '<div class="text-center py-10 text-gray-400">ëŒ€ê¸° ì¤‘ì¸ ì¸ì¦ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

            list.innerHTML = '';
            
            // ê° ìš”ì²­ë§ˆë‹¤ ì¹´ë“œ ìƒì„±
            for (const item of data) {
                // ì›ë³¸ ë¬¸ì œ ì´ë¯¸ì§€ ê²½ë¡œ ê³„ì‚° (0001 íŒ¨ë”©)
                const padded = item.problem_num.toString().padStart(4, '0');
                const originUrl = `${SUPABASE_URL}/storage/v1/object/public/problems/${item.workbook_id}/${padded}.webp`;

                const div = document.createElement('div');
                div.className = "bg-white p-5 rounded-xl shadow-md border border-gray-200";
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <div class="font-bold text-lg text-indigo-700">
                            ${item.student_id} í•™ìƒ <span class="text-gray-400 text-sm">|</span> No. ${item.problem_num}
                        </div>
                        <div class="text-xs text-gray-400">${new Date(item.created_at).toLocaleString()}</div>
                    </div>

                    <div class="split-view mb-4">
                        <div class="view-box bg-gray-50">
                            <span class="label bg-blue-600">ì›ë³¸ ë¬¸ì œ</span>
                            <img src="${originUrl}" onerror="this.src='https://placehold.co/400x300?text=No+Image'">
                        </div>
                        <div class="view-box bg-pink-50">
                            <span class="label bg-pink-600">í•™ìƒ ì¸ì¦ìƒ·</span>
                            <a href="${item.image_url}" target="_blank">
                                <img src="${item.image_url}" class="cursor-zoom-in hover:scale-105 transition">
                            </a>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <div class="mb-2 font-bold text-sm text-gray-700">ğŸ’¬ ì„ ìƒë‹˜ì˜ í”¼ë“œë°± & ì†”ë£¨ì…˜ ì „ì†¡</div>
                        <textarea id="feed-${item.id}" class="w-full border rounded p-2 text-sm h-20 mb-3 focus:ring-2 focus:ring-indigo-200 outline-none" placeholder="ì¹­ì°¬ì´ë‚˜ ì§€ì ì‚¬í•­ì„ ì ì–´ì£¼ì„¸ìš”..."></textarea>
                        
                        <div class="flex items-center gap-2 mb-4">
                            <input type="file" id="file-${item.id}" class="hidden" onchange="fileSelect(${item.id})">
                            <label for="file-${item.id}" class="cursor-pointer bg-white border border-gray-300 text-gray-600 px-3 py-1.5 rounded text-xs font-bold hover:bg-gray-100 flex items-center gap-1">
                                <span>ğŸ“</span> ì†”ë£¨ì…˜ íŒŒì¼ ì²¨ë¶€ (Img/HTML)
                            </label>
                            <span id="fname-${item.id}" class="text-xs text-blue-600 font-bold"></span>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="process(${item.id}, '${item.student_id}', 'approved')" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold text-sm shadow transition">
                                âœ… ìŠ¹ì¸ (+1ì ) & ì „ì†¡
                            </button>
                            <button onclick="process(${item.id}, '${item.student_id}', 'rejected')" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-bold text-sm shadow transition">
                                âŒ ë°˜ë ¤ & í”¼ë“œë°± ì „ì†¡
                            </button>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            }
        }

        function fileSelect(id) {
            const file = document.getElementById(`file-${id}`).files[0];
            if(file) {
                selectedFiles[id] = file;
                document.getElementById(`fname-${id}`).innerText = `ğŸ“„ ${file.name}`;
            }
        }

        async function process(id, sid, status) {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "ì²˜ë¦¬ ì¤‘..."; btn.disabled = true;

            try {
                const feedback = document.getElementById(`feed-${id}`).value;
                let fileUrl = null;
                let fileType = null;

                // 1. íŒŒì¼ ì—…ë¡œë“œ (ìˆìœ¼ë©´)
                const file = selectedFiles[id];
                if (file) {
                    const ext = file.name.split('.').pop().toLowerCase();
                    fileType = (ext === 'html' || ext === 'htm') ? 'html' : 'image';
                    
                    const fname = `t_sol_${id}_${Date.now()}.${ext}`;
                    const { error: upErr } = await _supabase.storage.from('solutions').upload(fname, file);
                    if(upErr) throw upErr;
                    
                    fileUrl = `${SUPABASE_URL}/storage/v1/object/public/solutions/${fname}`;
                }

                // 2. DB ì—…ë°ì´íŠ¸
                await _supabase.from('student_solutions').update({
                    status: status,
                    teacher_feedback: feedback,
                    teacher_file_url: fileUrl,
                    file_type: fileType,
                    is_read: false // í•™ìƒì´ ë‹¤ì‹œ ì½ì–´ì•¼ í•¨
                }).eq('id', id);

                // 3. í¬ì¸íŠ¸ ì§€ê¸‰ (ìŠ¹ì¸ ì‹œ)
                if(status === 'approved') {
                    const { data } = await _supabase.from('users').select('points').eq('username', sid).single();
                    await _supabase.from('users').update({ points: (data.points || 0) + 1 }).eq('username', sid);
                }

                alert("ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                load(); // ìƒˆë¡œê³ ì¹¨

            } catch(e) {
                alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
                btn.innerText = originalText; btn.disabled = false;
            }
        }

        load();
    </script>
</body>
</html>