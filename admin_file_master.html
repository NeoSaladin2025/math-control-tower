<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROOT ACCESS: Bulk File Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="config.js"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #0f172a; color: #f1f5f9; }
        .admin-card { background: #1e293b; border: 1px solid #334155; border-radius: 20px; transition: 0.2s; }
        .admin-card:hover { border-color: #6366f1; box-shadow: 0 0 20px rgba(99, 102, 241, 0.1); }
        .input-dark { background: #0f172a; border: 1px solid #334155; color: white; border-radius: 12px; padding: 10px; font-size: 14px; outline: none; }
        .input-dark:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        .bulk-area { 
            border: 3px dashed #475569; 
            background: #0f172a; 
            color: #94a3b8; 
            font-family: monospace; 
            transition: all 0.3s;
            resize: none;
        }
        .bulk-area.drag-over { 
            border-color: #6366f1; 
            background: #1e1b4b; 
            color: #e2e8f0;
            transform: scale(1.01);
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.3);
        }
        
        .custom-scroll { overflow-y: auto; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
    </style>
</head>
<body class="p-8">

    <header class="flex justify-between items-center mb-10 border-b border-slate-800 pb-6">
        <div>
            <h1 class="text-3xl font-black text-indigo-400 tracking-tighter flex items-center gap-3">
                <i class="fa-solid fa-skull-crossbones"></i> BULK FILE MASTER
            </h1>
            <p class="text-slate-500 text-xs font-bold mt-1 uppercase tracking-widest">Admin Root Access: Inventory Management</p>
        </div>
        <button onclick="location.href='teacher_main.html'" class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-6 py-2 rounded-xl text-sm font-bold transition border border-slate-700">Back to Main</button>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-5 space-y-6">
            <div class="admin-card p-6">
                <h3 class="text-sm font-black mb-4 flex items-center gap-2 text-indigo-400">
                    <i class="fa-solid fa-layer-group"></i> íŒŒì¼ ì´ë¦„ í›”ì³ì˜¤ê¸° (Drag & Drop)
                </h3>
                <p class="text-[10px] text-slate-500 mb-3 leading-tight">íƒìƒ‰ê¸°ì—ì„œ íŒŒì¼ë“¤ì„ ì„ íƒí•´ ì´ ë°•ìŠ¤ì— **íˆ­! ë˜ì§€ì„¸ìš”.**<br>ì´ë¦„ë§Œ ì™ ê³¨ë¼ë‚´ì„œ ì¤„ì„ ì„¸ì›Œë“œë¦´ê²Œìš”!! í•˜ì•„ì•™! â¤ï¸</p>
                
                <textarea id="bulk-input" 
                          class="w-full h-48 input-dark bulk-area mb-4 p-4 text-xs" 
                          placeholder="ì—¬ê¸°ì— íŒŒì¼ë“¤ì„ ì§ì ‘ ë˜ì§€ê±°ë‚˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!&#10;íŒŒì¼ëª…ë§Œ ì¶”ì¶œí•´ì„œ ìë™ìœ¼ë¡œ ì—”í„° ì²˜ë¦¬í•©ë‹ˆë‹¤... â¤ï¸"
                          ondragover="handleDragOver(event)"
                          ondragleave="handleDragLeave(event)"
                          ondrop="handleDrop(event)"></textarea>

                <button onclick="bulkRegister()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-black py-4 rounded-xl shadow-lg transition active:scale-95 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-cloud-arrow-up"></i> ë¯¸ë“±ë¡ íŒŒì¼ ì¼ê´„ ìŠ¤ìº”
                </button>
            </div>
            
            <div id="edit-form-area" class="admin-card p-6 opacity-40 pointer-events-none transition-all duration-300">
                <h3 class="text-sm font-black mb-6 flex items-center gap-2 text-emerald-400">
                    <i class="fa-solid fa-tag"></i> ì„ íƒ íŒŒì¼ ì •ë°€ ì„¤ì • (Assign)
                </h3>
                <div class="space-y-4">
                    <div class="flex flex-col gap-1">
                        <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Selected File Path</label>
                        <input type="text" id="f-name" class="input-dark bg-slate-800" readonly>
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Display Menu Name</label>
                        <input type="text" id="f-display" class="input-dark" placeholder="ì˜ˆ: ì‹¤ì‹œê°„ ì˜¤ë‹µ ë¶„ì„ê¸°">
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Description (ì„¤ëª…)</label>
                        <textarea id="f-desc" class="input-dark h-20 resize-none text-xs" placeholder="ìš©ë„ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”."></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="flex flex-col gap-1">
                            <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Category</label>
                            <select id="f-cat" class="input-dark text-xs">
                                <option value="ìˆ˜ì—…ê´€ë¦¬">ìˆ˜ì—…ê´€ë¦¬</option>
                                <option value="í•™ìƒê´€ë¦¬">í•™ìƒê´€ë¦¬</option>
                                <option value="ë¬¸ì œì§‘/ì¶œì œ">ë¬¸ì œì§‘/ì¶œì œ</option>
                                <option value="ì‹œìŠ¤í…œì„¤ì •">ì‹œìŠ¤í…œì„¤ì •</option>
                                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Target User</label>
                            <select id="f-target" class="input-dark text-xs">
                                <option value="teacher">ì„ ìƒë‹˜ (Teacher)</option>
                                <option value="student">í•™ìƒ (Student)</option>
                                <option value="admin">ê´€ë¦¬ì (Admin)</option>
                                <option value="common">ê³µìš© (Common)</option>
                            </select>
                        </div>
                    </div>
                    <div class="pt-2">
                        <button onclick="updateFileDetail()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-black py-4 rounded-xl shadow-lg transition active:scale-95">
                            ì¸ë²¤í† ë¦¬ì— ê°ì¸í•˜ê¸° (SAVE & ACTIVATE)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-7">
            <div class="admin-card p-6 h-[calc(100vh-200px)] flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-black flex items-center gap-2">
                        <i class="fa-solid fa-boxes-stacked text-indigo-400"></i> ì˜¬íŒŒì¼ ì¸ë²¤í† ë¦¬
                    </h3>
                    <div class="flex gap-4 items-center">
                        <div class="text-[10px] font-bold text-slate-500 tracking-widest uppercase"><span id="file-count" class="text-indigo-400">0</span> Files</div>
                        <button onclick="loadInventory()" class="text-slate-500 hover:text-white transition"><i class="fa-solid fa-rotate"></i></button>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto pr-2 custom-scroll space-y-2" id="file-list-area">
                    <div class="text-center py-20 text-slate-700 italic">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const user = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!user || user.role !== 'admin') { alert("ROOT ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤!! ğŸ’¢"); location.href = 'teacher_main.html'; }

        let editingId = null;

        document.addEventListener('DOMContentLoaded', loadInventory);

        // --- [Core Drag & Name Extraction Logic] ---
        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        
        async function handleDrop(e) {
            e.preventDefault();
            const el = e.currentTarget;
            el.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files && files.length > 0) {
                const names = Array.from(files).map(f => f.name).filter(n => n.includes('.html'));
                if (names.length === 0) return alert("HTML íŒŒì¼ì´ í•˜ë‚˜ë„ ì—†ë„¤ìš” ì£¼ì¸ë‹˜?! ğŸ’¦");
                insertToTextArea(names.join('\n'), el);
                alert(`í•˜ì•„ì•™! â¤ï¸ ì£¼ì¸ë‹˜ì´ ë˜ì ¸ì£¼ì‹  ${names.length}ê°œì˜ íŒŒì¼ ì´ë¦„ì„ í›”ì³ì™”ì–´ìš”!!`);
                return;
            }

            const text = e.dataTransfer.getData("text");
            if (text) {
                const refined = text.split(/[\s,;]+/).map(n => n.trim()).filter(n => n.length > 0 && n.includes('.html'));
                insertToTextArea(refined.join('\n'), el);
            }
        }

        function insertToTextArea(text, targetEl) {
            if (targetEl.value.trim().length > 0) targetEl.value += '\n' + text;
            else targetEl.value = text;
        }

        document.getElementById('bulk-input').addEventListener('paste', (e) => {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text');
            const refined = text.split(/[\s,;]+/).map(n => n.trim()).filter(n => n.length > 0).join('\n');
            insertToTextArea(refined, e.target);
        });

        // --- [Inventory DB Logic] ---
        async function bulkRegister() {
            const input = document.getElementById('bulk-input').value.trim();
            if (!input) return alert("íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”!! ğŸ’¢");

            const fileNames = [...new Set(input.split('\n').map(n => n.trim()).filter(n => n.length > 0))];
            
            const payload = fileNames.map(name => ({
                file_name: name,
                display_name: name,
                category: 'ê¸°íƒ€',
                target_user: 'teacher',
                is_active: false // ê¸°ë³¸ì ìœ¼ë¡œëŠ” ë¹„í™œì„± ìƒíƒœ (ì£¼ì¸ë‹˜ì´ ì»¨íŒí•´ì•¼ í™œì„±)
            }));

            const { error } = await _supabase
                .from('all_file_inventory')
                .upsert(payload, { onConflict: 'file_name', ignoreDuplicates: true });

            if (error) {
                alert("ë“±ë¡ ì‹¤íŒ¨: " + error.message);
            } else {
                alert(`âœ… ë“±ë¡ ì™„ë£Œ! ì´ë¯¸ ìˆë˜ íŒŒì¼ì€ í‰¤! í–ˆìŠµë‹ˆë‹¤. â¤ï¸`);
                document.getElementById('bulk-input').value = '';
                loadInventory();
            }
        }

        async function loadInventory() {
            const { data, error } = await _supabase.from('all_file_inventory').select('*').order('created_at', { ascending: false });
            if (error) return console.error(error);
            document.getElementById('file-count').innerText = data.length;
            renderList(data);
        }

        function renderList(list) {
            const area = document.getElementById('file-list-area');
            if (list.length === 0) { area.innerHTML = `<div class="text-center py-20 text-slate-700 text-sm">ì¸ë²¤í† ë¦¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>`; return; }

            area.innerHTML = list.map(f => {
                const isConfigured = f.display_name !== f.file_name;
                const isActive = f.is_active; // [â˜… NEW] í™œì„± ìƒíƒœ í™•ì¸
                const targetTag = f.target_user === 'teacher' ? 'bg-indigo-900/50 text-indigo-300' : 
                                 (f.target_user === 'student' ? 'bg-emerald-900/50 text-emerald-300' : 'bg-slate-800 text-slate-500');
                
                return `
                <div class="p-4 bg-slate-900/40 border ${editingId === f.id ? 'border-indigo-500 bg-slate-800' : 'border-slate-800'} rounded-2xl flex justify-between items-center group hover:border-slate-600 transition">
                    <div class="flex items-center gap-4 cursor-pointer flex-1" onclick="selectForEdit(${JSON.stringify(f).replace(/"/g, '&quot;')})">
                        <div class="w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center ${isActive ? 'text-indigo-400' : 'text-slate-600'} transition">
                            <i class="${isConfigured ? 'fa-solid fa-file-circle-check' : 'fa-solid fa-file-code'}"></i>
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="font-black ${isActive ? 'text-slate-100' : 'text-slate-500'}">${f.display_name}</span>
                                <span class="text-[8px] font-black px-1.5 py-0.5 rounded uppercase ${targetTag}">${f.target_user}</span>
                            </div>
                            <div class="text-[10px] text-slate-500 font-mono mt-0.5">${f.file_name}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div onclick="toggleActive(${f.id}, ${isActive})" class="cursor-pointer w-10 h-5 rounded-full relative transition-colors duration-200 ${isActive ? 'bg-indigo-600' : 'bg-slate-700'}">
                            <div class="absolute top-1 w-3 h-3 bg-white rounded-full transition-all duration-200 ${isActive ? 'left-6' : 'left-1'}"></div>
                        </div>
                        
                        <button onclick="deleteFile(event, ${f.id})" class="text-slate-700 hover:text-rose-500 transition px-2"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        // [â˜… NEW] Toggle Active Function
        async function toggleActive(id, currentStatus) {
            const { error } = await _supabase
                .from('all_file_inventory')
                .update({ is_active: !currentStatus })
                .eq('id', id);
            
            if (error) alert("ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: " + error.message);
            else loadInventory();
        }

        function selectForEdit(f) {
            editingId = f.id;
            const area = document.getElementById('edit-form-area');
            area.classList.remove('opacity-40', 'pointer-events-none');
            
            document.getElementById('f-name').value = f.file_name;
            document.getElementById('f-display').value = f.display_name === f.file_name ? '' : f.display_name;
            document.getElementById('f-desc').value = f.description || '';
            document.getElementById('f-cat').value = f.category || 'ê¸°íƒ€';
            document.getElementById('f-target').value = f.target_user || 'teacher';
            
            loadInventory();
        }

        async function updateFileDetail() {
            if (!editingId) return;
            const payload = {
                display_name: document.getElementById('f-display').value.trim() || document.getElementById('f-name').value,
                description: document.getElementById('f-desc').value.trim(),
                category: document.getElementById('f-cat').value,
                target_user: document.getElementById('f-target').value,
                is_active: true // [â˜… NEW] ì €ì¥(ê°ì¸) ì‹œ ìë™ìœ¼ë¡œ í™œì„±í™”(ON)
            };

            const { error } = await _supabase.from('all_file_inventory').update(payload).eq('id', editingId);
            if (error) alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
            else {
                alert("âœ… ì¸ë²¤í† ë¦¬ì— ì„±ê³µì ìœ¼ë¡œ ê°ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!! (ON ìƒíƒœë¡œ ì „í™˜ë¨) â¤ï¸");
                loadInventory();
            }
        }

        async function deleteFile(e, id) {
            e.stopPropagation();
            if (!confirm("ì •ë§ ì´ íŒŒì¼ì„ ì¸ë²¤í† ë¦¬ì—ì„œ ë§ì‚´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?!")) return;
            const { error } = await _supabase.from('all_file_inventory').delete().eq('id', id);
            if (error) alert(error.message); else loadInventory();
        }
    </script>
</body>
</html>