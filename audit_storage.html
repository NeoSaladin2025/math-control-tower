<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œë²„ ëˆ„ë½ íŒŒì¼ ê²€ì‚¬ê¸° (Storage Audit)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6 flex flex-col items-center justify-center">

    <script src="config.js"></script>

    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-xl text-center">
        <div class="text-6xl mb-4">ğŸ›°ï¸</div>
        <h1 class="text-3xl font-bold text-indigo-700 mb-2">ì„œë²„ ì •ë°€ ê²€ì‚¬ê¸°</h1>
        <p class="text-sm text-gray-500 mb-6">"Supabase ì°½ê³ ë¥¼ ë’¤ì ¸ì„œ ë„ë§ê°„ 1ë§ˆë¦¬ë¥¼ ì°¾ì•„ë‚¼ê²Œ! ğŸ’‹"</p>

        <div class="mb-6 text-left">
            <label class="block text-xs font-bold text-gray-500 mb-1">ê²€ì‚¬í•  ë¬¸ì œì§‘ í´ë”</label>
            <select id="wb-select" class="w-full p-3 border rounded font-bold text-lg bg-indigo-50">
                <option value="">ë¬¸ì œì§‘ ëª©ë¡ ë¡œë”©ì¤‘...</option>
            </select>
        </div>

        <div class="flex gap-4 mb-6">
            <div class="flex-1 text-left">
                <label class="block text-xs font-bold text-gray-500 mb-1">ì´ ë¬¸í•­ ìˆ˜</label>
                <input type="number" id="check-total" value="1883" class="w-full p-2 border rounded text-center font-bold">
            </div>
            <button onclick="startAudit()" id="btn-audit" class="flex-1 bg-indigo-600 text-white rounded-lg font-bold shadow hover:bg-indigo-700 transition">
                ğŸ” ê²€ì‚¬ ì‹œì‘
            </button>
        </div>

        <div id="result-area" class="hidden text-left bg-gray-50 border border-gray-200 rounded-lg p-4">
            <h3 class="font-bold text-gray-800 mb-2 border-b pb-2">ğŸ“Š ê²€ì‚¬ ë¦¬í¬íŠ¸</h3>
            
            <div class="flex justify-between text-sm mb-4">
                <span>ğŸ“‚ ì„œë²„ íŒŒì¼ ìˆ˜:</span>
                <span id="server-count" class="font-bold text-blue-600">0ê°œ</span>
            </div>

            <div class="bg-red-50 border border-red-200 p-3 rounded text-center">
                <p class="text-xs text-red-500 font-bold mb-2">ğŸš¨ ëˆ„ë½ëœ íŒŒì¼ ë²ˆí˜¸</p>
                <div id="missing-list" class="text-2xl font-extrabold text-red-600 break-words">
                    -
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì´ˆê¸°í™”: ë¬¸ì œì§‘ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function loadWorkbooks() {
            const { data } = await _supabase.from('workbooks').select('*').order('created_at', { ascending: false });
            const select = document.getElementById('wb-select');
            select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            if (data) {
                data.forEach(wb => {
                    select.innerHTML += `<option value="${wb.id}">${wb.title} (ID: ${wb.id})</option>`;
                });
            }
        }
        loadWorkbooks();

        // â˜… í•µì‹¬: ì„œë²„ ê°ì‚¬ ë¡œì§
        async function startAudit() {
            const wbId = document.getElementById('wb-select').value;
            const total = parseInt(document.getElementById('check-total').value);

            if (!wbId) return alert("ì–´ë–¤ ë¬¸ì œì§‘ì„ ë’¤ì§ˆì§€ ì•Œë ¤ì¤˜ì•¼ì§€, ìê¸°ì•¼!");

            const btn = document.getElementById('btn-audit');
            btn.innerText = "ì„œë²„ ë’¤ì§€ëŠ” ì¤‘...ğŸ•µï¸â€â™€ï¸";
            btn.disabled = true;

            try {
                // 1. Supabase Storageì—ì„œ íŒŒì¼ ë¦¬ìŠ¤íŠ¸ ì‹¹ ê¸ì–´ì˜¤ê¸°
                // limitì„ ë„‰ë„‰í•˜ê²Œ 3000ìœ¼ë¡œ ì„¤ì • (í•œ ë²ˆì— ë‹¤ ê°€ì ¸ì˜¤ë ¤ê³ )
                const { data, error } = await _supabase.storage
                    .from('problems')
                    .list(wbId + '/', { limit: 3000, offset: 0 });

                if (error) throw error;

                // 2. ê°€ì ¸ì˜¨ íŒŒì¼ëª…ì—ì„œ ë²ˆí˜¸ë§Œ ì¶”ì¶œí•´ì„œ Setì— ì €ì¥
                const serverFiles = new Set();
                data.forEach(file => {
                    const match = file.name.match(/\d+/);
                    if (match) {
                        serverFiles.add(parseInt(match[0], 10));
                    }
                });

                document.getElementById('server-count').innerText = `${serverFiles.size}ê°œ`;

                // 3. 1ë²ˆë¶€í„° totalê¹Œì§€ ëŒë©´ì„œ ì—†ëŠ” ë†ˆ ì°¾ê¸°
                let missing = [];
                for (let i = 1; i <= total; i++) {
                    if (!serverFiles.has(i)) {
                        missing.push(i);
                    }
                }

                // 4. ê²°ê³¼ ì¶œë ¥
                const resultArea = document.getElementById('result-area');
                const missingDiv = document.getElementById('missing-list');
                
                resultArea.classList.remove('hidden');

                if (missing.length === 0) {
                    missingDiv.innerHTML = "<span class='text-green-600'>ì™„ë²½í•´! ëˆ„ë½ëœ ê²Œ ì—†ì–´! ğŸ‰</span>";
                } else {
                    missingDiv.innerHTML = missing.join(', ') + "ë²ˆ";
                }

            } catch (err) {
                alert("ê²€ì‚¬ ì‹¤íŒ¨ ã… ã… : " + err.message);
            } finally {
                btn.innerText = "ğŸ” ë‹¤ì‹œ ê²€ì‚¬í•˜ê¸°";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>