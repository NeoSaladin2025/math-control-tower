<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Status Widget</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: transparent; overflow: hidden; }
        
        /* ì«€ë“í•œ ë²„íŠ¼ (ëª¨ë‹¬ ë‚´ë¶€ìš©) */
        .grade-btn {
            min-width: 50px; padding: 6px 14px; border-radius: 10px; font-weight: 800; font-size: 12px; 
            background: white; border: 2px solid #e2e8f0; color: #64748b; 
            box-shadow: 0 3px 0 #cbd5e1; transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1); 
            white-space: nowrap; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .grade-btn:active { transform: translateY(3px); box-shadow: none; }
        .grade-btn.active {
            background: linear-gradient(135deg, #6366f1, #4338ca); border-color: #3730a3; color: white; box-shadow: 0 3px 0 #312e81;
        }
        .grade-btn.active:active { transform: translateY(3px); box-shadow: none; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 50; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 100%; max-width: 600px; border-radius: 20px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-height: 90vh; display: flex; flex-direction: column; }
        
        /* ìŠ¤í¬ë¡¤ë°” */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <script src="config.js"></script>

    <div class="bg-gradient-to-br from-indigo-600 to-violet-700 rounded-xl shadow-lg p-5 text-white h-full flex flex-col">
        <h2 class="font-bold mb-6 opacity-90 border-b border-white/20 pb-2 text-sm flex justify-between items-center">
            <span>ğŸ“Š ì˜¤ëŠ˜ì˜ í˜„í™©</span>
            <button onclick="loadStats()" class="text-[10px] bg-white/20 hover:bg-white/30 px-2 py-1 rounded transition"><i class="fa-solid fa-rotate-right"></i></button>
        </h2>
        <div class="space-y-6 flex-1">
            <div onclick="openStatusModal('homework')" class="flex justify-between items-center cursor-pointer hover:bg-white/10 p-3 rounded-xl transition group">
                <div>
                    <div class="text-4xl font-black group-hover:scale-110 transition origin-left" id="stat-submit">0</div>
                    <div class="text-xs opacity-70 mt-1">ì œì¶œëœ ì¼ë°˜ ìˆ™ì œ</div>
                </div>
                <div class="text-4xl opacity-30 group-hover:opacity-100 transition">ğŸ“</div>
            </div>
            <div onclick="openStatusModal('question')" class="flex justify-between items-center cursor-pointer hover:bg-white/10 p-3 rounded-xl transition group">
                <div>
                    <div class="text-4xl font-black text-yellow-300 group-hover:scale-110 transition origin-left" id="stat-q">0</div>
                    <div class="text-xs opacity-70 mt-1">ëŒ€ê¸° ì¤‘ì¸ ì§ˆë¬¸</div>
                </div>
                <div class="text-4xl opacity-30 group-hover:opacity-100 transition">ğŸ™‹â€â™‚ï¸</div>
            </div>
        </div>
        <div class="text-[10px] opacity-50 text-center">Math Control Tower System</div>
    </div>

    <div id="status-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg" id="status-modal-title">í˜„í™© ìƒì„¸</h3>
                <button onclick="closeStatusModal()" class="text-white/70 hover:text-white text-xl transition">âœ•</button>
            </div>
            <div class="bg-white p-3 border-b flex gap-2 overflow-x-auto scrollbar-hide" id="status-grade-tabs"></div>
            <div id="status-list" class="p-4 overflow-y-auto flex-1 bg-slate-50 custom-scroll space-y-2"></div>
        </div>
    </div>

    <script>
        // ë°ì´í„° ì €ì¥ì†Œ
        let hwStatsData = [];
        let qStatsData = [];
        let currentStatusFilter = 'all';
        let currentStatusType = '';

        // ì´ˆê¸°í™”
        loadStats();

        async function loadStats() {
            const today = new Date().toISOString().split('T')[0];

            // 1. ìˆ™ì œ ë°ì´í„° (ì˜¤ëŠ˜ ì œì¶œëœ ì¼ë°˜ ìˆ™ì œ)
            const { data: hwData } = await _supabase.from('assignments')
                .select('*, users!student_id(name, grade)')
                .eq('is_special', false)
                .eq('status', 'submitted')
                .gte('submitted_at', today + ' 00:00:00');
            
            if(hwData) {
                hwStatsData = hwData;
                document.getElementById('stat-submit').innerText = hwData.length;
            }

            // 2. ì§ˆë¬¸ ë°ì´í„° (ëŒ€ê¸° ì¤‘ì¸ ì§ˆë¬¸ ì „ì²´) - users ì •ë³´ê¹Œì§€ ì¡°ì¸
            // â˜… ì¤‘ìš”: ì§ˆë¬¸ì€ í•™ìƒë³„ë¡œ ë¬¶ì–´ì„œ ì¹´ìš´íŠ¸í•˜ê¸° ìœ„í•´ users ì •ë³´ê°€ í•„ìš”í•¨
            const { data: qData } = await _supabase.from('student_progress')
                .select('*, users!student_id(name, grade)')
                .eq('is_question_active', true);

            if(qData) {
                qStatsData = processQData(qData);
                document.getElementById('stat-q').innerText = qData.length; // ì´ ì§ˆë¬¸ ê°œìˆ˜
            }
        }

        // ì§ˆë¬¸ ë°ì´í„°ë¥¼ í•™ìƒë³„ë¡œ ê·¸ë£¹í•‘
        function processQData(rawData) {
            const map = {};
            rawData.forEach(item => {
                const sid = item.student_id;
                if (!map[sid]) {
                    map[sid] = {
                        name: item.users.name,
                        grade: item.users.grade,
                        count: 0
                    };
                }
                map[sid].count++;
            });
            return Object.values(map); // ë°°ì—´ë¡œ ë³€í™˜
        }

        // --- ëª¨ë‹¬ ë¡œì§ ---
        function openStatusModal(type) {
            currentStatusType = type;
            document.getElementById('status-modal-overlay').style.display = 'flex';
            document.getElementById('status-modal-title').innerText = type === 'homework' ? 'ğŸ“ ì˜¤ëŠ˜ ì œì¶œëœ ìˆ™ì œ' : 'ğŸ™‹â€â™‚ï¸ ëŒ€ê¸° ì¤‘ì¸ ì§ˆë¬¸ í˜„í™©';
            
            // íƒ­ ë Œë”ë§
            const tabs = document.getElementById('status-grade-tabs');
            tabs.innerHTML = ['all','ì¤‘1','ì¤‘2','ì¤‘3','ê³ 1','ê³ 2','ê³ 3'].map(g => 
                `<button onclick="filterStatus('${g}')" id="st-tab-${g}" class="grade-btn ${g==='all'?'active':''}">
                    ${g==='all'?'âœ¨ ì „ì²´':g}
                </button>`
            ).join('');
            
            filterStatus('all');
        }

        function closeStatusModal() {
            document.getElementById('status-modal-overlay').style.display = 'none';
        }

        window.filterStatus = function(grade) { // HTML onclickì—ì„œ í˜¸ì¶œë˜ë„ë¡ windowì— ë°”ì¸ë”©
            currentStatusFilter = grade;
            document.querySelectorAll('#status-grade-tabs .grade-btn').forEach(b => {
                b.classList.remove('active');
                if (b.id === `st-tab-${grade}`) b.classList.add('active');
            });
            renderStatusList();
        }

        function renderStatusList() {
            const listEl = document.getElementById('status-list');
            listEl.innerHTML = '';
            
            let items = [];
            
            if (currentStatusType === 'homework') {
                items = [...hwStatsData]; // ë³µì‚¬
                if(currentStatusFilter !== 'all') items = items.filter(i => i.users.grade === currentStatusFilter);
                items.sort((a,b) => new Date(b.submitted_at) - new Date(a.submitted_at)); // ìµœì‹ ìˆœ
                
                if(items.length === 0) { listEl.innerHTML = '<div class="text-center py-10 text-gray-400 text-xs">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
                
                listEl.innerHTML = items.map(i => `
                    <div class="bg-white p-3 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm hover:border-indigo-300 transition">
                        <div>
                            <div class="text-sm font-bold text-slate-800">${i.users.name} <span class="text-xs text-slate-400 font-normal">(${i.users.grade})</span></div>
                            <div class="text-xs text-slate-500 truncate max-w-[200px]">${i.title}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-slate-400">${new Date(i.submitted_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                            <span class="text-[10px] font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded">ì œì¶œë¨</span>
                        </div>
                    </div>
                `).join('');

            } else {
                // Questions
                items = [...qStatsData];
                if(currentStatusFilter !== 'all') items = items.filter(s => s.grade === currentStatusFilter);
                items.sort((a,b) => b.count - a.count); // ì§ˆë¬¸ ë§ì€ ìˆœ

                if(items.length === 0) { listEl.innerHTML = '<div class="text-center py-10 text-gray-400 text-xs">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

                listEl.innerHTML = items.map((s, idx) => `
                    <div class="bg-white p-3 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm hover:border-yellow-400 transition">
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-bold text-slate-300 w-4 text-center">${idx+1}</span>
                            <div>
                                <div class="text-sm font-bold text-slate-800">${s.name} <span class="text-xs text-slate-400 font-normal">(${s.grade})</span></div>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-lg font-black text-red-500">${s.count}</span>
                            <span class="text-xs text-slate-400">ì§ˆë¬¸</span>
                        </div>
                    </div>
                `).join('');
            }
        }
    </script>
</body>
</html>