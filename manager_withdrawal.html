<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>CP ì¶œê¸ˆ ìŠ¹ì¸ ì„¼í„° & ì¹´ë“œ ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background: #f1f5f9; overflow: hidden; height: 100vh; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .lock-btn:disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; opacity: 0.6; }
        .grade-tab.active { background: #4f46e5; color: white; border-color: #4f46e5; }
        .history-tab.active { background: #059669; color: white; border-color: #059669; }
    </style>
</head>
<body class="flex flex-col h-full">
    <script src="config.js"></script>

    <header class="bg-white border-b px-8 py-4 flex justify-between items-center shrink-0 shadow-sm z-10">
        <div class="flex items-center gap-4">
            <div>
                <h2 class="text-xl font-black text-slate-800">ğŸ’° ê¸ˆìœµ ì²˜ë¦¬ ì‹œìŠ¤í…œ</h2>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Withdrawal & Card Control</p>
            </div>
            <div class="h-8 w-px bg-slate-200 mx-2"></div>
            <div class="flex gap-2">
                <button onclick="toggleCardManager()" class="bg-indigo-50 text-indigo-600 font-black px-4 py-2 rounded-xl text-xs hover:bg-indigo-100 transition flex items-center gap-2 border border-indigo-100">
                    <i class="fa-solid fa-credit-card"></i> ì¹´ë“œ ë²ˆí˜¸ ê´€ë¦¬
                </button>
                <button onclick="toggleHistoryManager()" class="bg-emerald-50 text-emerald-600 font-black px-4 py-2 rounded-xl text-xs hover:bg-emerald-100 transition flex items-center gap-2 border border-emerald-100">
                    <i class="fa-solid fa-clock-rotate-left"></i> ìŠ¹ì¸ ë‚´ì—­ ì¡°íšŒ
                </button>
            </div>
        </div>
        <div class="flex gap-2">
            <button id="btn-db-save" disabled onclick="saveToDatabase()" class="lock-btn bg-slate-900 text-white font-black px-6 py-3 rounded-xl text-sm transition shadow-lg">ìµœì¢… ë°ì´í„° ì €ì¥</button>
            <button id="btn-excel-down" disabled onclick="exportToExcel()" class="lock-btn bg-emerald-600 text-white font-black px-6 py-3 rounded-xl text-sm transition shadow-lg">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </header>

    <div id="card-manager-panel" class="hidden bg-white border-b shadow-inner p-6 overflow-hidden transition-all absolute top-[85px] left-0 right-0 z-20">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black text-indigo-600 text-sm"><i class="fa-solid fa-credit-card mr-2"></i>í•™ë…„ë³„ ì¹´ë“œë²ˆí˜¸ ê´€ë¦¬</h3>
                <button onclick="toggleCardManager()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex gap-2 mb-4">
                <button onclick="loadCardStudents('ì¤‘1')" class="grade-tab active px-4 py-2 rounded-lg text-xs font-bold border border-slate-200 transition">ì¤‘1</button>
                <button onclick="loadCardStudents('ì¤‘2')" class="grade-tab px-4 py-2 rounded-lg text-xs font-bold border border-slate-200 transition">ì¤‘2</button>
                <button onclick="loadCardStudents('ì¤‘3')" class="grade-tab px-4 py-2 rounded-lg text-xs font-bold border border-slate-200 transition">ì¤‘3</button>
                <button onclick="loadCardStudents('ê³ 1')" class="grade-tab px-4 py-2 rounded-lg text-xs font-bold border border-slate-200 transition">ê³ 1</button>
                <button onclick="loadCardStudents('ê³ 2')" class="grade-tab px-4 py-2 rounded-lg text-xs font-bold border border-slate-200 transition">ê³ 2</button>
                <button onclick="loadCardStudents('ê³ 3')" class="grade-tab px-4 py-2 rounded-lg text-xs font-bold border border-slate-200 transition">ê³ 3</button>
            </div>
            <div id="student-card-list" class="flex gap-4 overflow-x-auto pb-4 custom-scroll"></div>
        </div>
    </div>

    <div id="history-manager-panel" class="hidden bg-white border-b shadow-inner p-6 overflow-hidden transition-all absolute top-[85px] left-0 right-0 z-20">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black text-emerald-600 text-sm"><i class="fa-solid fa-list-check mr-2"></i>ìŠ¹ì¸ ì™„ë£Œ ë‚´ì—­ (ìµœê·¼ 100ê±´)</h3>
                <button onclick="toggleHistoryManager()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex gap-2 mb-4">
                <button onclick="loadHistory('ì¤‘1')" class="history-tab active px-4 py-2 rounded-lg text-xs font-bold border border-slate-200 transition">ì¤‘1</button>
                <button onclick="loadHistory('ì¤‘2')" class="history-tab px-4 py-2 rounded-lg text-xs font-bold border border-slate-200 transition">ì¤‘2</button>
                <button onclick="loadHistory('ì¤‘3')" class="history-tab px-4 py-2 rounded-lg text-xs font-bold border border-slate-200 transition">ì¤‘3</button>
                <button onclick="loadHistory('ê³ 1')" class="history-tab px-4 py-2 rounded-lg text-xs font-bold border border-slate-200 transition">ê³ 1</button>
                <button onclick="loadHistory('ê³ 2')" class="history-tab px-4 py-2 rounded-lg text-xs font-bold border border-slate-200 transition">ê³ 2</button>
                <button onclick="loadHistory('ê³ 3')" class="history-tab px-4 py-2 rounded-lg text-xs font-bold border border-slate-200 transition">ê³ 3</button>
            </div>
            <div id="history-list" class="grid grid-cols-4 gap-4 overflow-y-auto max-h-[300px] custom-scroll p-1"></div>
        </div>
    </div>

    <main class="flex-1 flex overflow-hidden p-6 gap-6 pt-6">
        <section class="flex-1 flex flex-col bg-white rounded-[32px] shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b bg-slate-50/50 flex justify-between items-center">
                <h3 class="font-black text-slate-700 flex items-center gap-2"><i class="fa-solid fa-hourglass-half text-amber-500"></i> ëŒ€ê¸° ë¦¬ìŠ¤íŠ¸</h3>
                <span id="cnt-pending" class="bg-slate-200 text-slate-600 px-3 py-1 rounded-full text-[10px] font-black">0</span>
            </div>
            <div id="list-pending" class="flex-1 overflow-y-auto custom-scroll p-4 space-y-3"></div>
        </section>

        <section class="w-[450px] flex flex-col bg-white rounded-[32px] shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b bg-indigo-50/30 flex justify-between items-center">
                <h3 class="font-black text-indigo-700 flex items-center gap-2"><i class="fa-solid fa-cart-shopping"></i> ìŠ¹ì¸ ì¥ë°”êµ¬ë‹ˆ</h3>
                <span id="cnt-cart" class="bg-indigo-600 text-white px-3 py-1 rounded-full text-[10px] font-black">0</span>
            </div>
            <div id="list-cart" class="flex-1 overflow-y-auto custom-scroll p-4 space-y-3 bg-indigo-50/10"></div>
            <div class="p-6 border-t bg-slate-50 space-y-4">
                <label class="flex items-center gap-3 cursor-pointer group">
                    <input type="checkbox" id="check-1" onchange="validateLocks()" class="w-5 h-5 rounded text-indigo-600"><span class="text-sm font-bold text-slate-600">1ì°¨ í™•ì¸: ëª…ë‹¨ ë° ê¸ˆì•¡ í™•ì¸</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer group">
                    <input type="checkbox" id="check-2" disabled onchange="validateLocks()" class="w-5 h-5 rounded text-indigo-600"><span id="text-check-2" class="text-sm font-bold text-slate-400">ìµœì¢… í™•ì¸: ë°ì´í„° ì²˜ë¦¬ ë™ì˜</span>
                </label>
            </div>
        </section>
    </main>

    <script>
        let pendingData = [], cartData = [], allStudents = [], lastApprovedData = [];

        async function init() {
            const { data } = await _supabase.from('cp_withdrawals').select(`id, amount, student_id, users(name, grade, crabit_card_number)`).eq('status', 'pending').order('created_at', { ascending: true });
            pendingData = data || [];
            const { data: s } = await _supabase.from('users').select('username, name, grade, crabit_card_number').eq('role', 'student');
            allStudents = s || [];
            renderAll();
            loadCardStudents('ì¤‘1'); 
        }

        function toggleCardManager() { document.getElementById('history-manager-panel').classList.add('hidden'); document.getElementById('card-manager-panel').classList.toggle('hidden'); }
        function toggleHistoryManager() { document.getElementById('card-manager-panel').classList.add('hidden'); document.getElementById('history-manager-panel').classList.toggle('hidden'); loadHistory('ì¤‘1'); }

        function loadCardStudents(grade) {
            document.querySelectorAll('.grade-tab').forEach(b => b.classList.toggle('active', b.innerText===grade));
            const filtered = allStudents.filter(s => s.grade === grade);
            document.getElementById('student-card-list').innerHTML = filtered.map(s => `
                <div class="min-w-[180px] bg-slate-50 p-4 rounded-2xl border border-slate-200 shrink-0">
                    <div class="text-xs font-black text-slate-800 mb-2">${s.name}</div>
                    <input type="text" id="card-${s.username}" value="${s.crabit_card_number || ''}" placeholder="ë²ˆí˜¸ ì…ë ¥" class="w-full text-[11px] p-2 rounded-lg border outline-none focus:border-indigo-500 mb-2">
                    <button onclick="updateCardNumber('${s.username}')" class="w-full bg-slate-800 text-white text-[10px] py-1.5 rounded-lg hover:bg-indigo-600 transition">ì €ì¥</button>
                </div>`).join('') || '<div class="text-slate-400 text-xs py-4">í•™ìƒ ì—†ìŒ</div>';
        }
        async function updateCardNumber(sid) {
            const num = document.getElementById(`card-${sid}`).value;
            await _supabase.from('users').update({ crabit_card_number: num }).eq('username', sid);
            alert("ì €ì¥ ì™„ë£Œ!");
        }

        async function loadHistory(grade) {
            document.querySelectorAll('.history-tab').forEach(b => b.classList.toggle('active', b.innerText===grade));
            const { data } = await _supabase.from('cp_withdrawals').select(`id, amount, approved_at, users!inner(name, grade)`).eq('status', 'approved').eq('users.grade', grade).order('approved_at', { ascending: false }).limit(100);
            document.getElementById('history-list').innerHTML = (data && data.length) ? data.map(i => `
                <div class="bg-emerald-50 border border-emerald-100 p-3 rounded-xl flex justify-between items-center">
                    <div><div class="text-[10px] text-emerald-600 font-bold mb-0.5">${new Date(i.approved_at).toLocaleDateString()}</div><div class="text-sm font-black text-slate-700">${i.users.name} | ${i.amount.toLocaleString()} P</div></div>
                    <button onclick="deleteHistoryItem(${i.id}, '${grade}')" class="text-slate-300 hover:text-red-500 transition px-2"><i class="fa-solid fa-trash-can"></i></button>
                </div>`).join('') : '<div class="col-span-4 text-center py-10 text-slate-400 text-xs">ë‚´ì—­ ì—†ìŒ</div>';
        }
        async function deleteHistoryItem(id, g) { if(confirm("ê¸°ë¡ ì‚­ì œ?")) { await _supabase.from('cp_withdrawals').delete().eq('id', id); loadHistory(g); } }

        function renderAll() { renderPending(); renderCart(); validateLocks(); }
        function renderPending() {
            const list = document.getElementById('list-pending');
            document.getElementById('cnt-pending').innerText = pendingData.length;
            list.innerHTML = pendingData.length ? pendingData.map(i => `
                <div class="bg-white border border-slate-100 p-5 rounded-2xl shadow-sm flex justify-between items-center hover:shadow-md transition">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-black text-slate-400 text-xs">${i.users.name[0]}</div>
                        <div><div class="text-sm font-black text-slate-800">${i.users.name} <span class="text-[10px] text-slate-400">${i.student_id}</span></div><div class="text-[10px] text-indigo-500 font-bold mt-1">ğŸ’³ ${i.users.crabit_card_number || 'ë¯¸ë“±ë¡'}</div></div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="text-right font-black text-slate-700 text-sm mr-2">${i.amount.toLocaleString()} CP</div>
                        <button onclick="rejectRequest(this, ${i.id})" class="bg-slate-100 text-slate-400 text-[11px] font-black px-3 py-2 rounded-lg hover:bg-red-50 hover:text-red-500 transition">ê±°ì ˆ</button>
                        <button onclick="moveToCart(${i.id})" class="bg-indigo-600 text-white text-[11px] font-black px-3 py-2 rounded-lg hover:bg-indigo-500 transition">ìŠ¹ì¸ ì˜ˆì •</button>
                    </div>
                </div>`).join('') : '<div class="text-center py-10 text-slate-400 text-xs">ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
        function renderCart() {
            const list = document.getElementById('list-cart');
            document.getElementById('cnt-cart').innerText = cartData.length;
            list.innerHTML = cartData.map(i => `
                <div class="bg-indigo-600 p-4 rounded-2xl shadow-md flex justify-between items-center animate-pulse-once">
                    <div class="text-sm font-black text-white">${i.users.name} / ${i.amount.toLocaleString()} CP</div>
                    <button onclick="removeFromCart(${i.id})" class="w-8 h-8 rounded-full bg-white/20 text-white flex items-center justify-center hover:bg-white/40"><i class="fa-solid fa-circle-minus"></i></button>
                </div>`).join('') || '<div class="text-center py-20 text-indigo-300 text-xs font-bold">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</div>';
        }
        function moveToCart(id) { const idx = pendingData.findIndex(x => x.id === id); if(idx > -1) { cartData.push(pendingData[idx]); pendingData.splice(idx, 1); renderAll(); } }
        function removeFromCart(id) { const idx = cartData.findIndex(x => x.id === id); if(idx > -1) { pendingData.push(cartData[idx]); cartData.splice(idx, 1); renderAll(); } }

        // --- â˜… [ìˆ˜ì •ë¨] ê±°ì ˆ ì‹œ í™˜ë¶ˆ + ë¦¬ìŠ¤íŠ¸ ì‚­ì œ + ë©”ì‹œì§€ ì „ì†¡ â˜… ---
        async function rejectRequest(btn, id) {
            if(btn) { btn.disabled = true; btn.innerText = "..."; }
            const reason = prompt("ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (í•™ìƒì—ê²Œ ì „ì†¡ë©ë‹ˆë‹¤):", "ì •ë³´ ë¶ˆì¼ì¹˜");
            if (!reason) { if(btn) { btn.disabled = false; btn.innerText = "ê±°ì ˆ"; } return; }

            const item = pendingData.find(x => x.id === id);
            try {
                // 1. í™˜ë¶ˆ
                const { error: rErr } = await _supabase.rpc('give_points', { p_student_id: item.student_id, p_xp: 0, p_cp: item.amount, p_rule_name: 'ğŸ’³ ì¶œê¸ˆ ë°˜ë ¤' });
                if(rErr) throw new Error("í™˜ë¶ˆ ì‹¤íŒ¨: " + rErr.message);

                // 2. ìƒíƒœ ì—…ë°ì´íŠ¸ (ì—¬ê¸°ì„œ reject_reason ì»¬ëŸ¼ í•„ìš”!)
                const { error: uErr } = await _supabase.from('cp_withdrawals').update({ status: 'rejected', reject_reason: reason }).eq('id', id);
                if(uErr) throw new Error("DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: " + uErr.message);

                // 3. ë©”ì‹œì§€ ì „ì†¡
                await _supabase.from('season_messages').insert([{
                    student_id: item.student_id,
                    message: `[ì¶œê¸ˆ ë°˜ë ¤] ${item.amount.toLocaleString()} CP ì¶œê¸ˆ ìš”ì²­ì´ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤. (ì‚¬ìœ : ${reason})`,
                    is_read: false, xp_change: 0, cp_change: item.amount
                }]);

                alert("ë°˜ë ¤ ë° í™˜ë¶ˆ ì™„ë£Œ!");
                pendingData = pendingData.filter(x => x.id !== id); // ë¦¬ìŠ¤íŠ¸ì—ì„œ ì¦‰ì‹œ ì œê±°
                renderAll();
            } catch(e) {
                alert("ì˜¤ë¥˜: " + e.message + "\n(DBì— reject_reason ì»¬ëŸ¼ì„ ì¶”ê°€í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”!)");
                if(btn) { btn.disabled = false; btn.innerText = "ê±°ì ˆ"; }
            }
        }

        function validateLocks() {
            const c1 = document.getElementById('check-1'), c2 = document.getElementById('check-2'), btn = document.getElementById('btn-db-save');
            if (cartData.length === 0) { c1.checked=false; c2.checked=false; c1.disabled=true; c2.disabled=true; btn.disabled=true; }
            else { c1.disabled=false; c2.disabled=!c1.checked; btn.disabled=!c2.checked; }
            document.getElementById('text-check-2').className = c1.checked ? "text-sm font-bold text-slate-800" : "text-sm font-bold text-slate-400";
        }

        async function saveToDatabase() {
            if(!confirm("ìŠ¹ì¸ í™•ì • í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const btn = document.getElementById('btn-db-save'); btn.disabled=true;
            try {
                lastApprovedData = [...cartData];
                for(let item of cartData) {
                    await _supabase.from('cp_withdrawals').update({ status: 'approved', approved_at: new Date() }).eq('id', item.id);
                    await _supabase.from('season_messages').insert([{
                        student_id: item.student_id, message: `[ì¶œê¸ˆ ìŠ¹ì¸] ${item.amount.toLocaleString()} CP ì¶œê¸ˆ ìŠ¹ì¸ ì™„ë£Œ.`, is_read: false, xp_change: 0, cp_change: 0
                    }]);
                }
                alert("ìŠ¹ì¸ ì™„ë£Œ!"); document.getElementById('btn-excel-down').disabled = false;
                cartData = []; document.getElementById('check-1').checked=false; document.getElementById('check-2').checked=false;
                init();
            } catch(e) { alert(e.message); } finally { btn.disabled=false; }
        }

        function exportToExcel() {
            const t = cartData.length ? cartData : lastApprovedData;
            if(!t.length) return alert("ë°ì´í„° ì—†ìŒ");
            const d = t.map(i => ({ "ì´ë¦„": i.users.name, "ì¹´ë“œ": i.users.crabit_card_number, "ê¸ˆì•¡": i.amount }));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d), "Withdrawal");
            XLSX.writeFile(wb, `ì¶œê¸ˆ_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        init();
    </script>
</body>
</html>