<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬¸ì œì§‘ ë“±ë¡ ë° ë°ì´í„° ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f8fafc; }
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .btn-primary { background-color: #4f46e5; color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #4338ca; }
        .input-group input, .input-group select { border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; font-size: 14px; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* ìŠ¤í¬ë¡¤ë°” */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #query-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .query-modal-content { background: white; width: 95%; max-width: 700px; height: 80vh; border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }

        /* ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .badge { font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 6px; }
        .badge-norm { background-color: #bfdbfe; color: #1d4ed8; } 
        .badge-high { background-color: #e9d5ff; color: #7e22ce; } 
        .badge-sub { background-color: #a7f3d0; color: #047857; } 
        .badge-rep { background-color: #fcd34d; color: #92400e; border: 1px solid #d97706; } 
        .badge-tough { background-color: #c7d2fe; color: #4f46e5; border: 1px solid #6366f1; } 

        /* Queue List Style */
        .queue-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: #f1f5f9; border-radius: 8px; border: 1px solid #cbd5e1; margin-bottom: 6px; font-size: 13px; animation: slideIn 0.2s ease-out; }
        .queue-item span.info { font-size: 0.75rem; color: #64748b; font-weight: 500; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .queue-item:hover { border-color: #6366f1; background: #eef2ff; }
    </style>
</head>
<body class="p-6">

    <script src="config.js"></script>

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black text-slate-800 flex items-center gap-2">
                    <i class="fa-solid fa-book-open text-indigo-600"></i> êµì¬ ë“±ë¡ ë° ë°ì´í„° ê´€ë¦¬ (Workbook Manager)
                </h1>
            </div>
            <div class="flex gap-3">
                <a href="teacher_main.html" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-indigo-700 transition flex items-center gap-2">
                    <i class="fa-solid fa-house"></i> ëŒ€ì‹œë³´ë“œ
                </a>
                <a href="teacher_assign_integrated.html" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-indigo-700 transition flex items-center gap-2">
                    <i class="fa-solid fa-pen-to-square"></i> ìˆ™ì œ ì¶œì œ
                </a>
            </div>
        </header>

        <div class="card mb-6">
            <label for="workbook-select" class="block text-sm font-bold text-slate-700 mb-2">ì‘ì—… ëŒ€ìƒ êµì¬ ì„ íƒ (í•„ìˆ˜)</label>
            <select id="workbook-select" onchange="loadWorkbookDetails(this.value)" class="w-full border p-3 rounded-lg text-base cursor-pointer focus:border-indigo-500">
                <option value="">êµì¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš” (ë¡œë”© ì¤‘...)</option>
            </select>
            <p class="text-sm text-slate-500 mt-2">ì„ íƒëœ êµì¬: <span id="selected-wb-info" class="font-bold">-</span></p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <div class="card space-y-4">
                <h2 class="text-lg font-bold text-slate-800 border-b pb-2 mb-3">1. ì‹ ê·œ êµì¬ ë“±ë¡</h2>
                <div class="input-group">
                    <label for="new-wb-name" class="block text-xs font-bold text-gray-500 mb-1">êµì¬ëª… (ì˜ˆ: ìˆ ìˆ˜í•™ ì¤‘2-1)</label>
                    <input type="text" id="new-wb-name" class="w-full" placeholder="êµì¬ ì´ë¦„">
                </div>
                <div class="input-group flex gap-2">
                    <div class="flex-1">
                        <label for="new-wb-grade" class="block text-xs font-bold text-gray-500 mb-1">í•™ë…„</label>
                        <select id="new-wb-grade" class="w-full">
                            <option value="ì¤‘1">ì¤‘1</option>
                            <option value="ì¤‘2">ì¤‘2</option>
                            <option value="ê³ 1">ê³ 1</option>
                            <option value="ê³ 2">ê³ 2</option>
                            <option value="ê³ 3">ê³ 3</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="new-wb-total" class="block text-xs font-bold text-gray-500 mb-1">ì´ ë¬¸í•­ ìˆ˜</label>
                        <input type="number" id="new-wb-total" class="w-full" placeholder="ì´ ë¬¸í•­">
                    </div>
                </div>
                <button onclick="registerWorkbook()" class="w-full btn-primary py-3 rounded-xl font-bold">ì‹ ê·œ ë“±ë¡</button>
            </div>

            <div class="card space-y-4">
                <h2 class="text-lg font-bold text-slate-800 border-b pb-2 mb-3">2. êµì¬ ì •ë³´ ìˆ˜ì • (Edit)</h2>
                <div class="input-group">
                    <label for="edit-wb-name" class="block text-xs font-bold text-gray-500 mb-1">êµì¬ëª…</label>
                    <input type="text" id="edit-wb-name" class="w-full" placeholder="êµì¬ëª…">
                </div>
                <div class="input-group flex gap-2">
                    <div class="flex-1">
                        <label for="edit-wb-grade" class="block text-xs font-bold text-gray-500 mb-1">í•™ë…„</label>
                        <select id="edit-wb-grade" class="w-full">
                            <option value="ì¤‘1">ì¤‘1</option>
                            <option value="ì¤‘2">ì¤‘2</option>
                            <option value="ê³ 1">ê³ 1</option>
                            <option value="ê³ 2">ê³ 2</option>
                            <option value="ê³ 3">ê³ 3</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="edit-wb-total" class="block text-xs font-bold text-gray-500 mb-1">ì´ ë¬¸í•­ ìˆ˜</label>
                        <input type="number" id="edit-wb-total" class="w-full" placeholder="ì´ ë¬¸í•­">
                    </div>
                </div>
                <button onclick="updateWorkbookInfo()" class="w-full btn-primary py-3 rounded-xl font-bold">ìˆ˜ì •ì‚¬í•­ ì €ì¥</button>
            </div>

            <div class="card space-y-4 col-span-2">
                <h2 class="text-lg font-bold text-slate-800 border-b pb-2 mb-3">3. ë‹¨ì›/ìœ í˜• ì¼ê´„ ì„¤ì • (Batch)</h2>
                
                <div class="bg-indigo-50 p-4 rounded-xl border-2 border-indigo-200 space-y-3">
                    <h3 class="text-base font-bold text-indigo-700 flex items-center gap-2"><i class="fa-solid fa-tags"></i> ë‹¨ì› ì •ë³´ ì¼ê´„ ì ìš© (New!)</h3>
                    
                    <div class="flex gap-3 items-center">
                        <span class="text-sm font-medium text-slate-600">ë¬¸ì œ ë²”ìœ„:</span>
                        <input type="number" id="chap-start" class="w-16 p-2 text-center" placeholder="Start">
                        ~
                        <input type="number" id="chap-end" class="w-16 p-2 text-center" placeholder="End">
                    </div>

                    <div class="grid grid-cols-4 gap-3">
                        <div class="input-group col-span-1">
                            <label for="chap-major" class="block text-xs font-bold text-gray-500 mb-1">ëŒ€ë‹¨ì›</label>
                            <select id="chap-major" class="w-full">
                                <option value="">ì„ íƒ</option>
                                <script>
                                    for(let i=1; i<=10; i++) document.write(`<option value="${i}">ëŒ€ë‹¨ì› ${i}</option>`);
                                </script>
                            </select>
                        </div>
                        <div class="input-group col-span-3">
                            <label for="chap-major-title" class="block text-xs font-bold text-gray-500 mb-1">ëŒ€ë‹¨ì› ëª… (í•œê¸€) <span class="text-red-500">(New!)</span></label>
                            <input type="text" id="chap-major-title" class="w-full" placeholder="ì˜ˆ: ë‹¤í•­ì‹ì˜ ì—°ì‚°">
                        </div>
                        <div class="input-group col-span-1">
                            <label for="chap-minor" class="block text-xs font-bold text-gray-500 mb-1">ì¤‘ë‹¨ì›</label>
                            <select id="chap-minor" class="w-full">
                                <option value="">ì„ íƒ</option>
                                <script>
                                    for(let i=1; i<=20; i++) document.write(`<option value="${i}">ì¤‘ë‹¨ì› ${i}</option>`);
                                </script>
                            </select>
                        </div>
                        <div class="input-group col-span-3">
                            <label for="chap-title" class="block text-xs font-bold text-gray-500 mb-1">ì¤‘/ì†Œë‹¨ì› ëª… (í•œê¸€)</label>
                            <input type="text" id="chap-title" class="w-full" placeholder="ì˜ˆ: ë‹¤í•­ì‹ì˜ ë§ì…ˆê³¼ ëº„ì…ˆ">
                        </div>
                    </div>
                    
                    <button onclick="updateChapterInfo()" id="btn-chapter-update" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold transition text-sm flex items-center justify-center gap-2">
                        <i class="fa-solid fa-stamp"></i> ë‹¨ì› ì •ë³´ ì¼ê´„ ì ìš©
                    </button>
                </div>
                
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-3">
                    <h3 class="text-base font-bold text-slate-700 flex items-center gap-2"><i class="fa-solid fa-layer-group"></i> ë‚œì´ë„/ìœ í˜• ë‹¤ì¤‘ ì…ë ¥ (Batch Queue)</h3>
                    
                    <button onclick="openQueryModal()" class="w-full bg-slate-200 text-slate-700 px-3 py-2 rounded-lg font-bold text-xs hover:bg-slate-300 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-search"></i> ë¬¸ì œ ì •ë³´ ìƒì„¸ ì¡°íšŒ (ë³„ë„ ì°½)
                    </button>
                    
                    <div class="flex gap-4 items-end">
                        <div class="input-group flex-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1">ë²”ìœ„</label>
                            <div class="flex items-center gap-1">
                                <input type="number" id="q-start" class="w-full p-2 text-center" placeholder="Start">
                                ~
                                <input type="number" id="q-end" class="w-full p-2 text-center" placeholder="End">
                            </div>
                        </div>
                        <div class="input-group flex-[2]">
                            <label class="block text-xs font-bold text-gray-500 mb-1">ìœ í˜• ì„ íƒ</label>
                            <div class="flex gap-2 items-center h-[42px]">
                                <label class="flex items-center gap-1 text-sm"><input type="radio" name="q-type" value="norm" checked> ì¼ë°˜</label>
                                <label class="flex items-center gap-1 text-sm"><input type="radio" name="q-type" value="sub"> ì„œìˆ </label>
                                <label class="flex items-center gap-1 text-sm"><input type="radio" name="q-type" value="high"> 1ë“±ê¸‰</label>
                            </div>
                        </div>
                    </div>
                    <button onclick="addToQueue()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-bold shadow-md transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus-circle"></i> ë¦¬ìŠ¤íŠ¸ì— ë‹´ê¸° (Add to List)
                    </button>

                    <div id="queue-box" class="hidden border-t border-slate-300 pt-3 mt-3">
                        <p class="text-xs font-bold text-slate-500 mb-2 flex justify-between items-center">
                            <span>ğŸš€ ì ìš© ëŒ€ê¸° ëª©ë¡ (Pending)</span>
                            <span id="queue-count" class="text-blue-600">0ê±´</span>
                        </p>
                        <div id="queue-list" class="space-y-2 max-h-60 overflow-y-auto custom-scroll p-1">
                            </div>
                        <button onclick="saveAllQueue()" id="btn-save-all" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 mt-3 rounded-xl font-bold shadow-lg transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-check-double"></i> ì „ì²´ ì ìš© ì‹¤í–‰ (Save All)
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div id="query-modal-overlay">
        <div class="query-modal-content">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-clipboard-list"></i> ë¬¸ì œ ë©”íƒ€ë°ì´í„° ì¡°íšŒ</h3>
                <button onclick="closeQueryModal()" class="text-slate-400 hover:text-white text-2xl transition">Ã—</button>
            </div>
            
            <div class="p-4 border-b border-slate-200 bg-slate-50 flex flex-col gap-2 shrink-0">
                <div id="query-range-container" class="flex flex-wrap gap-2 items-center">
                    <span class="text-xs font-bold text-slate-600 shrink-0">ì¡°íšŒ ë²”ìœ„ ì„¤ì •:</span>
                </div>
                <div id="query-status-msg" class="text-sm font-medium text-slate-500">êµì¬ë¥¼ ì„ íƒí•˜ê³  ë²”ìœ„ë¥¼ ì„¤ì •í•˜ì—¬ ì¡°íšŒí•˜ì„¸ìš”.</div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scroll p-4 space-y-3">
                <div class="bg-white p-3 rounded-lg border border-slate-200 shadow-inner">
                    <p class="font-bold text-sm text-slate-700 mb-2">ğŸ“Š ë²”ë¡€ (ë°ì´í„° ì†ì„±)</p>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div>
                            <span class="badge badge-norm">ì¼ë°˜í˜•</span> (Blue)<br>
                            <span class="badge badge-high">1ë“±ê¸‰</span> (Purple)<br>
                            <span class="badge badge-sub">ì„œìˆ í˜•</span> (Green)
                        </div>
                        <div>
                            <span class="badge badge-rep">ëŒ€í‘œ ë¬¸ì œ</span> : ì¼ë°˜í˜• ê·¸ë£¹ì˜ ì‹œì‘<br>
                            <span class="badge badge-tough">í„°í”„ ë¬¸ì œ</span> : ì¼ë°˜í˜• ê·¸ë£¹ì˜ ë<br>
                            **ê·¸ë£¹ ë²ˆí˜¸:** ì¼ë°˜í˜• ë¬¸ì œì— ë¶€ì—¬ëœ ìˆœë²ˆ
                        </div>
                    </div>
                </div>
                <table class="min-w-full divide-y divide-slate-200 text-sm">
                    <thead>
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">No.</th>
                            <th class="px-3 py-2 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">ê·¸ë£¹ ID</th>
                            <th class="px-3 py-2 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">ìœ í˜• / ë‚œì´ë„</th>
                            <th class="px-3 py-2 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">ë‹¨ì› ì •ë³´</th>
                        </tr>
                    </thead>
                    <tbody id="query-results-tbody" class="bg-white divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const user = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!user || (user.role !== 'teacher' && user.role !== 'admin')) { alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); location.href='index.html'; }

        let currentWorkbook = null;
        let batchQueue = []; // ì‘ì‘ ë¦¬ìŠ¤íŠ¸

        init();

        async function init() {
            await loadWorkbooks();
            // Init Query Modal Inputs
            const queryRangeContainer = document.getElementById('query-range-container');
            queryRangeContainer.innerHTML = `
                <span class="text-xs font-bold text-slate-600 shrink-0">ì¡°íšŒ ë²”ìœ„ ì„¤ì •:</span>
                <div class="flex gap-1 items-center range-row">
                    <input type="number" class="range-start w-16 p-1 text-center border rounded" placeholder="Start">
                    <span class="text-slate-400 font-bold text-xs">~</span>
                    <input type="number" class="range-end w-16 p-1 text-center border rounded" placeholder="End">
                    <button onclick="removeQueryRange(this)" class="text-slate-400 hover:text-red-500 px-1 text-sm"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <button onclick="addQueryRangeInput()" class="bg-slate-200 text-slate-700 px-2 py-1 rounded-lg font-bold text-xs hover:bg-slate-300 transition"><i class="fa-solid fa-plus"></i> êµ¬ê°„ ì¶”ê°€</button>
                <button onclick="runBatchQuery()" id="btn-run-query" class="bg-indigo-600 text-white px-3 py-1 rounded-lg font-bold text-xs hover:bg-indigo-700 transition">
                    <i class="fa-solid fa-search"></i> ì¡°íšŒ ì‹œì‘
                </button>
            `;
        }

        async function loadWorkbooks() {
            const sel = document.getElementById('workbook-select');
            sel.innerHTML = '<option value="">êµì¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>';
            const { data, error } = await _supabase.from('workbooks').select('*').order('title');
            if (error) { console.error(error); return; }
            data.forEach(wb => {
                const option = document.createElement('option');
                option.value = wb.id;
                option.innerText = `${wb.title} (${wb.total_problems}ë¬¸)`;
                sel.appendChild(option);
            });
        }

        function loadWorkbookDetails(wbId) {
            currentWorkbook = null;
            batchQueue = []; // êµì¬ ë°”ë€Œë©´ í ì´ˆê¸°í™”
            renderQueue();
            document.getElementById('selected-wb-info').innerText = '-';
            if (!wbId) return;

            const selectedOption = document.querySelector(`#workbook-select option[value="${wbId}"]`);
            document.getElementById('selected-wb-info').innerText = selectedOption.innerText;

            _supabase.from('workbooks').select('*').eq('id', wbId).single()
                .then(({ data }) => {
                    if (data) {
                        currentWorkbook = data;
                        document.getElementById('edit-wb-name').value = data.title;
                        document.getElementById('edit-wb-grade').value = data.grade;
                        document.getElementById('edit-wb-total').value = data.total_problems;
                    }
                });
        }

        // --- Basic Registration Logic (Kept same) ---
        async function registerWorkbook() { /* ... Same as before ... */ 
            const title = document.getElementById('new-wb-name').value;
            const grade = document.getElementById('new-wb-grade').value;
            const total = parseInt(document.getElementById('new-wb-total').value);
            if (!title || !grade || isNaN(total) || total <= 0) return alert("ëª¨ë“  í•­ëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            try {
                const { data, error } = await _supabase.from('workbooks').insert([{ title, grade, total_problems: total }]).select().single();
                if (error) throw error;
                const metadata = [];
                for (let i = 1; i <= total; i++) {
                    metadata.push({ workbook_id: data.id, problem_num: i, difficulty: 'normal', is_subjective: false, is_representative: false, is_tough: false, section_id: null });
                }
                const { error: metaError } = await _supabase.from('problem_metadata').insert(metadata);
                if (metaError) throw metaError;
                alert(`âœ… êµì¬ [${title}] ë“±ë¡ ë° ${total}ê°œ ë¬¸í•­ ì´ˆê¸°í™” ì™„ë£Œ!`);
                await loadWorkbooks();
            } catch (e) { alert("ë“±ë¡ ì‹¤íŒ¨: " + e.message); }
        }

        async function updateWorkbookInfo() { /* ... Same as before ... */ 
            if (!currentWorkbook) return alert("êµì¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
            const newTitle = document.getElementById('edit-wb-name').value;
            const newGrade = document.getElementById('edit-wb-grade').value;
            const newTotal = parseInt(document.getElementById('edit-wb-total').value);
            if (!newTitle || !newGrade || isNaN(newTotal) || newTotal <= 0) return alert("ëª¨ë“  í•­ëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if (!confirm(`[${currentWorkbook.title}]ì˜ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ê³ , ì´ ë¬¸í•­ ìˆ˜ë¥¼ ${newTotal}ê°œë¡œ ì—…ë°ì´íŠ¸ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            try {
                const { error } = await _supabase.from('workbooks').update({ title: newTitle, grade: newGrade, total_problems: newTotal }).eq('id', currentWorkbook.id);
                if (error) throw error;
                alert("âœ… êµì¬ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
                await loadWorkbooks();
                loadWorkbookDetails(currentWorkbook.id);
            } catch (e) { alert("ìˆ˜ì • ì‹¤íŒ¨: " + e.message); }
        }
        
        async function updateChapterInfo() { /* ... Same as before ... */
            if (!currentWorkbook) return alert("êµì¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
            const startNum = parseInt(document.getElementById('chap-start').value);
            const endNum = parseInt(document.getElementById('chap-end').value);
            const major = parseInt(document.getElementById('chap-major').value) || null;
            const majorTitle = document.getElementById('chap-major-title').value || null; 
            const minor = parseInt(document.getElementById('chap-minor').value) || null;
            const title = document.getElementById('chap-title').value || null; 
            if (isNaN(startNum) || isNaN(endNum) || startNum <= 0 || startNum > endNum || !title) return alert("í•„ìˆ˜ ì •ë³´ ëˆ„ë½");
            if(major && !majorTitle) return alert("ëŒ€ë‹¨ì› ëª…(í•œê¸€)ë„ í•„ìˆ˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            
            if (!confirm(`No.${startNum}~${endNum} ë‹¨ì› ì •ë³´ ë®ì–´ì“°ê¸°?`)) return;
            
            const btn = document.getElementById('btn-chapter-update');
            btn.innerHTML = '<div class="loader mr-2"></div> ì ìš© ì¤‘...'; btn.disabled = true;
            try {
                const { error } = await _supabase.from('problem_metadata').update({ chapter_major: major, chapter_major_title_ko: majorTitle, chapter_minor: minor, chapter_title_ko: title }).eq('workbook_id', currentWorkbook.id).gte('problem_num', startNum).lte('problem_num', endNum);
                if (error) throw error;
                alert("âœ… ë‹¨ì› ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ!");
                // Auto Reset
                document.getElementById('chap-start').value = endNum + 1; // í¸ì˜ìƒ ë‹¤ìŒ ë²ˆí˜¸ ìë™ ì„¸íŒ…
                document.getElementById('chap-end').value = '';
            } catch (e) { alert("ì‹¤íŒ¨: " + e.message); } 
            finally { btn.innerHTML = '<i class="fa-solid fa-stamp"></i> ë‹¨ì› ì •ë³´ ì¼ê´„ ì ìš©'; btn.disabled = false; }
        }

        // ==========================================
        // â˜… NEW: ì‘ì‘ ë‹´ê¸° (Batch Queue Logic) â˜…
        // ==========================================

        async function getNextSectionIdForQueue() {
            // 1. DBì—ì„œ í˜„ì¬ ìµœëŒ€ê°’ ì¡°íšŒ (ìµœëŒ€ 10000ê°œ ë¡œë“œ)
            const { data, error } = await _supabase
                .from('problem_metadata')
                .select('section_id')
                .eq('workbook_id', currentWorkbook.id)
                .not('section_id', 'is', null)
                .order('section_id', { ascending: false })
                .limit(10000); 
            
            let dbMax = 0;
            if (data && data.length > 0) {
                // ê°€ì ¸ì˜¨ ë°ì´í„° ë°°ì—´ ì „ì²´ì—ì„œ ìµœëŒ€ê°’ì„ ë‹¤ì‹œ ì°¾ìŒ
                const maxId = data.reduce((max, item) => item.section_id > max ? item.section_id : max, 0);
                dbMax = maxId;
            } else if (error && error.code !== 'PGRST116') {
                 console.error("DB ì„¹ì…˜ ID ì¡°íšŒ ì˜¤ë¥˜:", error);
            }
            
            // 2. í˜„ì¬ íì— ë‹´ê¸´ 'ì¼ë°˜í˜•' ì¤‘ ê°€ì¥ í° groupIdë¥¼ ì°¾ìŒ (ì—°ì†ì„± ë³´ì¥)
            let maxQueueId = 0;
            batchQueue.forEach(item => {
                if(item.type === 'norm' && item.groupId > maxQueueId) {
                    maxQueueId = item.groupId;
                }
            });

            // 3. ë‘˜ ì¤‘ í° ê°’ + 1
            return Math.max(dbMax, maxQueueId) + 1;
        }

        async function addToQueue() {
            if (!currentWorkbook) return alert("êµì¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            const start = parseInt(document.getElementById('q-start').value);
            const end = parseInt(document.getElementById('q-end').value);
            const type = document.querySelector('input[name="q-type"]:checked').value;

            if (isNaN(start) || isNaN(end) || start <= 0 || start > end) return alert("ë¬¸ì œ ë²”ìœ„ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
            if (end > currentWorkbook.total_problems) return alert("ì´ ë¬¸í•­ ìˆ˜ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.");

            // ì¼ë°˜í˜•ì¼ ê²½ìš° ê·¸ë£¹ ID ìë™ ê³„ì‚° (Smart Increment)
            let groupId = null;
            if (type === 'norm') {
                groupId = await getNextSectionIdForQueue();
            }

            // íì— ì¶”ê°€
            batchQueue.push({
                id: Date.now(), // Unique ID for queue removal
                start,
                end,
                type,
                groupId: groupId // Can be null
            });

            // ì…ë ¥ì°½ ì´ˆê¸°í™” (ë‹¤ìŒ ì…ë ¥ì„ ìœ„í•´)
            document.getElementById('q-start').value = end + 1; // ì„¼ìŠ¤ ìˆê²Œ ë‹¤ìŒ ë²ˆí˜¸ ì„¸íŒ…
            document.getElementById('q-end').value = '';
            // document.querySelector('input[name="q-type"][value="norm"]').checked = true; // (íƒ€ì…ì€ ìœ ì§€)

            renderQueue();
        }

        function removeFromQueue(id) {
            batchQueue = batchQueue.filter(item => item.id !== id);
            renderQueue();
        }

        function updateQueueGroupId(id, val) {
            const item = batchQueue.find(i => i.id === id);
            if (item) item.groupId = parseInt(val);
        }

        function renderQueue() {
            const queueBox = document.getElementById('queue-box');
            const queueList = document.getElementById('queue-list');
            const countEl = document.getElementById('queue-count');

            if (batchQueue.length === 0) {
                queueBox.classList.add('hidden');
                return;
            }

            queueBox.classList.remove('hidden');
            countEl.innerText = `${batchQueue.length}ê±´`;
            queueList.innerHTML = '';

            batchQueue.forEach((item, index) => {
                let typeBadge = '';
                if (item.type === 'norm') typeBadge = '<span class="badge badge-norm">ì¼ë°˜</span>';
                else if (item.type === 'sub') typeBadge = '<span class="badge badge-sub">ì„œìˆ í˜•</span>';
                else typeBadge = '<span class="badge badge-high">1ë“±ê¸‰</span>';

                let groupInfo = '';
                if (item.type === 'norm') {
                    // ëŒ€í‘œ/í„°í”„ ì•ˆë‚´ (ì¹œì ˆí•œ ì„¤ëª… ì¶”ê°€)
                    const isSingle = item.start === item.end;
                    let repToughInfo = '';
                    if (isSingle) {
                        repToughInfo = '<span class="info text-purple-700">ëŒ€í‘œ ë¬¸ì œ (1ë¬¸í•­)</span>';
                    } else {
                        repToughInfo = '<span class="info text-orange-600">ëŒ€í‘œ(ì‹œì‘)/í„°í”„(ë) ìë™ ì„¤ì •</span>';
                    }

                    groupInfo = `
                        <div class="flex items-center gap-1 ml-4">
                            <span class="text-xs font-bold text-slate-500">ê·¸ë£¹ë²ˆí˜¸:</span>
                            <input type="number" class="w-16 p-1 text-center border rounded text-xs font-bold text-purple-700" 
                                value="${item.groupId}" onchange="updateQueueGroupId(${item.id}, this.value)">
                            ${repToughInfo}
                        </div>
                    `;
                } else {
                    groupInfo = '<span class="info ml-4">ê·¸ë£¹í•‘/ëŒ€í‘œ/í„°í”„ ì„¤ì • ì—†ìŒ</span>';
                }

                const div = document.createElement('div');
                div.className = 'queue-item';
                div.innerHTML = `
                    <span class="text-xs font-bold text-slate-400 w-5">#${index + 1}</span>
                    <span class="font-bold text-slate-700">No.${item.start} ~ ${item.end}</span>
                    <span class="text-xs text-slate-400">(${item.end - item.start + 1}ë¬¸)</span>
                    ${typeBadge}
                    ${groupInfo}
                    <button onclick="removeFromQueue(${item.id})" class="ml-auto text-slate-400 hover:text-red-500 px-2">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `;
                queueList.appendChild(div);
            });
        }

        async function saveAllQueue() {
            if (batchQueue.length === 0) return;
            if (!confirm(`ì´ ${batchQueue.length}ê±´ì˜ ì„¤ì •ì„ ì¼ê´„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const btn = document.getElementById('btn-save-all');
            btn.innerHTML = '<div class="loader mr-2"></div> ì €ì¥ ì¤‘...';
            btn.disabled = true;

            try {
                // ìˆœì°¨ ì²˜ë¦¬
                for (const item of batchQueue) {
                    
                    // 1. ì´ˆê¸°í™” (ëŒ€í‘œ/í„°í”„ ë“±) - DBì— ì €ì¥ëœ ëª¨ë“  í”Œë˜ê·¸ ë° GID ì´ˆê¸°í™”
                    await _supabase.from('problem_metadata')
                        .update({ is_representative: false, is_tough: false, section_id: null })
                        .eq('workbook_id', currentWorkbook.id)
                        .gte('problem_num', item.start)
                        .lte('problem_num', item.end);

                    // 2. ì—…ë°ì´íŠ¸ ë°ì´í„° êµ¬ì„±
                    let updates = {};
                    if (item.type === 'high') {
                        updates.difficulty = 'high_rank';
                        updates.is_subjective = false;
                    } else if (item.type === 'sub') {
                        updates.difficulty = 'normal';
                        updates.is_subjective = true;
                    } else { // norm
                        updates.difficulty = 'normal';
                        updates.is_subjective = false;
                        updates.section_id = item.groupId;
                    }

                    // 3. ë©”ì¸ ì—…ë°ì´íŠ¸
                    const { error } = await _supabase.from('problem_metadata')
                        .update(updates)
                        .eq('workbook_id', currentWorkbook.id)
                        .gte('problem_num', item.start)
                        .lte('problem_num', item.end);
                    
                    if (error) throw error;

                    // 4. ì¼ë°˜í˜•ì¼ ê²½ìš° ëŒ€í‘œ/í„°í”„ í”Œë˜ê·¸ ìë™ ì„¤ì • (Start=Rep, End=Tough)
                    if (item.type === 'norm') {
                        // Start -> Rep
                        await _supabase.from('problem_metadata')
                            .update({ is_representative: true })
                            .eq('workbook_id', currentWorkbook.id)
                            .eq('problem_num', item.start);
                        
                        // End -> Tough (If different from start)
                        if (item.start !== item.end) {
                            await _supabase.from('problem_metadata')
                                .update({ is_tough: true })
                                .eq('workbook_id', currentWorkbook.id)
                                .eq('problem_num', item.end);
                        }
                    }
                }

                alert("âœ… ëª¨ë“  ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ");
                batchQueue = []; // í ë¹„ìš°ê¸°
                renderQueue(); // UI ê°±ì‹ 

                // â˜… NEW FIX: ìë™ ë¦¬ì…‹ í›„ ë‹¤ìŒ ì…ë ¥ ë²ˆí˜¸ ì„¸íŒ… â˜…
                const maxEnd = batchQueue.reduce((max, item) => item.end > max ? item.end : max, 0);
                if (maxEnd > 0) {
                     document.getElementById('q-start').value = maxEnd + 1;
                     document.getElementById('q-end').value = '';
                } else {
                     document.getElementById('q-start').value = '';
                     document.getElementById('q-end').value = '';
                }


            } catch (e) {
                alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-check-double"></i> ì „ì²´ ì ìš© ì‹¤í–‰ (Save All)';
                btn.disabled = false;
            }
        }

        // --- Query Modal Logic (Existing) ---
        function openQueryModal() { 
            if (!currentWorkbook) return alert("êµì¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
            document.getElementById('query-modal-overlay').style.display = 'flex';
            document.getElementById('query-results-tbody').innerHTML = '';
            const container = document.getElementById('query-range-container');
            const rows = container.querySelectorAll('.range-row');
            for(let i = 1; i < rows.length; i++) { rows[i].remove(); }
            rows[0].querySelector('.range-start').value = '';
            rows[0].querySelector('.range-end').value = '';
        }
        function closeQueryModal() { document.getElementById('query-modal-overlay').style.display = 'none'; }
        function addQueryRangeInput() { 
             const container = document.getElementById('query-range-container');
            const div = document.createElement('div'); 
            div.className = 'flex gap-1 items-center range-row'; 
            div.innerHTML = `<input type="number" class="range-start w-16 p-1 text-center border rounded" placeholder="Start"><span class="text-slate-400 font-bold text-xs">~</span><input type="number" class="range-end w-16 p-1 text-center border rounded" placeholder="End"><button onclick="removeQueryRange(this)" class="text-slate-400 hover:text-red-500 px-1 text-sm"><i class="fa-solid fa-xmark"></i></button>`; 
            container.insertBefore(div, container.querySelector('button[onclick="addQueryRangeInput()"]'));
        }
        function removeQueryRange(btn) { if (document.querySelectorAll('#query-range-container .range-row').length > 1) { btn.parentElement.remove(); } else { alert("ìµœì†Œ í•˜ë‚˜ì˜ ì¡°íšŒ ë²”ìœ„ëŠ” ìˆì–´ì•¼ í•©ë‹ˆë‹¤."); } }
        async function runBatchQuery() { 
             if (!currentWorkbook) return alert("êµì¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
            const rangeRows = document.querySelectorAll('#query-range-container .range-row');
            let problemNums = new Set();
            rangeRows.forEach(row => { const s = parseInt(row.querySelector('.range-start').value); const e = parseInt(row.querySelector('.range-end').value); if (!isNaN(s) && !isNaN(e) && s <= e) { for (let i = s; i <= e; i++) problemNums.add(i); } });
            if (problemNums.size === 0) return;
            const problemArray = Array.from(problemNums).sort((a, b) => a - b);
            const tbody = document.getElementById('query-results-tbody');
            tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4"><div class="loader mx-auto"></div></td></tr>`;
            try {
                const { data: metaData, error } = await _supabase.from('problem_metadata').select('*').eq('workbook_id', currentWorkbook.id).in('problem_num', problemArray).order('problem_num');
                if (error) throw error;
                tbody.innerHTML = '';
                metaData.forEach(data => {
                    let typeBadge, flagBadge = '';
                    if (data.difficulty === 'high_rank') typeBadge = '<span class="badge badge-high">1ë“±ê¸‰</span>';
                    else if (data.is_subjective) typeBadge = '<span class="badge badge-sub">ì„œìˆ í˜•</span>';
                    else typeBadge = '<span class="badge badge-norm">ì¼ë°˜í˜•</span>';
                    
                    let is_normal = (data.difficulty === 'normal' && !data.is_subjective);
                    if (data.is_representative && is_normal) flagBadge += `<span class="badge badge-rep mr-1">ëŒ€í‘œ ë¬¸ì œ</span>`;
                    if (data.is_tough && is_normal) flagBadge += `<span class="badge badge-tough">í„°í”„ ë¬¸ì œ</span>`;
                    
                    const sectionIdText = data.section_id ? `<span class="font-bold text-indigo-500">${data.section_id}</span>` : 'N/A';
                    const chapterInfoText = (data.chapter_major_title_ko ? data.chapter_major_title_ko + ' > ' : '') + (data.chapter_title_ko || '-');
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-50 transition';
                    row.innerHTML = `<td class="px-3 py-2 text-base font-bold text-slate-800">No.${data.problem_num}</td><td class="px-3 py-2">${sectionIdText}</td><td class="px-3 py-2 flex items-center gap-2">${typeBadge} ${flagBadge}</td><td class="px-3 py-2 text-xs text-slate-600">${chapterInfoText}</td>`;
                    tbody.appendChild(row);
                });
            } catch(e) { console.error(e); }
        }

        // --- Image Upload (Same) ---
        function displayFileCount() { const files = document.getElementById('file-upload').files; document.getElementById('file-count').innerText = `${files.length}ê°œì˜ WebP íŒŒì¼ì´ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.`; }
        async function uploadImages() { /* ... Same ... */ 
            if (!currentWorkbook) return alert("êµì¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
            const files = document.getElementById('file-upload').files;
            if (files.length === 0) return alert("ì—…ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            const btn = document.querySelector('button[onclick="uploadImages()"]');
            btn.innerHTML = '<div class="loader mr-2"></div> ì—…ë¡œë“œ ì¤‘...'; btn.disabled = true;
            try {
                let successCount = 0;
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const problemNum = file.name.split('.')[0].padStart(4, '0'); 
                    const fileName = `${currentWorkbook.id}/${problemNum}.webp`;
                    const { error } = await _supabase.storage.from('problems').upload(fileName, file, { upsert: true });
                    if (!error) successCount++;
                }
                alert(`âœ… ì—…ë¡œë“œ ì™„ë£Œ! ì´ ${files.length}ê°œ ì¤‘ ${successCount}ê°œ ì„±ê³µ.`);
                document.getElementById('file-count').innerText = 'ëŒ€ê¸° í™•ì¸ íŒŒì¼ ì—†ìŒ';
            } catch (e) { alert("ì˜¤ë¥˜: " + e.message); } finally { btn.innerHTML = 'ì—…ë¡œë“œ ì‹œì‘'; btn.disabled = false; }
        }

    </script>
</body>
</html>