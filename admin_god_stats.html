<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <link rel="manifest" href="site.webmanifest">
    
    <link rel="apple-touch-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <title>í•™ìŠµ ì •ë°€ ì§„ë‹¨ (X-Ray)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Base Styles - Admin Dark Theme */
        body { background-color: #1a1a1a; color: #eee; font-family: 'Apple SD Gothic Neo', 'Pretendard', sans-serif; overflow: hidden; height: 100vh; }
        .custom-scroll::-webkit-scrollbar { width: 8px; } .custom-scroll::-webkit-scrollbar-track { background: #222; } .custom-scroll::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

        /* [X-Ray Grid Styles] */
        .xray-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(32px, 1fr)); 
            gap: 4px; 
            padding: 8px; 
            background: rgba(30, 41, 59, 0.5); 
            border-radius: 8px;
            min-height: 48px; 
            border: 1px dashed #475569; 
            margin-bottom: 8px;
        }
        .xray-grid:empty::before { content: 'ë¬¸í•­ ì—†ìŒ'; color: #64748b; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; grid-column: 1 / -1; height: 100%; opacity: 0.5; }
        .tile { aspect-ratio: 1; border-radius: 4px; cursor: pointer; transition: transform 0.1s; position: relative; }
        .tile:hover { transform: scale(1.3); z-index: 20; border: 2px solid white; box-shadow: 0 0 15px rgba(0,0,0,0.6); }
        .tile.selected { border: 3px solid #ec4899; box-shadow: 0 0 10px #ec4899; transform: scale(0.9); z-index: 10; }
        
        /* [Section Header Styles] */
        .section-block { margin-bottom: 32px; border-bottom: 2px solid #475569; padding-bottom: 16px; }
        .subsection-block { margin-top: 16px; margin-bottom: 16px; padding-left: 12px; border-left: 3px solid #334155; }
        .type-block { margin-top: 12px; margin-bottom: 12px; }
        .header-major { 
            background: linear-gradient(90deg, #475569 0%, #1e293b 100%); 
            border-left: 6px solid #fbbf24; 
            padding: 10px 14px; 
            border-radius: 6px; 
            font-size: 16px; 
            font-weight: 900; 
            color: #f8fafc; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4); 
            display: flex; align-items: center; gap: 8px; 
            margin-bottom: 8px;
        }
        .header-minor { 
            background: #334155; 
            padding: 6px 10px; 
            border-radius: 4px; 
            border-left: 4px solid #94a3b8; 
            font-size: 14px; 
            font-weight: 800; 
            color: #e2e8f0; 
            display: flex; align-items: center; gap: 6px; 
            margin-bottom: 4px;
        }
        .header-type { font-size: 12px; font-weight: 800; margin-bottom: 4px; display: inline-block; padding: 3px 8px; border-radius: 4px; }
        .type-norm { color: #60a5fa; background: rgba(30, 58, 138, 0.4); border: 1px solid #1e40af; }
        .type-sub { color: #34d399; background: rgba(6, 78, 59, 0.4); border: 1px solid #065f46; }
        .type-high { color: #c084fc; background: rgba(88, 28, 135, 0.4); border: 1px solid #6b21a8; }

        /* Colors */
        .bg-new { background-color: #334155; border: 1px solid #475569; }
        .bg-perfect { background-color: #10b981; } .bg-correct { background-color: #10b981; }
        .bg-wrong-1 { background-color: #fca5a5; } .bg-wrong-2 { background-color: #ef4444; } .bg-wrong-3 { background-color: #7f1d1d; } 
        .bg-question { background-color: #fbbf24; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        
        /* Tooltip */
        #xray-tooltip { display: none; position: fixed; z-index: 9999; background: rgba(0, 0, 0, 0.95); border: 2px solid #6366f1; border-radius: 12px; padding: 10px; width: 320px; pointer-events: none; box-shadow: 0 0 30px rgba(0,0,0,0.8); }
        .tooltip-img { width: 100%; border-radius: 4px; margin-bottom: 8px; border: 1px solid #334155; background: white; }
        .stat-row-new { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; color: #cbd5e1; border-bottom: 1px solid #334155; padding-bottom: 2px; }

        /* [BASKET FILTER STYLES - IMPORTED] */
        .shop-btn { padding: 6px 12px; border-radius: 8px; font-weight: bold; font-size: 13px; transition: all 0.2s; cursor: pointer; border: 1px solid transparent; background: #334155; color: #cbd5e1; }
        .shop-btn:hover { background: #475569; color: white; transform: translateY(-2px); }
        .shop-btn.in-cart { opacity: 0.3; cursor: not-allowed; transform: none; }
        .basket-item { display: flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; background: #1e293b; border: 1px solid #475569; color: #e2e8f0; animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .basket-item input { width: 36px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; text-align: center; color: white; padding: 2px; }
        .basket-item input:focus { outline: 2px solid #6366f1; border-color: transparent; }
        .tag-high { border-color: #a78bfa; color: #a78bfa; background: #2e1065; }
        .tag-sub { border-color: #34d399; color: #34d399; background: #064e3b; }
        .tag-norm { border-color: #60a5fa; color: #60a5fa; background: #1e3a8a; }
        .tag-cond { border-color: #f472b6; color: #f472b6; background: #831843; }
        .tag-new { border-color: #94a3b8; color: #f1f5f9; background: #475569; }
    </style>
</head>
<body class="h-screen flex flex-col p-4 overflow-hidden">

    <script src="config.js"></script>

    <div id="xray-tooltip">
        <div id="xray-header" class="text-indigo-400 font-bold text-sm mb-2 text-center border-b border-gray-700 pb-1">No. 0000</div>
        <img id="xray-img" class="tooltip-img" src="" alt="Preview" onerror="this.src='https://placehold.co/300x200?text=No+Image'">
        <div class="space-y-1">
            <div class="stat-row-new"><span>ìµœê·¼ ìƒíƒœ</span><span id="x-status" class="font-bold text-white">-</span></div>
            <div class="stat-row-new"><span class="text-slate-500">ë‹¨ì›</span><span id="x-chapter" class="font-bold text-slate-300 text-xs text-right truncate w-32">-</span></div>
            <div class="stat-row-new"><span>ìœ í˜•</span><span id="x-type" class="font-bold text-slate-300">-</span></div>
            <div class="stat-row-new"><span>ëˆ„ì  ì •ë‹µ íšŸìˆ˜</span><span id="x-correct" class="font-bold text-emerald-400">0íšŒ</span></div>
            <div class="stat-row-new"><span>ëˆ„ì  ì˜¤ë‹µ íšŸìˆ˜</span><span id="x-wrong" class="font-bold text-red-400">0íšŒ</span></div>
            <div class="stat-row-new"><span>ëˆ„ì  ì§ˆë¬¸ íšŸìˆ˜</span><span id="x-quest" class="font-bold text-yellow-400">0íšŒ</span></div>
            <div class="stat-row-new"><span>ì •ë‹µë¥ </span><span id="x-acc" class="font-bold text-emerald-400">0%</span></div>
        </div>
    </div>

    <div class="flex flex-col gap-4 mb-4 shrink-0">
        <div class="flex justify-between items-center bg-gray-800 p-4 rounded-lg border border-gray-700 shadow-lg">
            <div class="flex items-center gap-4">
                <div class="text-3xl">ğŸ©º</div>
                <div><h1 class="text-xl font-bold text-indigo-400">í•™ìŠµ ì •ë°€ ì§„ë‹¨ (X-Ray)</h1><p class="text-xs text-gray-400">í•™ìƒë³„ í•™ìŠµ ë°ì´í„°ë¥¼ ì‹œê°ì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.</p></div>
            </div>
            <div class="flex gap-3">
                <select id="s-select" onchange="loadStudentWorkbooks()" class="bg-gray-700 text-white border border-gray-600 p-2 rounded text-xs w-32 outline-none focus:border-indigo-500"><option value="">í•™ìƒ ì„ íƒ</option></select>
                <select id="w-select" onchange="scanBody()" class="bg-gray-700 text-white border border-gray-600 p-2 rounded text-xs w-48 outline-none focus:border-indigo-500" disabled><option value="">ë¬¸ì œì§‘ ì„ íƒ</option></select>
                <button onclick="scanBody()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold px-4 py-2 rounded text-xs shadow-lg transition transform active:scale-95">ğŸ‘ï¸ ì§„ë‹¨ ì‹œì‘</button>
                <button onclick="window.close()" class="bg-gray-700 text-gray-400 px-3 py-2 rounded text-xs hover:bg-gray-600">ë‹«ê¸°</button>
            </div>
        </div>

        <div class="bg-gray-800 p-3 rounded-lg border border-gray-700 shadow-lg">
             <div class="flex flex-wrap gap-2 mb-3 items-center">
                <span class="text-xs font-bold text-slate-500 mr-2 uppercase tracking-wide">Filter Menu</span>
                <div onclick="addToBasket('high', '1ë“±ê¸‰')" id="btn-high" class="shop-btn border-indigo-500/30 text-indigo-200">ğŸ† 1ë“±ê¸‰</div>
                <div onclick="addToBasket('sub', 'ì„œìˆ í˜•')" id="btn-sub" class="shop-btn border-emerald-500/30 text-emerald-200">âœï¸ ì„œìˆ í˜•</div>
                <div onclick="addToBasket('norm', 'ì¼ë°˜')" id="btn-norm" class="shop-btn border-blue-500/30 text-blue-200">ğŸ§© ì¼ë°˜</div>
                <div class="w-px h-6 bg-slate-600 mx-1"></div>
                <div onclick="addToBasket('wrong', 'ì˜¤ë‹µ')" id="btn-wrong" class="shop-btn border-pink-500/30 text-pink-200">ğŸ¤¬ ì˜¤ë‹µíšŸìˆ˜</div>
                <div onclick="addToBasket('quest', 'ì§ˆë¬¸')" id="btn-quest" class="shop-btn border-yellow-500/30 text-yellow-200">ğŸ™‹â€â™‚ï¸ ì§ˆë¬¸íšŸìˆ˜</div>
                <div onclick="addToBasket('acc', 'ì •ë‹µë¥ ')" id="btn-acc" class="shop-btn border-purple-500/30 text-purple-200">ğŸ“‰ ì •ë‹µë¥ </div>
                <div class="w-px h-6 bg-slate-600 mx-1"></div>
                <div onclick="addToBasket('new', 'ì‹ ê·œ')" id="btn-new" class="shop-btn border-slate-400 text-white font-black bg-slate-600 hover:bg-slate-500">âœ¨ ì‹ ê·œ í¬í•¨</div>
            </div>

            <div class="bg-black/20 rounded-lg p-3 min-h-[50px] border border-slate-700/50 flex flex-wrap gap-2 items-center" id="filter-basket">
                <span class="text-xs text-slate-500 select-none italic" id="empty-msg">ì›í•˜ëŠ” ì¡°ê±´ì„ í´ë¦­í•˜ì—¬ ë‹´ìœ¼ì„¸ìš”.</span>
            </div>

            <div class="flex justify-end items-center mt-3 pt-2 border-t border-slate-700">
                <button onclick="resetFilters()" class="text-xs text-gray-500 hover:text-white underline mr-4">ì´ˆê¸°í™”</button>
                <button onclick="applyShopFilters()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-lg font-bold text-sm shadow-lg shadow-indigo-500/20 transition transform active:scale-95 flex items-center gap-2">
                    <i class="fa-solid fa-bolt"></i> í•„í„° ì ìš©
                </button>
            </div>
        </div>
    </div>

    <div class="flex-1 bg-gray-900 rounded-lg border border-gray-800 p-4 overflow-y-auto relative custom-scroll">
        <div class="flex gap-4 mb-4 text-[10px] text-gray-400 justify-center sticky top-0 bg-gray-900/90 py-2 z-20 backdrop-blur-sm">
            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-new rounded-sm"></div>ë¯¸í•™ìŠµ</div>
            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-perfect rounded-sm"></div>ì •ë‹µ</div>
            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-wrong-1 rounded-sm"></div>ì˜¤ë‹µ(1íšŒ)</div>
            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-wrong-2 rounded-sm"></div>ì˜¤ë‹µ(2~3íšŒ)</div>
            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-wrong-3 rounded-sm"></div>ì·¨ì•½(4â†‘)</div>
            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-question rounded-sm animate-pulse"></div>ì§ˆë¬¸ì¤‘</div>
        </div>
        
        <div id="body-grid-container" class="space-y-4 pb-20">
            <div class="col-span-full text-center text-gray-600 py-20">ëŒ€ê¸° ì¤‘...</div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 w-full bg-gray-800 border-t border-gray-700 p-3 flex justify-between items-center z-30 shadow-2xl">
        <div class="text-xs text-gray-400">ì„ íƒëœ ë¬¸í•­: <span id="sel-cnt" class="text-pink-500 font-bold text-lg">0</span>ê°œ <button onclick="clearSel()" class="ml-2 text-[10px] underline hover:text-white">ì´ˆê¸°í™”</button></div>
        <button onclick="makePunishment()" class="bg-pink-600 hover:bg-pink-500 text-white font-bold px-6 py-3 rounded shadow-lg transition transform active:scale-95 flex items-center gap-2"><span>ğŸ“</span> ì„ íƒ ë¬¸í•­ìœ¼ë¡œ ê³¼ì œ ìƒì„±</button>
    </div>

    <script>
        const user = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!user || (user.role !== 'teacher' && user.role !== 'admin')) { alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); window.close(); }

        let currentWbId = null; 
        let currentStudentId = null; 
        let selectedSet = new Set(); 
        let progressMap = {}; 
        let metaMap = {}; 
        let sortedMetaArray = []; 
        // [IMPORTED] activeFilters Map for Basket Logic
        let activeFilters = new Map();

        // -----------------------------------------------------------
        // [BASKET FILTER LOGIC] - Identical to Teacher Assign Center
        // -----------------------------------------------------------
        function addToBasket(type, label) {
            if(activeFilters.has(type)) return; 
            let config = { type: type, label: label, value: 0 };
            if(type === 'wrong') config.value = 1;
            if(type === 'quest') config.value = 1;
            if(type === 'acc') config.value = 80;
            activeFilters.set(type, config);
            document.getElementById(`btn-${type}`).classList.add('in-cart');
            renderBasket();
        }

        function removeFromBasket(type) {
            activeFilters.delete(type);
            document.getElementById(`btn-${type}`).classList.remove('in-cart');
            renderBasket();
        }

        function renderBasket() {
            const container = document.getElementById('filter-basket');
            const emptyMsg = document.getElementById('empty-msg');
            Array.from(container.children).forEach(c => { if(c.id !== 'empty-msg') c.remove(); });
            if(activeFilters.size === 0) { emptyMsg.classList.remove('hidden'); return; }
            emptyMsg.classList.add('hidden');
            activeFilters.forEach((conf, type) => {
                const tag = document.createElement('div');
                let colorClass = 'tag-cond';
                if(type==='high') colorClass = 'tag-high'; if(type==='sub') colorClass = 'tag-sub';
                if(type==='norm') colorClass = 'tag-norm'; if(type==='new') colorClass = 'tag-new';
                tag.className = `basket-item ${colorClass}`;
                let inputHtml = '';
                if(['wrong', 'quest', 'acc'].includes(type)) {
                    const ph = type==='acc' ? '%' : 'íšŒ';
                    inputHtml = `<input type="number" value="${conf.value}" class="ml-1" onchange="updateFilterValue('${type}', this.value)" onclick="event.stopPropagation()"> ${ph}`;
                }
                tag.innerHTML = `<span>${conf.label}</span>${inputHtml}<i class="fa-solid fa-xmark ml-1 cursor-pointer hover:text-white" onclick="removeFromBasket('${type}')"></i>`;
                container.appendChild(tag);
            });
        }

        function updateFilterValue(type, val) { 
            if(activeFilters.has(type)) activeFilters.get(type).value = parseInt(val); 
        }

        function resetFilters() { 
            activeFilters.clear(); 
            document.querySelectorAll('.shop-btn').forEach(b => b.classList.remove('in-cart')); 
            // Default Filters
            addToBasket('high', '1ë“±ê¸‰'); addToBasket('sub', 'ì„œìˆ í˜•'); addToBasket('norm', 'ì¼ë°˜'); addToBasket('new', 'ì‹ ê·œ'); 
            applyShopFilters(); 
        }

        function applyShopFilters() {
            const useHigh = activeFilters.has('high'); 
            const useSub = activeFilters.has('sub'); 
            const useNorm = activeFilters.has('norm'); 
            const useNew = activeFilters.has('new');
            const minWrong = activeFilters.has('wrong') ? activeFilters.get('wrong').value : 0;
            const minQuest = activeFilters.has('quest') ? activeFilters.get('quest').value : 0;
            const maxAcc = activeFilters.has('acc') ? activeFilters.get('acc').value : 100;
            
            document.querySelectorAll('.tile').forEach(tile => { 
                const type = tile.dataset.type; 
                const wrong = parseInt(tile.dataset.wrong); 
                const quest = parseInt(tile.dataset.quest); 
                const acc = parseInt(tile.dataset.acc); 
                const isNew = tile.dataset.status === 'ë¯¸í•™ìŠµ';
                let show = true;

                if (type === 'high' && !useHigh) show = false; 
                if (type === 'sub' && !useSub) show = false; 
                if (type === 'norm' && !useNorm) show = false;
                if (isNew && !useNew) show = false;
                if (minWrong > 0 && wrong < minWrong) show = false; 
                if (minQuest > 0 && quest < minQuest) show = false;
                if (activeFilters.has('acc') && acc > maxAcc) show = false;
                
                // Keep selected tiles visible
                if (selectedSet.has(parseInt(tile.dataset.num))) { 
                    tile.style.opacity = '1'; tile.style.pointerEvents = 'auto'; tile.style.boxShadow = '0 0 10px #ec4899'; return; 
                }

                tile.style.opacity = show ? '1' : '0.05'; 
                tile.style.pointerEvents = show ? 'auto' : 'none';
                tile.style.boxShadow = 'none';
            });
        }

        // -----------------------------------------------------------
        // [DATA LOADING & RENDER LOGIC]
        // -----------------------------------------------------------

        async function init() {
            try {
                const { data } = await _supabase.from('users').select('username, name, grade').eq('role', 'student').order('name');
                const sSel = document.getElementById('s-select');
                if(data) sSel.innerHTML = '<option value="">í•™ìƒ ì„ íƒ</option>' + data.map(s => `<option value="${s.username}">${s.name} (${s.grade})</option>`).join('');
                
                // Initial load: Set default filters
                addToBasket('high', '1ë“±ê¸‰'); addToBasket('sub', 'ì„œìˆ í˜•'); addToBasket('norm', 'ì¼ë°˜');
            } catch(e) { console.error(e); }
            
            const wSel = document.getElementById('w-select');
            const wRes = await _supabase.from('workbooks').select('id, title, total_problems');
            wRes.data.forEach(w => wSel.innerHTML += `<option value="${w.id}" data-total="${w.total_problems}">${w.title}</option>`);
        }
        init();

        async function loadStudentWorkbooks() {
            const sSel = document.getElementById('s-select');
            const sId = sSel.value;
            currentStudentId = sId; 
            currentWbId = null;
            
            const wbSel = document.getElementById('w-select');
            wbSel.innerHTML = '<option value="">ë¬¸ì œì§‘ ì„ íƒ</option>'; wbSel.disabled = true;
            document.getElementById('body-grid-container').innerHTML = '<div class="col-span-full text-center text-gray-600 py-20">í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
            
            if(!sId) return;

            const { data } = await _supabase.from('student_books').select('workbook_id, workbooks(id, title, total_problems)').eq('student_id', sId);
            if(data && data.length) { 
                wbSel.innerHTML = '<option value="">ë¬¸ì œì§‘ ì„ íƒ</option>' + data.map(b => `<option value="${b.workbooks.id}" data-total="${b.workbooks.total_problems}">${b.workbooks.title}</option>`).join(''); 
                wbSel.disabled = false; 
            }
        }

        async function scanBody() {
            const sId = document.getElementById('s-select').value; 
            const wId = document.getElementById('w-select').value;
            if(!sId || !wId) return alert("ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            currentStudentId = sId;
            currentWbId = wId;
            
            const total = parseInt(document.querySelector(`#w-select option[value="${wId}"]`).dataset.total);
            const gridContainer = document.getElementById('body-grid-container');
            gridContainer.innerHTML = '<div class="col-span-full text-center text-indigo-400 py-20">ë°ì´í„° ì¡°íšŒ ì¤‘...</div>';
            
            try {
                const [progRes, metaRes] = await Promise.all([
                    _supabase.from('student_progress').select('*').eq('student_id', sId).eq('workbook_id', wId).limit(10000),
                    _supabase.from('problem_metadata').select('*').eq('workbook_id', wId).order('problem_num', {ascending: true}).limit(10000)
                ]);
                
                progressMap = {}; 
                if(progRes.data) progRes.data.forEach(p => progressMap[p.problem_num] = p);

                let metaDataList = metaRes.data || [];
                metaDataList.sort((a,b) => a.problem_num - b.problem_num); 
                sortedMetaArray = metaDataList; 
                
                let lastMajor = null, lastMajorTitle = null, lastMinor = null, lastMinorTitle = null;
                for(let i=0; i<metaDataList.length; i++) {
                    const curr = metaDataList[i];
                    if (curr.chapter_major) { lastMajor = curr.chapter_major; lastMajorTitle = curr.chapter_major_title_ko; lastMinor = curr.chapter_minor; lastMinorTitle = curr.chapter_title_ko; } 
                    else if (lastMajor) { curr.chapter_major = lastMajor; curr.chapter_major_title_ko = lastMajorTitle; curr.chapter_minor = lastMinor; curr.chapter_title_ko = lastMinorTitle; }
                }
                let firstValidMajor = null, firstValidMajorTitle = null, firstValidMinor = null, firstValidMinorTitle = null;
                for(let i=0; i<metaDataList.length; i++) {
                     if (metaDataList[i].chapter_major) { firstValidMajor = metaDataList[i].chapter_major; firstValidMajorTitle = metaDataList[i].chapter_major_title_ko; firstValidMinor = metaDataList[i].chapter_minor; firstValidMinorTitle = metaDataList[i].chapter_title_ko; break; }
                }
                if (firstValidMajor) {
                    for(let i=0; i<metaDataList.length; i++) {
                        if (!metaDataList[i].chapter_major) { metaDataList[i].chapter_major = firstValidMajor; metaDataList[i].chapter_major_title_ko = firstValidMajorTitle; metaDataList[i].chapter_minor = firstValidMinor; metaDataList[i].chapter_title_ko = firstValidMinorTitle; } 
                        else { break; }
                    }
                }
                metaMap = {}; 
                metaDataList.forEach(m => metaMap[m.problem_num] = m);
                
                renderGridHierarchy(total, metaDataList);
                
            } catch(e) { alert("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜: " + e.message); console.error(e); }
        }

        function renderGridHierarchy(total, metaDataList) {
            const container = document.getElementById('body-grid-container'); 
            container.innerHTML = ''; 
            if (!metaDataList || metaDataList.length === 0) {
                 const simpleGrid = document.createElement('div');
                 simpleGrid.className = 'xray-grid';
                 container.appendChild(simpleGrid);
                 for(let i=1; i<=total; i++) {
                     const tile = createTile(i, null, progressMap[i]);
                     tile.onclick = () => toggleSelect(tile, i);
                     simpleGrid.appendChild(tile);
                 }
                 return;
            }

            const tree = {};
            metaDataList.forEach(m => {
                const maj = m.chapter_major || 999;
                const majTitle = m.chapter_major_title_ko || (maj === 999 ? 'ê¸°íƒ€ (ë‹¨ì› ë¯¸ì„¤ì •)' : `ëŒ€ë‹¨ì› ${maj}`);
                const min = m.chapter_minor || 999;
                const minTitle = m.chapter_title_ko || (min === 999 ? 'ì¤‘ë‹¨ì› ë¯¸ì„¤ì •' : `ì¤‘ë‹¨ì› ${min}`);
                let type = 'norm';
                if(m.difficulty && m.difficulty.toLowerCase().includes('high')) type = 'high'; else if(m.is_subjective) type = 'sub';
                if (!tree[maj]) tree[maj] = { title: majTitle, minors: {} };
                if (!tree[maj].minors[min]) tree[maj].minors[min] = { title: minTitle, types: { 'norm': [], 'sub': [], 'high': [] } };
                tree[maj].minors[min].types[type].push(m);
            });

            const sortedMajors = Object.keys(tree).sort((a,b) => Number(a) - Number(b));
            
            sortedMajors.forEach(majKey => {
                const majorNode = tree[majKey];
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'section-block';
                const majHeader = document.createElement('div');
                majHeader.className = 'header-major';
                majHeader.innerHTML = `<span>${majKey == 999 ? '?' : majKey + '.'}</span> <span>${majorNode.title}</span>`;
                sectionDiv.appendChild(majHeader);

                const sortedMinors = Object.keys(majorNode.minors).sort((a,b) => Number(a) - Number(b));
                
                sortedMinors.forEach(minKey => {
                    const minorNode = majorNode.minors[minKey];
                    const subSectionDiv = document.createElement('div');
                    subSectionDiv.className = 'subsection-block';
                    const minHeader = document.createElement('div');
                    minHeader.className = 'header-minor';
                    const numbering = (majKey != 999 && minKey != 999) ? `${majKey}-${minKey}.` : '';
                    minHeader.innerHTML = `<span>${numbering}</span> <span>${minorNode.title}</span>`;
                    subSectionDiv.appendChild(minHeader);

                    ['norm', 'sub', 'high'].forEach(typeKey => {
                        const problems = minorNode.types[typeKey];
                        const typeBlock = document.createElement('div');
                        typeBlock.className = 'type-block';
                        const typeHeader = document.createElement('div');
                        typeHeader.className = `header-type type-${typeKey}`;
                        let label = 'ğŸ§© ì¼ë°˜ìœ í˜•';
                        if(typeKey === 'sub') label = 'âœï¸ ì„œìˆ í˜•'; if(typeKey === 'high') label = 'ğŸ† 1ë“±ê¸‰';
                        typeHeader.innerHTML = label;
                        typeBlock.appendChild(typeHeader);

                        const grid = document.createElement('div');
                        grid.className = 'xray-grid'; 
                        
                        if (problems.length > 0) {
                            problems.sort((a,b) => a.problem_num - b.problem_num);
                            problems.forEach(m => {
                                const tile = createTile(m.problem_num, m, progressMap[m.problem_num]);
                                tile.onclick = () => toggleSelect(tile, m.problem_num);
                                grid.appendChild(tile);
                            });
                        } 
                        typeBlock.appendChild(grid);
                        subSectionDiv.appendChild(typeBlock);
                    });
                    sectionDiv.appendChild(subSectionDiv);
                });
                container.appendChild(sectionDiv);
            });
            applyShopFilters();
        }

        function createTile(i, m, p) {
            let bgClass = 'bg-new'; let statusText = 'ë¯¸í•™ìŠµ'; let wrongCnt = 0; let qCnt = 0; let cCnt = 0; let acc = 0; 
            if (p) {
                wrongCnt = p.wrong_count || 0; qCnt = p.question_count || 0; cCnt = p.correct_count || 0; 
                const totalTry = cCnt + wrongCnt;
                acc = totalTry > 0 ? Math.round((cCnt / totalTry) * 100) : 0;
                if (p.is_question_active) { bgClass = 'bg-question'; statusText = 'ì§ˆë¬¸ì¤‘'; }
                else if (p.last_result === 'wrong' || wrongCnt > 0) { 
                    if (wrongCnt >= 4) { bgClass = 'bg-wrong-3'; statusText = `ì·¨ì•½(${wrongCnt}íšŒ)`; }
                    else if (wrongCnt >= 2) { bgClass = 'bg-wrong-2'; statusText = `ì˜¤ë‹µ(${wrongCnt}íšŒ)`; }
                    else { bgClass = 'bg-wrong-1'; statusText = 'ì˜¤ë‹µ(1íšŒ)'; }
                } else if (p.last_result === 'correct' || cCnt > 0) { bgClass = 'bg-perfect'; statusText = 'ì •ë‹µ'; }
            }
            const tile = document.createElement('div'); tile.className = `tile ${bgClass}`; tile.dataset.num = i;
            let safeType = 'norm';
            if (m) { if(m.difficulty && m.difficulty.toLowerCase().includes('high')) safeType = 'high'; else if(m.is_subjective) safeType = 'sub'; }
            tile.dataset.type = safeType; tile.dataset.correct = cCnt; tile.dataset.wrong = wrongCnt; tile.dataset.quest = qCnt; tile.dataset.status = statusText; tile.dataset.acc = acc;
            tile.dataset.chapMajor = m?.chapter_major_title_ko || ''; tile.dataset.chapMinor = m?.chapter_title_ko || '';
            tile.onmouseenter = (e) => showXray(e.target, i); tile.onmouseleave = hideXray; return tile;
        }

        // --- ê¸°íƒ€ ê¸°ëŠ¥ ---
        function showXray(el, num) {
            const tip = document.getElementById('xray-tooltip'); const img = document.getElementById('xray-img');
            const padded = num.toString().padStart(4, '0');
            img.src = `${SUPABASE_URL}/storage/v1/object/public/problems/${currentWbId}/${padded}.webp`;
            document.getElementById('xray-header').innerText = `No. ${num}`;
            const statusEl = document.getElementById('x-status'); const status = el.dataset.status;
            statusEl.innerText = status;
            statusEl.className = status === 'ë¯¸í•™ìŠµ' ? 'font-bold text-slate-400' : (status === 'ì •ë‹µ' ? 'font-bold text-emerald-400' : (status === 'ì§ˆë¬¸ì¤‘' ? 'font-bold text-yellow-400 animate-pulse' : 'font-bold text-red-400'));
            
            const chapInfo = el.dataset.chapMajor ? `${el.dataset.chapMajor} > ${el.dataset.chapMinor}` : '-';
            document.getElementById('x-chapter').innerText = chapInfo;
            document.getElementById('x-correct').innerText = el.dataset.correct + 'íšŒ'; 
            document.getElementById('x-wrong').innerText = el.dataset.wrong + 'íšŒ'; 
            document.getElementById('x-quest').innerText = el.dataset.quest + 'íšŒ'; 
            document.getElementById('x-acc').innerText = el.dataset.acc + '%'; 
            
            const typeKey = el.dataset.type;
            document.getElementById('x-type').innerText = typeKey==='high'?'1ë“±ê¸‰':(typeKey==='sub'?'ì„œìˆ í˜•':'ì¼ë°˜');
            
            const rect = el.getBoundingClientRect();
            let left = rect.right + 10; if (left + 320 > window.innerWidth) left = rect.left - 330;
            let top = rect.top - 100; if (top < 10) top = 10; if (top + 400 > window.innerHeight) top = window.innerHeight - 410;
            tip.style.left = left + 'px'; tip.style.top = top + 'px'; tip.style.display = 'block';
        }
        function hideXray() { document.getElementById('xray-tooltip').style.display = 'none'; }
        
        function toggleSelect(el, num) { 
            if (selectedSet.has(num)) { selectedSet.delete(num); el.classList.remove('selected'); el.style.boxShadow = 'none'; } 
            else { selectedSet.add(num); el.classList.add('selected'); el.style.boxShadow = '0 0 10px #ec4899'; } 
            document.getElementById('sel-cnt').innerText = selectedSet.size; 
        }
        function clearSel() { 
            selectedSet.clear(); 
            document.querySelectorAll('.tile.selected').forEach(el => { el.classList.remove('selected'); el.style.boxShadow = 'none'; }); 
            document.getElementById('sel-cnt').innerText = 0; 
        }

        async function makePunishment() {
            if (selectedSet.size === 0) return alert("ë¬¸í•­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            const list = Array.from(selectedSet).sort((a,b)=>a-b);
            const title = prompt("ê³¼ì œëª…ì„ ì…ë ¥í•˜ì„¸ìš”:", `í´ë¦¬ë‹‰ ê³¼ì œ (${new Date().toLocaleDateString()})`);
            if(!title) return;
            const sId = document.getElementById('s-select').value;
            const payload = { student_id: sId, workbook_id: parseInt(currentWbId), title: title, type: 'review', status: 'assigned', problem_list: list, review_list: list, teacher_id: user.username };
            const { data, error } = await _supabase.from('assignments').insert([payload]).select('id');
            if(error) alert("ìƒì„± ì‹¤íŒ¨: "+error.message); 
            else { if(confirm("ê³¼ì œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì¸ì‡„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) window.open(`print_paper.html?id=${data[0].id}`, '_blank'); clearSel(); scanBody(); }
        }
    </script>
</body>
</html>