<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í•™ìŠµ ì •ë°€ ì§„ë‹¨ (X-Ray)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #1a1a1a; color: #eee; font-family: 'Apple SD Gothic Neo', sans-serif; }
        .tile { width: 100%; aspect-ratio: 1; border-radius: 4px; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; position: relative; }
        .tile:hover { transform: scale(1.2); z-index: 10; box-shadow: 0 0 10px white; border: 2px solid white; }
        .tile.selected { border: 2px solid #ec4899; box-shadow: 0 0 10px #ec4899; transform: scale(0.9); }
        .bg-new { background-color: #333; border: 1px solid #444; } .bg-perfect { background-color: #10b981; } .bg-wrong-1 { background-color: #fca5a5; } .bg-wrong-2 { background-color: #ef4444; } .bg-wrong-3 { background-color: #7f1d1d; } .bg-question { background-color: #fbbf24; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        #xray-tooltip { display: none; position: fixed; z-index: 9999; background: rgba(0, 0, 0, 0.95); border: 2px solid #6366f1; border-radius: 12px; padding: 10px; width: 320px; pointer-events: none; box-shadow: 0 0 30px rgba(0,0,0,0.8); }
        #xray-img { width: 100%; border-radius: 4px; margin-bottom: 8px; border: 1px solid #555; }
        .stat-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 2px; color: #ccc; }
        .stat-val { font-weight: bold; color: #fff; } .stat-val.bad { color: #f87171; }
        .custom-scroll::-webkit-scrollbar { width: 8px; } .custom-scroll::-webkit-scrollbar-track { background: #222; } .custom-scroll::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col p-4 overflow-hidden">

    <script src="config.js"></script>

    <div id="xray-tooltip">
        <div id="xray-header" class="text-indigo-400 font-bold text-sm mb-2 text-center border-b border-gray-700 pb-1">No. 0000</div>
        <img id="xray-img" src="" alt="No Image">
        <div class="space-y-1 bg-gray-800 p-2 rounded border border-gray-700">
            <div class="stat-row"><span>ìƒíƒœ</span><span id="x-status" class="stat-val">-</span></div>
            <div class="stat-row"><span>ì˜¤ë‹µ íšŸìˆ˜</span><span id="x-wrong" class="stat-val bad">0íšŒ</span></div>
            <div class="stat-row"><span>ì§ˆë¬¸ íšŸìˆ˜</span><span id="x-q" class="stat-val text-yellow-400">0íšŒ</span></div>
            <div class="stat-row"><span>ì •ë‹µë¥ </span><span id="x-acc" class="stat-val">0%</span></div>
        </div>
    </div>

    <div class="flex flex-col gap-4 mb-4 shrink-0">
        <div class="flex justify-between items-center bg-gray-800 p-4 rounded-lg border border-gray-700 shadow-lg">
            <div class="flex items-center gap-4">
                <div class="text-3xl">ğŸ©º</div>
                <div><h1 class="text-xl font-bold text-indigo-400">í•™ìŠµ ì •ë°€ ì§„ë‹¨ (X-Ray)</h1><p class="text-xs text-gray-400">í•™ìƒë³„ í•™ìŠµ ë°ì´í„°ë¥¼ ì‹œê°ì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.</p></div>
            </div>
            <div class="flex gap-3">
                <select id="s-select" class="bg-gray-700 text-white border border-gray-600 p-2 rounded text-xs w-32 outline-none focus:border-indigo-500"><option value="">í•™ìƒ ì„ íƒ</option></select>
                <select id="w-select" class="bg-gray-700 text-white border border-gray-600 p-2 rounded text-xs w-48 outline-none focus:border-indigo-500"><option value="">ë¬¸ì œì§‘ ì„ íƒ</option></select>
                <button onclick="scanBody()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold px-4 py-2 rounded text-xs shadow-lg transition transform active:scale-95">ğŸ‘ï¸ ì§„ë‹¨ ì‹œì‘</button>
                <button onclick="window.close()" class="bg-gray-700 text-gray-400 px-3 py-2 rounded text-xs hover:bg-gray-600">ë‹«ê¸°</button>
            </div>
        </div>

        <div class="bg-gray-800 p-3 rounded-lg border border-gray-700 flex flex-wrap gap-4 items-center justify-center shadow-lg">
            <div class="flex items-center gap-2 bg-black/30 px-3 py-1 rounded border border-gray-600">
                <span class="text-xs text-gray-400 font-bold">ìœ í˜•:</span>
                <label class="text-xs text-purple-400"><input type="checkbox" id="f-high" checked> 1ë“±ê¸‰</label>
                <label class="text-xs text-green-400"><input type="checkbox" id="f-sub" checked> ì„œìˆ í˜•</label>
                <label class="text-xs text-blue-400"><input type="checkbox" id="f-norm" checked> ì¼ë°˜</label>
            </div>
            <div class="flex items-center gap-2 bg-black/30 px-3 py-1 rounded border border-gray-600">
                <label class="text-xs text-gray-300">ì˜¤ë‹µ <input type="number" id="f-wrong" value="1" class="w-8 bg-gray-700 text-center border border-gray-500 rounded">íšŒâ†‘</label>
                <label class="text-xs text-gray-300">ì •ë‹µë¥  <input type="number" id="f-acc" value="50" class="w-8 bg-gray-700 text-center border border-gray-500 rounded">%â†“</label>
            </div>
            <button onclick="applyXrayFilter()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-1 rounded text-xs font-bold shadow">ğŸ” í•„í„° ì ìš©</button>
            <button onclick="resetXrayFilter()" class="text-xs text-gray-500 hover:text-white underline">ì´ˆê¸°í™”</button>
        </div>
    </div>

    <div class="flex-1 bg-gray-900 rounded-lg border border-gray-800 p-4 overflow-y-auto relative custom-scroll">
        <div class="flex gap-4 mb-4 text-[10px] text-gray-400 justify-center sticky top-0 bg-gray-900/90 py-2 z-20 backdrop-blur-sm">
            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-new"></div>ë¯¸í•™ìŠµ</div>
            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-perfect"></div>ì •ë‹µ</div>
            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-wrong-1"></div>ì˜¤ë‹µ(1íšŒ)</div>
            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-wrong-2"></div>ì˜¤ë‹µ(2~3íšŒ)</div>
            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-wrong-3"></div>ì·¨ì•½(4â†‘)</div>
            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-question"></div>ì§ˆë¬¸ì¤‘</div>
        </div>
        <div id="body-grid" class="grid grid-cols-10 md:grid-cols-20 lg:grid-cols-25 gap-1 content-start pb-20"><div class="col-span-full text-center text-gray-600 py-20">ëŒ€ê¸° ì¤‘...</div></div>
    </div>

    <div class="fixed bottom-0 left-0 w-full bg-gray-800 border-t border-gray-700 p-3 flex justify-between items-center z-30 shadow-2xl">
        <div class="text-xs text-gray-400">ì„ íƒëœ ë¬¸í•­: <span id="sel-cnt" class="text-pink-500 font-bold text-lg">0</span>ê°œ <button onclick="clearSel()" class="ml-2 text-[10px] underline hover:text-white">ì´ˆê¸°í™”</button></div>
        <button onclick="makePunishment()" class="bg-pink-600 hover:bg-pink-500 text-white font-bold px-6 py-3 rounded shadow-lg transition transform active:scale-95 flex items-center gap-2"><span>ğŸ“</span> ì„ íƒ ë¬¸í•­ìœ¼ë¡œ ê³¼ì œ ìƒì„±</button>
    </div>

    <script>
        const user = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!user || (user.username !== 'ê³½ëª…ìš©' && user.role !== 'admin' && user.role !== 'teacher')) { alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); window.close(); }

        async function init() {
            const [uRes, wRes] = await Promise.all([ _supabase.from('users').select('username, name').eq('role', 'student'), _supabase.from('workbooks').select('id, title, total_problems') ]);
            const sSel = document.getElementById('s-select'); const wSel = document.getElementById('w-select');
            uRes.data.forEach(u => sSel.innerHTML += `<option value="${u.username}">${u.name}</option>`);
            wRes.data.forEach(w => wSel.innerHTML += `<option value="${w.id}" data-total="${w.total_problems}">${w.title}</option>`);
        }
        init();

        let currentWbId = null; let selectedSet = new Set(); let metaMap = {};

        async function scanBody() {
            const sId = document.getElementById('s-select').value; const wId = document.getElementById('w-select').value;
            if(!sId || !wId) return alert("ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            currentWbId = wId;
            const total = parseInt(document.querySelector(`#w-select option[value="${wId}"]`).dataset.total);
            const grid = document.getElementById('body-grid');
            grid.innerHTML = '<div class="col-span-full text-center text-indigo-400 py-20">ë°ì´í„° ì¡°íšŒ ì¤‘...</div>';

            const [progRes, metaRes] = await Promise.all([
                _supabase.from('student_progress').select('*').eq('student_id', sId).eq('workbook_id', wId),
                _supabase.from('problem_metadata').select('*').eq('workbook_id', wId)
            ]);

            const pMap = {}; if(progRes.data) progRes.data.forEach(p => pMap[p.problem_num] = p);
            metaMap = {}; if(metaRes.data) metaRes.data.forEach(m => metaMap[m.problem_num] = m);

            grid.innerHTML = '';
            for(let i=1; i<=total; i++) {
                const p = pMap[i]; let bgClass = 'bg-new'; let statusText = 'ë¯¸í•™ìŠµ';
                if (p) {
                    if (p.is_question_active || p.last_result === 'question') { bgClass = 'bg-question'; statusText = 'ì§ˆë¬¸ì¤‘'; }
                    else if (p.wrong_count > 0 || p.last_result === 'wrong') {
                        let w = p.wrong_count || 1;
                        if (w >= 4) { bgClass = 'bg-wrong-3'; statusText = `ì·¨ì•½(${w}íšŒ)`; }
                        else if (w >= 2) { bgClass = 'bg-wrong-2'; statusText = `ì˜¤ë‹µ(${w}íšŒ)`; }
                        else { bgClass = 'bg-wrong-1'; statusText = `ì˜¤ë‹µ(1íšŒ)`; }
                    } else if (p.correct_count > 0) { bgClass = 'bg-perfect'; statusText = 'ì •ë‹µ'; }
                }
                const tile = document.createElement('div');
                tile.className = `tile ${bgClass}`;
                tile.dataset.num = i;
                tile.dataset.status = statusText;
                tile.dataset.wrong = p ? (p.wrong_count||0) : 0;
                tile.dataset.q = p ? (p.question_count||0) : 0;
                tile.dataset.acc = p ? calcAcc(p) : 0;
                
                // ë©”íƒ€ ì •ë³´ ì‹¬ê¸°
                const meta = metaMap[i];
                tile.dataset.type = meta ? (meta.difficulty==='high_rank'?'high':(meta.is_subjective?'sub':'norm')) : 'norm';

                tile.onmouseenter = (e) => showXray(e.target, i);
                tile.onmouseleave = hideXray;
                tile.onclick = () => toggleSelect(tile, i);
                grid.appendChild(tile);
            }
        }

        function calcAcc(p) {
            const t = (p.correct_count||0) + (p.wrong_count||0);
            const safeT = (t===0 && p.last_result) ? 1 : t;
            if(safeT===0) return 0;
            return Math.round(((p.correct_count||0)/safeT)*100);
        }

        // --- í•„í„°ë§ (Dimming) ---
        function applyXrayFilter() {
            const useHigh = document.getElementById('f-high').checked;
            const useSub = document.getElementById('f-sub').checked;
            const useNorm = document.getElementById('f-norm').checked;
            const minWrong = parseInt(document.getElementById('f-wrong').value) || 0;
            const maxAcc = parseInt(document.getElementById('f-acc').value) || 100;

            document.querySelectorAll('.tile').forEach(tile => {
                const type = tile.dataset.type;
                const wrong = parseInt(tile.dataset.wrong);
                const acc = parseInt(tile.dataset.acc);
                let show = true;

                if (type === 'high' && !useHigh) show = false;
                if (type === 'sub' && !useSub) show = false;
                if (type === 'norm' && !useNorm) show = false;
                if (wrong < minWrong) show = false;
                if (acc > maxAcc) show = false;

                if (show) {
                    tile.style.opacity = '1'; tile.style.pointerEvents = 'auto';
                    if(!selectedSet.has(parseInt(tile.dataset.num))) tile.style.boxShadow = '0 0 5px cyan'; 
                } else {
                    tile.style.opacity = '0.1'; tile.style.pointerEvents = 'none'; tile.style.boxShadow = 'none';
                }
            });
        }

        function resetXrayFilter() {
            document.querySelectorAll('.tile').forEach(t => { t.style.opacity = '1'; t.style.pointerEvents = 'auto'; t.style.boxShadow = 'none'; });
        }

        function showXray(el, num) {
            const tip = document.getElementById('xray-tooltip'); const img = document.getElementById('xray-img');
            const padded = num.toString().padStart(4, '0');
            const url1 = `${SUPABASE_URL}/storage/v1/object/public/problems/${currentWbId}/${padded}.webp`;
            const url2 = `${SUPABASE_URL}/storage/v1/object/public/problems/${currentWbId}/${num}.webp`;
            img.src = url1; img.onerror = () => img.src = url2;
            document.getElementById('xray-header').innerText = `No. ${num}`;
            document.getElementById('x-status').innerText = el.dataset.status;
            document.getElementById('x-status').className = 'stat-val ' + (el.className.includes('bg-wrong') ? 'bad' : 'text-white');
            document.getElementById('x-wrong').innerText = el.dataset.wrong + 'íšŒ';
            document.getElementById('x-q').innerText = el.dataset.q + 'íšŒ';
            document.getElementById('x-acc').innerText = el.dataset.acc + '%';
            const rect = el.getBoundingClientRect();
            let left = rect.right + 10; if (left + 320 > window.innerWidth) left = rect.left - 330;
            let top = rect.top - 100; if (top < 10) top = 10; if (top + 400 > window.innerHeight) top = window.innerHeight - 410;
            tip.style.left = left + 'px'; tip.style.top = top + 'px'; tip.style.display = 'block';
        }
        function hideXray() { document.getElementById('xray-tooltip').style.display = 'none'; }
        function toggleSelect(el, num) { if (selectedSet.has(num)) { selectedSet.delete(num); el.classList.remove('selected'); } else { selectedSet.add(num); el.classList.add('selected'); } document.getElementById('sel-cnt').innerText = selectedSet.size; }
        function clearSel() { selectedSet.clear(); document.querySelectorAll('.tile.selected').forEach(el => el.classList.remove('selected')); document.getElementById('sel-cnt').innerText = 0; }
        async function makePunishment() {
            if (selectedSet.size === 0) return alert("ë¬¸í•­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            const list = Array.from(selectedSet).sort((a,b)=>a-b);
            const title = prompt("ê³¼ì œëª…ì„ ì…ë ¥í•˜ì„¸ìš”:", `í´ë¦¬ë‹‰ ê³¼ì œ (${new Date().toLocaleDateString()})`);
            if(!title) return;
            const sId = document.getElementById('s-select').value;
            const payload = { student_id: sId, workbook_id: parseInt(currentWbId), title: title, type: 'review', status: 'assigned', problem_list: list, review_list: list, teacher_id: user.username };
            const { data, error } = await _supabase.from('assignments').insert([payload]).select('id');
            if(error) alert("ìƒì„± ì‹¤íŒ¨: "+error.message); else { if(confirm("ê³¼ì œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì¸ì‡„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) window.open(`print_paper.html?id=${data[0].id}`, '_blank'); clearSel(); }
        }
    </script>
</body>
</html>