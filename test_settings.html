<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Integrated Diagnostic Settings Central</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="config.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; height: 100vh; display: flex; padding: 24px; gap: 24px; overflow: hidden; }
        .glass-panel { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); border-radius: 24px; display: flex; flex-direction: column; overflow: hidden; }
        .pro-input { background: #1e293b; border: 1px solid #334155; color: white; border-radius: 12px; padding: 12px; font-size: 0.9rem; outline: none; width: 100%; transition: all 0.2s; }
        .pro-input:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body>

    <aside class="w-1/4 glass-panel p-6">
        <div class="mb-8">
            <label class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-3 block">Category Focus</label>
            <select id="sel-category" onchange="CentralManager.switchEngine(this.value)" class="pro-input font-bold">
                </select>
        </div>

        <div class="flex-1 flex flex-col min-h-0">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xs font-black text-slate-500 uppercase tracking-widest">Master Repository</h2>
                <div id="engine-badge" class="text-[9px] px-2 py-0.5 rounded-full font-bold hidden"></div>
            </div>
            <div id="list-master" class="flex-1 custom-scroll overflow-y-auto space-y-2 pr-2">
                <div class="text-center py-20 text-xs text-slate-600 italic">Select a category to<br>initialize engine.</div>
            </div>
        </div>
    </aside>

    <main class="flex-1 glass-panel flex flex-col relative border-indigo-500/10">
        <div id="engine-header" class="p-8 border-b border-white/5 bg-white/[0.02]"></div>
        
        <div id="engine-content" class="flex-1 custom-scroll overflow-y-auto p-8">
            <div class="h-full flex flex-col items-center justify-center opacity-10">
                <i class="fa-solid fa-microchip text-7xl mb-4"></i>
                <p class="text-sm font-bold tracking-widest uppercase">Engine Disconnected</p>
            </div>
        </div>
        
        <div id="engine-footer" class="p-6 bg-slate-900/50 border-t border-white/5 flex justify-between items-center"></div>
    </main>

    <script>
        /**
         * @object CentralManager
         * @description HTML 본체에서 엔진을 스위칭하고 전역 상태를 관리함
         */
        const CentralManager = {
            state: { categories: [], activeEngine: null },

            async init() {
                // [1] 카테고리 정보 로드
                const { data } = await _supabase.from('test_category').select('*').order('name');
                if (data) {
                    this.state.categories = data;
                    document.getElementById('sel-category').innerHTML = 
                        '<option value="">카테고리를 선택하세요...</option>' + 
                        data.map(c => `<option value="${c.test_id}">${c.name}</option>`).join('');
                }
            },

            async switchEngine(catId) {
                const cat = this.state.categories.find(c => c.test_id == catId);
                if (!cat) return;

                const badge = document.getElementById('engine-badge');
                badge.classList.remove('hidden', 'bg-emerald-500/20', 'text-emerald-400', 'bg-amber-500/20', 'text-amber-400');
                
                // [2] 엔진 타입 결정 (Internal vs External)
                const isInternal = cat.is_internal;
                const engineName = isInternal ? 'InternalEngine' : 'ExternalEngine';
                const scriptPath = `./test_settings/${isInternal ? 'engine_internal.js' : 'engine_external.js'}`;

                // UI 배지 업데이트
                badge.innerText = isInternal ? 'INTERNAL' : 'EXTERNAL';
                badge.classList.add('block', isInternal ? 'bg-emerald-500/20' : 'bg-amber-500/20', isInternal ? 'text-emerald-400' : 'text-amber-400');

                // [3] 기존 엔진 스크립트 정리 및 신규 엔진 장착
                const oldScript = document.getElementById('engine-runtime');
                if (oldScript) oldScript.remove();

                const script = document.createElement('script');
                script.id = 'engine-runtime';
                script.src = `${scriptPath}?v=${Date.now()}`; // 캐싱 방지
                script.onload = () => {
                    if (window[engineName]) {
                        console.log(`[System] ${engineName} Mounted.`);
                        this.state.activeEngine = window[engineName];
                        this.state.activeEngine.mount(cat);
                    }
                };
                document.head.appendChild(script);
            }
        };

        document.addEventListener('DOMContentLoaded', () => CentralManager.init());
    </script>
</body>
</html>