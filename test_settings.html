<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>진단평가 세부 설정 - 마스터 컨트롤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 메인 테마: 다크 인디고 & 사이버 펑크 스타일 */
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #0f172a; color: #f8fafc; overflow: hidden; height: 100vh; display: flex; padding: 30px; gap: 30px; }
        .glass-panel { background: rgba(30, 41, 59, 0.6); backdrop-blur: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .cat-card { transition: all 0.2s; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); }
        .cat-card:hover { background: rgba(255,255,255,0.05); transform: translateX(5px); }
        .cat-card.selected { background: rgba(99, 102, 241, 0.2); border-color: #6366f1; }

        input { background: rgba(15, 23, 42, 0.8) !important; border: 1px solid #334155 !important; color: white !important; outline: none; }
        input:focus { border-color: #6366f1 !important; }

        .btn-factory { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-factory:hover { background: rgba(99, 102, 241, 0.2); transform: scale(1.05); }
        
        .text-glow { text-shadow: 0 0 10px rgba(99, 102, 241, 0.4); }
    </style>
</head>
<body>
    <script src="config.js"></script>

    <aside class="w-[380px] flex flex-col gap-6 h-full">
        <div class="px-2 flex justify-between items-end">
            <div>
                <h3 class="text-indigo-400 font-black text-[10px] uppercase tracking-[0.3em] mb-1 italic text-glow">Configuration</h3>
                <h2 class="text-2xl font-black text-white tracking-tighter">진단평가 카테고리</h2>
            </div>
            
            <button onclick="window.open('test_molecule_builder.html', 'molecule_factory', 'width=1200,height=850')" 
                    class="btn-factory px-4 py-2 rounded-xl text-[10px] font-black text-indigo-400 border border-indigo-500/30 shadow-lg">
                <i class="fa-solid fa-dna mr-1"></i> 분자 속성 제작소
            </button>
        </div>
        
        <div class="glass-panel flex-1 rounded-[40px] p-8 flex flex-col overflow-hidden shadow-2xl">
            <div id="category-list" class="flex-1 overflow-y-auto custom-scroll space-y-3 pr-2">
                <div class="text-center py-20 text-slate-600 text-xs font-bold italic animate-pulse">카테고리 데이터를 불러오는 중...</div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col gap-6 h-full">
        <div class="px-2">
            <h3 class="text-indigo-400 font-black text-[10px] uppercase tracking-[0.3em] mb-1 italic text-glow">Parameter Settings</h3>
            <h2 id="target-title" class="text-2xl font-black text-white tracking-tighter italic">카테고리를 선택해 주세요</h2>
        </div>

        <div class="glass-panel flex-1 rounded-[48px] p-12 overflow-y-auto custom-scroll shadow-2xl relative border-t border-white/5">
            <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-slate-600">
                <i class="fa-solid fa-sliders text-6xl mb-6 opacity-20"></i>
                <p class="text-sm font-black italic tracking-widest uppercase opacity-40">Select a category to modify settings</p>
            </div>

            <div id="settings-form" class="hidden space-y-10">
                <div class="grid grid-cols-2 gap-8" id="dynamic-properties">
                    </div>

                <div class="pt-10 border-t border-slate-800 flex justify-end">
                    <button onclick="updateSettings()" class="px-16 py-5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-[24px] font-black text-sm tracking-[0.2em] shadow-2xl transition-all transform hover:-translate-y-1">
                        <i class="fa-solid fa-cloud-arrow-up mr-2"></i> 설정 데이터 동기화
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        let selectedCategoryId = null;

        /**
         * @description 페이지 로드 시 카테고리 목록 호출
         */
        async function fetchCategories() {
            const { data, error } = await _supabase.from('test_category').select('*').order('created_at', { ascending: false });
            if (error) return console.error(error);

            const list = document.getElementById('category-list');
            list.innerHTML = data.map(c => `
                <div onclick="selectCategory('${c.id}', '${c.name}')" class="cat-card glass-panel p-5 rounded-2xl">
                    <div class="text-[13px] font-black text-slate-100">${c.name}</div>
                    <div class="text-[9px] text-slate-500 font-bold mt-1 uppercase tracking-tighter italic">UID: ${c.id.substring(0,8)}...</div>
                </div>
            `).join('');
        }

        /**
         * @description 카테고리 선택 시 해당 카테고리에 할당된 분자 속성들을 렌더링
         */
        function selectCategory(id, name) {
            selectedCategoryId = id;
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('settings-form').classList.remove('hidden');
            document.getElementById('target-title').innerText = `${name} 마스터 세부 설정`;

            // 선택 UI 강조
            document.querySelectorAll('.cat-card').forEach(card => card.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            loadDynamicProperties();
        }

        /**
         * @description [핵심] JSONB 보따리(test_setting_template)에서 분자들을 가져와 화면에 그림
         */
        async function loadDynamicProperties() {
            const { data, error } = await _supabase.from('test_setting_template').select('*');
            if (error) return;

            const container = document.getElementById('dynamic-properties');
            
            // 보따리를 풀어서 화면에 렌더링 (JSONB 기반 동적 UI 생성)
            container.innerHTML = data.map(prop => `
                <div class="space-y-4 p-6 rounded-3xl bg-slate-900/40 border border-slate-800">
                    <label class="block text-[11px] font-black text-indigo-400 uppercase tracking-widest italic ml-1">
                        <i class="fa-solid fa-atom mr-1 text-[10px]"></i> ${prop.label}
                    </label>
                    <div class="flex items-center gap-3">
                        <input type="${prop.input_type === 'number' ? 'number' : 'text'}" 
                               id="prop-${prop.label}" 
                               class="flex-1 px-6 py-4 rounded-2xl font-black text-lg shadow-inner"
                               placeholder="${prop.guide_text || ''}">
                    </div>
                    <p class="text-[10px] text-slate-500 font-bold italic ml-1"># ${prop.guide_text}</p>
                </div>
            `).join('');
        }

        /**
         * @description 설정값 DB 저장 (업데이트)
         */
        async function updateSettings() {
            if (!selectedCategoryId) return;
            
            // 실제 서비스에서는 모든 input 값을 수집하여 test_category의 settings JSONB 컬럼에 저장
            alert("✅ 주인님! 카테고리 설정 데이터가 보따리(JSONB)에 안전하게 저장되었습니다!");
        }

        window.onload = fetchCategories;
    </script>
</body>
</html>