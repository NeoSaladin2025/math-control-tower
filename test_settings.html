<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <link rel="manifest" href="site.webmanifest">
    
    <link rel="apple-touch-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <title>진단평가 세부 설정 - 엘리트 컨트롤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 시스템 메인 테마: 다크 인디고 & 사이버네틱 스타일 */
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #0f172a; color: #f8fafc; overflow: hidden; height: 100vh; display: flex; padding: 30px; gap: 30px; }
        .glass-panel { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.05); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        /* 카테고리 카드 스타일 */
        .cat-card { transition: all 0.2s; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); }
        .cat-card:hover { background: rgba(99, 102, 241, 0.1); border-color: rgba(99, 102, 241, 0.3); transform: translateX(5px); }
        .cat-card.active { background: rgba(99, 102, 241, 0.2); border-left: 4px solid #6366f1; border-color: rgba(99, 102, 241, 0.5); }

        /* 입력 폼 애니메이션 */
        .mode-container { display: none; animation: fadeIn 0.3s ease-out; }
        .mode-container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <script src="config.js"></script>

    <div class="w-1/3 flex flex-col glass-panel rounded-[40px] overflow-hidden shadow-2xl">
        <div class="p-8 border-b border-white/5 bg-white/5">
            <h2 class="text-xl font-black flex items-center gap-3">
                <i class="fa-solid fa-list-check text-indigo-400"></i> 대상 카테고리
            </h2>
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Select Category to Configure</p>
        </div>
        <div id="category-list" class="flex-1 overflow-y-auto custom-scroll p-6 space-y-3">
            <div class="text-center py-20 opacity-30 italic text-sm">Loading Categories...</div>
        </div>
    </div>

    <div class="flex-1 glass-panel rounded-[40px] overflow-hidden flex flex-col shadow-2xl relative">
        <div id="lock-overlay" class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center transition-all duration-500">
            <div class="w-20 h-20 rounded-full bg-slate-800 flex items-center justify-center mb-4 border border-white/10 shadow-2xl">
                <i class="fa-solid fa-lock text-3xl text-slate-600"></i>
            </div>
            <p class="text-slate-400 font-bold tracking-tight">좌측에서 설정할 카테고리를 선택하세요.</p>
        </div>

        <div class="p-8 border-b border-white/5 flex justify-between items-center bg-white/5 shrink-0">
            <div>
                <h2 id="selected-cat-name" class="text-2xl font-black tracking-tight text-white">세부 범위 설정</h2>
                <div id="mode-badge" class="mt-1 inline-block"></div>
            </div>
            <button onclick="saveSettings()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-black px-8 py-3 rounded-2xl transition shadow-lg shadow-indigo-500/20 active:scale-95 flex items-center gap-2">
                <i class="fa-solid fa-cloud-arrow-up"></i> 설정값 저장
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scroll p-8 space-y-10">
            <section class="grid grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">Limit Time (Minutes)</label>
                    <input type="number" id="limit-time" class="w-full bg-slate-800/50 border border-slate-700 rounded-2xl p-4 font-black text-indigo-400 outline-none focus:border-indigo-500 transition" placeholder="60">
                </div>
                <div class="space-y-2">
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">Passing Score (%)</label>
                    <input type="number" id="pass-score" class="w-full bg-slate-800/50 border border-slate-700 rounded-2xl p-4 font-black text-emerald-400 outline-none focus:border-emerald-500 transition" placeholder="80">
                </div>
            </section>

            <hr class="border-white/5">

            <section>
                <div id="mode-internal" class="mode-container space-y-6">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fa-solid fa-book-bookmark text-emerald-400"></i>
                        <h3 class="text-lg font-black text-white">시스템 등록 교재 동기화</h3>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">Select Workbook</label>
                        <select id="workbook-select" class="w-full bg-slate-800/80 border border-slate-700 rounded-2xl p-4 font-bold text-slate-200 outline-none focus:border-indigo-500 cursor-pointer">
                            <option value="">교재를 선택하세요</option>
                        </select>
                    </div>
                </div>

                <div id="mode-external" class="mode-container space-y-6">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-diagram-predecessor text-amber-400"></i>
                            <h3 class="text-lg font-black text-white">커스텀 단원 족보 생성</h3>
                        </div>
                        <button onclick="addUnitRow()" class="text-xs font-bold bg-white/5 hover:bg-white/10 text-slate-300 px-4 py-2 rounded-xl border border-white/10 transition">
                            <i class="fa-solid fa-plus mr-1"></i> 단원 추가
                        </button>
                    </div>
                    <div id="unit-list" class="space-y-3"></div>
                </div>
            </section>
        </div>
    </div>

    <script>
        let selectedCategoryId = null;
        let selectedCategoryMode = null;

        init();
        async function init() {
            await fetchCategories();
            await fetchWorkbooks();
        }

        async function fetchCategories() {
            const list = document.getElementById('category-list');
            const { data, error } = await _supabase.from('test_category').select('*').order('created_at', { ascending: false });
            if (error) return;
            list.innerHTML = data.map(cat => `
                <div onclick="selectCategory('${cat.test_id}', '${cat.name}', ${cat.is_internal}, this)" class="cat-card glass-panel p-5 rounded-3xl">
                    <div class="flex justify-between items-start">
                        <span class="text-[9px] font-black px-2 py-0.5 rounded-full ${cat.is_internal ? 'bg-emerald-500/20 text-emerald-400' : 'bg-amber-500/20 text-amber-400'} uppercase">
                            ${cat.is_internal ? 'Internal' : 'External'}
                        </span>
                    </div>
                    <h4 class="font-black text-white mt-2">${cat.name}</h4>
                </div>
            `).join('');
        }

        async function fetchWorkbooks() {
            const sel = document.getElementById('workbook-select');
            const { data } = await _supabase.from('workbooks').select('id, title').order('title');
            if (data) sel.innerHTML = '<option value="">교재를 선택하세요</option>' + data.map(w => `<option value="${w.id}">${w.title}</option>`).join('');
        }

        function selectCategory(id, name, isInternal, el) {
            document.querySelectorAll('.cat-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');

            selectedCategoryId = id;
            selectedCategoryMode = isInternal ? 'internal' : 'external';

            document.getElementById('selected-cat-name').innerText = name;
            document.getElementById('mode-badge').innerHTML = `<span class="text-[10px] font-black px-3 py-1 rounded-full ${isInternal ? 'bg-emerald-500 text-white' : 'bg-amber-500 text-white'} uppercase tracking-widest">${isInternal ? 'Internal Mode' : 'External Mode'}</span>`;

            // 잠금 해제 로직
            const overlay = document.getElementById('lock-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.style.display = 'none'; }, 500);

            document.querySelectorAll('.mode-container').forEach(m => m.classList.remove('active'));
            document.getElementById(`mode-${selectedCategoryMode}`).classList.add('active');

            loadCategorySettings(id);
        }

        function addUnitRow(code = '', title = '') {
            const container = document.getElementById('unit-list');
            const div = document.createElement('div');
            div.className = 'flex gap-3 animate-[fadeIn_0.2s]';
            div.innerHTML = `
                <input type="text" class="unit-code w-24 bg-slate-900 border border-slate-700 rounded-xl p-3 text-center font-black text-amber-400 outline-none focus:border-amber-500" placeholder="111" value="${code}" maxlength="3">
                <input type="text" class="unit-title flex-1 bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm font-bold text-slate-300 outline-none focus:border-indigo-500" placeholder="단원명을 입력하세요" value="${title}">
                <button onclick="this.parentElement.remove()" class="text-slate-600 hover:text-red-500 transition px-2"><i class="fa-solid fa-xmark"></i></button>
            `;
            container.appendChild(div);
        }

        async function loadCategorySettings(testId) {
            // 필드 초기화
            document.getElementById('limit-time').value = '';
            document.getElementById('pass-score').value = '';
            document.getElementById('unit-list').innerHTML = '';
            document.getElementById('workbook-select').value = '';

            const { data, error } = await _supabase.from('test_master').select('*').eq('test_id', testId).maybeSingle();
            if (data) {
                document.getElementById('limit-time').value = data.limit_time;
                document.getElementById('pass-score').value = data.pass_score;
                if (selectedCategoryMode === 'internal') {
                    document.getElementById('workbook-select').value = data.range_data.workbook_id || '';
                } else if (data.range_data.units) {
                    data.range_data.units.forEach(u => addUnitRow(u.code, u.title));
                }
            }
        }

        async function saveSettings() {
            if (!selectedCategoryId) return;

            const time = parseInt(document.getElementById('limit-time').value) || 60;
            const pass = parseInt(document.getElementById('pass-score').value) || 80;
            let rangeData = {};

            if (selectedCategoryMode === 'internal') {
                const wbId = document.getElementById('workbook-select').value;
                if (!wbId) return alert("연동할 교재를 선택해주세요.");
                rangeData = { workbook_id: wbId };
            } else {
                const rows = document.querySelectorAll('#unit-list > div');
                const units = Array.from(rows).map(row => ({
                    code: row.querySelector('.unit-code').value,
                    title: row.querySelector('.unit-title').value
                })).filter(u => u.code && u.title);
                if (units.length === 0) return alert("최소 하나 이상의 단원을 등록해주세요.");
                rangeData = { units: units };
            }

            // DB Upsert
            const { error } = await _supabase.from('test_master').upsert({
                test_id: selectedCategoryId,
                limit_time: time,
                pass_score: pass,
                range_data: rangeData
            }, { onConflict: 'test_id' });

            if (error) alert("저장 실패: " + error.message);
            else alert("✅ 설정값이 카테고리에 성공적으로 저장되었습니다.");
        }
    </script>
</body>
</html>