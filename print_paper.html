<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì˜¤ë‹µ í´ë¦¬ë‹‰ ì¸ì‡„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap');
        body { font-family: 'Noto Serif KR', serif; background: #525659; margin: 0; padding: 0; }
        .page { background: white; width: 210mm; min-height: 297mm; padding: 15mm; margin: 10mm auto; box-shadow: 0 0 10px rgba(0,0,0,0.5); box-sizing: border-box; position: relative; }
        .problem-grid { display: grid; grid-template-columns: 1fr 1fr; grid-auto-rows: 110mm; gap: 10mm; }
        .problem-card { border: 0; display: flex; flex-col; overflow: hidden; }
        .prob-img { width: 100%; height: 100%; object-fit: contain; object-position: top center; }
        .controller { position: fixed; top: 20px; right: 20px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; display: flex; gap: 10px; }
        @media print { body { background: white; margin: 0; } .page { margin: 0; box-shadow: none; width: 100%; padding: 10mm; page-break-after: always; } .controller { display: none !important; } .problem-grid { page-break-inside: avoid; } }
    </style>
</head>
<body>
    <div class="controller">
        <button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button>
        <button onclick="window.close()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded font-bold hover:bg-gray-300">ë‹«ê¸°</button>
    </div>
    <div id="paper-container"></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const assignmentId = urlParams.get('id');
        if (!assignmentId) { alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤."); window.close(); }

        async function loadPaper() {
            const container = document.getElementById('paper-container');
            container.innerHTML = '<div class="text-white text-center mt-20">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            const { data: assign } = await _supabase
                .from('assignments')
                .select('*, users!student_id(name), workbooks(title)')
                .eq('id', assignmentId)
                .single();

            if (!assign) return alert("ìˆ™ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            const printList = assign.review_list || [];
            if (printList.length === 0) {
                container.innerHTML = `<div class="flex items-center justify-center h-screen"><div class="bg-white p-10 rounded-xl text-center"><h2 class="text-2xl font-bold text-gray-700 mb-2">ë³µìŠµí•  ë¬¸ì œê°€ ì—†ì–´ìš”! ğŸ‰</h2><p class="text-gray-500">ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</p></div></div>`;
                return;
            }

            container.innerHTML = '';
            const problemsPerPage = 4;
            
            for (let i = 0; i < printList.length; i += problemsPerPage) {
                const chunk = printList.slice(i, i + problemsPerPage);
                const page = document.createElement('div');
                page.className = 'page';
                
                const header = `
                    <div class="flex justify-between border-b-2 border-black pb-2 mb-6">
                        <div class="text-lg font-bold">ğŸ“š ${assign.workbooks?.title} [ì˜¤ë‹µ í´ë¦¬ë‹‰]</div>
                        <div class="text-lg font-bold">ì´ë¦„: ${assign.users?.name}</div>
                    </div>`;
                
                let gridHtml = '<div class="problem-grid">';
                
                chunk.forEach(pNum => {
                    // â˜… 1. ìŠ¤í† ë¦¬ì§€ ê²½ë¡œ ìƒì„± (ë¬¸ì œì§‘ID í´ë” ì•ˆ)
                    const basePath = `${SUPABASE_URL}/storage/v1/object/public/problems/${assign.workbook_id}/`;
                    
                    // â˜… 2. íŒŒì¼ëª… ì¡°í•© (íŒ¨ë”©ëœ ê²ƒ vs ì•ˆ ëœ ê²ƒ)
                    // ì£¼ì¸ë‹˜ ìŠ¤í† ë¦¬ì§€ì—” '0001.webp' (4ìë¦¬ íŒ¨ë”©)ìœ¼ë¡œ ë˜ì–´ ìˆìŒ!
                    const paddedNum = pNum.toString().padStart(4, '0'); // 1 -> "0001"
                    
                    const imgUrlPadded = `${basePath}${paddedNum}.webp`; // 0001.webp (ì´ê²Œ ì •ë‹µ!)
                    const imgUrlNormal = `${basePath}${pNum}.webp`;      // 1.webp (í˜¹ì‹œ ëª°ë¼ ëŒ€ë¹„ìš©)
                    
                    // â˜… 3. ì´ë¯¸ì§€ íƒœê·¸ ìƒì„± (onerror ì²´ì¸)
                    // ë¨¼ì € "0001.webp"ë¥¼ ì‹œë„í•˜ê³ , ì—†ìœ¼ë©´ "1.webp"ë¥¼ ì‹œë„í•˜ê³ , ê·¸ë˜ë„ ì—†ìœ¼ë©´ ì—‘ë°• ì²˜ë¦¬
                    gridHtml += `
                        <div class="problem-card">
                            <div class="text-xs font-bold text-gray-500 mb-1">No. ${pNum}</div>
                            <img src="${imgUrlPadded}" class="prob-img" 
                                onerror="this.onerror=null; this.src='${imgUrlNormal}';"> 
                        </div>`;
                        // ì„¤ëª…: srcì— ë¨¼ì € 0001.webpë¥¼ ë„£ê³ , ì—ëŸ¬ë‚˜ë©´ 1.webpë¡œ ë°”ê¿ˆ.
                });
                gridHtml += '</div>';

                const footer = `<div class="absolute bottom-5 left-0 w-full text-center text-xs text-gray-400">Math Clinic System - Page ${Math.floor(i/4) + 1}</div>`;
                page.innerHTML = header + gridHtml + footer;
                container.appendChild(page);
            }
        }
        loadPaper();
    </script>
</body>
</html>