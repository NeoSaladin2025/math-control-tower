<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <link rel="manifest" href="site.webmanifest">
    
    <link rel="apple-touch-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Academy Connect</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Pretendard', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' },
                        accent: { 500: '#ec4899', 600: '#db2777' }
                    },
                    boxShadow: { 'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.15)' }
                }
            }
        }
    </script>

    <style>
        body { background: #f3f4f6; overflow: hidden; touch-action: pan-y; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 99px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .tab-btn { @apply flex-1 py-3 text-center text-sm font-bold rounded-2xl cursor-pointer text-slate-400 border border-slate-100 bg-white transition-all duration-200 shadow-sm; white-space: nowrap; }
        .tab-btn:hover { @apply text-brand-500 border-brand-200 shadow-md; }
        .tab-btn.active-indigo { @apply bg-indigo-50 text-indigo-600 border-indigo-200 ring-1 ring-indigo-200 shadow-inner scale-[1.02]; }
        .tab-btn.active-pink { @apply bg-pink-50 text-pink-500 border-pink-200 ring-1 ring-pink-200 shadow-inner scale-[1.02]; }
        .tab-btn.active-teal { @apply bg-emerald-50 text-emerald-600 border-emerald-200 ring-1 ring-emerald-200 shadow-inner scale-[1.02]; }
        
        #lightbox { backdrop-filter: blur(10px); }
        .heart-pop { animation: pop 0.3s; }
        @keyframes pop { 50% { transform: scale(1.3); } }
    </style>
</head>
<body class="h-screen w-screen flex flex-col p-4 md:p-6 bg-slate-100 text-slate-800">

    <script src="config.js"></script>

    <div id="lightbox" class="hidden fixed inset-0 z-[9999] bg-black/90 flex flex-col items-center justify-center fade-in">
        <button onclick="closeZoom()" class="absolute top-6 right-6 text-white text-3xl z-50 p-4"><i class="fa-solid fa-xmark"></i></button>
        <div class="w-full h-full flex items-center justify-center overflow-hidden p-2">
            <img id="zoom-img" class="max-w-full max-h-full object-contain transition-transform duration-200" src="" alt="Full View">
        </div>
        <div class="absolute bottom-10 bg-black/50 text-white text-xs px-4 py-2 rounded-full pointer-events-none">
            <i class="fa-solid fa-arrows-up-down-left-right mr-1"></i> íœ ë¡œ í™•ëŒ€ / ë“œë˜ê·¸ë¡œ ì´ë™
        </div>
    </div>

    <header class="flex justify-between items-center mb-6 shrink-0 px-2">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-brand-600 to-accent-500 flex items-center justify-center text-white shadow-neon">
                <i class="fa-brands fa-instagram text-2xl"></i>
            </div>
            <h1 class="text-2xl font-black tracking-tight text-slate-800">
                Academy<span class="text-brand-600">Connect</span>
            </h1>
        </div>
        <button onclick="window.close()" class="bg-white border border-slate-200 text-slate-500 px-5 py-2.5 rounded-full text-sm hover:bg-slate-50 font-bold shadow-sm flex items-center gap-2">
            <i class="fa-solid fa-arrow-left"></i> ë©”ì¸ìœ¼ë¡œ
        </button>
    </header>

    <main class="flex-1 flex gap-6 overflow-hidden fade-in" style="animation-delay: 0.1s;">
        <aside class="w-[360px] shrink-0 bg-white rounded-[32px] shadow-glass flex flex-col overflow-hidden border border-white">
            <div class="p-5 border-b border-slate-100 bg-white/50 backdrop-blur-sm z-10">
                <div class="flex w-full gap-4 justify-between"> 
                    <div onclick="switchTab('list')" id="tab-list" class="tab-btn active-indigo"><i class="fa-solid fa-users mr-1"></i> ì¹œêµ¬</div>
                    <div onclick="switchTab('req')" id="tab-req" class="tab-btn"><i class="fa-solid fa-heart mr-1"></i> ìš”ì²­ <span id="badge-req" class="hidden bg-accent-500 w-2 h-2 rounded-full inline-block align-top ml-1 animate-ping"></span></div>
                    <div onclick="switchTab('search')" id="tab-search" class="tab-btn"><i class="fa-solid fa-magnifying-glass mr-1"></i> ì°¾ê¸°</div>
                </div>
            </div>
            <div class="flex-1 relative overflow-hidden bg-slate-50/30">
                <div id="view-list" class="absolute inset-0 p-4 overflow-y-auto custom-scroll space-y-3"></div>
                <div id="view-req" class="absolute inset-0 p-4 overflow-y-auto custom-scroll space-y-3 hidden"></div>
                <div id="view-search" class="absolute inset-0 p-5 flex-col hidden bg-white">
                    <div class="relative mb-6">
                        <input type="text" id="search-input" class="w-full bg-slate-100 border-none rounded-2xl pl-12 pr-14 py-4 text-sm font-bold focus:ring-2 focus:ring-brand-500 placeholder-slate-400" placeholder="ì¹œêµ¬ ì´ë¦„..." onkeyup="if(event.key==='Enter') doSearch()">
                        <i class="fa-solid fa-search absolute left-5 top-4.5 text-slate-400"></i>
                        <button onclick="doSearch()" class="absolute right-2 top-2 bottom-2 bg-brand-600 text-white w-10 rounded-xl hover:bg-brand-700 shadow-lg"><i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                    <div id="search-res" class="flex-1 overflow-y-auto custom-scroll pr-1 space-y-2"></div>
                </div>
            </div>
        </aside>

        <section class="flex-1 bg-white rounded-[32px] shadow-glass border border-white flex flex-col overflow-hidden relative">
            <div class="h-20 border-b border-slate-100 flex justify-between items-center px-8 bg-white/80 backdrop-blur-md z-20 absolute top-0 w-full">
                <div class="flex items-center gap-3">
                    <div id="feed-avatar" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold border border-slate-200 transition-all duration-300"><i class="fa-solid fa-user"></i></div>
                    <div><h2 id="feed-title" class="text-lg font-black text-slate-800">ë‚˜ì˜ í”¼ë“œ</h2><span id="feed-subtitle" class="text-xs text-slate-400 font-bold">My Daily Stories</span></div>
                </div>
                <button id="btn-go-home" onclick="goHome()" class="hidden bg-slate-100 text-slate-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-slate-200 transition gap-2 flex"><i class="fa-solid fa-rotate-left"></i> ë‚´ í”¼ë“œë¡œ</button>
            </div>

            <div id="feed-list" class="flex-1 overflow-y-auto p-0 bg-slate-50 custom-scroll pt-20 pb-28"></div>

            <div id="write-area" class="absolute bottom-0 left-0 w-full p-5 bg-gradient-to-t from-white via-white to-transparent z-30">
                <div id="preview-box" class="hidden absolute bottom-24 left-8 w-32 h-32 bg-white p-1.5 rounded-2xl shadow-xl border border-slate-100 animate-[bounce_0.5s_ease-out]">
                    <img id="img-preview" class="w-full h-full object-cover rounded-xl bg-slate-100">
                    <button onclick="removeImg()" class="absolute -top-2 -right-2 bg-slate-800 text-white w-6 h-6 flex items-center justify-center text-xs rounded-full hover:bg-red-500 shadow-md transition border-2 border-white"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="bg-white p-2 rounded-[24px] shadow-[0_8px_30px_rgba(0,0,0,0.08)] border border-slate-100 flex items-center gap-3">
                    <label class="w-12 h-12 bg-slate-50 hover:bg-brand-50 rounded-full flex items-center justify-center text-slate-400 hover:text-brand-600 cursor-pointer transition-all duration-300 shrink-0">
                        <i class="fa-solid fa-camera text-xl"></i>
                        <input type="file" id="file-input" class="hidden" accept="image/*" onchange="previewImg()">
                    </label>
                    <input type="text" id="post-input" class="flex-1 bg-transparent border-none text-sm font-medium placeholder-slate-400 focus:ring-0 px-2" placeholder="ì˜¤ëŠ˜ ê³µë¶€í•œ ë‚´ìš©ì„ ìë‘í•´ë³´ì„¸ìš”!">
                    <button onclick="writePost()" id="btn-post" class="w-12 h-12 bg-brand-600 hover:bg-brand-700 text-white rounded-full flex items-center justify-center shadow-lg shadow-brand-500/30 transition-transform active:scale-90 shrink-0"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </section>
    </main>

    <script>
        const user = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!user) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); window.close(); }
        
        let currentTarget = null; 
        let currentFeedName = "ë‚˜"; 
        let selectedFile = null;
        let zoomInstance = null;

        async function init() { loadFriends(); checkRequests(); goHome(); }

        function openZoom(url) {
            const modal = document.getElementById('lightbox');
            const img = document.getElementById('zoom-img');
            img.src = url; modal.classList.remove('hidden');
            if (zoomInstance) zoomInstance.dispose();
            zoomInstance = Panzoom(img, { maxScale: 5, minScale: 0.5, contain: false });
            img.parentElement.addEventListener('wheel', zoomInstance.zoomWithWheel);
        }
        function closeZoom() { document.getElementById('lightbox').classList.add('hidden'); if(zoomInstance) zoomInstance.reset(); }

        function switchTab(t) {
            ['list','req','search'].forEach(x => { 
                document.getElementById(`view-${x}`).classList.add('hidden'); 
                document.getElementById(`tab-${x}`).classList.remove('active-indigo', 'active-pink', 'active-teal');
            });
            document.getElementById(`view-${t}`).classList.remove('hidden');
            if(t==='search') document.getElementById(`view-${t}`).classList.add('flex');
            
            const btn = document.getElementById(`tab-${t}`);
            if(t==='list') btn.classList.add('active-indigo');
            else if(t==='req') btn.classList.add('active-pink');
            else btn.classList.add('active-teal');

            if(t==='list') loadFriends(); if(t==='req') loadRequests();
        }

        async function loadFriends() {
            const div = document.getElementById('view-list'); div.innerHTML = `<div class="flex justify-center py-10"><i class="fa-solid fa-circle-notch fa-spin text-brand-300"></i></div>`;
            const { data } = await _supabase.from('friends').select('*').or(`requester.eq.${user.username},receiver.eq.${user.username}`).eq('status', 'accepted');
            if(!data || !data.length) { div.innerHTML = `<div class="text-center text-slate-400 text-xs py-10">ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.<br>'ì°¾ê¸°' íƒ­ì„ ì´ìš©í•´ë³´ì„¸ìš”!</div>`; return; }
            const ids = data.map(f => f.requester===user.username ? f.receiver : f.requester);
            const { data: us } = await _supabase.from('users').select('username,name,grade').in('username', ids).order('name');
            div.innerHTML = us.map(u => `<div onclick="visit('${u.username}', '${u.name}')" class="flex items-center gap-4 p-4 bg-white rounded-2xl hover:shadow-md border border-transparent hover:border-brand-100 transition-all cursor-pointer group"><div class="w-12 h-12 rounded-full bg-brand-50 text-brand-600 flex items-center justify-center font-bold text-lg group-hover:bg-brand-600 group-hover:text-white transition-colors duration-300">${u.name[0]}</div><div class="flex-1"><div class="text-sm font-bold text-slate-800 group-hover:text-brand-600">${u.name}</div><div class="text-xs text-slate-400">${u.grade}</div></div><i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-brand-500 text-xs transition-transform group-hover:translate-x-1"></i></div>`).join('');
        }

        function visit(id, name) { currentTarget = id; currentFeedName = name; updateHeader(true); loadFeed(); }
        function goHome() { currentTarget = null; currentFeedName = "ë‚˜"; updateHeader(false); loadFeed(); }
        function updateHeader(isVisit) {
            const title = document.getElementById('feed-title'); const sub = document.getElementById('feed-subtitle'); const avatar = document.getElementById('feed-avatar'); const btn = document.getElementById('btn-go-home'); const write = document.getElementById('write-area');
            if (isVisit) { title.innerText = `${currentFeedName} ë‹˜ì˜ í”¼ë“œ`; title.classList.add('text-brand-600'); sub.innerText = "Visiting..."; avatar.className = "w-10 h-10 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center font-bold shadow-inner"; avatar.innerHTML = currentFeedName[0]; btn.classList.remove('hidden'); write.classList.add('hidden');
            } else { title.innerText = "ë‚˜ì˜ í”¼ë“œ"; title.classList.remove('text-brand-600'); sub.innerText = "My Daily Stories"; avatar.className = "w-10 h-10 rounded-full bg-slate-800 text-white flex items-center justify-center font-bold shadow-lg"; avatar.innerHTML = '<i class="fa-solid fa-house"></i>'; btn.classList.add('hidden'); write.classList.remove('hidden'); }
        }

        async function loadFeed() {
            const div = document.getElementById('feed-list'); const target = currentTarget || user.username;
            
            // â˜… ëª¨ë“  ë°ì´í„° ë³‘ë ¬ ë¡œë“œ â˜…
            const [postRes, comRes, likeRes, comLikeRes] = await Promise.all([
                _supabase.from('guestbook').select('*').eq('receiver_id', target).order('created_at', {ascending:false}),
                _supabase.from('guestbook_comments').select('*').order('created_at', {ascending:true}),
                _supabase.from('guestbook_likes').select('*'),
                _supabase.from('guestbook_comment_likes').select('*')
            ]);

            const posts = postRes.data; 
            if(!posts || !posts.length) { div.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-300 gap-3 opacity-60"><i class="fa-regular fa-image text-5xl"></i><span class="text-sm font-bold">ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</span></div>`; return; }

            // ë§¤í•‘
            const comMap = {};
            if(comRes.data) comRes.data.forEach(c => {
                if(!comMap[c.post_id]) comMap[c.post_id] = {roots:[], replies:{}};
                if(c.parent_id) { if(!comMap[c.post_id].replies[c.parent_id]) comMap[c.post_id].replies[c.parent_id]=[]; comMap[c.post_id].replies[c.parent_id].push(c); } else comMap[c.post_id].roots.push(c);
            });

            const likeMap = {};
            if(likeRes.data) likeRes.data.forEach(l => { if(!likeMap[l.post_id]) likeMap[l.post_id] = []; likeMap[l.post_id].push(l.user_id); });

            const comLikeMap = {};
            if(comLikeRes.data) comLikeRes.data.forEach(l => { if(!comLikeMap[l.comment_id]) comLikeMap[l.comment_id] = []; comLikeMap[l.comment_id].push(l.user_id); });

            div.innerHTML = posts.map(p => {
                const postComs = comMap[p.id] || { roots: [], replies: {} };
                const commentsHtml = postComs.roots.map(root => {
                    const likers = comLikeMap[root.id] || [];
                    const isLiked = likers.includes(user.username);
                    const likeIcon = isLiked ? '<i class="fa-solid fa-heart text-red-500 heart-pop"></i>' : '<i class="fa-regular fa-heart"></i>';
                    const likeCnt = likers.length > 0 ? `<span class="ml-1 text-[10px] text-slate-400">${likers.length}</span>` : '';

                    const replyHtml = (postComs.replies[root.id] || []).map(rep => {
                        const rLikers = comLikeMap[rep.id] || [];
                        const rIsLiked = rLikers.includes(user.username);
                        const rIcon = rIsLiked ? '<i class="fa-solid fa-heart text-red-500 heart-pop"></i>' : '<i class="fa-regular fa-heart"></i>';
                        const rCnt = rLikers.length > 0 ? `<span class="ml-1 text-[10px] text-slate-400">${rLikers.length}</span>` : '';
                        
                        return `<div class="flex gap-2 text-xs py-1 pl-4 border-l-2 border-slate-200 ml-1 mt-1 bg-slate-50/50 rounded-r items-center group"><span class="font-bold ${rep.writer_id==='ì„ ìƒë‹˜'?'text-indigo-600':'text-slate-600'}">â†³ ${rep.writer_id}</span><span class="text-slate-600 break-all flex-1">${rep.content}</span><div class="flex items-center gap-1"><button onclick="toggleCommentLike(${rep.id}, ${rIsLiked})" class="text-xs text-slate-400 hover:text-red-500 transition">${rIcon}</button>${rCnt}<span class="text-[10px] text-slate-400 whitespace-nowrap">${getTimeAgo(new Date(rep.created_at))}</span></div></div>`;
                    }).join('');

                    return `<div class="mb-2"><div class="flex justify-between items-center group"><div class="flex gap-2 text-xs py-1.5 items-center flex-1"><span class="font-bold ${root.writer_id==='ì„ ìƒë‹˜'?'text-indigo-600':'text-slate-800'}">${root.writer_id}</span><span class="text-slate-600 break-all">${root.content}</span></div><div class="flex items-center gap-2"><button onclick="toggleCommentLike(${root.id}, ${isLiked})" class="text-xs text-slate-400 hover:text-red-500 transition flex items-center">${likeIcon} ${likeCnt}</button><span class="text-[10px] text-slate-400 whitespace-nowrap">${getTimeAgo(new Date(root.created_at))}</span><button onclick="toggleReplyBox(${root.id})" class="text-[10px] text-slate-300 hover:text-brand-500 opacity-0 group-hover:opacity-100 transition whitespace-nowrap">ë‹µê¸€</button></div></div>${replyHtml}<div id="reply-box-${root.id}" class="hidden mt-1 pl-4 flex gap-1"><input type="text" id="reply-input-${root.id}" class="w-full bg-slate-100 border-0 rounded px-2 py-1 text-[10px]" placeholder="ë‹µê¸€ ì…ë ¥..." onkeyup="if(event.key==='Enter') addComment(${p.id}, ${root.id})"><button onclick="addComment(${p.id}, ${root.id})" class="bg-brand-100 text-brand-600 px-2 py-0.5 rounded text-[10px] font-bold shrink-0">ë“±ë¡</button></div></div>`;
                }).join('');

                const likers = likeMap[p.id] || [];
                const isLiked = likers.includes(user.username);
                const likeIcon = isLiked ? '<i class="fa-solid fa-heart text-red-500 heart-pop"></i>' : '<i class="fa-regular fa-heart"></i>';
                const likeText = likers.length > 0 ? `<div class="text-xs font-bold text-slate-800 cursor-pointer hover:underline" onclick="alert('${likers.join(', ')} ë‹˜ì´ ì¢‹ì•„í•©ë‹ˆë‹¤!')">ì¢‹ì•„ìš” ${likers.length}ê°œ</div>` : '';

                let media = p.image_url ? `<div class="mt-3 rounded-2xl overflow-hidden shadow-sm bg-slate-100 relative group cursor-zoom-in h-72 flex justify-center items-center" onclick="openZoom('${p.image_url}')"><img src="${p.image_url}" class="w-full h-full object-contain hover:scale-105 transition-transform duration-500" loading="lazy"><div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-white font-bold text-xs pointer-events-none"><i class="fa-solid fa-magnifying-glass-plus mr-1"></i> í¬ê²Œ ë³´ê¸°</div></div>` : '';
                let gift = ''; if(p.gift_type) { if(!p.is_gift_opened && target===user.username) gift=`<div onclick="openGift(${p.id},'${p.gift_type}',${p.gift_amount})" class="mt-3 bg-gradient-to-r from-amber-100 to-orange-100 border border-amber-200 p-4 rounded-2xl cursor-pointer hover:scale-[1.02] transition-transform flex items-center gap-4 shadow-sm gift-box"><div class="text-3xl">ğŸ</div><div><div class="font-bold text-amber-900 text-sm">ì„ ë¬¼ ë„ì°©!</div><div class="text-xs text-amber-700">í„°ì¹˜í•´ì„œ í™•ì¸í•˜ì„¸ìš”</div></div></div>`; else if(p.is_gift_opened) gift=`<div class="mt-3 bg-slate-50 border border-slate-200 p-3 rounded-2xl text-center text-xs text-slate-400 font-bold"><i class="fa-solid fa-check mr-1"></i> íšë“ ì™„ë£Œ</div>`; }
                
                if(p.status === 'blind') return `<div class="mx-6 my-4 p-6 bg-slate-100 rounded-3xl border border-dashed border-slate-300 text-center text-xs text-slate-400">ğŸš« ë¸”ë¼ì¸ë“œ ê²Œì‹œë¬¼</div>`;

                return `<div class="bg-white mb-6 p-0 border-b-8 border-slate-50 last:border-0 hover-lift">
                    <div class="px-6 pt-5 pb-3 flex justify-between items-start">
                        <div class="flex gap-3"><div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500 text-sm">${p.sender_id[0]}</div><div><div class="font-bold text-slate-900 text-sm">${p.sender_id}</div><div class="text-[10px] text-slate-400">${getTimeAgo(new Date(p.created_at))}</div></div></div>
                        ${(p.sender_id===user.username || target===user.username) ? `<button onclick="delPost(${p.id})" class="text-slate-300 hover:text-red-500 transition"><i class="fa-solid fa-trash-can"></i></button>` : ''}
                    </div>
                    <div class="px-6 pb-4"><div class="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap">${p.content}</div>${media}${gift}</div>
                    <div class="px-0 py-2 flex items-center gap-2"><button onclick="toggleLike(${p.id}, ${isLiked})" class="text-xl hover:scale-110 transition-transform">${likeIcon}</button>${likeText}</div>
                    <div class="px-6 py-4 bg-slate-50/50 border-t border-slate-100">
                        <div class="space-y-1 mb-3 max-h-40 overflow-y-auto custom-scroll pr-2">${commentsHtml}</div>
                        <div class="relative flex gap-2"><input type="text" id="comment-input-${p.id}" class="w-full bg-white border border-slate-200 rounded-full pl-4 pr-12 py-2 text-xs focus:ring-1 focus:ring-brand-500 transition shadow-sm" placeholder="ëŒ“ê¸€..." onkeyup="if(event.key==='Enter') addComm(${p.id})"><button onclick="addComment(${p.id})" class="absolute right-1 top-1 bottom-1 text-brand-600 font-bold text-xs px-3 hover:bg-brand-50 rounded-full transition">ê²Œì‹œ</button></div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ---
        function toggleReplyBox(cid) { document.getElementById(`reply-box-${cid}`).classList.toggle('hidden'); }
        function previewImg() { const f=document.getElementById('file-input').files[0]; if(f){selectedFile=f; const r=new FileReader(); r.onload=e=>{document.getElementById('img-preview').src=e.target.result; document.getElementById('preview-box').classList.remove('hidden');}; r.readAsDataURL(f);} }
        function removeImg() { selectedFile=null; document.getElementById('file-input').value=''; document.getElementById('preview-box').classList.add('hidden'); }
        function getTimeAgo(d) { const s=Math.floor((new Date()-d)/1000); if(s<60)return"ë°©ê¸ˆ"; const m=Math.floor(s/60); if(m<60)return`${m}ë¶„ ì „`; const h=Math.floor(m/60); if(h<24)return`${h}ì‹œê°„ ì „`; return`${Math.floor(h/24)}ì¼ ì „`; }
        
        async function toggleLike(pid, isLiked) {
            if (isLiked) await _supabase.from('guestbook_likes').delete().match({post_id: pid, user_id: user.username});
            else await _supabase.from('guestbook_likes').insert([{post_id: pid, user_id: user.username}]);
            loadFeed();
        }

        async function toggleCommentLike(cid, isLiked) {
            if (isLiked) await _supabase.from('guestbook_comment_likes').delete().match({comment_id: cid, user_id: user.username});
            else await _supabase.from('guestbook_comment_likes').insert([{comment_id: cid, user_id: user.username}]);
            loadFeed();
        }

        async function writePost() {
            const txt=document.getElementById('post-input').value.trim(); if(!txt && !selectedFile) return; const btn=document.getElementById('btn-post'); const originalIcon=btn.innerHTML; btn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>'; btn.disabled=true; const target=currentTarget||user.username;
            if(target!==user.username){const{data}=await _supabase.from('friends').select('*').or(`and(requester.eq.${user.username},receiver.eq.${target}),and(requester.eq.${target},receiver.eq.${user.username})`).eq('status','accepted');if(!data||data.length===0){alert("ì¹œêµ¬ë§Œ ê°€ëŠ¥");btn.innerHTML=originalIcon;btn.disabled=false;return;}}
            try{let imgUrl=null;if(selectedFile){const ext=selectedFile.name.split('.').pop();const cleanName=`sns_${Date.now()}_${Math.floor(Math.random()*1000)}.${ext}`;const{error:upErr}=await _supabase.storage.from('solutions').upload(cleanName,selectedFile,{cacheControl:'3600',upsert:false});if(upErr)throw upErr;const{data:urlData}=_supabase.storage.from('solutions').getPublicUrl(cleanName);imgUrl=urlData.publicUrl;}
            const{error:postErr}=await _supabase.from('guestbook').insert([{sender_id:user.username,receiver_id:target,content:txt,image_url:imgUrl}]);if(postErr)throw postErr;document.getElementById('post-input').value='';removeImg();loadFeed();}catch(e){alert("ì‹¤íŒ¨:"+e.message);}finally{btn.innerHTML=originalIcon;btn.disabled=false;}
        }
        
        async function delPost(id) { if(confirm("ì‚­ì œ?")) { await _supabase.from('guestbook').delete().eq('id', id); loadFeed(); } }
        
        // â˜… ëŒ€ëŒ“ê¸€ ì§€ì› ëŒ“ê¸€ ë“±ë¡ â˜…
        async function addComment(postId, parentId = null) {
            let inputId = `comment-input-${postId}`;
            if (parentId) inputId = `reply-input-${parentId}`;
            
            const input = document.getElementById(inputId);
            const content = input.value.trim();
            if(!content) return;
            
            const payload = { post_id: postId, writer_id: user.username, content: content };
            if(parentId) payload.parent_id = parentId;

            await _supabase.from('guestbook_comments').insert([payload]);
            loadFeed();
        }

        async function openGift(pid,t,a) { const {data:u}=await _supabase.from('users').select('*').eq('username',user.username).single(); const up=t==='xp'?{total_xp:(u.total_xp||0)+a,season_xp:(u.season_xp||0)+a}:{cp:(u.cp||0)+a}; await _supabase.from('users').update(up).eq('username',user.username); await _supabase.from('guestbook').update({is_gift_opened:true}).eq('id',pid); await _supabase.from('point_logs').insert([{student_id:user.username,rule_name:'ì„ ë¬¼',xp_earned:t==='xp'?a:0,cp_earned:t==='cp'?a:0}]); alert(`ğŸ íšë“! ${a} ${t.toUpperCase()}`); loadFeed(); }
        async function doSearch() { const k=document.getElementById('search-input').value.trim(); if(!k)return; const d=document.getElementById('search-res'); d.innerHTML='<div class="text-center py-10"><i class="fa-solid fa-spinner fa-spin text-brand-300"></i></div>'; const {data}=await _supabase.from('users').select('*').eq('role','student').ilike('name',`%${k}%`); const f=(data||[]).filter(u=>u.username!==user.username); d.innerHTML=f.length?f.map(u=>`<div class="flex justify-between items-center p-4 bg-white border border-slate-100 rounded-2xl mb-2"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-brand-50 text-brand-600 rounded-full flex items-center justify-center font-bold">${u.name[0]}</div><div><div class="font-bold text-sm text-slate-800">${u.name}</div><div class="text-xs text-slate-400">${u.grade}</div></div></div><button onclick="sendReq('${u.username}')" class="bg-brand-50 text-brand-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-brand-600 hover:text-white transition">ìš”ì²­</button></div>`).join(''):'<div class="text-center py-10 text-xs text-slate-400">ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; }
        async function sendReq(id) { const m=prompt("ë©”ì‹œì§€:"); if(!m)return; await _supabase.from('friends').insert([{requester:user.username, receiver:id, status:'pending', message:m}]); alert("ì „ì†¡ ì™„ë£Œ!"); }
        async function loadRequests() { const d=document.getElementById('view-req'); const {data}=await _supabase.from('friends').select('*').eq('receiver',user.username).eq('status','pending'); d.innerHTML=(data&&data.length)?data.map(r=>`<div class="bg-white p-4 rounded-2xl border border-slate-100 mb-2"><div class="flex justify-between mb-2"><span class="font-bold text-sm text-slate-800">${r.requester}</span></div><div class="text-xs mb-3 text-slate-500">"${r.message}"</div><div class="flex gap-2"><button onclick="ansReq(${r.id},'accepted')" class="flex-1 bg-brand-600 text-white py-2 rounded-xl text-xs">ìˆ˜ë½</button><button onclick="ansReq(${r.id},'rejected')" class="flex-1 bg-slate-100 text-slate-500 py-2 rounded-xl text-xs">ê±°ì ˆ</button></div></div>`).join(''):'<div class="text-center py-10 text-xs text-slate-400">ì—†ìŒ</div>'; }
        async function ansReq(id,s){ if(s==='rejected')await _supabase.from('friends').delete().eq('id',id); else await _supabase.from('friends').update({status:'accepted'}).eq('id',id); loadRequests(); checkRequests(); loadFriends(); }
        async function checkRequests() { const {count}=await _supabase.from('friends').select('*',{count:'exact',head:true}).eq('receiver',user.username).eq('status','pending'); if(count>0)document.getElementById('badge-req').classList.remove('hidden'); }

        init();
    </script>
</body>
</html>