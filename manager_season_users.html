<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹œì¦Œ ì°¸ì—¬ì ì‹¬íŒì†Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; user-select: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* í•™ë…„ í•„í„° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .grade-btn { 
            padding: 6px 12px; 
            border-radius: 99px; 
            font-size: 11px; 
            font-weight: 800; 
            background-color: white; 
            border: 1px solid #e2e8f0; 
            color: #64748b; 
            transition: all 0.2s; 
        }
        .grade-btn:hover { background-color: #f8fafc; color: #475569; transform: translateY(-1px); }
        .grade-btn.active { 
            background-color: #4f46e5; 
            color: white; 
            border-color: #4f46e5; 
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
        }
    </style>
</head>
<body class="p-6">

    <script src="config.js"></script>

    <div class="max-w-5xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden min-h-[700px] flex flex-col">
        
        <div class="bg-slate-900 p-6 flex justify-between items-center text-white">
            <h2 class="text-2xl font-black flex items-center gap-2"><i class="fa-solid fa-gavel text-amber-400"></i> ì‹œì¦Œ ì‹¬íŒì†Œ</h2>
            <p class="text-xs text-slate-400">í•™ìƒë“¤ì˜ XPì™€ CPë¥¼ ì§‘í–‰í•©ë‹ˆë‹¤.</p>
        </div>

        <div class="flex flex-1">
            
            <div class="w-1/3 border-r border-slate-200 flex flex-col bg-slate-50">
                <div class="p-4 border-b border-slate-200 space-y-3">
                    <div class="flex flex-wrap gap-1 justify-center" id="grade-filters">
                        <button onclick="filterGrade('all')" class="grade-btn active" id="btn-grade-all">ì „ì²´</button>
                        <button onclick="filterGrade('ì¤‘1')" class="grade-btn" id="btn-grade-ì¤‘1">ì¤‘1</button>
                        <button onclick="filterGrade('ì¤‘2')" class="grade-btn" id="btn-grade-ì¤‘2">ì¤‘2</button>
                        <button onclick="filterGrade('ì¤‘3')" class="grade-btn" id="btn-grade-ì¤‘3">ì¤‘3</button>
                        <button onclick="filterGrade('ê³ 1')" class="grade-btn" id="btn-grade-ê³ 1">ê³ 1</button>
                        <button onclick="filterGrade('ê³ 2')" class="grade-btn" id="btn-grade-ê³ 2">ê³ 2</button>
                        <button onclick="filterGrade('ê³ 3')" class="grade-btn" id="btn-grade-ê³ 3">ê³ 3</button>
                    </div>
                    <input type="text" id="search-input" placeholder="ì´ë¦„ ê²€ìƒ‰..." class="w-full px-4 py-2 rounded-xl border border-slate-300 focus:outline-none focus:border-indigo-500 font-bold text-sm" onkeyup="filterStudents()">
                </div>
                
                <div id="student-list" class="flex-1 overflow-y-auto custom-scroll p-2 space-y-1">
                    <div class="text-center py-10"><i class="fa-solid fa-spinner fa-spin text-slate-400"></i></div>
                </div>
            </div>

            <div class="w-2/3 flex flex-col bg-white relative">
                
                <div id="selected-user-header" class="p-6 border-b border-slate-100 flex justify-between items-center hidden bg-indigo-50/50">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 rounded-2xl bg-white border border-indigo-100 flex items-center justify-center text-3xl shadow-sm">ğŸ“</div>
                        <div>
                            <h3 class="text-2xl font-black text-slate-800" id="detail-name">í•™ìƒì´ë¦„</h3>
                            <div class="flex gap-2 text-xs font-bold text-slate-500 mt-1">
                                <span class="bg-white px-2 py-0.5 rounded border" id="detail-grade">í•™ë…„</span>
                                <span class="bg-white px-2 py-0.5 rounded border" id="detail-school">í•™êµ</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold text-slate-400 mb-1">Current XP</div>
                        <div class="text-3xl font-black text-indigo-600" id="detail-xp">0</div>
                    </div>
                </div>

                <div id="panel-reward" class="p-10 flex-1 hidden flex flex-col justify-center">
                    <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-lg max-w-lg mx-auto w-full relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-6 opacity-5 pointer-events-none"><i class="fa-solid fa-scale-balanced text-9xl"></i></div>

                        <h4 class="font-black text-xl text-slate-800 mb-8 flex items-center gap-2 border-b pb-4">
                            âš–ï¸ íŒê²° ì§‘í–‰ (Adjustment)
                        </h4>
                        
                        <div class="grid grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-xs font-bold text-indigo-500 mb-2 ml-1">XP ë³€ë™ (ê²½í—˜ì¹˜)</label>
                                <input type="number" id="adj-xp" placeholder="0" class="w-full px-4 py-4 rounded-2xl border-2 border-indigo-100 bg-indigo-50/50 font-black text-indigo-700 text-center text-xl focus:border-indigo-500 outline-none transition placeholder-indigo-200">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-amber-500 mb-2 ml-1">CP ë³€ë™ (í¬ì¸íŠ¸)</label>
                                <input type="number" id="adj-cp" placeholder="0" class="w-full px-4 py-4 rounded-2xl border-2 border-amber-100 bg-amber-50/50 font-black text-amber-700 text-center text-xl focus:border-amber-500 outline-none transition placeholder-amber-200">
                            </div>
                        </div>

                        <div class="mb-8">
                            <label class="block text-xs font-bold text-slate-500 mb-2 ml-1">ğŸ“¢ í”¼ë“œë°± ë©”ì‹œì§€ (í•™ìƒì—ê²Œ ì „ì†¡ë¨)</label>
                            <textarea id="adj-msg" class="w-full p-4 rounded-2xl border-2 border-slate-200 text-sm font-medium focus:border-indigo-500 outline-none h-32 resize-none bg-slate-50 focus:bg-white transition" placeholder="ì˜ˆ: ì£¼ê°„ í…ŒìŠ¤íŠ¸ ë§Œì  ë³´ìƒ, ì§€ê° ë²Œì  ë“± ì‚¬ìœ ë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                        </div>

                        <button onclick="executeJudgment()" class="w-full bg-slate-900 hover:bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-xl transition transform active:scale-95 flex items-center justify-center gap-2 text-lg">
                            <i class="fa-solid fa-gavel"></i> íŒê²° ì§‘í–‰ ë° ì „ì†¡
                        </button>
                    </div>
                </div>

                <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 bg-white z-0">
                    <i class="fa-solid fa-user-graduate text-7xl mb-4 opacity-50"></i>
                    <p class="font-bold text-lg">ì¢Œì¸¡ ëª©ë¡ì—ì„œ í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.</p>
                </div>

            </div>
        </div>
    </div>

    <script>
        let allStudents = [];
        let filteredList = [];
        let selectedUser = null;
        let currentGradeFilter = 'all';

        async function init() {
            const { data, error } = await _supabase.from('users').select('*').eq('role', 'student').order('name');
            if (error) { alert("ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨"); return; }
            allStudents = data;
            filterGrade('all'); // ì´ˆê¸°í™”
        }

        // --- í•™ë…„ í•„í„°ë§ ë¡œì§ ---
        function filterGrade(grade) {
            currentGradeFilter = grade;
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.grade-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-grade-${grade}`).classList.add('active');

            filterStudents(); // ê²€ìƒ‰ì–´ í•„í„°ì™€ ì—°ë™
        }

        function filterStudents() {
            const term = document.getElementById('search-input').value.toLowerCase();
            
            filteredList = allStudents.filter(s => {
                const matchName = s.name.toLowerCase().includes(term);
                const matchGrade = currentGradeFilter === 'all' || s.grade === currentGradeFilter;
                return matchName && matchGrade;
            });

            renderList(filteredList);
        }

        function renderList(list) {
            const container = document.getElementById('student-list');
            container.innerHTML = '';
            
            if (list.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-xs text-slate-400">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            list.forEach(s => {
                container.innerHTML += `
                    <div onclick="selectUser('${s.username}')" class="p-4 bg-white rounded-2xl border border-slate-200 cursor-pointer hover:border-indigo-500 hover:shadow-md transition flex justify-between items-center group mb-2">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-xs font-black border group-hover:bg-indigo-500 group-hover:text-white transition">${s.name[0]}</div>
                            <div>
                                <div class="font-bold text-slate-700 group-hover:text-indigo-600 transition">${s.name}</div>
                                <div class="text-[10px] text-slate-400 font-medium">${s.grade} | ${s.tier || 'Unranked'}</div>
                            </div>
                        </div>
                        <div class="text-xs font-black text-slate-400 group-hover:text-indigo-500 bg-slate-50 px-2 py-1 rounded group-hover:bg-indigo-50">${(s.season_xp || 0).toLocaleString()} XP</div>
                    </div>
                `;
            });
        }

        async function selectUser(username) {
            // DBì—ì„œ ìµœì‹  ì •ë³´ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸° (ì‹±í¬ ë§ì¶”ê¸°)
            const { data, error } = await _supabase.from('users').select('*').eq('username', username).single();
            if (error || !data) return alert("í•™ìƒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            
            selectedUser = data;

            // UI í™œì„±í™”
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('selected-user-header').classList.remove('hidden');
            document.getElementById('panel-reward').classList.remove('hidden'); // ì‹¬íŒ íŒ¨ë„ ì¦‰ì‹œ í‘œì‹œ

            // ì •ë³´ ì±„ìš°ê¸°
            document.getElementById('detail-name').innerText = selectedUser.name;
            document.getElementById('detail-grade').innerText = selectedUser.grade;
            document.getElementById('detail-school').innerText = selectedUser.school || 'í•™êµë¯¸ì •';
            document.getElementById('detail-xp').innerText = (selectedUser.season_xp || 0).toLocaleString();

            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('adj-xp').value = '';
            document.getElementById('adj-cp').value = '';
            document.getElementById('adj-msg').value = '';
        }

        // --- â˜… [í•µì‹¬] íŒê²° ì§‘í–‰ ë° ë©”ì‹œì§€ ì „ì†¡ (DB ì—ëŸ¬ ìˆ˜ì •ë¨) â˜… ---
        async function executeJudgment() {
            if (!selectedUser) return;

    const xpChange = parseInt(document.getElementById('adj-xp').value) || 0;
    const cpChange = parseInt(document.getElementById('adj-cp').value) || 0;
    const feedbackMsg = document.getElementById('adj-msg').value.trim();

    if (xpChange === 0 && cpChange === 0) return alert("ë³€í™”ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.");
    if (!feedbackMsg) return alert("ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");

    if (!confirm(`[${selectedUser.name}] í•™ìƒì—ê²Œ ì§‘í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    try {
        // 1. í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì‹œì¦Œ ID ê°€ì ¸ì˜¤ê¸°
        const { data: season } = await _supabase.from('seasons').select('id').eq('is_current', true).single();
        if (!season) throw new Error("í˜„ì¬ í™œì„±í™”ëœ ì‹œì¦Œì´ ì—†ìŠµë‹ˆë‹¤.");

        // 2. ìœ ì € ì ìˆ˜ ì—…ë°ì´íŠ¸
        const { error: userErr } = await _supabase.from('users').update({
            season_xp: (selectedUser.season_xp || 0) + xpChange,
            total_xp: (selectedUser.total_xp || 0) + xpChange,
            cp: (selectedUser.cp || 0) + cpChange
        }).eq('username', selectedUser.username);

        if (userErr) throw userErr;

        // 3. â˜… ì‹œì¦Œ ì „ìš© ë©”ì‹œì§€í•¨(season_messages)ì— ê¸°ë¡ â˜…
        const { error: msgErr } = await _supabase.from('season_messages').insert({
            season_id: season.id,
            student_id: selectedUser.username,
            message: feedbackMsg,
            xp_change: xpChange,
            cp_change: cpChange,
            type: 'adjustment'
        });

        if (msgErr) throw msgErr;

        alert("âœ… íŒê²°ì´ ì§‘í–‰ë˜ê³  ì‹œì¦Œ ì•Œë¦¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.reload();

    } catch (e) {
        alert("ì‹¤íŒ¨: " + e.message);
    }
        }

        init();
    </script>
</body>
</html>