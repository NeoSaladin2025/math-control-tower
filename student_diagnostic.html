<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì§„ë‹¨í‰ê°€ ì…ë ¥ì„¼í„° | Beyond Math</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f8fafc; user-select: none; -webkit-tap-highlight-color: transparent; }
        .choice-btn { transition: all 0.1s ease-in-out; touch-action: manipulation; }
        .choice-btn:active { transform: scale(0.92); }
        .active-correct { background-color: #3b82f6 !important; color: white !important; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
        .active-wrong { background-color: #ef4444 !important; color: white !important; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); }
        .active-unknown { background-color: #f59e0b !important; color: white !important; box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3); }
        .view-section { display: none; }
        .view-section.active { display: block; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <script src="config.js"></script>

    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-slate-200 px-4 h-16 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <button onclick="App.handleBack()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-50 text-slate-600 active:bg-slate-200">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <span class="font-black text-slate-800 tracking-tight">ì§„ë‹¨í‰ê°€ ì…ë ¥</span>
        </div>
        <div id="user-tag" class="text-[11px] font-black text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-full">ë¡œë”© ì¤‘..</div>
    </nav>

    <main class="flex-1 p-4 max-w-xl mx-auto w-full">
        <section id="lobby" class="view-section active space-y-5">
            <div class="py-4"><h2 class="text-2xl font-black text-slate-900 leading-tight">ì§„ë‹¨í‰ê°€ ëª©ë¡</h2></div>
            <div id="test-list" class="space-y-3"></div>
        </section>

        <section id="input-panel" class="view-section space-y-6">
            <div class="bg-slate-900 rounded-[32px] p-6 text-white shadow-2xl relative overflow-hidden">
                <h3 id="test-title" class="text-xl font-black mb-1 truncate">-</h3>
                <div class="flex justify-between items-center mt-4">
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-500 font-black uppercase">Progress</span>
                        <span id="test-progress-text" class="text-2xl font-black text-blue-400 italic">0%</span>
                    </div>
                </div>
                <div class="absolute bottom-0 left-0 w-full h-1.5 bg-white/10"><div id="test-progress-bar" class="h-full bg-blue-500 w-0 transition-all duration-300"></div></div>
            </div>
            <div id="q-container" class="space-y-3 pb-32"></div>
        </section>
    </main>

    <footer id="submit-bar" class="fixed bottom-0 left-0 right-0 p-4 bg-white/80 backdrop-blur-xl border-t border-slate-100 hidden">
        <div class="max-w-xl mx-auto">
            <button onclick="App.submitData()" class="w-full h-16 bg-slate-900 text-white rounded-[24px] font-black text-lg shadow-xl active:scale-95 transition-transform flex items-center justify-center gap-3">ì œì¶œí•˜ê¸°</button>
        </div>
    </footer>

    <script>
        /* --- [CORE ENGINE] --- */
        const DiagnosticCore = {
            /**
             * @method getAssignedTests
             * @description [ë²„ê·¸ ìˆ˜ì •] ë‚´ë¶€ ì§„ë‹¨í‰ê°€(type='internal')ë§Œ í•„í„°ë§í•´ì„œ ê°€ì ¸ì˜´
             */
            async getAssignedTests(studentId) {
                const { data, error } = await _supabase
                    .from('student_assignments')
                    .select(`
                        id, 
                        status, 
                        diagnostic_packages!inner(
                            title, 
                            type,
                            package_items(count_normal, count_subjective, count_high)
                        )
                    `)
                    .eq('student_id', studentId)
                    .eq('status', 'assigned')
                    .eq('diagnostic_packages.type', 'internal'); // ğŸ‘ˆ ì—¬ê¸°! ë‚´ë¶€ ì§„ë‹¨ë§Œ í•„í„°ë§!

                if (error) throw error;
                return data;
            },
            
            async submitAnswers(assignmentId, answers) {
                const keys = Object.keys(answers);
                const total = keys.length;
                const correctCount = keys.filter(k => answers[k] === 'C').length;
                const finalScore = total > 0 ? Math.round((correctCount / total) * 100) : 0;

                const { error } = await _supabase
                    .from('student_assignments')
                    .update({ 
                        student_answers: answers, 
                        status: 'completed',
                        score: finalScore 
                    })
                    .eq('id', assignmentId);

                if (error) throw error;
            }
        };

        /* --- [RENDERER ENGINE] --- */
        const DiagnosticRenderer = {
            renderTestList(containerId, tests) {
                const container = document.getElementById(containerId);
                if (!tests || tests.length === 0) {
                    container.innerHTML = '<div class="py-20 text-center text-slate-400 font-bold">ë°°ì •ëœ ë‚´ë¶€ ì§„ë‹¨í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                container.innerHTML = tests.map(t => {
                    const pkg = t.diagnostic_packages;
                    const count = pkg.package_items.reduce((s, i) => s + (i.count_normal * 2) + i.count_subjective + i.count_high, 0);
                    return `<div onclick="App.startExam(${t.id}, '${pkg.title}', ${count})" class="bg-white p-6 rounded-[28px] border-2 border-slate-100 active:border-indigo-500 transition-all shadow-sm flex justify-between items-center group">
                        <div><h4 class="font-bold text-slate-800 mb-1">${pkg.title}</h4><p class="text-[11px] text-slate-400 font-black uppercase">${count} Questions</p></div>
                        <div class="w-12 h-12 rounded-2xl bg-indigo-50 text-indigo-600 flex items-center justify-center group-active:scale-90 transition"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>`;
                }).join('');
            },
            renderQuestions(containerId, count) {
                const container = document.getElementById(containerId);
                let html = '';
                for (let i = 1; i <= count; i++) {
                    html += `<div class="bg-white p-4 rounded-3xl flex items-center border border-slate-100 shadow-sm mb-3">
                        <div class="w-10 font-black text-slate-300 text-sm italic">#${i}</div>
                        <div class="flex-1 grid grid-cols-3 gap-2">
                            <button onclick="App.handleSelect(${i}, 'C', this)" class="choice-btn py-3 rounded-2xl bg-slate-50 text-slate-400 text-xs font-black">ë§ìŒ</button>
                            <button onclick="App.handleSelect(${i}, 'W', this)" class="choice-btn py-3 rounded-2xl bg-slate-50 text-slate-400 text-xs font-black">í‹€ë¦¼</button>
                            <button onclick="App.handleSelect(${i}, 'U', this)" class="choice-btn py-3 rounded-2xl bg-slate-50 text-slate-400 text-xs font-black">ëª¨ë¦„</button>
                        </div>
                    </div>`;
                }
                container.innerHTML = html;
            }
        };

        /* --- [APP CONTROLLER] --- */
        const App = {
            user: JSON.parse(sessionStorage.getItem('currentUser')),
            currentId: null, totalCount: 0, answers: {},
            async init() {
                if(!this.user) { location.href = 'index.html'; return; }
                document.getElementById('user-tag').innerText = `${this.user.name} í•™ìƒ`;
                try {
                    const tests = await DiagnosticCore.getAssignedTests(this.user.username);
                    DiagnosticRenderer.renderTestList('test-list', tests);
                } catch(e) { console.error(e); }
            },
            startExam(id, title, count) {
                this.currentId = id; this.totalCount = count; this.answers = {};
                document.getElementById('lobby').classList.remove('active');
                document.getElementById('input-panel').classList.add('active');
                document.getElementById('submit-bar').classList.remove('hidden');
                document.getElementById('test-title').innerText = title;
                DiagnosticRenderer.renderQuestions('q-container', count);
            },
            handleSelect(idx, type, btn) {
                const row = btn.parentElement;
                row.querySelectorAll('button').forEach(b => b.classList.remove('active-correct', 'active-wrong', 'active-unknown'));
                btn.classList.add(type === 'C' ? 'active-correct' : type === 'W' ? 'active-wrong' : 'active-unknown');
                this.answers[idx] = type;
                const per = Math.round((Object.keys(this.answers).length / this.totalCount) * 100);
                document.getElementById('test-progress-bar').style.width = per + '%';
                document.getElementById('test-progress-text').innerText = per + '%';
            },
            handleBack() {
                if(document.getElementById('input-panel').classList.contains('active')) {
                    if(confirm("ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.")) location.reload();
                } else history.back();
            },
            async submitData() {
                if(Object.keys(this.answers).length < this.totalCount) { alert("ëª¨ë“  ë¬¸í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
                if(!confirm("ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                try {
                    await DiagnosticCore.submitAnswers(this.currentId, this.answers);
                    alert("ì œì¶œ ì™„ë£Œ! ì ìˆ˜ê°€ ì„±ê³µì ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                    location.reload();
                } catch(e) { alert("ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
            }
        };
        App.init();
    </script>
</body>
</html>