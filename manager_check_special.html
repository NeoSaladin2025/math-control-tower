<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <link rel="manifest" href="site.webmanifest">
    
    <link rel="apple-touch-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ì: ìŠ¤í˜ì…œ ê³¼ì œ ì‹¬íŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #cbd5e1; font-family: 'Pretendard', sans-serif; }
        .glass-card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        .stat-box { background: #0f172a; border-radius: 8px; padding: 10px; border: 1px solid #334155; }
        .input-elite { background: #020617; border: 1px solid #475569; color: white; padding: 8px; border-radius: 6px; width: 100%; font-family: monospace; font-weight: bold; text-align: right; }
        .input-elite:focus { border-color: #6366f1; outline: none; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
    </style>
</head>
<body class="p-6 min-h-screen">
    <script src="config.js"></script>

    <div class="max-w-4xl mx-auto mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-black text-white flex items-center gap-2">
                <i class="fa-solid fa-scale-balanced text-indigo-500"></i> Assessment Dashboard
            </h1>
            <p class="text-xs text-slate-400 mt-1">Special Assignment Final Judgment System</p>
        </div>
        <button onclick="location.reload()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-lg text-xs font-bold transition">
            <i class="fa-solid fa-rotate mr-1"></i> Refresh
        </button>
    </div>

    <div id="loading" class="text-center py-20 text-slate-500">
        <i class="fa-solid fa-circle-notch fa-spin text-2xl mb-2"></i><br>ë°ì´í„° ë¡œë”© ì¤‘...
    </div>

    <div id="list-container" class="space-y-6 hidden"></div>

    <script>
        async function load() {
            const container = document.getElementById('list-container');
            const loader = document.getElementById('loading');
            
            // 1. ì‹¬íŒ ëŒ€ê¸° ê³¼ì œ ì¡°íšŒ
            const { data: list, error } = await _supabase
                .from('assignments')
                .select('*')
                .eq('is_special', true)
                .eq('status', 'submitted')
                .is('final_score', null)
                .order('submitted_at', { ascending: true });

            loader.classList.add('hidden');
            container.classList.remove('hidden');

            if (!list || list.length === 0) {
                container.innerHTML = `<div class="text-center py-20 text-slate-600 border border-dashed border-slate-700 rounded-xl">ì‹¬íŒ ëŒ€ê¸° ì¤‘ì¸ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            container.innerHTML = '';
            
            for (const item of list) {
                // [A] ìŠ¤í˜ì…œ ë³´ìƒ ì •ë³´ ì¡°íšŒ
                const { data: sp } = await _supabase.from('assignment_specials').select('*').eq('assignment_id', item.id).maybeSingle();
                const rule = sp || { reward_xp: item.reward_points || 0, reward_cp: 0, penalty_xp: item.penalty_points || 0, penalty_cp: 0 };
                
                // [B] â˜… [EVE FIX] í•™ìƒ ì½”ë©˜íŠ¸ ì¡°íšŒ (student_opinions í…Œì´ë¸” ì‚¬ìš©) â˜…
                const { data: op } = await _supabase.from('student_opinions')
                    .select('content')
                    .eq('related_id', item.id)
                    .eq('category', 'SPECIAL_SUBMISSION') // ì¹´í…Œê³ ë¦¬ ë§¤ì¹­
                    .maybeSingle();
                
                const studentMsg = op ? op.content : '(ì½”ë©˜íŠ¸ ì—†ìŒ)';

                // [C] ì§€ê° ì²´í¬
                const deadline = new Date(item.deadline);
                const submitted = new Date(item.submitted_at);
                const isLate = submitted > deadline;
                let timeBadge = isLate 
                    ? `<span class="bg-red-950 text-red-400 text-[10px] px-2 py-0.5 rounded border border-red-800">âš ï¸ LATE</span>` 
                    : `<span class="bg-emerald-950 text-emerald-400 text-[10px] px-2 py-0.5 rounded border border-emerald-800">âœ… ON TIME</span>`;

                // [D] ì´ë¯¸ì§€ íŒŒì‹±
                const imgContainerId = `imgs-${item.id}`;
                const card = document.createElement('div');
                card.className = "glass-card p-6 fade-in";
                
                card.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="flex-1 space-y-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-indigo-400 font-bold text-lg">${item.student_id}</span>
                                        ${timeBadge}
                                    </div>
                                    <h3 class="font-bold text-white text-md">${item.title}</h3>
                                </div>
                                <div class="text-right text-[10px] text-slate-500 font-mono">ì œì¶œ: ${submitted.toLocaleString()}</div>
                            </div>

                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700 min-h-[60px]">
                                <p class="text-xs text-slate-400 font-bold mb-1">ğŸ’¬ í•™ìƒ ì˜ê²¬ (Student Opinion)</p>
                                <p class="text-sm text-slate-300 italic">"${studentMsg}"</p>
                            </div>

                            <div class="space-y-2">
                                <p class="text-xs text-slate-400 font-bold">ğŸ“‚ ì œì¶œ íŒŒì¼</p>
                                <div class="flex gap-2 overflow-x-auto pb-2 custom-scroll" id="${imgContainerId}"><span class="text-xs text-slate-600">ë¡œë”© ì¤‘...</span></div>
                            </div>
                        </div>

                        <div class="w-full md:w-80 bg-slate-950 rounded-xl p-4 border border-slate-800 flex flex-col gap-4">
                            <div class="grid grid-cols-2 gap-2 text-center">
                                <div class="stat-box opacity-70"><div class="text-[9px] text-emerald-500 font-bold">SUCCESS</div><div class="text-xs text-slate-300">+${rule.reward_xp} XP</div><div class="text-[10px] text-slate-500">+${rule.reward_cp} CP</div></div>
                                <div class="stat-box opacity-70"><div class="text-[9px] text-red-500 font-bold">FAIL</div><div class="text-xs text-slate-300">-${rule.penalty_xp} XP</div><div class="text-[10px] text-slate-500">-${rule.penalty_cp} CP</div></div>
                            </div>
                            <div class="space-y-3 pt-2 border-t border-slate-800">
                                <div class="flex justify-between items-center"><label class="text-xs font-bold text-indigo-400">Final XP</label><div class="w-24"><input type="number" id="xp-${item.id}" class="input-elite" value="${isLate ? -rule.penalty_xp : rule.reward_xp}"></div></div>
                                <div class="flex justify-between items-center"><label class="text-xs font-bold text-indigo-400">Final CP</label><div class="w-24"><input type="number" id="cp-${item.id}" class="input-elite" value="${isLate ? -rule.penalty_cp : rule.reward_cp}"></div></div>
                            </div>
                            <textarea id="fb-${item.id}" class="w-full bg-slate-900 border border-slate-700 text-slate-300 text-xs p-2 rounded resize-none h-16 focus:border-indigo-500 outline-none" placeholder="í”¼ë“œë°± ì…ë ¥..."></textarea>
                            <button onclick="executeJudgment(${item.id}, '${item.student_id}')" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg text-sm shadow-lg flex items-center justify-center gap-2"><i class="fa-solid fa-gavel"></i> íŒê²° ì§‘í–‰</button>
                        </div>
                    </div>`;
                container.appendChild(card);

                // ì´ë¯¸ì§€ ë¡œë“œ
                const imgContainer = document.getElementById(imgContainerId);
                let finalUrls = [];
                try {
                    const raw = item.submission_images;
                    if (Array.isArray(raw)) finalUrls = raw;
                    else if (typeof raw === 'string') finalUrls = raw.replace(/^{|}$/g, '').split(',').map(s=>s.replace(/"/g,''));
                } catch(e){}

                if (finalUrls.length > 0) {
                    imgContainer.innerHTML = finalUrls.map(url => `<a href="${url}" target="_blank" class="block shrink-0"><img src="${url}" class="w-16 h-16 object-cover rounded border border-slate-600 hover:border-white"></a>`).join('');
                } else { imgContainer.innerHTML = `<span class="text-xs text-slate-600 italic">ì´ë¯¸ì§€ ì—†ìŒ</span>`; }
            }
        }

        async function executeJudgment(aid, sid) {
            const xp = parseInt(document.getElementById(`xp-${aid}`).value)||0;
            const cp = parseInt(document.getElementById(`cp-${aid}`).value)||0;
            const fb = document.getElementById(`fb-${aid}`).value;
            if (!confirm(`[ì‹¬íŒ í™•ì¸]\nXP: ${xp}, CP: ${cp}\nì§‘í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const { error } = await _supabase.rpc('judge_special_mission', {
                p_assign_id: aid, p_student_id: sid, p_final_xp: xp, p_final_cp: cp, p_feedback: fb
            });

            if (error) alert("ì˜¤ë¥˜: " + error.message);
            else { alert("âœ… íŒê²° ì§‘í–‰ ì™„ë£Œ"); load(); }
        }
        load();
    </script>
</body>
</html>