<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìŠ¤í˜ì…œ ìˆ™ì œ ì‹¬íŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-900 p-6 text-white min-h-screen">
    <script src="config.js"></script>
    <h1 class="text-2xl font-bold text-red-500 mb-6">âš–ï¸ ìµœí›„ì˜ ì‹¬íŒ (Special Check)</h1>
    <div id="list" class="space-y-6"></div>

    <script>
        async function load() {
            // ì œì¶œë˜ì—ˆì§€ë§Œ ì•„ì§ ì±„ì  ì•ˆ ëœ(final_score is null) ìŠ¤í˜ì…œ ìˆ™ì œ
            const { data } = await _supabase.from('assignments')
                .select('*')
                .eq('is_special', true)
                .eq('status', 'submitted')
                .is('final_score', null); // ì•„ì§ íŒê²° ì•ˆ ë‚¨

            const list = document.getElementById('list');
            if(!data || !data.length) { list.innerHTML = '<div class="text-gray-500">ì‹¬íŒí•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

            list.innerHTML = data.map(a => {
                // ì§€ê° ì²´í¬
                const deadline = new Date(a.deadline);
                const submitted = new Date(a.submitted_at);
                let timeMsg = `<span class="text-green-400">âœ… ì •ìƒ ì œì¶œ</span>`;
                let isLate = false;

                if (submitted > deadline) {
                    isLate = true;
                    const diff = submitted - deadline;
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    timeMsg = `<span class="text-red-500 font-bold">âš ï¸ [${hours}ì‹œê°„ ${mins}ë¶„] ì§€ê°!</span>`;
                }

                // ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬
                const imgs = a.submission_images || [];
                const imgHtml = imgs.map(url => `<a href="${url}" target="_blank"><img src="${url}" class="w-24 h-24 object-cover rounded border border-gray-600 hover:border-white"></a>`).join('');

                return `
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                    <div class="flex justify-between mb-4">
                        <div>
                            <div class="font-bold text-xl">${a.student_id} - ${a.title}</div>
                            <div class="text-sm mt-1">${timeMsg}</div>
                        </div>
                        <div class="text-right text-xs text-gray-400">
                            ì•½ì†ëœ ë³´ìƒ: +${a.reward_points} / ì²˜ë²Œ: -${a.penalty_points}
                        </div>
                    </div>

                    <div class="flex gap-2 mb-4 overflow-x-auto p-2 bg-black/30 rounded">${imgHtml}</div>

                    <div class="bg-gray-700 p-4 rounded-lg">
                        <div class="flex items-center gap-4 mb-2">
                            <label>ìµœì¢… í¬ì¸íŠ¸ íŒê²°:</label>
                            <input type="number" id="score-${a.id}" class="bg-gray-900 border border-gray-500 text-white p-2 rounded w-20 text-center font-bold" 
                                value="${isLate ? -a.penalty_points : a.reward_points}">
                            <span class="text-xs text-gray-400">(ì–‘ìˆ˜:ìƒ / ìŒìˆ˜:ë²Œ)</span>
                        </div>
                        <textarea id="feed-${a.id}" class="w-full bg-gray-900 border border-gray-500 text-white p-2 rounded h-20 text-sm" placeholder="íŒê²° ì´ìœ  ë° í”¼ë“œë°±..."></textarea>
                    </div>

                    <button onclick="judge(${a.id}, '${a.student_id}')" class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-bold shadow-lg">
                        ğŸ”¨ íŒê²° ì§‘í–‰ (ìŠ¹ì¸)
                    </button>
                </div>`;
            }).join('');
        }

        async function judge(aid, sid) {
            const score = parseInt(document.getElementById(`score-${aid}`).value);
            const feedback = document.getElementById(`feed-${aid}`).value;

            // 1. ê³¼ì œ ì—…ë°ì´íŠ¸
            await _supabase.from('assignments').update({ final_score: score, teacher_feedback: feedback }).eq('id', aid);

            // 2. ìœ ì € í¬ì¸íŠ¸ ë°˜ì˜
            const { data: u } = await _supabase.from('users').select('points').eq('username', sid).single();
            const newPoint = (u.points || 0) + score;
            await _supabase.from('users').update({ points: newPoint }).eq('username', sid);

            alert(`íŒê²° ì™„ë£Œ! (í•™ìƒ í¬ì¸íŠ¸ ${score > 0 ? '+' : ''}${score} ë°˜ì˜ë¨)`);
            load();
        }
        load();
    </script>
</body>
</html>