<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì„ ìƒë‹˜ í†µí•© ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f8fafc; }
        .menu-card { transition: all 0.2s; cursor: pointer; }
        .menu-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ì•Œë¦¼ í„ìŠ¤ íš¨ê³¼ */
        .inbox-pulse-red { animation: pulse-red 2s infinite; border-color: #fca5a5; background-color: #fff1f2; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.2); } 70% { box-shadow: 0 0 0 10px rgba(225, 29, 72, 0); } 100% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0); } }
        
        .inbox-pulse-yellow { animation: pulse-yellow 2s infinite; border-color: #fcd34d; background-color: #fffbeb; }
        @keyframes pulse-yellow { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.2); } 70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }

        /* ëª¨ë‹¬ */
        #modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.2); max-height: 80vh; display: flex; flex-direction: column; }
        
        /* Q-Center Modal (Larger) */
        #q-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 150; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        .q-modal-content { background: white; width: 100%; max-width: 1000px; height: 85vh; border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }

        /* ì«€ë“í•œ ì…ì²´ ë²„íŠ¼ (Grade Tabs) */
        .grade-btn {
            min-width: 60px; padding: 8px 16px; border-radius: 12px; font-weight: 800; font-size: 13px; 
            background: white; border: 2px solid #e2e8f0; color: #64748b; 
            box-shadow: 0 4px 0 #cbd5e1; transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1); 
            white-space: nowrap; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .grade-btn:active { transform: translateY(4px); box-shadow: none; }
        .grade-btn.active {
            background: linear-gradient(135deg, #6366f1, #4338ca); border-color: #3730a3; color: white; box-shadow: 0 4px 0 #312e81;
        }
        .grade-btn.active:active { transform: translateY(4px); box-shadow: none; }

        /* ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸ìš© ì«€ë“ ë²„íŠ¼ (Q-Item) */
        .q-click-btn {
            width: 100%; padding: 12px 16px; border-radius: 12px; 
            background: white; border: 2px solid #e2e8f0; color: #334155;
            box-shadow: 0 4px 0 #cbd5e1; transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer; text-align: left; position: relative;
            display: flex; justify-content: space-between; items-center;
        }
        .q-click-btn:active { transform: translateY(4px); box-shadow: none; }
        .q-click-btn:hover { border-color: #6366f1; color: #4338ca; }
        .q-click-btn.selected {
            background: #eef2ff; border-color: #6366f1; color: #4338ca;
            box-shadow: 0 2px 0 #818cf8; transform: translateY(2px);
        }

        /* Type Badges */
        .badge-high { background: #7e22ce; color: white; border: 1px solid #581c87; }
        .badge-sub { background: #059669; color: white; border: 1px solid #065f46; }
        .badge-norm { background: #3b82f6; color: white; border: 1px solid #1e40af; }
        
        /* ë¼ìš´ë“œë³„ í•™ìƒ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card-round-0 { background: white; border: 1px solid #e2e8f0; } /* ê¸°ë³¸ */
        .card-round-1 { background: #f0fdf4; border: 1px solid #86efac; } /* 1íšŒì°¨ ì™„ë£Œ (ì´ˆë¡) */
        .card-round-2 { background: #eff6ff; border: 1px solid #93c5fd; } /* 2íšŒì°¨ ì™„ë£Œ (íŒŒë‘) */
        .card-round-3 { background: #f1f5f9; border: 1px solid #cbd5e1; opacity: 0.8; } /* 3íšŒì°¨ ì´ìƒ (íšŒìƒ‰) */

        /* ìŠ¤í¬ë¡¤ë°” */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen">

    <script src="config.js"></script>

    <nav class="bg-white border-b shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2 font-bold text-xl text-indigo-700">
                <span>ğŸ«</span> Math Control Tower
            </div>
            <div class="flex items-center gap-2 text-sm">
                <span><b id="t-name" class="text-slate-800">ì„ ìƒë‹˜</b>ë‹˜</span>
                <button onclick="openManual()" class="bg-slate-100 text-slate-600 px-3 py-1.5 rounded border border-slate-200 hover:bg-slate-200 font-bold transition flex items-center gap-1"><span>ğŸ“˜</span> ê°€ì´ë“œ</button>
                <button onclick="openPwModal()" class="bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded border border-indigo-200 hover:bg-indigo-100 font-bold transition">ğŸ”’ ë¹„ë²ˆë³€ê²½</button>
                <button onclick="logout()" class="bg-slate-100 px-3 py-1.5 rounded hover:bg-slate-200 text-slate-600 font-bold transition">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-6">
        
        <h2 class="font-bold text-slate-700 mb-3 flex items-center gap-2 text-sm"><span>ğŸ“¨</span> ë„ì°©í•œ ë©”ì‹œì§€</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            <div onclick="openSpecialInbox()" id="box-special" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm cursor-pointer hover:border-red-300 transition relative overflow-hidden group flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center text-xl group-hover:scale-110 transition">ğŸ</div>
                    <div>
                        <div class="text-slate-800 font-bold">ìŠ¤í˜ì…œ ìˆ˜ì‹ í•¨</div>
                        <div class="text-xs text-slate-500">ê³¼ì œ ì œì¶œ ë° ì‹¬íŒ</div>
                    </div>
                </div>
                <div class="text-right">
                    <span id="cnt-special" class="text-2xl font-black text-slate-800">0</span>
                    <span id="badge-special" class="hidden bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold ml-1 align-top">N</span>
                </div>
            </div>

            <div onclick="openGiteukInbox()" id="box-giteuk" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm cursor-pointer hover:border-amber-300 transition relative overflow-hidden group flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-amber-50 flex items-center justify-center text-xl group-hover:scale-110 transition">ğŸ¥</div>
                    <div>
                        <div class="text-slate-800 font-bold">ê¸°íŠ¹í•œ ìˆ˜ì‹ í•¨</div>
                        <div class="text-xs text-slate-500">ììœ¨ í•™ìŠµ ì¸ì¦</div>
                    </div>
                </div>
                <div class="text-right">
                    <span id="cnt-giteuk" class="text-2xl font-black text-slate-800">0</span>
                    <span id="badge-giteuk" class="hidden bg-amber-500 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold ml-1 align-top">N</span>
                </div>
            </div>
        </div>

        <h2 class="font-bold text-slate-700 mb-3 text-sm">ğŸš€ ê´€ë¦¬ ë©”ë‰´</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div onclick="location.href='teacher_daily.html'" class="menu-card bg-white p-4 rounded-xl border-l-4 border-green-500 shadow-sm">
                <div class="text-xl mb-1">ğŸ®</div><div class="font-bold text-slate-800 text-sm">ì¼ì¼ ê´€ë¦¬</div><div class="text-[10px] text-slate-500">XP/CP ì§€ê¸‰ & ì²´í¬</div>
            </div>
            <div onclick="location.href='manager_student.html'" class="menu-card bg-white p-4 rounded-xl border-l-4 border-indigo-500 shadow-sm">
                <div class="text-xl mb-1">ğŸ‘‘</div><div class="font-bold text-slate-800 text-sm">í•™ìƒ ê´€ë¦¬</div><div class="text-[10px] text-slate-500">í•™ìƒ ë“±ë¡ & ë°°ì •</div>
            </div>
            <div onclick="location.href='manager_workbook.html'" class="menu-card bg-white p-4 rounded-xl border-l-4 border-pink-500 shadow-sm">
                <div class="text-xl mb-1">ğŸ“š</div><div class="font-bold text-slate-800 text-sm">ë¬¸ì œì§‘ ë“±ë¡</div><div class="text-[10px] text-slate-500">êµì¬ ê´€ë¦¬</div>
            </div>
            <div onclick="location.href='teacher_assign_integrated.html'" class="menu-card bg-white p-4 rounded-xl border-l-4 border-blue-500 shadow-sm">
                <div class="text-xl mb-1">ğŸ©º</div><div class="font-bold text-slate-800 text-sm">ì •ë°€ ê³¼ì œ ì¶œì œ</div><div class="text-[10px] text-slate-500">ì§„ë‹¨ê³¼ ì²˜ë°©ì„ ë™ì‹œì—</div>
            </div>
            <div onclick="location.href='teacher_test.html'" class="menu-card bg-white p-4 rounded-xl border-l-4 border-slate-500 shadow-sm hover:opacity-100">
                <div class="text-xl mb-1">ğŸ’¯</div><div class="font-bold text-slate-800 text-sm">ì§„ë‹¨í‰ê°€</div><div class="text-[10px] text-slate-500">ì‹œí—˜ì§€ ìƒì„±</div>
            </div>
            <div onclick="openGodMode()" class="menu-card bg-slate-800 p-4 rounded-xl border-l-4 border-red-500 shadow-lg hover:bg-slate-900 cursor-pointer transition transform hover:scale-105">
                <div class="text-xl mb-1">ğŸ“Š</div><div class="font-bold text-red-400 text-sm">í•™ìŠµ ì •ë°€ ì§„ë‹¨</div><div class="text-[10px] text-slate-400">ê´€ë¦¬ììš© í†µê³„ (VIP)</div>
            </div>
            <div onclick="window.open('teacher_sns.html', '_blank', 'width=1200,height=900')" class="menu-card bg-white p-4 rounded-xl border-l-4 border-teal-500 shadow-sm">
                <div class="text-xl mb-1">ğŸ‘®</div><div class="font-bold text-slate-800 text-sm">SNS ë³´ì•ˆê´€</div><div class="text-[10px] text-slate-500">í”¼ë“œ ìˆœì°° & í¬ìƒ</div>
            </div>
            <div onclick="location.href='teacher_integrated_config.html'" class="menu-card bg-white p-4 rounded-xl border-l-4 border-orange-400 shadow-sm">
                <div class="text-xl mb-1">âš™ï¸</div><div class="font-bold text-slate-800 text-sm">í†µí•© ê´€ë¦¬ ì„¼í„°</div><div class="text-[10px] text-slate-500">ê·œì¹™ & ë³´ìƒ & ì„±ì¥ ì„¤ê³„</div>
            </div>
            <div id="god-menu" onclick="location.href='admin_db_inspector.html'" class="menu-card bg-black p-4 rounded-xl border-l-4 border-yellow-400 shadow-lg hidden cursor-pointer transition transform hover:scale-105">
                <div class="text-xl mb-1">ğŸ‘ï¸</div><div class="font-bold text-yellow-400 text-sm">DB ì •ë°€ ê²€ì‚¬</div><div class="text-[10px] text-slate-400">ë°ì´í„° ëˆ„ë½ í™•ì¸</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col h-[500px]">
                <div class="flex justify-between items-center mb-4 shrink-0">
                    <h2 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                        <span>ğŸ™‹â€â™‚ï¸</span> ì‹¤ì‹œê°„ ì§ˆë¬¸ ì„¼í„° (Q-Center)
                    </h2>
                    <button onclick="fetchQuestions()" class="text-[10px] bg-slate-100 px-3 py-1.5 rounded-lg hover:bg-slate-200 font-bold text-slate-600 transition">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>
                
                <div class="flex gap-2 overflow-x-auto pb-4 mb-2 shrink-0 scrollbar-hide px-1" id="q-grade-tabs">
                    <button onclick="filterQ('all')" id="q-tab-all" class="grade-btn active">âœ¨ ì „ì²´</button>
                    <button onclick="filterQ('ì¤‘1')" id="q-tab-ì¤‘1" class="grade-btn">ì¤‘1</button>
                    <button onclick="filterQ('ì¤‘2')" id="q-tab-ì¤‘2" class="grade-btn">ì¤‘2</button>
                    <button onclick="filterQ('ì¤‘3')" id="q-tab-ì¤‘3" class="grade-btn">ì¤‘3</button>
                    <button onclick="filterQ('ê³ 1')" id="q-tab-ê³ 1" class="grade-btn">ê³ 1</button>
                    <button onclick="filterQ('ê³ 2')" id="q-tab-ê³ 2" class="grade-btn">ê³ 2</button>
                    <button onclick="filterQ('ê³ 3')" id="q-tab-ê³ 3" class="grade-btn">ê³ 3</button>
                </div>

                <div id="q-student-grid" class="flex-1 overflow-y-auto custom-scroll grid grid-cols-2 md:grid-cols-3 gap-3 content-start p-1">
                    <div class="col-span-full text-center py-20 text-slate-400 text-xs">ì§ˆë¬¸ ë¡œë”© ì¤‘...</div>
                </div>
            </div>

            <iframe src="teacher_dashboard_status.html" class="w-full h-[500px] rounded-xl shadow-lg border-0" scrolling="no"></iframe>
        </div>
    </div>

    <div id="pw-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
            <div class="space-y-3 mb-6">
                <div><label class="block text-xs font-bold text-gray-500 mb-1">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="cur-pw" class="w-full border rounded p-2 text-sm"></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="new-pw" class="w-full border rounded p-2 text-sm"></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input type="password" id="confirm-pw" class="w-full border rounded p-2 text-sm"></div>
            </div>
            <div class="flex gap-2">
                <button onclick="closePwModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded font-bold text-sm hover:bg-gray-300">ì·¨ì†Œ</button>
                <button onclick="changePassword()" class="flex-1 bg-indigo-600 text-white py-2 rounded font-bold text-sm hover:bg-indigo-700">ë³€ê²½í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal-content">
            <div id="modal-header" class="p-4 text-white flex justify-between items-center shrink-0 shadow-sm">
                <h3 class="font-bold text-base" id="modal-title">ëª©ë¡</h3>
                <button onclick="closeModal()" class="text-white/80 hover:text-white text-xl transition">Ã—</button>
            </div>
            <div id="modal-body" class="p-4 overflow-y-auto flex-1 space-y-2 bg-slate-50"></div>
        </div>
    </div>

    <div id="q-modal-overlay">
        <div class="q-modal-content">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-lg" id="qm-avatar">?</div>
                    <div>
                        <h3 class="font-bold text-lg" id="qm-name">í•™ìƒ ì´ë¦„</h3>
                        <p class="text-xs text-slate-400" id="qm-info">í•™ë…„ | í‹°ì–´</p>
                    </div>
                </div>
                <button onclick="closeQModal()" class="text-slate-400 hover:text-white text-2xl transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="flex-1 flex overflow-hidden bg-slate-50">
                <div class="w-1/3 min-w-[240px] border-r border-slate-200 bg-white flex flex-col">
                    <div class="p-3 border-b bg-slate-50 text-xs font-bold text-slate-500 flex justify-between">
                        <span>ì§ˆë¬¸ ëª©ë¡ (<span id="qm-cnt">0</span>)</span>
                    </div>
                    <div id="qm-list" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scroll"></div>
                    
                    <div class="p-3 border-t border-slate-200 bg-white space-y-2">
                        <button onclick="completeRound()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition text-sm shadow-md flex items-center justify-center gap-2">
                            <i class="fa-solid fa-flag-checkered"></i> 1íšŒ í´ë¦¬ë‹‰ ì™„ë£Œ (ìˆœí™˜)
                        </button>
                        <button onclick="closeQModal()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-500 font-bold py-2 rounded-xl transition text-xs">
                            ë©”ì¸ìœ¼ë¡œ ë³µê·€
                        </button>
                    </div>
                </div>

                <div class="flex-1 flex flex-col relative bg-slate-100">
                    <div id="qm-viewer" class="flex-1 overflow-auto flex items-center justify-center p-4">
                        <span class="text-slate-400 text-sm font-bold opacity-60">ì¢Œì¸¡ì—ì„œ ì§ˆë¬¸ì„ ë”¸ê¹! ì„ íƒí•˜ì„¸ìš”. ğŸ‘†</span>
                    </div>
                    
                    <div id="qm-actions" class="p-4 bg-white border-t border-slate-200 shrink-0 hidden shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-10">
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer p-2 rounded-lg border border-transparent hover:bg-green-50 transition select-none">
                                    <input type="radio" name="q-action" value="resolve" class="w-5 h-5 accent-green-600" checked>
                                    <div><div class="font-bold text-sm text-green-700">âœ… í•´ê²° ì™„ë£Œ</div><div class="text-[10px] text-green-600">ìˆ™ì œ í¬í•¨ & ì§ˆë¬¸ ì œê±°</div></div>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer p-2 rounded-lg border border-transparent hover:bg-yellow-50 transition select-none">
                                    <input type="radio" name="q-action" value="hold" class="w-5 h-5 accent-yellow-500">
                                    <div><div class="font-bold text-sm text-yellow-700">â³ ë³´ë¥˜ (Keep)</div><div class="text-[10px] text-yellow-600">ë‚˜ì¤‘ì— ì²˜ë¦¬ (ìœ ì§€)</div></div>
                                </label>
                            </div>
                            <button onclick="confirmQAction()" class="bg-slate-800 text-white px-8 py-3 rounded-xl font-bold hover:bg-black shadow-lg transition transform active:scale-95 flex items-center gap-2">
                                <i class="fa-solid fa-check"></i> í™•ì¸
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const user = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!user || (user.role !== 'teacher' && user.role !== 'admin')) { 
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href = 'index.html'; 
        } else {
            document.getElementById('t-name').innerText = user.name;
            if (user.username === 'ê³½ëª…ìš©ì´ë¸Œ' || user.role === 'admin') document.getElementById('god-menu').classList.remove('hidden');
        }

        function logout() { sessionStorage.clear(); location.href = 'index.html'; }

        // --- Q-Center Data ---
        let qDataAll = []; 
        let currentQFilter = 'all';
        let currentTargetQStudent = null;
        let selectedQItem = null;
        let clinicRounds = JSON.parse(sessionStorage.getItem('clinicRounds')) || {}; 

        async function loadData() {
            fetchQuestions(); checkInboxes();
        }

        async function fetchQuestions() {
            const grid = document.getElementById('q-student-grid');
            
            const { data, error } = await _supabase
                .from('student_progress')
                .select('*, users!inner(name, grade, tier)')
                .eq('is_question_active', true)
                .order('updated_at', {ascending: true});

            if (error) { console.error(error); return; }
            
            const map = {};
            data.forEach(item => {
                const sid = item.student_id;
                if (!map[sid]) {
                    map[sid] = {
                        id: sid,
                        name: item.users.name,
                        grade: item.users.grade,
                        tier: item.users.tier || 'Bronze',
                        questions: [],
                        round: clinicRounds[sid] || 0
                    };
                }
                map[sid].questions.push(item);
            });

            qDataAll = Object.values(map);
            
            qDataAll.sort((a, b) => {
                if (a.round !== b.round) return a.round - b.round;
                return b.questions.length - a.questions.length;
            });

            renderQStudents();
            loadStats(); // ì§ˆë¬¸ ê°œìˆ˜ í†µê³„ ì—…ë°ì´íŠ¸
        }

        function filterQ(grade) {
            currentQFilter = grade;
            document.querySelectorAll('.grade-btn').forEach(b => {
                b.classList.remove('active');
                if (b.id === `q-tab-${grade}`) b.classList.add('active');
            });
            renderQStudents();
        }

        function renderQStudents() {
            const grid = document.getElementById('q-student-grid');
            let list = qDataAll;
            if (currentQFilter !== 'all') list = qDataAll.filter(s => s.grade === currentQFilter);

            if (list.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-20 text-slate-400 text-xs">ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤. (ê¹¨ë—!) ğŸ‰</div>`;
                return;
            }

            grid.innerHTML = list.map(s => {
                const r = s.round;
                let cardClass = 'card-round-0';
                let badgeText = 'New';
                let badgeColor = 'bg-indigo-50 text-indigo-600';
                
                if (r === 1) { cardClass = 'card-round-1'; badgeText = '1íšŒ ì™„ë£Œ'; badgeColor = 'bg-green-100 text-green-700'; }
                else if (r === 2) { cardClass = 'card-round-2'; badgeText = '2íšŒ ì™„ë£Œ'; badgeColor = 'bg-blue-100 text-blue-700'; }
                else if (r >= 3) { cardClass = 'card-round-3'; badgeText = `${r}íšŒ ì™„ë£Œ`; badgeColor = 'bg-slate-200 text-slate-600'; }

                return `
                <div onclick="openQModal('${s.id}')" class="${cardClass} rounded-xl p-3 shadow-sm hover:shadow-md cursor-pointer transition group relative overflow-hidden border border-slate-200">
                    <div class="absolute right-0 top-0 ${badgeColor} text-[10px] font-bold px-2 py-1 rounded-bl-lg">${badgeText}</div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center font-bold text-slate-500 text-sm shadow-sm group-hover:scale-105 transition">${s.name[0]}</div>
                        <div>
                            <div class="font-bold text-slate-800 text-sm">${s.name}</div>
                            <div class="text-[10px] text-slate-400">${s.grade}</div>
                        </div>
                    </div>
                    <div class="mt-3 flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-500">ì§ˆë¬¸ ê°œìˆ˜</span>
                        <span class="bg-red-500 text-white px-2 py-0.5 rounded-lg text-xs font-black shadow-sm">${s.questions.length}</span>
                    </div>
                </div>
                `;
            }).join('');
        }

        async function openQModal(sid) {
            const s = qDataAll.find(x => x.id === sid);
            if(!s) return;
            currentTargetQStudent = s;

            document.getElementById('qm-name').innerText = s.name;
            document.getElementById('qm-info').innerText = `${s.grade} | ${s.tier} (í˜„ì¬ ${s.round}íšŒì°¨ ì™„ë£Œ)`;
            document.getElementById('qm-avatar').innerText = s.name[0];
            document.getElementById('qm-cnt').innerText = s.questions.length;
            
            const listEl = document.getElementById('qm-list');
            listEl.innerHTML = '<div class="text-center py-4"><div class="loader"></div></div>';

            // â˜… [NEW] Metadata Fetch: ë¬¸ì œ ìœ í˜•ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ ë©”íƒ€ë°ì´í„° ë¡œë“œ
            const requests = s.questions.map(q => 
                _supabase.from('problem_metadata')
                .select('workbook_id, problem_num, difficulty, is_subjective')
                .match({workbook_id: q.workbook_id, problem_num: q.problem_num})
                .single()
            );
            const results = await Promise.all(requests);
            let metaMap = {};
            results.forEach(res => {
                if(res.data) {
                    const k = `${res.data.workbook_id}-${res.data.problem_num}`;
                    metaMap[k] = res.data;
                }
            });

            listEl.innerHTML = s.questions.map((q, idx) => {
                const k = `${q.workbook_id}-${q.problem_num}`;
                const meta = metaMap[k];
                let typeBadge = '<span class="badge-norm text-[9px] px-1 rounded">ì¼ë°˜</span>';
                if (meta) {
                    if (meta.difficulty === 'high_rank') typeBadge = '<span class="badge-high text-[9px] px-1 rounded">1ë“±ê¸‰</span>';
                    else if (meta.is_subjective) typeBadge = '<span class="badge-sub text-[9px] px-1 rounded">ì„œìˆ í˜•</span>';
                }

                return `
                <div onclick="viewQDetail(${q.workbook_id}, ${q.problem_num}, this)" class="q-click-btn group" data-wb-id="${q.workbook_id}" data-p-num="${q.problem_num}">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-sm font-black group-hover:text-indigo-600">No. ${q.problem_num}</span>
                            ${typeBadge}
                        </div>
                        <div class="text-[10px] text-slate-400 font-medium">${q.workbooks?.title || 'ë¬¸ì œì§‘ ì •ë³´ ì—†ìŒ'}</div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-xs text-slate-300 group-hover:text-indigo-400"></i>
                </div>
                `;
            }).join('');

            document.getElementById('qm-viewer').innerHTML = '<span class="text-slate-400 text-sm font-bold opacity-60">ì¢Œì¸¡ì—ì„œ ì§ˆë¬¸ì„ ë”¸ê¹! ì„ íƒí•˜ì„¸ìš”. ğŸ‘†</span>';
            document.getElementById('qm-actions').classList.add('hidden');
            selectedQItem = null;

            document.getElementById('q-modal-overlay').style.display = 'flex';
        }

        function closeQModal() {
            document.getElementById('q-modal-overlay').style.display = 'none';
            fetchQuestions(); // ì§ˆë¬¸ ëª©ë¡ ê°±ì‹ 
        }

        function viewQDetail(wbId, pNum, el) {
            document.querySelectorAll('.q-click-btn').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');

            selectedQItem = { wbId, pNum, el };

            const padded = pNum.toString().padStart(4, '0');
            const url = `${SUPABASE_URL}/storage/v1/object/public/problems/${wbId}/${padded}.webp`;
            
            document.getElementById('qm-viewer').innerHTML = `
                <div class="text-center w-full h-full flex flex-col items-center justify-center animate-[fadeIn_0.2s]">
                    <div class="mb-3 text-xs font-bold text-slate-400 bg-white px-3 py-1 rounded-full shadow-sm border">Question Viewer</div>
                    <img src="${url}" class="max-w-full max-h-full object-contain shadow-2xl rounded-lg bg-white border border-slate-200" onerror="this.src='https://placehold.co/400x300?text=No+Image'">
                </div>`;
            
            document.getElementById('qm-actions').classList.remove('hidden');
            document.querySelector('input[name="q-action"][value="resolve"]').checked = true;
        }

        async function confirmQAction() {
            if (!selectedQItem || !currentTargetQStudent) return;
            const action = document.querySelector('input[name="q-action"]:checked').value;
            const btn = document.querySelector('#qm-actions button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ì²˜ë¦¬ ì¤‘...';
            btn.disabled = true;

            if (action === 'resolve') {
                try {
                    // â˜… í•µì‹¬ ë¡œì§: mark_clinic_resolved í˜¸ì¶œ (ìŠ¤íƒ¬í”„ ì°ê³  last_result='wrong'ìœ¼ë¡œ ë³€ê²½)
                    const { error } = await _supabase.rpc('mark_clinic_resolved', {
                        p_student_id: currentTargetQStudent.id,
                        p_wb_id: selectedQItem.wbId,
                        p_prob_num: selectedQItem.pNum
                    });

                    if (error) throw error;
                    
                    alert(`âœ… [No.${selectedQItem.pNum}] í•´ê²° ì²˜ë¦¬ ë° ìˆ™ì œ ìë™ ë“±ë¡ ì™„ë£Œ!`);
                    
                    // UIì—ì„œ í•´ë‹¹ ë¬¸ì œ ì œê±°
                    const qEl = selectedQItem.el;
                    qEl.style.transition = 'all 0.3s';
                    qEl.style.opacity = '0';
                    qEl.style.transform = 'translateX(-50px)';
                    setTimeout(() => {
                        qEl.remove();
                        // ë°ì´í„° ëª¨ë¸ì—ì„œë„ ì œê±°
                        const idx = currentTargetQStudent.questions.findIndex(q => q.workbook_id === selectedQItem.wbId && q.problem_num === selectedQItem.pNum);
                        if (idx > -1) currentTargetQStudent.questions.splice(idx, 1);
                        
                        // ëª¨ë‹¬ ìƒíƒœ ê°±ì‹ 
                        if (currentTargetQStudent.questions.length === 0) {
                            closeQModal();
                        } else {
                            openQModal(currentTargetQStudent.id); // ëª©ë¡ ê°±ì‹ 
                        }
                    }, 300);


                } catch(e) {
                    alert("ì²˜ë¦¬ ì‹¤íŒ¨: DB ì˜¤ë¥˜ ë°œìƒ. " + e.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }

            } else {
                alert("â³ ë³´ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤. (ë¦¬ìŠ¤íŠ¸ì— ìœ ì§€ë¨)");
                document.querySelectorAll('.q-click-btn').forEach(d => d.classList.remove('selected'));
                document.getElementById('qm-viewer').innerHTML = '<span class="text-slate-400 text-sm font-bold opacity-60">ë³´ë¥˜ë¨. ë‹¤ìŒ ì§ˆë¬¸ ì„ íƒ.</span>';
                document.getElementById('qm-actions').classList.add('hidden');
                selectedQItem = null;
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function completeRound() {
            if(!currentTargetQStudent) return;
            const sid = currentTargetQStudent.id;
            clinicRounds[sid] = (clinicRounds[sid] || 0) + 1;
            sessionStorage.setItem('clinicRounds', JSON.stringify(clinicRounds));
            alert(`[${currentTargetQStudent.name}] í•™ìƒì˜ ${clinicRounds[sid]}íšŒì°¨ í´ë¦¬ë‹‰ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            closeQModal();
        }
        // --- End Q-Center Logic ---

        // --- Inbox Logic (ê¸°ì¡´ ìœ ì§€) ---
        async function checkInboxes() {
            const { count: spCount } = await _supabase.from('assignments').select('*', { count: 'exact', head: true }).eq('is_special', true).eq('status', 'submitted').is('final_score', null);
            document.getElementById('cnt-special').innerText = spCount || 0;
            if (spCount > 0) { document.getElementById('box-special').classList.add('inbox-pulse-red'); document.getElementById('badge-special').classList.remove('hidden'); }
            else { document.getElementById('box-special').classList.remove('inbox-pulse-red'); document.getElementById('badge-special').classList.add('hidden'); }

            const { count: gtCount } = await _supabase.from('student_solutions').select('*', { count: 'exact', head: true }).eq('status', 'pending');
            document.getElementById('cnt-giteuk').innerText = gtCount || 0;
            if (gtCount > 0) { document.getElementById('box-giteuk').classList.add('inbox-pulse-yellow'); document.getElementById('badge-giteuk').classList.remove('hidden'); }
            else { document.getElementById('box-giteuk').classList.remove('inbox-pulse-yellow'); document.getElementById('badge-giteuk').classList.add('hidden'); }
        }

        async function openSpecialInbox() {
            openModal('ğŸ ìŠ¤í˜ì…œ ìˆ˜ì‹ í•¨', 'bg-red-600');
            const body = document.getElementById('modal-body'); body.innerHTML = '<div class="loader"></div>';
            const { data } = await _supabase.from('assignments').select('*').eq('is_special', true).eq('status', 'submitted').is('final_score', null).order('submitted_at', { ascending: true });
            if (!data || !data.length) { body.innerHTML = '<div class="text-center text-slate-400 py-10 text-xs">ëŒ€ê¸° ì¤‘ì¸ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
            body.innerHTML = data.map(a => `<div onclick="openDetail('special')" class="bg-white p-3 rounded-lg border border-red-100 shadow-sm cursor-pointer hover:bg-red-50 transition"><div class="flex justify-between mb-1"><div class="font-bold text-slate-800 text-sm">${a.student_id} <span class="text-xs text-slate-400 font-normal">| ${a.title}</span></div></div><div class="text-[10px] text-slate-400">${new Date(a.submitted_at).toLocaleString()}</div></div>`).join('');
        }
        async function openGiteukInbox() {
            openModal('ğŸ¥ ê¸°íŠ¹í•œ ìˆ˜ì‹ í•¨', 'bg-amber-500');
            const body = document.getElementById('modal-body'); body.innerHTML = '<div class="loader"></div>';
            const { data } = await _supabase.from('student_solutions').select('*').eq('status', 'pending').order('created_at', { ascending: true });
            if (!data || !data.length) { body.innerHTML = '<div class="text-center text-slate-400 py-10 text-xs">ëŒ€ê¸° ì¤‘ì¸ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
            body.innerHTML = data.map(s => `<div onclick="openDetail('giteuk')" class="bg-white p-3 rounded-lg border border-amber-100 shadow-sm cursor-pointer hover:bg-amber-50 transition"><div class="flex justify-between mb-1"><div class="font-bold text-slate-800 text-sm">${s.student_id}</div><span class="text-xs font-bold text-indigo-600">No. ${s.problem_num}</span></div><div class="text-[10px] text-slate-400 text-right">${new Date(s.created_at).toLocaleString()}</div></div>`).join('');
        }
        function openDetail(type) {
            const w = 1000, h = 900; const left = (screen.width - w) / 2; const top = (screen.height - h) / 2;
            const url = type === 'special' ? 'manager_check_special.html' : 'manager_challenge.html';
            window.open(url, '_blank', `width=${w},height=${h},top=${top},left=${left}`);
            closeModal(); 
        }
        function openModal(title, headerClass) { document.getElementById('modal-overlay').style.display = 'flex'; document.getElementById('modal-title').innerText = title; document.getElementById('modal-header').className = `p-4 text-white flex justify-between items-center shrink-0 shadow-sm ${headerClass}`; }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; loadData(); }
        
        function openGodMode() { window.open('admin_god_stats.html', '_blank', 'width=1250,height=950'); }
        function openManual() { window.open('teacher_manual.html', '_blank', 'width=900,height=800'); }
        function openPwModal() { document.getElementById('pw-modal').classList.remove('hidden'); }
        function closePwModal() { document.getElementById('pw-modal').classList.add('hidden'); }
        
        async function changePassword() {
            const curPw = document.getElementById('cur-pw').value; const newPw = document.getElementById('new-pw').value; const confirmPw = document.getElementById('confirm-pw').value;
            if (!curPw || !newPw || !confirmPw) return alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if (newPw !== confirmPw) return alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            const { data: userData, error: fetchError } = await _supabase.from('users').select('password').eq('username', user.username).single();
            if (fetchError || !userData) { return alert("íšŒì› ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (DB ì˜¤ë¥˜)"); }
            if (userData.password !== curPw) { return alert("í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); }
            const { error: rpcError } = await _supabase.rpc('change_password', { p_username: user.username, p_new_password: newPw });
            if (rpcError) { return alert("ë³€ê²½ ì‹¤íŒ¨: " + rpcError.message); }
            alert("âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); closePwModal();
            document.getElementById('cur-pw').value = ''; document.getElementById('new-pw').value = ''; document.getElementById('confirm-pw').value = '';
        }

        // Helper: Time Ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return "ë°©ê¸ˆ ì „";
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}ë¶„ ì „`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}ì‹œê°„ ì „`;
            return `${Math.floor(hours / 24)}ì¼ ì „`;
        }
        
        loadData();
    </script>
</body>
</html>