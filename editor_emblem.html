<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="manifest" href="site.webmanifest">
    <link rel="apple-touch-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Emblem Atelier (V16.5 SECRET GARDEN)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Orbitron:wght@900&family=Rubik+Glitch&family=Bangers&family=Exo+2:ital,wght@1,900&family=Nosifer&family=Creepster&display=swap" rel="stylesheet">
    
    <style>
        /* --- System Core --- */
        body { font-family: 'Pretendard', sans-serif; background-color: #020617; color: #f1f5f9; overflow: hidden; user-select: none; }
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }

        /* --- Stage Physics --- */
        #stage-wrapper {
            background-image: radial-gradient(#334155 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: #0f172a;
            box-shadow: inset 0 0 100px #000;
            overflow: hidden; perspective: 1200px;
        }
        
        .obj-root { position: absolute; transform-origin: center center; cursor: grab; display: flex; align-items: center; justify-content: center; width: 0; height: 0; }
        .obj-root:active { cursor: grabbing; }
        .obj-root.selected .obj-core { outline: 2px dashed #f472b6; outline-offset: 8px; z-index: 999; filter: drop-shadow(0 0 10px rgba(244, 114, 182, 0.8)); }

        .effect-wrapper { position: absolute; display: flex; align-items: center; justify-content: center; transform-style: preserve-3d; will-change: transform, filter, opacity; width: 0; height: 0; }
        .obj-orbit, .obj-spin { position: absolute; display: flex; align-items: center; justify-content: center; transform-style: preserve-3d; will-change: transform; }
        .obj-core { position: relative; display: flex; align-items: center; justify-content: center; text-align: center; line-height: 1; white-space: nowrap; -webkit-user-select: none; user-select: none; }
        .obj-core img { pointer-events: none; -webkit-user-drag: none; max-width: none; }

        /* --- VITAL ANIMATIONS (Motion) --- */
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }
        @keyframes heartbeat { 0% {transform: scale(1);} 14% {transform: scale(1.3);} 28% {transform: scale(1);} 42% {transform: scale(1.3);} 70% {transform: scale(1);} }
        @keyframes rubberBand { 0% {transform: scale3d(1,1,1);} 30% {transform: scale3d(1.25,0.75,1);} 40% {transform: scale3d(0.75,1.25,1);} 50% {transform: scale3d(1.15,0.85,1);} 65% {transform: scale3d(0.95,1.05,1);} 75% {transform: scale3d(1.05,0.95,1);} 100% {transform: scale3d(1,1,1);} }
        @keyframes swing { 20% {transform: rotate3d(0,0,1,15deg);} 40% {transform: rotate3d(0,0,1,-10deg);} 60% {transform: rotate3d(0,0,1,5deg);} 80% {transform: rotate3d(0,0,1,-5deg);} 100% {transform: rotate3d(0,0,1,0deg);} }
        @keyframes tada { 0% {transform: scale3d(1,1,1);} 10%, 20% {transform: scale3d(0.9,0.9,0.9) rotate3d(0,0,1,-3deg);} 30%, 50%, 70%, 90% {transform: scale3d(1.1,1.1,1.1) rotate3d(0,0,1,3deg);} 40%, 60%, 80% {transform: scale3d(1.1,1.1,1.1) rotate3d(0,0,1,-3deg);} 100% {transform: scale3d(1,1,1);} }
        @keyframes wobble { 0% {transform: none} 15% {transform: translate3d(-25%,0,0) rotate3d(0,0,1,-5deg)} 30% {transform: translate3d(20%,0,0) rotate3d(0,0,1,3deg)} 45% {transform: translate3d(-15%,0,0) rotate3d(0,0,1,-3deg)} 60% {transform: translate3d(10%,0,0) rotate3d(0,0,1,2deg)} 75% {transform: translate3d(-5%,0,0) rotate3d(0,0,1,-1deg)} 100% {transform: none} }
        @keyframes jello { 0%,11.1%,to {transform:translateZ(0)} 22.2% {transform:skewX(-12.5deg) skewY(-12.5deg)} 33.3% {transform:skewX(6.25deg) skewY(6.25deg)} 44.4% {transform:skewX(-3.125deg) skewY(-3.125deg)} 55.5% {transform:skewX(1.5625deg) skewY(1.5625deg)} 66.6% {transform:skewX(-.78125deg) skewY(-.78125deg)} 77.7% {transform:skewX(.390625deg) skewY(.390625deg)} 88.8% {transform:skewX(-.1953125deg) skewY(-.1953125deg)} }
        @keyframes bounce { 0%, 20%, 53%, 80%, 100% {transform: translate3d(0,0,0);} 40%, 43% {transform: translate3d(0, -30px, 0);} 70% {transform: translate3d(0, -15px, 0);} 90% {transform: translate3d(0,-4px,0);} }
        @keyframes flip { from {transform: perspective(400px) scale3d(1, 1, 1) translate3d(0, 0, 0) rotate3d(0, 1, 0, -360deg);} 40%, 50% {transform: perspective(400px) scale3d(1, 1, 1) translate3d(0, 0, 0) rotate3d(0, 1, 0, -190deg);} 80% {transform: perspective(400px) scale3d(0.95, 0.95, 0.95) translate3d(0, 0, 0) rotate3d(0, 1, 0, 0deg);} 100% {transform: perspective(400px) scale3d(1, 1, 1) translate3d(0, 0, 0) rotate3d(0, 1, 0, 0deg);} }
        @keyframes zoomInOut { 0% {transform: scale(1);} 50% {transform: scale(1.5);} 100% {transform: scale(1);} }
        @keyframes panic { 0% {transform: translate(0,0) rotate(0deg);} 25% {transform: translate(5px,5px) rotate(5deg);} 50% {transform: translate(0,0) rotate(0eg);} 75% {transform: translate(-5px,5px) rotate(-5deg);} 100% {transform: translate(0,0) rotate(0deg);} }
        @keyframes breath { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
        @keyframes barrel { 0% {transform: rotateX(0deg);} 100% {transform: rotateX(360deg);} }
        @keyframes compress { 0% {transform: scaleY(1);} 50% {transform: scaleY(0.5);} 100% {transform: scaleY(1);} }
        @keyframes blackHole { 0% {transform: scale(1) rotate(0deg);} 50% {transform: scale(0.1) rotate(180deg); opacity: 0.5;} 100% {transform: scale(1) rotate(360deg); opacity: 1;} }
        @keyframes tornado { 0% {transform: translateX(-50px) rotateY(0deg);} 50% {transform: translateX(50px) rotateY(180deg) scale(1.2);} 100% {transform: translateX(-50px) rotateY(360deg);} }
        @keyframes teleport { 0% {opacity:1; transform: scale(1);} 49% {opacity:1; transform: scale(0.1);} 50% {opacity:0; transform: scale(0.1);} 51% {opacity:0; transform: scale(1.5);} 52% {opacity:1; transform: scale(1);} 100% {opacity:1;} }
        @keyframes orbit3d { 0% {transform: rotate3d(1,1,1,0deg);} 100% {transform: rotate3d(1,1,1,360deg);} }
        @keyframes glitch-skew { 0% {transform: skew(0deg);} 20% {transform: skew(-10deg);} 40% {transform: skew(10deg);} 60% {transform: skew(-5deg);} 80% {transform: skew(5deg);} 100% {transform: skew(0deg);} }
        @keyframes vibrate { 0% {transform: translate(0);} 20% {transform: translate(-2px, 2px);} 40% {transform: translate(-2px, -2px);} 60% {transform: translate(2px, 2px);} 80% {transform: translate(2px, -2px);} 100% {transform: translate(0);} }
        @keyframes float-h { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(-20px); } }
        @keyframes pendulum { 0% { transform: rotate(20deg); } 50% { transform: rotate(-20deg); } 100% { transform: rotate(20deg); } }
        @keyframes quake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        @keyframes stretch { 0% { transform: scale(1, 1); } 50% { transform: scale(1.5, 0.5); } 100% { transform: scale(1, 1); } }
        @keyframes spiral { 0% { transform: rotate(0deg) scale(1) translateX(10px); } 50% { transform: rotate(180deg) scale(0.5) translateX(10px); } 100% { transform: rotate(360deg) scale(1) translateX(10px); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
        @keyframes scan-h { 0% { transform: translateX(-10%); } 50% { transform: translateX(10%); } 100% { transform: translateX(-10%); } }
        @keyframes zigzag { 0% { transform: translate(0,0); } 25% { transform: translate(10px, -10px); } 50% { transform: translate(0, -20px); } 75% { transform: translate(-10px, -10px); } 100% { transform: translate(0,0); } }

        /* --- FX ANIMATIONS (Visual) --- */
        @keyframes fire { 0% { filter: drop-shadow(0 0 2px orangered); } 50% { filter: drop-shadow(0 -5px 5px yellow); } 100% { filter: drop-shadow(0 0 2px orangered); } }
        @keyframes sparkle { 0% { filter: brightness(100%); } 50% { filter: brightness(150%) drop-shadow(0 0 5px white); } 100% { filter: brightness(100%); } }
        @keyframes neon-pulse { 0% { filter: drop-shadow(0 0 2px cyan); } 50% { filter: drop-shadow(0 0 10px magenta); } 100% { filter: drop-shadow(0 0 2px cyan); } }
        @keyframes glitch-filter { 0% { clip-path: inset(50% 0 30% 0); transform: translate(-5px,0); } 100% { clip-path: inset(0 0 0 0); transform: translate(0); } }
        @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
        @keyframes blurPulse { 0% { filter: blur(0px); } 50% { filter: blur(4px); } 100% { filter: blur(0px); } }
        @keyframes invertFlash { 0% { filter: invert(0%); } 50% { filter: invert(100%); } 100% { filter: invert(0%); } }
        @keyframes sepiaDream { 0% { filter: sepia(0%); } 50% { filter: sepia(100%); } 100% { filter: sepia(0%); } }
        @keyframes brightnessFlash { 0% { filter: brightness(1); } 50% { filter: brightness(3) drop-shadow(0 0 10px white); } 100% { filter: brightness(1); } }
        @keyframes grayscalePulse { 0% { filter: grayscale(0%); } 50% { filter: grayscale(100%); } 100% { filter: grayscale(0%); } }
        @keyframes radioactive { 0% { filter: drop-shadow(0 0 2px lime); } 50% { filter: drop-shadow(0 0 10px #0f0) hue-rotate(90deg); } 100% { filter: drop-shadow(0 0 2px lime); } }
        @keyframes ice { 0% { filter: drop-shadow(0 0 2px cyan) hue-rotate(180deg) brightness(1.2); } 100% { filter: drop-shadow(0 0 5px white) hue-rotate(180deg) brightness(1.2); } }
        @keyframes shadowClone { 0% { filter: drop-shadow(5px 5px 0px rgba(0,0,0,0.5)); } 50% { filter: drop-shadow(-5px -5px 0px rgba(255,0,0,0.5)); } 100% { filter: drop-shadow(5px 5px 0px rgba(0,0,0,0.5)); } }
        @keyframes midas { 0% { filter: sepia(1) saturate(5) brightness(1); } 50% { filter: sepia(1) saturate(5) brightness(1.5) drop-shadow(0 0 5px gold); } 100% { filter: sepia(1) saturate(5) brightness(1); } }
        @keyframes matrix { 0% { filter: drop-shadow(0 0 2px #0f0) hue-rotate(0deg) contrast(1.5); } 50% { filter: drop-shadow(0 0 5px #0f0) hue-rotate(20deg) contrast(2); } 100% { filter: drop-shadow(0 0 2px #0f0) hue-rotate(0deg) contrast(1.5); } }
        @keyframes thermal { 0% { filter: contrast(1.5) hue-rotate(0deg); } 50% { filter: contrast(2) hue-rotate(180deg) invert(1); } 100% { filter: contrast(1.5) hue-rotate(360deg); } }
        @keyframes hologram { 0% { filter: drop-shadow(0 0 2px cyan) opacity(0.8); } 20% { filter: drop-shadow(2px 0 5px cyan) opacity(0.6) blur(1px); } 40% { filter: drop-shadow(-2px 0 5px cyan) opacity(0.8); } 100% { filter: drop-shadow(0 0 2px cyan) opacity(0.8); } }
        @keyframes noir { 0% { filter: grayscale(1) contrast(1.5) brightness(0.8); } 100% { filter: grayscale(1) contrast(2) brightness(0.6); } }
        @keyframes pixelate { 0% { filter: contrast(1); } 50% { filter: contrast(3) brightness(1.2); } 100% { filter: contrast(1); } } 
        @keyframes underwater { 0% { filter: blur(1px) hue-rotate(180deg) brightness(0.8); } 50% { filter: blur(2px) hue-rotate(200deg) brightness(1); } 100% { filter: blur(1px) hue-rotate(180deg) brightness(0.8); } }
        @keyframes divine { 0% { filter: drop-shadow(0 0 5px gold) brightness(1.2); } 50% { filter: drop-shadow(0 0 20px white) brightness(2); } 100% { filter: drop-shadow(0 0 5px gold) brightness(1.2); } }
        @keyframes nightmare { 0% { filter: contrast(2) hue-rotate(0deg) drop-shadow(5px 0 0 red); } 50% { filter: contrast(2) hue-rotate(10deg) drop-shadow(-5px 0 0 blue); } 100% { filter: contrast(2) hue-rotate(0deg) drop-shadow(5px 0 0 red); } }
        @keyframes blood { 0% { filter: drop-shadow(0 0 0 red); } 50% { filter: drop-shadow(0 10px 5px crimson); } 100% { filter: drop-shadow(0 0 0 red); } }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        @keyframes scanline { 0% { filter: brightness(1); } 50% { filter: brightness(1.2) drop-shadow(0 2px 0 rgba(0,255,0,0.5)); } 100% { filter: brightness(1); } }
        @keyframes vignette { 0% { filter: brightness(1); } 100% { filter: brightness(0.6); } }

        @keyframes orbit-cw { from { transform: rotate(0deg) translateX(var(--orbit-r)) rotate(0deg); } to { transform: rotate(360deg) translateX(var(--orbit-r)) rotate(-360deg); } }
        @keyframes spin-z { from { transform: rotateZ(0deg); } to { transform: rotateZ(360deg); } }
        @keyframes spin-y { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }
        @keyframes spin-x { from { transform: rotateX(0deg); } to { transform: rotateX(360deg); } }

        /* UI Styles */
        .effect-toggle { 
            padding: 8px 12px; border-radius: 8px; font-size: 10px; font-weight: 700; cursor: pointer; 
            border: 1px solid #334155; background: #0f172a; color: #94a3b8; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; height: 100%; min-height: 50px;
            position: relative;
        }
        .effect-toggle i { font-size: 16px; margin-bottom: 2px; }
        .effect-toggle:hover { border-color: #64748b; color: #e2e8f0; background: #1e293b; }
        .effect-toggle.active { background: linear-gradient(135deg, #db2777, #be185d); border-color: #f472b6; color: white; box-shadow: 0 4px 12px rgba(219, 39, 119, 0.4); transform: translateY(-1px); }
        .effect-toggle.active.fx { background: linear-gradient(135deg, #ea580c, #c2410c); border-color: #fb923c; box-shadow: 0 4px 12px rgba(234, 88, 12, 0.4); }
        .effect-toggle.active.blend { background: linear-gradient(135deg, #7c3aed, #4f46e5); border-color: #818cf8; box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4); }

        .active-effect-item { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 8px; margin-bottom: 6px; display: flex; flex-direction: column; gap: 4px; }
        .active-effect-item .header { display: flex; justify-content: space-between; align-items: center; }
        .active-effect-item .name { font-size: 10px; font-weight: bold; color: #e2e8f0; display: flex; align-items: center; gap: 6px; }
        .active-effect-item .slider-row { display: flex; align-items: center; gap: 8px; }
        .active-effect-item .label-col { width: 35px; font-size: 8px; font-weight: bold; color: #64748b; }
        .active-effect-item .val-col { font-size: 9px; color: #94a3b8; font-family: monospace; width: 30px; text-align: right; }

        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: #e2e8f0; border: 2px solid #ec4899; cursor: pointer; margin-top: -5px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: transform 0.1s; }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }
        .fx-slider input[type=range]::-webkit-slider-thumb { border-color: #f97316; }
        .blend-slider input[type=range]::-webkit-slider-thumb { border-color: #8b5cf6; }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; backdrop-filter: blur(8px); justify-content: center; align-items: center; }
        .modal-content { width: 90%; max-width: 1000px; height: 90%; background: #1e293b; border-radius: 20px; border: 1px solid #475569; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 60px rgba(0,0,0,0.6); animation: popUp 0.25s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        
        #help-popup { display: none; position: absolute; width: 320px; top: 100px; left: 400px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); border: 1px solid #4f46e5; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.6); z-index: 9999; overflow: hidden; animation: popUp 0.2s; }
        #help-popup .header { background: #312e81; padding: 12px; cursor: grab; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #4338ca; }
        #help-popup .header:active { cursor: grabbing; }
        #help-popup .content { padding: 16px; max-height: 400px; overflow-y: auto; color: #cbd5e1; font-size: 12px; line-height: 1.5; }
        
        .market-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 12px; padding: 20px; overflow-y: auto; align-content: start; }
        .market-item { aspect-ratio: 1; background: #334155; border: 1px solid #475569; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 36px; cursor: pointer; transition: all 0.15s ease-out; position: relative; overflow: hidden; }
        .market-item:hover { background: #4f46e5; border-color: #818cf8; transform: translateY(-3px) scale(1.05); color: white; z-index: 10; box-shadow: 0 10px 20px rgba(79, 70, 229, 0.4); }
        
        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .loader { border: 4px solid #334155; border-top: 4px solid #f472b6; border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite; margin-bottom: 16px; box-shadow: 0 0 20px rgba(244, 114, 182, 0.3); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* [ELITE SECRETARY] Draggable Preview Styles */
        #live-preview-card { 
            position: absolute; top: 24px; right: 24px; width: 340px; 
            background: rgba(255,255,255,0.95); border-radius: 24px; padding: 24px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); 
            z-index: 50; 
            transition: opacity 0.3s; backdrop-filter: blur(10px);
            /* Important: Allow interaction for dragging */
            pointer-events: auto; 
        }
        #live-preview-card .drag-header { cursor: grab; display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        #live-preview-card .drag-header:active { cursor: grabbing; }
    </style>
</head>
<body class="flex h-screen text-sm">
    <script src="config.js"></script>
    <div id="loading-overlay"><div class="loader"></div><div class="text-white font-bold text-base tracking-widest">Ï≤òÎ¶¨Ï§ë...</div></div>

    <div id="help-popup">
        <div class="header" id="help-header">
            <span class="font-bold text-white"><i class="fa-solid fa-circle-info mr-2 text-cyan-400"></i>Í∞ÄÏù¥Îìú</span>
            <button onclick="document.getElementById('help-popup').style.display='none'" class="text-indigo-200 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="content" id="help-content"></div>
    </div>

    <div class="w-80 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0 z-20 shadow-2xl">
        <div class="p-5 border-b border-slate-800 bg-slate-950 relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-br from-indigo-900/20 to-pink-900/20 pointer-events-none"></div>
            <h1 class="font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 text-xl tracking-tighter relative z-10">
                <i class="fa-solid fa-flask mr-2 text-white"></i>Ïó†Î∏îÎüº Ïó∞Íµ¨ÏÜå
            </h1>
            <div class="flex justify-between items-center mt-2 relative z-10">
                <p class="text-[10px] text-slate-500 font-mono">V16.5 (SECRET GARDEN)</p>
                <div class="flex gap-1"><div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div><span class="text-[9px] text-green-500 font-bold">ONLINE</span></div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-3 border-b border-slate-800 h-1/4 custom-scroll">
            <div class="flex justify-between items-center mb-3 px-1"><span class="text-xs font-black text-slate-400 tracking-wider">ÌòÑÏû¨ Î†àÏù¥Ïñ¥</span><button onclick="clearCanvas()" class="text-[10px] font-bold text-rose-500 hover:text-rose-400 transition bg-rose-500/10 px-2 py-1 rounded">Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî</button></div>
            <div id="layer-list" class="space-y-2"></div>
        </div>

        <div id="prop-panel" class="flex-1 bg-slate-900 overflow-y-auto hidden flex flex-col custom-scroll">
            <div class="p-4 bg-slate-950 border-b border-slate-800 flex justify-between items-center sticky top-0 z-10 shadow-lg">
                <span class="text-xs font-black text-pink-500 tracking-widest"><i class="fa-solid fa-sliders mr-1"></i> ÏÜçÏÑ± Ï†úÏñ¥</span>
                <div class="flex gap-2">
                    <button onclick="centerLayer()" class="text-xs text-white bg-cyan-600 px-2 py-1 rounded hover:bg-cyan-500 transition" title="Ï§ëÏïô Ï†ïÎ†¨"><i class="fa-solid fa-crosshairs"></i></button>
                    <button onclick="randomizeLayer()" class="text-xs text-white bg-indigo-600 px-2 py-1 rounded hover:bg-indigo-500 transition" title="ÎûúÎç§ Ìö®Í≥º"><i class="fa-solid fa-dice"></i></button>
                    <button onclick="deleteLayer()" class="text-xs text-slate-400 hover:text-rose-500 transition"><i class="fa-solid fa-trash-can"></i></button>
                </div>
            </div>
            <div class="p-5 space-y-8 pb-32">
                <div class="space-y-3">
                    <label class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Í∏∞Î≥∏ ÏÑ§Ï†ï</label>
                    <div class="flex gap-3 items-center">
                        <input type="color" id="p-color" class="w-10 h-10 rounded-lg cursor-pointer bg-slate-800 border border-slate-600 p-1" onchange="updateProp('color', this.value)">
                        
                        <div class="flex-1 space-y-1">
                            <div class="flex justify-between text-[9px] text-slate-500">
                                <span>ÌÅ¨Í∏∞ (Ïä§ÌîÑÎßÅ)</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-pink-400" id="p-size-val">100%</span>
                                    <button onclick="resetSize()" class="text-[9px] bg-slate-700 text-slate-300 px-1.5 rounded hover:bg-slate-600 transition" title="100% Î¶¨ÏÖã"><i class="fa-solid fa-rotate-left"></i></button>
                                </div>
                            </div>
                            <div class="relative flex items-center h-6 bg-slate-800 rounded-full border border-slate-700 px-2">
                                <div class="absolute left-2 text-[8px] text-slate-500"><i class="fa-solid fa-minus"></i> Ï∂ïÏÜå</div>
                                <div class="absolute right-2 text-[8px] text-slate-500">ÌôïÎåÄ <i class="fa-solid fa-plus"></i></div>
                                <input type="range" id="p-spring-zoom" min="-10" max="10" value="0" step="1"
                                       class="w-full h-full opacity-0 cursor-ew-resize absolute inset-0 z-10"
                                       oninput="handleSpringZoom(this.value)"
                                       onmouseup="resetSpringZoom(this)"
                                       ontouchend="resetSpringZoom(this)">
                                <div id="spring-thumb" class="w-4 h-4 bg-pink-500 rounded-full shadow-lg absolute left-1/2 -translate-x-1/2 transition-transform duration-75 pointer-events-none border-2 border-white"></div>
                            </div>
                        </div>
                    </div>

                    <div id="text-control" class="hidden"><input type="text" id="p-text" class="w-full bg-slate-800 border border-slate-700 rounded-lg text-xs p-3 text-white focus:border-pink-500 outline-none transition" oninput="updateProp('content', this.value)" placeholder="ÌÖçÏä§Ìä∏ ÏûÖÎ†•..."></div>
                    <div id="texture-control" class="grid grid-cols-5 gap-2 pt-1">
                        <div onclick="applyTexture('none')" class="h-8 rounded-md bg-slate-700 border-2 border-transparent hover:border-white transition" title="ÏóÜÏùå"></div>
                        <div onclick="applyTexture('gold')" class="h-8 rounded-md bg-gradient-to-br from-yellow-300 to-amber-600 border-2 border-transparent hover:border-white transition" title="Í≥®Îìú"></div>
                        <div onclick="applyTexture('silver')" class="h-8 rounded-md bg-gradient-to-br from-gray-300 to-slate-600 border-2 border-transparent hover:border-white transition" title="Ïã§Î≤Ñ"></div>
                        <div onclick="applyTexture('magma')" class="h-8 rounded-md bg-gradient-to-t from-red-600 to-yellow-400 border-2 border-transparent hover:border-white transition" title="ÎßàÍ∑∏Îßà"></div>
                        <div onclick="applyTexture('neon')" class="h-8 rounded-md bg-gradient-to-r from-cyan-400 to-fuchsia-500 border-2 border-transparent hover:border-white transition" title="ÎÑ§Ïò®"></div>
                    </div>
                </div>

                <hr class="border-slate-800">

                <div class="space-y-3">
                    <label class="text-[10px] text-indigo-400 font-bold uppercase tracking-wider"><i class="fa-solid fa-layer-group mr-1"></i> Î∏îÎ†åÎìú (ÌïÑÌÑ∞ Ìö®Í≥º)</label>
                    <div class="grid grid-cols-4 gap-2" id="blend-toggles"></div>
                    <div id="active-blend-list" class="mt-3 space-y-2"></div>
                </div>

                <div class="space-y-3">
                    <label class="text-[10px] text-green-400 font-bold uppercase tracking-wider"><i class="fa-solid fa-heart-pulse mr-1"></i> Î™®ÏÖò (ÏõÄÏßÅÏûÑ)</label>
                    <div class="grid grid-cols-4 gap-2" id="vital-toggles"></div>
                    <div id="active-vital-list" class="mt-3 space-y-2"></div>
                </div>

                <div class="space-y-3">
                    <label class="text-[10px] text-orange-400 font-bold uppercase tracking-wider"><i class="fa-solid fa-wand-magic-sparkles mr-1"></i> FX (ÌäπÏàòÌö®Í≥º)</label>
                    <div class="grid grid-cols-4 gap-2" id="fx-toggles"></div>
                    <div id="active-fx-list" class="mt-3 space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-1 flex flex-col relative bg-slate-950">
        <div class="h-16 bg-slate-900 border-b border-slate-800 flex items-center justify-center px-6 shrink-0 z-10 shadow-lg relative">
            <div class="absolute left-6 flex gap-4 items-center">
                <button onclick="openMarket()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2.5 rounded-xl font-bold text-xs flex items-center gap-2 shadow-lg shadow-indigo-900/50 transition transform hover:-translate-y-0.5"><i class="fa-solid fa-store"></i> ÎßàÏºì Ïó¥Í∏∞</button>
                <div class="flex items-center gap-2 bg-slate-800/50 p-1.5 rounded-xl border border-slate-700"><input type="text" id="quick-text" placeholder="ÌÖçÏä§Ìä∏..." class="bg-transparent border-none text-white text-xs px-2 w-24 focus:outline-none placeholder-slate-500"><button onclick="addTextLayer()" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-3 py-1.5 rounded-lg text-xs font-bold transition">Ï∂îÍ∞Ä</button></div>
            </div>
            
            <div class="text-[10px] text-slate-500 font-mono flex gap-4">
                <span><i class="fa-solid fa-mouse mr-1"></i>ÎìúÎûòÍ∑∏: Ïù¥Îèô</span>
                <span><i class="fa-solid fa-arrows-left-right mr-1"></i>Ïä§ÌîÑÎßÅ: ÌÅ¨Í∏∞Ï°∞Ï†à</span>
            </div>

            <div class="absolute right-6 flex gap-3">
                <button onclick="togglePreview()" class="text-pink-400 hover:text-white px-4 py-2 rounded-lg font-bold text-xs flex items-center gap-2 transition border border-pink-500/30 hover:bg-pink-500/20"><i class="fa-solid fa-eye"></i> ÎØ∏Î¶¨Î≥¥Í∏∞</button>
                <button onclick="randomizeLayer()" class="btn-chaos text-white px-4 py-2 rounded-lg font-bold text-xs flex items-center gap-2 transition shadow-lg shadow-purple-900/50 animate-pulse"><i class="fa-solid fa-shuffle"></i> ÎûúÎç§</button>
                <button onclick="openLibraryModal()" class="text-slate-400 hover:text-white px-4 py-2 rounded-lg font-bold text-xs flex items-center gap-2 transition"><i class="fa-solid fa-box-archive"></i> Î≥¥Í¥ÄÌï®</button>
                <button onclick="saveToLibrary()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2.5 rounded-xl font-bold text-xs shadow-lg shadow-emerald-900/50 transition transform hover:-translate-y-0.5 flex items-center gap-2"><i class="fa-solid fa-floppy-disk"></i> Ï†ÄÏû•</button>
            </div>
        </div>
        <div id="stage-wrapper" class="flex-1 relative flex items-center justify-center cursor-crosshair">
            <div class="absolute inset-0 pointer-events-none opacity-20"><div class="absolute top-1/2 w-full h-[1px] bg-cyan-500/50"></div><div class="absolute left-1/2 h-full w-[1px] bg-cyan-500/50"></div><div class="absolute top-1/2 left-1/2 w-[400px] h-[400px] -translate-x-1/2 -translate-y-1/2 border border-cyan-500/30 rounded-full border-dashed"></div></div>
            <div id="stage" class="w-full h-full relative pointer-events-none transform-style-3d"></div>
            
            <div id="live-preview-card">
                <div class="drag-header" id="preview-header">
                    <div class="flex items-center gap-2 text-xs font-black text-slate-400 tracking-widest"><span class="w-2 h-2 rounded-full bg-rose-500 animate-pulse"></span> ÎØ∏Î¶¨Î≥¥Í∏∞</div>
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-grip-lines text-slate-300 cursor-grab hover:text-white" title="Ïù¥Îèô"></i>
                        <button onclick="togglePreview()" class="text-slate-400 hover:text-rose-500"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-2"><div class="flex items-center gap-2"><span class="text-lg font-black text-slate-800">ÎãâÎÑ§ÏûÑ</span><span class="bg-indigo-100 text-indigo-600 text-[10px] font-bold px-2 py-0.5 rounded-full border border-indigo-200">Lv.99</span></div><div class="text-[10px] font-bold text-slate-400 border border-slate-200 px-2 py-1 rounded-lg">Ï†ÑÏÑ§</div></div>
                <div class="relative w-full h-48 bg-slate-50 rounded-xl border border-slate-200 flex items-center justify-center overflow-visible mb-4 shadow-inner"><div id="preview-stage" class="w-40 h-40 relative flex items-center justify-center"></div></div>
                <div class="space-y-1"><div class="flex justify-between text-[10px] font-bold text-slate-400"><span>Í≤ΩÌóòÏπò</span><span>99.9%</span></div><div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full w-[99%] bg-gradient-to-r from-indigo-400 to-purple-500"></div></div></div>
            </div>
        </div>
    </div>

    <div id="market-modal" class="modal-overlay"><div class="modal-content"><div class="flex justify-between items-center p-5 bg-slate-950 border-b border-slate-800 shrink-0"><h2 class="text-xl font-black text-white tracking-tight"><i class="fa-solid fa-basket-shopping text-pink-500 mr-3"></i>ÏóêÏÖã ÎßàÏºì</h2><button onclick="closeModal('market-modal')" class="text-slate-500 hover:text-white transition text-2xl"><i class="fa-solid fa-xmark"></i></button></div><div class="market-header flex gap-1 p-2 bg-slate-900 border-b border-slate-800 overflow-x-auto custom-scroll"></div><div id="market-grid" class="market-grid custom-scroll flex-1 bg-slate-900/50"></div></div></div>
    <div id="library-modal" class="modal-overlay"><div class="modal-content max-w-2xl h-3/4"><div class="flex justify-between items-center p-5 bg-slate-950 border-b border-slate-800 shrink-0"><h2 class="text-xl font-black text-white tracking-tight"><i class="fa-solid fa-server text-emerald-500 mr-3"></i>ÌÅ¥ÎùºÏö∞Îìú Î≥¥Í¥ÄÌï®</h2><button onclick="closeModal('library-modal')" class="text-slate-500 hover:text-white transition text-2xl"><i class="fa-solid fa-xmark"></i></button></div><div id="library-list" class="flex-1 overflow-y-auto p-4 bg-slate-900 custom-scroll space-y-2"></div></div></div>

    <script>
        /**
         * V16.5: SECRET GARDEN EDITION
         * - Feature: Draggable & Togglable Live Preview ("Stripping the Panties")
         * - Update: Replaced "Eve" with "Secret Recipe"
         * - Content: Added new Blend modes, Vital motions, and FX
         */
        let layers = []; let selectedId = null; let isDragging = false; let dragTargetId = null;

        // ‚òÖ MASTER DATA REGISTRY (Expanded)
        const EFFECT_DATA = {
            vital: [
                {id:'pulse', icon:'üíì', label:'ÎëêÍ∑ºÎëêÍ∑º', desc: "ÏùºÏ†ïÌïú Î∞ïÏûêÎ°ú Ïª§Ï°åÎã§ ÏûëÏïÑÏßëÎãàÎã§.", recipe: "Í∞ÄÏû• Î¨¥ÎÇúÌïòÍ≥† ÏÉùÎèôÍ∞ê ÎÑòÏπòÎäî Í∏∞Î≥∏ Ìö®Í≥º."},
                {id:'heartbeat', icon:'üíó', label:'Ïã¨Ïû•Î∞ïÎèô', desc: "ÎëêÍ∑º! ÎëêÍ∑º! Ïã§Ï†ú Ïã¨Ïû• Î∞ïÎèôÏ≤òÎüº ÎúÅÎãàÎã§.", recipe: "ÌïòÌä∏ ÏïÑÏù¥ÏΩòÏù¥ÎÇò ÏÉùÎ™ÖÎ†• ÌëúÏãúÏóê Îî±!"},
                {id:'rubberBand', icon:'ü™Ä', label:'Í≥†Î¨¥Ï§Ñ', desc: "Í≥†Î¨¥Ï§ÑÏ≤òÎüº ÏñëÏòÜÏúºÎ°ú ÌåÖ~ ÌïòÍ≥† ÎäòÏñ¥ÎÇ©ÎãàÎã§.", recipe: "Ïû•ÎÇúÏä§ÎüΩÍ≥† Í∑ÄÏó¨Ïö¥ ÎäêÎÇåÏùÑ Ï§Ñ Îïå."},
                {id:'tada', icon:'üéâ', label:'ÏßúÏûî!', desc: "ÏßúÏûî~ ÌïòÍ≥† Îì±Ïû•ÌïòÎäî ÎìØÌïú Î™®ÏÖòÏûÖÎãàÎã§.", recipe: "Î†àÎ≤®ÏóÖÏù¥ÎÇò ÌöçÎìù Ïãú Í∞ïÏ°∞Ìï† Îïå."},
                {id:'swing', icon:'üé™', label:'Í∑∏ÎÑ§', desc: "Ï≤úÏû•Ïóê Îß§Îã¨Î¶∞ Í∑∏ÎÑ§Ï≤òÎüº ÏÇ¥ÎûëÏÇ¥Îûë ÌùîÎì§Î¶ΩÎãàÎã§.", recipe: "Í∞ÑÌåêÏù¥ÎÇò Îß§Îã¨Î¶∞ Î¨ºÏ≤¥ ÌëúÌòÑÏóê Íµø."},
                {id:'float', icon:'‚òÅÔ∏è', label:'Îë•Îë•', desc: "Í≥µÏ§ëÏóê Îë•Îë• Îñ† ÏûàÎäî Í≤ÉÏ≤òÎüº ÏúÑÏïÑÎûòÎ°ú ÏõÄÏßÅÏûÖÎãàÎã§.", recipe: "Íµ¨Î¶Ñ, Ïú†Î†π, ÎπÑÌñâ Î¨ºÏ≤¥Ïóê ÌïÑÏàò."},
                {id:'ghost', icon:'üëª', label:'Ïú†Î†π', desc: "Ìà¨Î™ÖÌï¥Ï°åÎã§Í∞Ä ÎÇòÌÉÄÎÇòÎ©∞ ÏúÑÎ°ú ÏÜüÍµ¨Ïπ©ÎãàÎã§.", recipe: "Ïú†Î†πÏù¥ÎÇò ÏòÅÌòº ÏäπÏ≤ú Ìö®Í≥º."},
                {id:'jelly', icon:'üçÆ', label:'Ï†§Î¶¨', desc: "Ï†§Î¶¨Ï≤òÎüº ÌùêÎ¨ºÌùêÎ¨ºÍ±∞Î¶¨Î©∞ ÏõÄÏßÅÏûÖÎãàÎã§.", recipe: "Ïä¨ÎùºÏûÑÏù¥ÎÇò Ïï°Ï≤¥ Í¥¥Î¨º ÌëúÌòÑ."},
                {id:'wobble', icon:'ü•¥', label:'ÎπÑÌãÄÎπÑÌãÄ', desc: "Ïà† Ï∑®Ìïú Í≤ÉÏ≤òÎüº ÎπÑÌãÄÎπÑÌãÄÍ±∞Î¶ΩÎãàÎã§.", recipe: "Ïñ¥ÏßÄÎü¨ÏõÄ ÏÉÅÌÉúÏù¥ÏÉÅ ÌëúÌòÑ."},
                {id:'jello', icon:'üçÆ', label:'ÌÉ±Í∏Ä', desc: "ÌÉ±Í∏ÄÌÉ±Í∏ÄÌïòÍ≤å ÌäïÍπÅÎãàÎã§.", recipe: "ÌÉÑÎ†• ÏûàÎäî Î¨ºÏ≤¥ ÌëúÌòÑ."},
                {id:'bounce', icon:'üèÄ', label:'ÌÜµÌÜµ', desc: "Í≥µÏùÑ ÌäÄÍ∏∞ÎìØ ÏúÑÏïÑÎûòÎ°ú Ï†êÌîÑÌï©ÎãàÎã§.", recipe: "Ïä§Ìè¨Ï∏† Í≥µÏù¥ÎÇò ÌôúÍ∏∞Ï∞¨ ÏïÑÏù¥ÌÖú."},
                {id:'flip', icon:'üîÑ', label:'Îí§ÏßëÍ∏∞', desc: "ÎèôÏ†ÑÏùÑ Îí§ÏßëÎìØ 360ÎèÑ ÌöåÏ†ÑÌï©ÎãàÎã§.", recipe: "Ïπ¥Îìú Îí∑Î©¥/ÏïûÎ©¥ Ï†ÑÌôò Ïó∞Ï∂ú."},
                {id:'zoomInOut', icon:'üîç', label:'ÌôïÎåÄÏ∂ïÏÜå', desc: "ÏïÑÏ£º ÌÅ¨Í≤å ÌôïÎåÄÎêòÏóàÎã§Í∞Ä Îã§Ïãú ÏûëÏïÑÏßëÎãàÎã§.", recipe: "Ï£ºÎ™©Ìï¥Ïïº Ìï† Ï§ëÏöî ÏïÑÏù¥ÌÖú."},
                {id:'panic', icon:'üò±', label:'Ìå®Îãâ', desc: "Ï†úÏûêÎ¶¨ÏóêÏÑú Ïò§Îì§Ïò§Îì§ Îñ±ÎãàÎã§.", recipe: "Í≤ÅÏóê ÏßàÎ¶∞ ÏÉÅÌÉú, Ï∂îÏúÑ."},
                {id:'breath', icon:'üå¨Ô∏è', label:'Ïà®Ïâ¨Í∏∞', desc: "Ï≤úÏ≤úÌûà Ïà®ÏùÑ Ïâ¨ÎìØ Î∂ÄÎìúÎüΩÍ≤å ÌÅ¨Í∏∞Í∞Ä Î≥ÄÌï©ÎãàÎã§.", recipe: "ÎåÄÍ∏∞ ÏÉÅÌÉú, ÌèâÏò®Ìï®."},
                {id:'barrel', icon:'üõ¢Ô∏è', label:'Îç∞Íµ¥Îç∞Íµ¥', desc: "ÏïûÍµ¨Î•¥Í∏∞Î•º ÌïòÎìØ ÌöåÏ†ÑÌï©ÎãàÎã§.", recipe: "Íµ¥Îü¨Í∞ÄÎäî Î¨ºÏ≤¥."},
                {id:'compress', icon:'üß±', label:'ÎÇ©Ïûë', desc: "ÏúÑÏïÑÎûòÎ°ú Ï∞åÍ∑∏Îü¨Ï°åÎã§Í∞Ä Ìé¥ÏßëÎãàÎã§.", recipe: "ÏïïÎ†•ÏùÑ Î∞õÎäî ÎäêÎÇå."},
                {id:'blackHole', icon:'‚ö´', label:'Î∏îÎûôÌôÄ', desc: "Îπ®Î†§ Îì§Ïñ¥Í∞îÎã§Í∞Ä Îã§Ïãú ÌäÄÏñ¥ÎÇòÏòµÎãàÎã§.", recipe: "Ï∞®Ïõê Ïù¥ÎèôÏù¥ÎÇò ÏÜåÌôò Ïó∞Ï∂ú."},
                {id:'tornado', icon:'üå™Ô∏è', label:'ÌöåÏò§Î¶¨', desc: "ÌöåÏò§Î¶¨Î∞îÎûåÏ≤òÎüº ÎπôÍ∏ÄÎπôÍ∏Ä ÎèåÎ©∞ ÎÇ†ÏïÑÎã§ÎãôÎãàÎã§.", recipe: "Í∞ïÎ†•Ìïú Î∞îÎûå ÏÜçÏÑ± ÌëúÌòÑ."},
                {id:'teleport', icon:'üõ∏', label:'ÏàúÍ∞ÑÏù¥Îèô', desc: "ÏàúÍ∞ÑÏù¥ÎèôÌïòÎìØ ÍπúÎπ°Í±∞Î¶¨Î©∞ ÌÅ¨Í∏∞Í∞Ä Î≥ÄÌï©ÎãàÎã§.", recipe: "SFÏ†ÅÏù∏ Îì±Ïû• Ïó∞Ï∂ú."},
                {id:'orbit3d', icon:'ü™ê', label:'3DÍ≥µÏ†Ñ', desc: "3D Í≥µÍ∞ÑÏóêÏÑú ÏûÖÏ≤¥Ï†ÅÏúºÎ°ú ÌöåÏ†ÑÌï©ÎãàÎã§.", recipe: "ÌñâÏÑ±Ïù¥ÎÇò ÏúÑÏÑ± ÌëúÌòÑÏóê ÏïïÎèÑÏ†Å."},
                {id:'glitch-skew', icon:'üì∂', label:'ÏßÄÏßÄÏßÅ', desc: "ÌòïÌÉúÍ∞Ä ÏπòÏßÅÍ±∞Î¶¨Î©∞ ÏôúÍ≥°Îê©ÎãàÎã§.", recipe: "Ï†ÑÌåå Î∞©Ìï¥, ÌÜµÏã† Ïò§Î•ò."},
                {id:'vibrate', icon:'üì≥', label:'ÏßÑÎèô', desc: "ÎØ∏ÏÑ∏ÌïòÍ≤å ÎçúÎçú Îñ±ÎãàÎã§.", recipe: "Ìú¥ÎåÄÌè∞ ÏßÑÎèô, Í∏¥Ïû•Í∞ê."},
                {id:'float-h', icon:'‚ÜîÔ∏è', label:'Ï¢åÏö∞Îë•Îë•', desc: "Ï¢åÏö∞Î°ú Îë•Îë• Îñ†Îã§ÎãôÎãàÎã§.", recipe: "Ïú†Î†π, Î¨ºÍ≥†Í∏∞."},
                {id:'pendulum', icon:'üï∞Ô∏è', label:'ÏãúÍ≥ÑÏ∂î', desc: "ÏãúÍ≥ÑÏ∂îÏ≤òÎüº Ï¢åÏö∞Î°ú ÏùºÏ†ïÌïòÍ≤å ÌùîÎì§Î¶ΩÎãàÎã§.", recipe: "ÏµúÎ©¥, ÏãúÍ∞Ñ Í¥ÄÎ†® ÏïÑÏù¥ÌÖú."},
                {id:'quake', icon:'üåã', label:'ÏßÄÏßÑ', desc: "Í≤©Î†¨ÌïòÍ≤å ÌùîÎì§Î¶ΩÎãàÎã§.", recipe: "ÏßÄÏßÑÏù¥ÎÇò Í∞ïÎ†•Ìïú ÌÉÄÍ≤© Ìö®Í≥º."},
                {id:'stretch', icon:'üìè', label:'ÎäòÎ¶¨Í∏∞', desc: "Í∞ÄÎ°úÏÑ∏Î°úÎ°ú Ï≠âÏ≠â ÎäòÏñ¥ÎÇ©ÎãàÎã§.", recipe: "Ïä¨ÎùºÏûÑ, Íªå."},
                {id:'spiral', icon:'üåÄ', label:'ÎÇòÏÑ†', desc: "ÎÇòÏÑ†ÌòïÏùÑ Í∑∏Î¶¨Î©∞ Î±ÖÍ∏ÄÎ±ÖÍ∏Ä ÎèïÎãàÎã§.", recipe: "ÏµúÎ©¥Ïù¥ÎÇò ÌòºÎûÄ ÏÉÅÌÉú."},
                {id:'blink', icon:'üëÄ', label:'ÍπúÎπ°ÏûÑ', desc: "Ìà¨Î™ÖÎèÑÍ∞Ä Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú Î≥ÄÌï©ÎãàÎã§.", recipe: "ÎπÑÏÉÅÎì±, Ïã†Ìò∏."},
                {id:'scan-h', icon:'‚ÜîÔ∏è', label:'Ï¢åÏö∞Ïä§Ï∫î', desc: "Ï¢åÏö∞Î°ú Îπ†Î•¥Í≤å Ïä§Ï∫îÌïòÎìØ ÏõÄÏßÅÏûÖÎãàÎã§.", recipe: "Î°úÎ¥á, ÌÉêÏÉâ Î™®Îìú."},
                {id:'zigzag', icon:'‚ö°', label:'ÏßÄÍ∑∏Ïû¨Í∑∏', desc: "ÏßÄÍ∑∏Ïû¨Í∑∏Î°ú ÏõÄÏßÅÏûÖÎãàÎã§.", recipe: "Ï†ÑÍ∏∞, Î≤åÎ†à."}
            ],
            fx: [
                {id:'fire', icon:'üî•', label:'ÌôîÏóº', desc: "Î∂âÏùÄ ÌôîÏóºÏù¥ ÌÉÄÏò§Î•¥Îäî ÎìØÌïú Í∑∏Î¶ºÏûêÎ•º Ï§çÎãàÎã§.", recipe: "Î∂à ÏÜçÏÑ±, Î∂ÑÎÖ∏, Ïó¥Ï†ï ÌëúÌòÑ."},
                {id:'sparkle', icon:'‚ú®', label:'Î∞òÏßùÏûÑ', desc: "ÌïòÏñóÍ≤å Î≤àÏ©çÍ±∞Î¶¨Î©∞ ÎπõÎÇ©ÎãàÎã§.", recipe: "Î≥¥Î¨º, Ìù¨Í∑Ä ÏïÑÏù¥ÌÖú, Íπ®ÎÅóÌï®."},
                {id:'neon-pulse', icon:'‚ö°', label:'ÎÑ§Ïò®', desc: "ÎÑ§Ïò® ÏÇ¨Ïù∏Ï≤òÎüº ÏÉâÏù¥ Î≥ÄÌïòÎ©∞ ÎπõÎÇ©ÎãàÎã§.", recipe: "ÏÇ¨Ïù¥Î≤ÑÌéëÌÅ¨, ÎØ∏ÎûòÏ†ÅÏù∏ ÎäêÎÇå."},
                {id:'shake', icon:'ü´®', label:'ÏßÄÏßÑ', desc: "Ïù¥ÎØ∏ÏßÄÍ∞Ä ÎØ∏Ïπú ÎìØÏù¥ ÌùîÎì§Î¶ΩÎãàÎã§.", recipe: "Ï∂©Í≤©, Îç∞ÎØ∏ÏßÄ ÏûÖÏùå."},
                {id:'glitch-filter', icon:'‚ò†Ô∏è', label:'Í∏ÄÎ¶¨Ïπò', desc: "ÌôîÎ©¥Ïù¥ Íπ®ÏßÑ ÎìØÌïú ÎÖ∏Ïù¥Ï¶àÎ•º Ï§çÎãàÎã§.", recipe: "ÏãúÏä§ÌÖú Ïò§Î•ò, Ìï¥ÌÇπ, Í≥µÌè¨."},
                {id:'rainbow', icon:'üåà', label:'Î¨¥ÏßÄÍ∞ú', desc: "Î¨¥ÏßÄÍ∞úÏÉâÏúºÎ°ú Í≥ÑÏÜç Î≥ÄÌï©ÎãàÎã§.", recipe: "ÌîºÎ≤Ñ ÌÉÄÏûÑ, Î¨¥Ï†Å ÏÉÅÌÉú."},
                {id:'blurPulse', icon:'üå´Ô∏è', label:'ÏïàÍ∞ú', desc: "Ï¥àÏ†êÏù¥ ÎßûÏïòÎã§Í∞Ä ÌùêÎ†§Ï°åÎã§Í∞ÄÎ•º Î∞òÎ≥µÌï©ÎãàÎã§.", recipe: "Î™ΩÌôòÏ†ÅÏù∏ Î∂ÑÏúÑÍ∏∞, ÍøàÏÜç."},
                {id:'invertFlash', icon:'üåì', label:'Î∞òÏ†Ñ', desc: "ÏÉâÏÉÅÏù¥ Î∞òÏ†ÑÎêòÎ©∞ ÍπúÎπ°ÏûÖÎãàÎã§.", recipe: "Í∞ïÎ†•Ìïú Í≤ΩÍ≥†, ÏúÑÌóò Ïã†Ìò∏."},
                {id:'sepiaDream', icon:'üìú', label:'ÏÑ∏ÌîºÏïÑ', desc: "Ïò§ÎûòÎêú ÏòÅÌôîÏ≤òÎüº ÎàÑÎ†áÍ≤å Î≥ÄÌï©ÎãàÎã§.", recipe: "ÌöåÏÉÅ, Í≥ºÍ±∞, Ïó≠ÏÇ¨Ï†Å Í∏∞Î°ù."},
                {id:'brightnessFlash', icon:'üí°', label:'ÌîåÎûòÏãú', desc: "ÎààÎ∂ÄÏãúÍ≤å ÌïòÏñóÍ≤å Î≤àÏ©çÏûÖÎãàÎã§.", recipe: "ÏÇ¨ÏßÑ Ï¥¨ÏòÅ, ÏÑ¨Í¥ëÌÉÑ."},
                {id:'grayscalePulse', icon:'‚ö´', label:'ÌùëÎ∞±', desc: "ÌùëÎ∞±Í≥º Ïª¨Îü¨Î•º Ïò§Í∞ëÎãàÎã§.", recipe: "ÏÉùÎ™ÖÎ†• Ï†ÄÌïò, ÏúÑÍ∏∞."},
                {id:'radioactive', icon:'‚ò¢Ô∏è', label:'Î∞©ÏÇ¨Îä•', desc: "Ï¥àÎ°ùÏÉâ ÎèÖÍ∑πÎ¨º Í∞ôÏùÄ ÎπõÏùÑ ÎÉÖÎãàÎã§.", recipe: "ÎèÖ, Î∞©ÏÇ¨Îä•, Ï¢ÄÎπÑ."},
                {id:'ice', icon:'üßä', label:'ÏñºÏùå', desc: "Ï∞®Í∞ÄÏö¥ Ìë∏Î•∏ÎπõÍ≥º Ìï®Íªò ÏñºÏñ¥Î∂ôÏùÄ ÎäêÎÇåÏùÑ Ï§çÎãàÎã§.", recipe: "ÏñºÏùå ÏÜçÏÑ±, ÎÉâÎèô ÏÉÅÌÉú."},
                {id:'shadowClone', icon:'üë•', label:'Î∂ÑÏã†', desc: "ÏûîÏÉÅÏù¥ ÎÇ®Îäî Î∂ÑÏã†Ïà† Ìö®Í≥ºÎ•º Ï§çÎãàÎã§.", recipe: "ÎãåÏûê, Ï¥àÍ≥†ÏÜç Ïù¥Îèô."},
                {id:'midas', icon:'üëë', label:'Ìô©Í∏à', desc: "Î≤àÏ©çÏù¥Îäî Ìô©Í∏àÏÉâÏúºÎ°ú Î≥ÄÌï©ÎãàÎã§.", recipe: "ÏµúÍ≥† Îì±Í∏â ÏïÑÏù¥ÌÖú, Î∂ÄÏûê."},
                {id:'matrix', icon:'üíª', label:'Îß§Ìä∏Î¶≠Ïä§', desc: "Ï¥àÎ°ùÏÉâ ÎîîÏßÄÌÑ∏ ÏΩîÎìúÍ∞Ä ÌùêÎ•¥Îäî ÎäêÎÇåÏùÑ Ï§çÎãàÎã§.", recipe: "Ìï¥Ïª§, Í∞ÄÏÉÅ ÌòÑÏã§."},
                {id:'thermal', icon:'üå°Ô∏è', label:'Ïó¥ÌôîÏÉÅ', desc: "Ïó¥ÌôîÏÉÅ Ïπ¥Î©îÎùºÎ°ú Î≥¥Îäî ÎìØÌïú ÏÉâÍ∞êÏûÖÎãàÎã§.", recipe: "ÌäπÏàò Î∂ÄÎåÄ, ÌÉêÏßÄ Î™®Îìú."},
                {id:'hologram', icon:'üí†', label:'ÌôÄÎ°úÍ∑∏Îû®', desc: "Ìà¨Î™ÖÌïòÍ≥† Ìë∏Î•∏ ÌôÄÎ°úÍ∑∏Îû® ÏßàÍ∞êÏùÑ Ï§çÎãàÎã§.", recipe: "ÎØ∏Îûò ÌÜµÏã†, AI."},
                {id:'noir', icon:'üïµÔ∏è', label:'ÎäêÏôÄÎ•¥', desc: "Í±∞Ïπú ÌùëÎ∞± ÏòÅÌôî ÌïÑÎ¶Ñ ÎäêÎÇåÏùÑ Ï§çÎãàÎã§.", recipe: "Î≤îÏ£Ñ, Í≥ºÍ±∞ ÌöåÏÉÅ, ÏßÑÏßÄÌï®."},
                {id:'pixelate', icon:'üëæ', label:'ÌîΩÏÖÄ', desc: "ÌîΩÏÖÄÏù¥ Íπ®Ï†∏ Î≥¥ÏûÖÎãàÎã§(ÎåÄÎπÑ Ìö®Í≥º).", recipe: "Î†àÌä∏Î°ú Í≤åÏûÑ, 8ÎπÑÌä∏ Í∞êÏÑ±."},
                {id:'underwater', icon:'üåä', label:'Î¨ºÏÜç', desc: "Î¨ºÏÜçÏóê ÏûàÎäî Í≤ÉÏ≤òÎüº ÏùºÎ†ÅÍ±∞Î¶ΩÎãàÎã§.", recipe: "ÏàòÏ§ë Ïä§ÌÖåÏù¥ÏßÄ, Î¨º ÏÜçÏÑ±."},
                {id:'divine', icon:'üëº', label:'ÏÑ±Ïä§Îü¨ÏõÄ', desc: "ÏÑ±Ïä§Îü¨Ïö¥ Ìô©Í∏àÎπõÍ≥º Ìù∞ÎπõÏù¥ Í∞êÎèïÎãàÎã§.", recipe: "Ï≤úÏÇ¨, Î∂ÄÌôú, Ïã†ÏÑ±Ìï®."},
                {id:'nightmare', icon:'üëø', label:'ÏïÖÎ™Ω', desc: "ÏÉâÏù¥ Îí§ÌãÄÎ¶¨Í≥† Î∂âÏùÄ Í∑∏Î¶ºÏûêÍ∞Ä ÏÉùÍπÅÎãàÎã§.", recipe: "Î≥¥Ïä§ Îì±Ïû•, Í≥µÌè¨, ÏïÖÎ™Ω."},
                {id:'blood', icon:'ü©∏', label:'Ïú†Ìòà', desc: "Î∂âÏùÄ ÌïèÎπõ Í∑∏Î¶ºÏûêÍ∞Ä Îß•ÎèôÌï©ÎãàÎã§.", recipe: "Î±ÄÌååÏù¥Ïñ¥, Ï∂úÌòà, Ìè≠Ï£º."},
                {id:'scanline', icon:'üì∫', label:'CRT', desc: "Ïò§ÎûòÎêú TV ÌôîÎ©¥Ï≤òÎüº Í∞ÄÎ°úÏ§ÑÏù¥ ÏÉùÍπÅÎãàÎã§.", recipe: "Î†àÌä∏Î°ú Î™®ÎãàÌÑ∞."},
                {id:'vignette', icon:'üåë', label:'ÎπÑÎÑ§Ìä∏', desc: "Í∞ÄÏû•ÏûêÎ¶¨Í∞Ä Ïñ¥ÎëêÏõåÏßëÎãàÎã§.", recipe: "Í≥µÌè¨, ÏßëÏ§ë."}
            ],
            blend: [
                {id:'multiply', icon:'üåë', label:'Í≥±ÌïòÍ∏∞', desc: "ÏÉâÏÉÅÏùÑ Í≥±Ìï¥ÏÑú Ïñ¥Îë°Í≤å ÎßåÎì≠ÎãàÎã§. (Î∞∞Í≤Ω ÌïÑÏöî)", recipe: "Ìù∞ÏÉâ Î∞∞Í≤Ω Ìï©ÏÑ± Ïãú Ìà¨Î™ÖÌïòÍ≤å ÎßåÎì§ Îïå."},
                {id:'screen', icon:'‚òÄÔ∏è', label:'Ïä§ÌÅ¨Î¶∞', desc: "ÏÉâÏÉÅÏùÑ Î∞òÏ†ÑÌï¥ Í≥±Ìï©ÎãàÎã§. ÎπõÎÇòÎäî Ìö®Í≥º. (Î∞∞Í≤Ω ÌïÑÏöî)", recipe: "Í≤ÄÏùÄ Î∞∞Í≤ΩÏùò Î∂àÍΩÉ/ÎπõÏùÑ Ìï©ÏÑ±Ìï† Îïå."},
                {id:'overlay', icon:'üåó', label:'Ïò§Î≤ÑÎ†àÏù¥', desc: "Î∞ùÏùÄ Í±¥ Îçî Î∞ùÍ≤å, Ïñ¥ÎëêÏö¥ Í±¥ Îçî Ïñ¥Îë°Í≤å. (Î∞∞Í≤Ω ÌïÑÏöî)", recipe: "ÌÖçÏä§Ï≤òÎ•º ÏûêÏó∞Ïä§ÎüΩÍ≤å ÏûÖÌûê Îïå."},
                {id:'darken', icon:'üåò', label:'Ïñ¥Îë°Í≤å', desc: "Ïñ¥ÎëêÏö¥ ÏÉâÏÉÅÎßå ÎÇ®ÍπÅÎãàÎã§.", recipe: "Í∑∏Î¶ºÏûê Ìö®Í≥º."},
                {id:'lighten', icon:'üåñ', label:'Î∞ùÍ≤å', desc: "Î∞ùÏùÄ ÏÉâÏÉÅÎßå ÎÇ®ÍπÅÎãàÎã§.", recipe: "Í¥ëÏõê Ìö®Í≥º."},
                {id:'grayscale', icon:'‚ö´', label:'ÌùëÎ∞±', desc: "ÏôÑÏ†ÑÌïú Î¨¥Ï±ÑÏÉâÏúºÎ°ú ÎßåÎì≠ÎãàÎã§.", recipe: "ÏÑùÏÉÅ, Í≥†Ïù∏Î¨º, ÏÇ¨Îßù ÏÉÅÌÉú."},
                {id:'sepia', icon:'üü§', label:'ÏÑ∏ÌîºÏïÑ', desc: "Îπõ Î∞îÎûú Í∞àÏÉâ ÌÜ§ÏùÑ ÏûÖÌûôÎãàÎã§.", recipe: "Í≥†ÏßÄÎèÑ, Ïú†Î¨º, ÌöåÏÉÅ Ïî¨."},
                {id:'invert', icon:'üîÑ', label:'Î∞òÏ†Ñ', desc: "Î≥¥ÏÉâÏúºÎ°ú Î∞òÏ†ÑÏãúÌÇµÎãàÎã§.", recipe: "ÎßàÎ≤ï, Ï†ÄÏ£º, Í∏∞Í¥¥Ìï®."},
                {id:'hue-rotate', icon:'üé®', label:'ÏÉâÏÉÅÌöåÏ†Ñ', desc: "ÏÉâÏÉÅÌôòÏùÑ ÎèåÎ†§ ÏÉâÏùÑ Î∞îÍøâÎãàÎã§.", recipe: "ÌååÎûÄ Ïò∑ÏùÑ Îπ®Í∞Ñ Ïò∑ÏúºÎ°ú Î∞îÍøÄ Îïå."},
                {id:'saturate', icon:'üî¥', label:'Ï±ÑÎèÑ', desc: "ÏÉâÏùÑ Í∞ïÎ†¨ÌïòÍ≥† ÏßÑÌïòÍ≤å ÎßåÎì≠ÎãàÎã§.", recipe: "ÏóêÎÑàÏßÄ ÎÑòÏπòÎäî ÏÉÅÌÉú, Ìè≠Ï£º."},
                {id:'contrast', icon:'üî≥', label:'ÎåÄÎπÑ', desc: "Î™ÖÏïî Ï∞®Ïù¥Î•º Í∑πÎåÄÌôîÌï©ÎãàÎã§.", recipe: "Í∞ïÎ†¨Ìïú Ïù∏ÏÉÅ, ÎßåÌôî Í∞ôÏùÄ ÎäêÎÇå."},
                {id:'blur', icon:'üå´Ô∏è', label:'Î∏îÎü¨', desc: "ÌùêÎ¶øÌïòÍ≤å Î≠âÍ∞≠ÎãàÎã§.", recipe: "ÏõêÍ∑ºÍ∞ê, Ïú†Î†π, Îπ†Î•∏ Ïù¥Îèô."},
                {id:'opacity', icon:'üëª', label:'Ìà¨Î™ÖÎèÑ', desc: "Î∞òÌà¨Î™ÖÌïòÍ≤å ÎßåÎì≠ÎãàÎã§.", recipe: "Ïú†Î†π, ÏùÄÏã†, ÌôÄÎ°úÍ∑∏Îû®."},
                {id:'drop-shadow', icon:'üë§', label:'Í∑∏Î¶ºÏûê', desc: "Ïô∏Î∂Ä Í∑∏Î¶ºÏûêÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§.", recipe: "ÏûÖÏ≤¥Í∞ê, Îë•Îë• Îñ†ÏûàÎäî ÎäêÎÇå."},
                {id:'difference', icon:'‚ûñ', label:'Ï∞®Ïù¥', desc: "Í≤πÏπòÎäî ÏÉâÏÉÅÏùÑ Î∫çÎãàÎã§.", recipe: "ÏÇ¨Ïù¥ÌÇ§Îç∏Î¶≠, Î∞òÏ†Ñ Ìö®Í≥º."},
                {id:'exclusion', icon:'‚ùå', label:'Ï†úÏô∏', desc: "Ï∞®Ïù¥ÏôÄ ÎπÑÏä∑ÌïòÏßÄÎßå ÎåÄÎπÑÍ∞Ä ÎÇÆÏäµÎãàÎã§.", recipe: "Î∂ÄÎìúÎü¨Ïö¥ Î∞òÏ†Ñ."},
                {id:'hard-light', icon:'üî¶', label:'ÌïòÎìúÎùºÏù¥Ìä∏', desc: "Í∞ïÌïú Ïä§Ìè¨Ìä∏ÎùºÏù¥Ìä∏Î•º ÎπÑÏ∂ò ÎìØÌï©ÎãàÎã§.", recipe: "Í∞ïÎ†¨Ìïú Ìï©ÏÑ±."},
                {id:'soft-light', icon:'üïØÔ∏è', label:'ÏÜåÌîÑÌä∏ÎùºÏù¥Ìä∏', desc: "Î∂ÄÎìúÎü¨Ïö¥ Ï°∞Î™ÖÏùÑ ÎπÑÏ∂ò ÎìØÌï©ÎãàÎã§.", recipe: "ÏùÄÏùÄÌïú Ìï©ÏÑ±."}
            ]
        };

        const ASSET_DATA = { face: ['üòÄ','üòé','üíÄ','üî•','üí©','üëë','üíé','üèÜ','‚ù§Ô∏è','üöÄ','üëΩ','üëª','ü§°','üëπ','üë∫','ü§ñ','ü§†','ü§¢','ü•≥','ü§¨','ü§Ø','ü•∂','ü•µ','üò±','ü¶Ñ'], animal: ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','ü¶Ö','ü¶Ü','ü¶á','üê∫','üêó','üê¥','ü¶ã','üêô','ü¶ï'], icon: ['fa-solid fa-crown','fa-solid fa-trophy','fa-solid fa-medal','fa-solid fa-star','fa-solid fa-bolt','fa-solid fa-fire','fa-solid fa-skull','fa-solid fa-dragon','fa-solid fa-rocket','fa-solid fa-heart','fa-solid fa-certificate','fa-solid fa-radiation','fa-solid fa-biohazard','fa-solid fa-eye','fa-solid fa-hand-fist','fa-solid fa-diamond','fa-solid fa-chess-king','fa-solid fa-yin-yang','fa-solid fa-user-astronaut','fa-solid fa-meteor','fa-solid fa-shield-halved','fa-solid fa-dungeon','fa-solid fa-hat-wizard'], object: ['üëì','üï∂','üíç','üí£','üéà','üéâ','üíä','üíâ','ü©∏','üß¨','üî≠','üî¨','üõ°','üó°','‚öî','üèπ','üéÅ','üîî','üéµ','üé§','üéÆ','üé≤','üéØ','üé±','üé≥'], food: ['üçé','üçå','üçâ','üçá','üçì','üçî','üçü','üçï','üå≠','üçø','üç©','üç™','üéÇ','üç´','üç¨','üç≠','üç∫','ü•Ç','üßä','üßÅ','ü•ü','üç£','üç±','üçõ','üçú'], symbol: ['‚òÆ','‚úù','‚ò™','üïâ','‚ò∏','‚ú°','üîØ','üïé','‚òØ','‚ò¶','üõê','‚õé','‚ôà','‚ôâ','‚ôä','‚ôã','‚ôå','‚ôç','‚ôé','‚ôè','‚ôê','‚ôë','‚ôí','‚ôì','‚öõ'] };

        async function init() {
            window.addEventListener('mousemove', handleGlobalMouseMove);
            window.addEventListener('mouseup', handleGlobalMouseUp);
            setupDraggablePopup();
            setupDraggablePreview(); // [ELITE SECRETARY] Initialize draggable preview
            renderToggleButtons();
            renderMarketTabs();
        }

        // [ELITE SECRETARY] Draggable Preview Logic
        function setupDraggablePreview() {
            const card = document.getElementById('live-preview-card');
            const header = document.getElementById('preview-header');
            let isDown = false; let offset = [0, 0];
            header.addEventListener('mousedown', (e) => { 
                if(e.target.tagName === 'BUTTON' || e.target.closest('button')) return; // Allow button clicks
                isDown = true; 
                offset = [card.offsetLeft - e.clientX, card.offsetTop - e.clientY]; 
            });
            document.addEventListener('mouseup', () => { isDown = false; });
            document.addEventListener('mousemove', (e) => {
                if (isDown) {
                    e.preventDefault();
                    card.style.left = (e.clientX + offset[0]) + 'px';
                    card.style.top = (e.clientY + offset[1]) + 'px';
                    card.style.right = 'auto'; // Disable default right positioning
                }
            });
        }

        function togglePreview() {
            const card = document.getElementById('live-preview-card');
            card.style.display = card.style.display === 'none' ? 'block' : 'none';
        }

        function setupDraggablePopup() {
            const popup = document.getElementById('help-popup');
            const header = document.getElementById('help-header');
            let isDown = false; let offset = [0, 0];
            header.addEventListener('mousedown', (e) => { isDown = true; offset = [popup.offsetLeft - e.clientX, popup.offsetTop - e.clientY]; });
            document.addEventListener('mouseup', () => { isDown = false; });
            document.addEventListener('mousemove', (e) => {
                if (isDown) {
                    e.preventDefault();
                    popup.style.left = (e.clientX + offset[0]) + 'px';
                    popup.style.top = (e.clientY + offset[1]) + 'px';
                }
            });
        }

        function showHelp(group, type) {
            const popup = document.getElementById('help-popup');
            const content = document.getElementById('help-content');
            
            // Look up in MASTER DATA
            const item = EFFECT_DATA[group].find(x => x.id === type);
            if(!item) return;
            
            content.innerHTML = `
                <div class="mb-3">
                    <span class="text-xl font-bold text-pink-400 capitalize flex items-center gap-2">${item.icon} ${item.label}</span>
                    <hr class="border-indigo-800 my-2">
                    <p class="text-white mb-2 font-bold text-xs uppercase tracking-wider text-indigo-400">Effect</p>
                    <p class="text-slate-300 mb-4 font-normal leading-relaxed">${item.desc}</p>
                    <p class="text-white mb-2 font-bold text-xs uppercase tracking-wider text-yellow-400">Secret Recipe</p>
                    <div class="bg-indigo-900/50 p-3 rounded-lg border border-indigo-700 text-yellow-200 text-xs">
                        <i class="fa-solid fa-lightbulb mr-2"></i>${item.recipe}
                    </div>
                    ${group === 'blend' && ['multiply','screen','overlay','darken','lighten','hard-light','soft-light','difference','exclusion'].includes(type) ? 
                        '<p class="mt-2 text-[10px] text-slate-500 italic">* Ïù¥ Ìö®Í≥ºÎäî Î∞∞Í≤Ω(Îã§Î•∏ Î†àÏù¥Ïñ¥)Í≥º Í≤πÏ≥êÏïº Î≥¥ÏûÖÎãàÎã§.</p>' : ''}
                </div>
            `;
            popup.style.display = 'block';
        }

        function renderToggleButtons() {
            // Render from MASTER DATA to ensure consistency
            ['vital', 'fx', 'blend'].forEach(group => {
                const container = document.getElementById(`${group}-toggles`);
                container.innerHTML = EFFECT_DATA[group].map(t => 
                    `<div class="effect-toggle ${group}" onclick="toggleEffect('${group}', '${t.id}')" id="btn-${group}-${t.id}" title="${t.desc}">
                        ${t.icon}<span>${t.label}</span>
                    </div>`
                ).join('');
            });
        }

        function renderMarketTabs() {
            const header = document.querySelector('.market-header');
            const korTabs = { face: 'ÏñºÍµ¥', animal: 'ÎèôÎ¨º', icon: 'ÏïÑÏù¥ÏΩò', object: 'ÏÇ¨Î¨º', food: 'ÏùåÏãù', symbol: 'Í∏∞Ìò∏' };
            header.innerHTML = Object.keys(ASSET_DATA).map(key => `<div class="px-5 py-3 cursor-pointer text-xs font-bold text-slate-400 hover:text-white border-b-2 border-transparent hover:border-pink-500 transition uppercase" onclick="switchMarketTab('${key}')" id="tab-${key}">${korTabs[key]||key}</div>`).join('');
            if(Object.keys(ASSET_DATA).length > 0) switchMarketTab('face');
        }

        async function handleImageUpload(input) {
            const file = input.files[0]; if (!file) return;
            const loading = document.getElementById('loading-overlay'); loading.style.display = 'flex';
            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
                const { data, error } = await _supabase.storage.from('emblem_assets').upload(fileName, file);
                if (error) throw error;
                const { data: { publicUrl } } = _supabase.storage.from('emblem_assets').getPublicUrl(fileName);
                addLayer('image', publicUrl, 'custom');
            } catch (e) { alert("ÏóÖÎ°úÎìú Ïã§Ìå®: " + e.message); } 
            finally { loading.style.display = 'none'; input.value = ''; }
        }

        function addLayer(type, content, subType='emoji') {
            const id = Date.now().toString();
            const layer = { 
                id, type, content, subType, x: 50, y: 50, 
                style: { size: type==='image'?150:(type==='bg'?300:100), color: '#ffffff', texture: 'none' },
                anim: {
                    spin: { on: false, axis: 'z', speed: 10 },
                    orbit: { on: false, radius: 100, speed: 20 },
                    vital: [], fx: [], blend: []
                }
            };
            if(type==='text') layer.style.color='#fbbf24';
            layers.push(layer); 
            closeModal('market-modal');
            renderAll(); selectLayer(id);
        }

        function handleSpringZoom(val) {
            if(!selectedId) return;
            const value = parseInt(val);
            if(value === 0) return;
            const thumb = document.getElementById('spring-thumb');
            if(thumb) thumb.style.transform = `translate(calc(-50% + ${value * 10}px), 0)`;
            const l = layers.find(x => x.id === selectedId);
            if(l) {
                let current = parseInt(l.style.size);
                const speed = Math.abs(value) * 1.5; 
                if(value > 0) current += speed;
                else current = Math.max(10, current - speed);
                l.style.size = current;
                document.getElementById('p-size-val').innerText = Math.round(current) + '%';
                renderStage(); renderPreview();
            }
        }

        function resetSpringZoom(input) {
            input.value = 0;
            const thumb = document.getElementById('spring-thumb');
            if(thumb) thumb.style.transform = `translate(-50%, 0)`;
        }

        function resetSize() {
            if(!selectedId) return;
            const l = layers.find(x => x.id === selectedId);
            if(l) {
                l.style.size = (l.type === 'image' ? 150 : (l.type === 'bg' ? 300 : 100));
                document.getElementById('p-size-val').innerText = Math.round(l.style.size) + '%';
                renderStage(); renderPreview();
            }
        }

        function centerLayer() {
            if(!selectedId) return;
            const l = layers.find(x => x.id === selectedId);
            if(l) {
                l.x = 50; l.y = 50;
                renderStage();
            }
        }

        function toggleEffect(group, type) {
            if(!selectedId) return;
            const l = layers.find(x => x.id === selectedId);
            if(!l) return;
            const existingIdx = l.anim[group].findIndex(e => e.type === type);
            if(existingIdx !== -1) { l.anim[group].splice(existingIdx, 1); } 
            else { l.anim[group].push({ type: type, speed: 10, intensity: 10 }); }
            updateToggleUI(l); renderAll();
        }

        function updateEffectProp(group, type, prop, value) {
            if(!selectedId) return;
            const l = layers.find(x => x.id === selectedId);
            if(!l) return;
            const effect = l.anim[group].find(e => e.type === type);
            if(effect) {
                effect[prop] = parseInt(value);
                const label = document.getElementById(`${prop}-val-${group}-${type}`);
                if(label) {
                     if(prop === 'speed') label.innerText = group==='blend' ? value+'%' : ((21 - value)/10).toFixed(1) + 'x';
                     else label.innerText = value; 
                }
                renderStage(); renderPreview();
            }
        }

        function randomizeLayer() {
            if(!selectedId) return alert("Ïπ¥Ïò§Ïä§ Ìö®Í≥ºÎ•º Ï§Ñ Î†àÏù¥Ïñ¥Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!");
            const l = layers.find(x => x.id === selectedId);
            if(!l) return;
            l.anim.vital = []; l.anim.fx = []; l.anim.blend = [];
            ['vital', 'fx', 'blend'].forEach(group => {
                const arr = EFFECT_DATA[group];
                const count = Math.floor(Math.random() * 2) + 1;
                const target = l.anim[group];
                for(let k=0; k<count; k++) {
                    const id = arr[Math.floor(Math.random() * arr.length)].id;
                    if(!target.find(e=>e.type===id)) target.push({type:id, speed: Math.floor(Math.random()*15)+5, intensity: 10});
                }
            });
            selectLayer(l.id);
        }

        function updateToggleUI(layer) {
            document.querySelectorAll('.effect-toggle').forEach(el => el.classList.remove('active'));
            ['vital', 'fx', 'blend'].forEach(g => {
                if(!layer.anim[g]) layer.anim[g] = [];
                // Legacy Fix
                if(layer.anim[g].length > 0 && typeof layer.anim[g][0] === 'string') layer.anim[g] = layer.anim[g].map(t=>({type:t, speed:10, intensity:10}));
                layer.anim[g].forEach(e => { 
                    const btn = document.getElementById(`btn-${g}-${e.type}`); 
                    if(btn) btn.classList.add('active'); 
                });
                renderActiveStackList(g, layer.anim[g]);
            });
        }

        function renderActiveStackList(group, list) {
            const container = document.getElementById(`active-${group}-list`);
            if(!list || list.length === 0) {
                container.innerHTML = `<div class="text-[9px] text-slate-600 text-center italic py-2">ÌôúÏÑ±ÌôîÎêú Ìö®Í≥º ÏóÜÏùå</div>`;
                return;
            }
            const typeArr = EFFECT_DATA[group];
            
            container.innerHTML = list.map(e => {
                const def = typeArr.find(t => t.id === e.type) || {label:e.type, icon:'?'};
                const speedVal = group==='blend' ? (e.speed*10)+'%' : ((21-e.speed)/10).toFixed(1)+'x';
                const accent = group==='fx'?'accent-orange-500':(group==='blend'?'accent-indigo-500':'accent-green-500');
                // HELP BUTTON FOR EVERYONE
                const helpBtn = `<button onclick="showHelp('${group}', '${e.type}')" class="text-cyan-400 hover:text-white px-2"><i class="fa-solid fa-circle-question"></i></button>`;

                return `
                <div class="active-effect-item">
                    <div class="header">
                        <div class="name">${def.icon} ${def.label} ${helpBtn}</div>
                        <button onclick="toggleEffect('${group}', '${e.type}')" class="text-slate-500 hover:text-rose-500"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="slider-row">
                        <div class="label-col">ÏÜçÎèÑ</div>
                        <input type="range" min="1" max="20" value="${e.speed}" class="h-1 bg-slate-700 rounded-lg cursor-pointer ${accent}" 
                               oninput="updateEffectProp('${group}', '${e.type}', 'speed', this.value)">
                        <span class="val-col" id="speed-val-${group}-${e.type}">${speedVal}</span>
                    </div>
                    <div class="slider-row mt-1">
                        <div class="label-col">Í∞ïÎèÑ</div>
                        <input type="range" min="1" max="20" value="${e.intensity||10}" class="h-1 bg-slate-700 rounded-lg cursor-pointer ${accent}" style="opacity:0.7" 
                               oninput="updateEffectProp('${group}', '${e.type}', 'intensity', this.value)">
                        <span class="val-col" id="intensity-val-${group}-${e.type}">${e.intensity||10}</span>
                    </div>
                </div>`;
            }).join('');
        }

        function renderAll() { renderStage(); renderPreview(); renderLayerList(); }

        function renderStage() {
            const stage = document.getElementById('stage'); stage.innerHTML = '';
            layers.forEach(l => {
                const root = createObjDOM(l, 'edit');
                root.addEventListener('mousedown', (e) => { 
                    e.stopPropagation(); e.preventDefault(); 
                    selectLayer(l.id); 
                    isDragging = true; dragTargetId = l.id; 
                });
                root.style.pointerEvents = "auto";
                if(l.id === selectedId) root.classList.add('selected');
                stage.appendChild(root);
            });
        }

        function renderPreview() {
            const stage = document.getElementById('preview-stage'); stage.innerHTML = '';
            layers.forEach(l => { stage.appendChild(createObjDOM(l, 'preview', 0.45)); });
        }

        function renderLayerList() {
            const list = document.getElementById('layer-list'); list.innerHTML = '';
            const reversedLayers = [...layers].map((l, idx) => ({...l, originalIndex: idx})).reverse();
            reversedLayers.forEach(l => {
                const item = document.createElement('div');
                const isSelected = l.id === selectedId;
                item.className = `p-3 rounded-xl border flex flex-col mb-2 transition-all group ${isSelected ? 'bg-indigo-900/40 border-pink-500/50 shadow-lg' : 'bg-slate-800/50 border-slate-800 hover:border-slate-600'}`;
                item.onclick = () => selectLayer(l.id);
                let icon = '';
                if(l.type === 'image') icon = '<i class="fa-solid fa-image text-pink-400"></i>';
                else if(l.type === 'text') icon = '<i class="fa-solid fa-font text-yellow-400"></i>';
                else icon = '<i class="fa-solid fa-icons text-cyan-400"></i>';
                item.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-8 h-8 rounded-lg bg-slate-900 flex items-center justify-center border border-slate-700">${icon}</div>
                            <div class="flex flex-col">
                                <span class="text-xs font-bold text-slate-200 truncate w-24">${l.type==='text' ? l.content : l.type.toUpperCase()}</span>
                                <span class="text-[9px] text-slate-500 font-mono">ID: ${l.id.substr(-4)}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 opacity-50 group-hover:opacity-100 transition">
                            <button onclick="event.stopPropagation(); moveLayer('${l.id}', 1)" class="w-6 h-6 rounded bg-slate-700 hover:bg-slate-600 text-slate-300 flex items-center justify-center transition"><i class="fa-solid fa-chevron-up text-[10px]"></i></button>
                            <button onclick="event.stopPropagation(); moveLayer('${l.id}', -1)" class="w-6 h-6 rounded bg-slate-700 hover:bg-slate-600 text-slate-300 flex items-center justify-center transition"><i class="fa-solid fa-chevron-down text-[10px]"></i></button>
                            <button onclick="event.stopPropagation(); deleteLayerById('${l.id}')" class="w-6 h-6 rounded bg-slate-700 hover:bg-rose-500 hover:text-white text-slate-300 flex items-center justify-center transition ml-1"><i class="fa-solid fa-xmark text-[10px]"></i></button>
                        </div>
                    </div>
                    <div class="px-1 flex items-center justify-between text-[9px] text-slate-500 font-mono">
                         <span>SIZE: ${Math.round(l.style.size)}%</span>
                    </div>`;
                list.appendChild(item);
            });
        }

        // ‚òÖ MASTER OBJECT CREATION
        function createObjDOM(l, mode, scale=1.0) {
            const root = document.createElement('div'); root.className = 'obj-root';
            root.id = mode === 'edit' ? `obj-${l.id}` : `prev-${l.id}`;
            root.style.left = `${l.x}%`; root.style.top = `${l.y}%`;

            const orbit = document.createElement('div'); orbit.className = 'obj-orbit';
            if(l.anim.orbit.on) { 
                orbit.style.setProperty('--orbit-r', `${l.anim.orbit.radius * scale}px`); 
                orbit.style.animation = `orbit-cw ${l.anim.orbit.speed/5}s linear infinite`; 
            }

            let currentContainer = orbit;
            if(l.anim.vital && l.anim.vital.length > 0) {
                l.anim.vital.forEach(e => {
                    const wrapper = document.createElement('div'); wrapper.className = 'effect-wrapper';
                    const speed = (21 - (e.speed || 10)) / 10;
                    wrapper.style.animation = `${e.type} ${speed}s infinite ease-in-out`;
                    const intensity = (e.intensity || 10) / 10; 
                    if(intensity !== 1) wrapper.style.transform = `scale(${intensity})`;
                    currentContainer.appendChild(wrapper); currentContainer = wrapper;
                });
            }
            if(l.anim.fx && l.anim.fx.length > 0) {
                l.anim.fx.forEach(e => {
                    const wrapper = document.createElement('div'); wrapper.className = 'effect-wrapper';
                    const speed = (21 - (e.speed || 10)) / 10;
                    wrapper.style.animation = `${e.type} ${speed}s infinite`;
                    const intensity = (e.intensity || 10);
                    if(intensity > 10) wrapper.style.filter = `saturate(${1 + (intensity-10)/10})`;
                    currentContainer.appendChild(wrapper); currentContainer = wrapper;
                });
            }

            const spin = document.createElement('div'); spin.className = 'obj-spin';
            if(l.anim.spin.on) { spin.style.animation = `spin-${l.anim.spin.axis} ${l.anim.spin.speed/5}s linear infinite`; }
            currentContainer.appendChild(spin);

            const core = document.createElement('div'); core.className = 'obj-core';
            
            // ‚òÖ BLEND INTENSITY LOGIC
            let filterString = '';
            let mixBlend = '';
            
            if(l.anim.blend && l.anim.blend.length > 0) {
                l.anim.blend.forEach(b => {
                    const intensity = b.intensity || 10; // 1-20
                    const factor = intensity / 10; // 0.1 - 2.0
                    
                    if(b.type === 'drop-shadow') {
                        const px = intensity * 2; 
                        filterString += ` drop-shadow(${px}px ${px}px ${px/2}px rgba(0,0,0,0.5))`;
                    }
                    else if(b.type === 'blur') { filterString += ` blur(${intensity/3}px)`; }
                    else if(b.type === 'contrast') { filterString += ` contrast(${factor * 2})`; }
                    else if(b.type === 'saturate') { filterString += ` saturate(${factor * 2})`; }
                    else if(b.type === 'hue-rotate') { filterString += ` hue-rotate(${intensity * 18}deg)`; }
                    else if(b.type === 'opacity') { core.style.opacity = intensity / 20; }
                    else if(['multiply', 'screen', 'overlay', 'darken', 'lighten', 'difference', 'exclusion', 'hard-light', 'soft-light'].includes(b.type)) {
                        mixBlend = b.type;
                    } 
                    else {
                        const def = EFFECT_DATA.blend.find(t => t.id === b.type);
                        if(def && def.filter) filterString += ` ${def.filter}`; 
                    }
                });
            }
            if(filterString) core.style.filter = filterString;
            if(mixBlend) core.style.mixBlendMode = mixBlend;

            if (l.type === 'image') {
                const img = document.createElement('img'); img.src = l.content;
                img.style.width = `${l.style.size * scale}px`; img.style.height = 'auto';
                core.appendChild(img);
            } else {
                core.style.fontSize = `${l.style.size * scale}px`;
                if(l.style.texture !== 'none') {
                     core.style.color='transparent'; core.style.backgroundClip='text'; core.style.webkitBackgroundClip='text';
                     if(l.style.texture==='gold') core.style.backgroundImage='linear-gradient(135deg, #fef08a, #d97706)';
                     else if(l.style.texture==='magma') core.style.backgroundImage='linear-gradient(0deg, #ef4444, #000)';
                     else if(l.style.texture==='silver') core.style.backgroundImage='linear-gradient(135deg, #e2e8f0, #64748b)';
                     else if(l.style.texture==='neon') core.style.backgroundImage='linear-gradient(90deg, #22d3ee, #a855f7)';
                } else { core.style.color = l.style.color; }
                if(l.type==='icon') core.innerHTML = `<i class="${l.content}"></i>`; else core.innerText = l.content;
                if(l.type==='text') core.style.fontFamily = "'Black Han Sans', sans-serif";
            }
            spin.appendChild(core); root.appendChild(orbit);
            return root;
        }

        function updateAnim(group, key, val) { if(!selectedId) return; const l = layers.find(x => x.id === selectedId); if(l) { if(group==='spin'||group==='orbit') l.anim[group][key]=val; else l.anim[group][key]=val; renderAll(); } }
        function updateProp(key, val) { if(!selectedId) return; const l = layers.find(x => x.id === selectedId); if(l) { if(key==='content') l.content = val; else l.style[key] = val; renderAll(); } }
        function applyTexture(t) { updateProp('texture', t); }

        function selectLayer(id) {
            selectedId = id; renderAll(); 
            const l = layers.find(x => x.id === id); const p = document.getElementById('prop-panel');
            if(l) {
                p.classList.remove('hidden'); updateToggleUI(l);
                const isImg = l.type === 'image';
                document.getElementById('p-color').closest('.flex').style.display = isImg ? 'none' : 'flex';
                document.getElementById('texture-control').style.display = isImg ? 'none' : 'grid';
                document.getElementById('text-control').style.display = l.type === 'text' ? 'block' : 'none';
                if(!isImg) document.getElementById('p-color').value = l.style.color;
                if(l.type === 'text') document.getElementById('p-text').value = l.content;
                document.getElementById('p-size-val').innerText = Math.round(l.style.size) + '%';
            } else p.classList.add('hidden');
        }

        function openMarket() { document.getElementById('market-modal').style.display='flex'; switchMarketTab('face'); }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function switchMarketTab(tab) {
            document.querySelectorAll('#market-modal .border-pink-500').forEach(t => t.classList.remove('border-pink-500', 'text-white'));
            document.getElementById(`tab-${tab}`).classList.add('border-pink-500', 'text-white');
            const grid = document.getElementById('market-grid'); grid.innerHTML = '';
            const items = ASSET_DATA[tab] || ASSET_DATA.face;
            items.forEach(item => {
                const isIcon = tab === 'icon';
                const content = isIcon ? `<i class="${item}"></i>` : item;
                grid.innerHTML += `<div class="market-item" onclick="addLayer('${isIcon?'icon':'emoji'}', '${item}')">${content}</div>`;
            });
        }

        async function saveToLibrary() { if(layers.length===0) return alert("ÎπÑÏñ¥ÏûàÏäµÎãàÎã§!"); const name = prompt("Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:"); if(!name) return; const layersToSave = JSON.parse(JSON.stringify(layers)); if(layersToSave.length > 0) layersToSave[0]._signature = 'SIG-' + Date.now(); const { error } = await _supabase.from('emblem_library').insert({ name: name, layers: layersToSave }); if(error) alert("Ïò§Î•ò: " + error.message); else alert("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§."); }
        async function openLibraryModal() { document.getElementById('library-modal').style.display='flex'; const list = document.getElementById('library-list'); list.innerHTML = '<div class="text-white text-center py-10 opacity-50 font-mono">Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>'; const { data } = await _supabase.from('emblem_library').select('*').order('created_at', {ascending:false}); list.innerHTML = ''; if(data) data.forEach(item => list.innerHTML += `<div class="bg-slate-800 p-4 rounded-xl flex justify-between items-center group hover:bg-slate-700 transition cursor-pointer" onclick="loadFromLibrary('${item.id}')"><div class="font-bold text-white group-hover:text-pink-400">${item.name} <span class="text-[10px] text-slate-500 ml-2 font-mono">${new Date(item.created_at).toLocaleDateString()}</span></div><button onclick="event.stopPropagation(); deleteLibraryItem('${item.id}')" class="text-slate-500 hover:text-rose-500"><i class="fa-solid fa-trash"></i></button></div>`); }
        async function loadFromLibrary(id) { if(!confirm("ÌòÑÏû¨ ÏûëÏóÖ ÎÇ¥Ïö©ÏùÑ ÎçÆÏñ¥Ïì∞ÏãúÍ≤†ÏäµÎãàÍπå?")) return; const { data } = await _supabase.from('emblem_library').select('*').eq('id', id).single(); if(data) { layers = data.layers; closeModal('library-modal'); selectedId = null; document.getElementById('prop-panel').classList.add('hidden'); renderAll(); } }
        async function deleteLibraryItem(id) { if(confirm("Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) { await _supabase.from('emblem_library').delete().eq('id', id); openLibraryModal(); } }
        function moveLayer(id, dir) { const idx = layers.findIndex(l => l.id === id); if (idx === -1) return; const newIdx = idx + dir; if (newIdx < 0 || newIdx >= layers.length) return; [layers[idx], layers[newIdx]] = [layers[newIdx], layers[idx]]; renderAll(); }
        function deleteLayerById(id) { layers = layers.filter(l => l.id !== id); if(selectedId === id) { selectedId = null; document.getElementById('prop-panel').classList.add('hidden'); } renderAll(); }
        function deleteLayer() { deleteLayerById(selectedId); }
        function clearCanvas() { if(confirm("Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî ÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) { layers=[]; selectedId=null; document.getElementById('prop-panel').classList.add('hidden'); renderAll(); } }
        function addTextLayer() { const txt=document.getElementById('quick-text').value||"TIER"; addLayer('text', txt); document.getElementById('quick-text').value=''; }
        function handleGlobalMouseMove(e) { if (!isDragging || !dragTargetId) return; const rect = document.getElementById('stage-wrapper').getBoundingClientRect(); const l = layers.find(layer => layer.id === dragTargetId); if (l) { l.x = ((e.clientX - rect.left) / rect.width) * 100; l.y = ((e.clientY - rect.top) / rect.height) * 100; renderStage(); } }
        function handleGlobalMouseUp() { if (isDragging) { isDragging = false; dragTargetId = null; renderAll(); } }

        init();
    </script>
</body>
</html>