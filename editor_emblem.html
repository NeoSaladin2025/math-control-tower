<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Math Emblem Atelier (Storage Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Orbitron:wght@900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #0f172a; color: #e2e8f0; overflow: hidden; user-select: none; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; } ::-webkit-scrollbar-track { background: #0f172a; }

        #stage-wrapper {
            background-image: radial-gradient(#334155 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: #1e293b;
            box-shadow: inset 0 0 50px #000;
            overflow: hidden; perspective: 1000px;
        }
        
        .obj-root { position: absolute; transform-origin: center center; cursor: grab; display: flex; align-items: center; justify-content: center; width: 0; height: 0; }
        .obj-root:active { cursor: grabbing; }
        .obj-root.selected .obj-core { outline: 2px dashed #ec4899; outline-offset: 5px; z-index: 999; }

        .obj-orbit, .obj-vital, .obj-fx, .obj-spin { position: absolute; display: flex; align-items: center; justify-content: center; transform-style: preserve-3d; }
        .obj-core { position: relative; display: flex; align-items: center; justify-content: center; text-align: center; line-height: 1; white-space: nowrap; -webkit-user-select: none; user-select: none; }
        .obj-core img { pointer-events: none; -webkit-user-drag: none; max-width: none; }

        @keyframes orbit-cw { from { transform: rotate(0deg) translateX(var(--orbit-r)) rotate(0deg); } to { transform: rotate(360deg) translateX(var(--orbit-r)) rotate(-360deg); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes ghost { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
        @keyframes jelly { 0%, 100% { transform: scale(1, 1); } 25% { transform: scale(0.9, 1.1); } 50% { transform: scale(1.1, 0.9); } 75% { transform: scale(0.95, 1.05); } }
        @keyframes shake { 0% { transform: translate(0,0); } 25% { transform: translate(2px, -2px); } 50% { transform: translate(-2px, 2px); } 75% { transform: translate(2px, 2px); } 100% { transform: translate(0,0); } }
        @keyframes glitch { 0% { clip-path: inset(50% 0 30% 0); transform: translate(-5px,0); } 100% { clip-path: inset(0 0 0 0); transform: translate(0); } }
        @keyframes fire { 0% { filter: drop-shadow(0 0 2px orangered); } 50% { filter: drop-shadow(0 -5px 5px yellow); } 100% { filter: drop-shadow(0 0 2px orangered); } }
        @keyframes sparkle { 0% { filter: brightness(100%); } 50% { filter: brightness(150%) drop-shadow(0 0 5px white); } 100% { filter: brightness(100%); } }
        @keyframes neon-pulse { 0% { filter: drop-shadow(0 0 2px cyan); } 50% { filter: drop-shadow(0 0 10px magenta); } 100% { filter: drop-shadow(0 0 2px cyan); } }
        @keyframes spin-z { from { transform: rotateZ(0deg); } to { transform: rotateZ(360deg); } }
        @keyframes spin-y { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }
        @keyframes spin-x { from { transform: rotateX(0deg); } to { transform: rotateX(360deg); } }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal-content { width: 90%; max-width: 900px; height: 85%; background: #1e293b; border-radius: 20px; border: 1px solid #475569; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: popUp 0.2s forwards; }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .market-header { display: flex; overflow-x: auto; background: #334155; shrink-0; }
        .market-tab { padding: 12px 20px; cursor: pointer; font-weight: bold; color: #94a3b8; border-bottom: 3px solid transparent; white-space: nowrap; transition: 0.2s; }
        .market-tab.active { color: #f472b6; border-color: #f472b6; background: rgba(244, 114, 182, 0.1); }
        .market-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; padding: 20px; overflow-y: auto; align-content: start; }
        .market-item { aspect-ratio: 1; background: #1e293b; border: 1px solid #475569; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; transition: 0.1s; }
        .market-item:hover { background: #4f46e5; border-color: #6366f1; transform: scale(1.1); color: white; z-index: 10; }
        .library-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #334155; margin-bottom: 8px; border-radius: 12px; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .library-item:hover { border-color: #f472b6; background: #475569; transform: translateX(5px); }

        #live-preview-card {
            position: absolute; top: 20px; right: 20px; width: 350px; 
            background: white; border-radius: 20px; padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 4px solid #334155;
            z-index: 50; pointer-events: none; opacity: 0.95; transition: opacity 0.3s; overflow: visible;
        }
        #live-preview-card:hover { opacity: 0.1; }
        
        .preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .preview-title { font-weight: 900; font-size: 18px; color: #1e293b; }
        .preview-badge { font-size: 10px; font-weight: bold; background: #f1f5f9; color: #64748b; padding: 2px 8px; border-radius: 10px; border: 1px solid #e2e8f0; }
        .preview-stage-box { position: relative; width: 100%; height: 192px; display: flex; align-items: center; justify-content: center; margin: 16px 0; z-index: 20; perspective: 1000px; overflow: visible; }
        .preview-bar-bg { width: 100%; height: 10px; background: #f1f5f9; border-radius: 999px; overflow: hidden; margin-top: 8px; }
        .preview-bar-fill { width: 60%; height: 100%; background: linear-gradient(to right, #818cf8, #a855f7); }

        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden; width: 160px; background-color: #334155; color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 100; bottom: 125%; left: 50%; margin-left: -80px; opacity: 0; transition: opacity 0.3s; font-size: 10px; pointer-events: none; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid #475569;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        
        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9999; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #f472b6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex h-screen">

    <script src="config.js"></script>
    
    <div id="loading-overlay">
        <div class="loader"></div>
        <div class="text-white font-bold text-sm">Supabase Ïä§ÌÜ†Î¶¨ÏßÄÏóê ÏóÖÎ°úÎìú Ï§ë...</div>
    </div>

    <div class="w-80 bg-slate-900 border-r border-slate-700 flex flex-col shrink-0 z-20 shadow-xl">
        <div class="p-4 border-b border-slate-800 bg-slate-950">
            <h1 class="font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-500 text-lg">
                <i class="fa-solid fa-flask mr-2"></i>EMBLEM LAB
            </h1>
            <p class="text-[10px] text-slate-500 mt-1">Storage Edition (Bucket Upload)</p>
        </div>

        <div class="flex-1 overflow-y-auto p-2 border-b border-slate-800 h-1/4">
            <div class="flex justify-between items-center mb-2 px-2">
                <span class="text-xs font-bold text-slate-500">LAYERS</span>
                <button onclick="clearCanvas()" class="text-[10px] text-red-400 hover:text-red-300">CLEAR</button>
            </div>
            <div id="layer-list" class="space-y-1"></div>
        </div>

        <div id="prop-panel" class="flex-1 bg-slate-800 overflow-y-auto hidden flex flex-col">
            <div class="p-3 bg-slate-900 border-b border-slate-700 flex justify-between items-center sticky top-0 z-10">
                <span class="text-xs font-bold text-pink-400">MIXER CONSOLE</span>
                <button onclick="deleteLayer()" class="text-xs text-red-400"><i class="fa-solid fa-trash"></i></button>
            </div>
            
            <div class="p-4 space-y-6 pb-20">
                <div class="space-y-2">
                    <label class="text-[10px] text-slate-400 font-bold">BASE</label>
                    <div class="flex gap-2">
                        <input type="color" id="p-color" class="w-8 h-8 rounded cursor-pointer bg-transparent border border-slate-600" onchange="updateProp('color', this.value)">
                        <input type="range" id="p-size" min="10" max="300" class="flex-1 accent-indigo-500" oninput="updateProp('size', this.value)">
                    </div>
                    <div id="text-control" class="hidden">
                        <input type="text" id="p-text" class="w-full bg-slate-900 border border-slate-600 rounded text-xs p-2 text-white" oninput="updateProp('content', this.value)">
                    </div>
                    <div id="texture-control" class="grid grid-cols-5 gap-1">
                        <div onclick="applyTexture('none')" class="h-5 rounded bg-slate-600 cursor-pointer border border-transparent hover:border-white"></div>
                        <div onclick="applyTexture('gold')" class="h-5 rounded bg-yellow-500 cursor-pointer border border-transparent hover:border-white"></div>
                        <div onclick="applyTexture('silver')" class="h-5 rounded bg-gray-400 cursor-pointer border border-transparent hover:border-white"></div>
                        <div onclick="applyTexture('magma')" class="h-5 rounded bg-red-600 cursor-pointer border border-transparent hover:border-white"></div>
                        <div onclick="applyTexture('neon')" class="h-5 rounded bg-cyan-400 cursor-pointer border border-transparent hover:border-white"></div>
                    </div>
                </div>
                <hr class="border-slate-700">
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-[10px] text-cyan-400 font-bold"><i class="fa-solid fa-rotate mr-1"></i> SELF SPIN</label>
                        <input type="checkbox" id="anim-spin-on" onchange="updateAnim('spin', 'on', this.checked)" class="accent-cyan-500">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="anim-spin-axis" class="bg-slate-900 text-[10px] text-white p-1 rounded border border-slate-600" onchange="updateAnim('spin', 'axis', this.value)">
                            <option value="z">ZÏ∂ï (ÌèâÎ©¥)</option><option value="y">YÏ∂ï (Î¨∏Ïó¥Í∏∞)</option><option value="x">XÏ∂ï (Îç§Î∏îÎßÅ)</option>
                        </select>
                        <input type="range" id="anim-spin-speed" min="1" max="50" class="accent-cyan-500 h-1 my-auto" oninput="updateAnim('spin', 'speed', 51-this.value)">
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-[10px] text-purple-400 font-bold"><i class="fa-solid fa-globe mr-1"></i> ORBIT</label>
                        <input type="checkbox" id="anim-orbit-on" onchange="updateAnim('orbit', 'on', this.checked)" class="accent-purple-500">
                    </div>
                    <div class="flex gap-2 items-center"><span class="text-[9px] text-slate-500 w-6">Î∞òÍ≤Ω</span><input type="range" id="anim-orbit-radius" min="20" max="200" class="flex-1 accent-purple-500 h-1" oninput="updateAnim('orbit', 'radius', this.value)"></div>
                    <div class="flex gap-2 items-center"><span class="text-[9px] text-slate-500 w-6">ÏÜçÎèÑ</span><input type="range" id="anim-orbit-speed" min="1" max="50" class="flex-1 accent-purple-500 h-1" oninput="updateAnim('orbit', 'speed', 51-this.value)"></div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-[10px] text-green-400 font-bold"><i class="fa-solid fa-heart-pulse mr-1"></i> VITAL</label>
                        <input type="checkbox" id="anim-vital-on" onchange="updateAnim('vital', 'on', this.checked)" class="accent-green-500">
                    </div>
                    <select id="anim-vital-type" class="w-full bg-slate-900 text-[10px] text-white p-1 rounded border border-slate-600 mb-1" onchange="updateAnim('vital', 'type', this.value)">
                        <option value="pulse">Î∞ïÎèô (Pulse)</option><option value="float">Îë•Îë• (Float)</option><option value="ghost">Ïú†Î†π (Ghost)</option><option value="jelly">Ï†§Î¶¨ (Jelly)</option>
                    </select>
                    <div class="flex gap-2 items-center"><span class="text-[9px] text-slate-500 w-6">ÏÜçÎèÑ</span><input type="range" id="anim-vital-speed" min="1" max="20" class="flex-1 accent-green-500 h-1" oninput="updateAnim('vital', 'speed', 21-this.value)"></div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-[10px] text-red-400 font-bold"><i class="fa-solid fa-bolt mr-1"></i> FX</label>
                        <input type="checkbox" id="anim-fx-on" onchange="updateAnim('fx', 'on', this.checked)" class="accent-red-500">
                    </div>
                    <select id="anim-fx-type" class="w-full bg-slate-900 text-[10px] text-white p-1 rounded border border-slate-600 mb-1" onchange="updateAnim('fx', 'type', this.value)">
                        <option value="fire">üî• Î∂àÌÉÄÏò§Î¶Ñ (Burning)</option><option value="sparkle">‚ú® Î∞òÏßùÏûÑ (Sparkle)</option><option value="neon-pulse">‚ö° ÎÑ§Ïò® ÌéÑÏä§ (Neon)</option><option value="shake">ü´® ÏßÄÏßÑ (Shake)</option><option value="glitch">‚ò†Ô∏è Í∏ÄÎ¶¨Ïπò (Glitch)</option>
                    </select>
                    <div class="flex gap-2 items-center"><span class="text-[9px] text-slate-500 w-6">ÏÜçÎèÑ</span><input type="range" id="anim-fx-speed" min="1" max="20" class="flex-1 accent-red-500 h-1" oninput="updateAnim('fx', 'speed', 21-this.value)"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-1 flex flex-col relative">
        <div class="h-14 bg-slate-800 border-b border-slate-700 flex items-center justify-between px-4 shrink-0 z-10">
            <div class="flex gap-2 items-center">
                <button onclick="openMarket()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded font-bold text-xs flex items-center gap-2 shadow-lg">
                    <i class="fa-solid fa-cart-shopping"></i> Ïû¨Î£å (E-MART)
                </button>
                <div class="h-8 w-[1px] bg-slate-600 mx-2"></div>
                <div class="flex items-center gap-2">
                    <input type="text" id="quick-text" placeholder="TEXT" class="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs w-20 text-white">
                    <button onclick="addTextLayer()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-xs font-bold">Í∏ÄÏûê</button>
                </div>
                <div class="h-8 w-[1px] bg-slate-600 mx-2"></div>
                
                <div class="flex items-center gap-2 bg-slate-900/50 p-1 rounded border border-slate-700">
                    <input type="file" id="img-upload" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                    <button onclick="document.getElementById('img-upload').click()" class="tooltip bg-pink-600 hover:bg-pink-500 text-white px-3 py-1 rounded text-xs font-bold flex items-center gap-1 transition">
                        <i class="fa-solid fa-cloud-arrow-up"></i> ÏóÖÎ°úÎìú (Storage)
                        <span class="tooltiptext">Supabase Î≤ÑÌÇ∑Ïóê ÏòÅÍµ¨ Ï†ÄÏû•Îê©ÎãàÎã§!</span>
                    </button>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="openLibraryModal()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded font-bold text-xs flex items-center gap-2 border border-slate-600">
                    <i class="fa-solid fa-folder-open"></i> Î≥¥Í¥ÄÌï® (Repository)
                </button>
                <button onclick="saveToLibrary()" class="bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white px-6 py-2 rounded font-bold text-xs shadow-lg flex items-center gap-2">
                    <i class="fa-solid fa-floppy-disk"></i> ÏÉà Ïù¥Î¶Ñ Ï†ÄÏû•
                </button>
            </div>
        </div>

        <div id="stage-wrapper" class="flex-1 relative flex items-center justify-center cursor-crosshair">
            <div class="absolute inset-0 pointer-events-none opacity-30">
                <div class="absolute top-1/2 w-full h-[1px] bg-cyan-500"></div>
                <div class="absolute left-1/2 h-full w-[1px] bg-cyan-500"></div>
                <div class="absolute top-1/2 left-1/2 w-[300px] h-[300px] -translate-x-1/2 -translate-y-1/2 border border-cyan-500 rounded-full border-dashed"></div>
            </div>
            <div id="stage" class="w-full h-full relative pointer-events-none"></div>
            
            <div id="live-preview-card">
                <div class="text-xs font-bold text-slate-400 mb-2 uppercase tracking-widest flex justify-between">
                    <span>üî¥ Real-Time Preview</span>
                    <i class="fa-solid fa-mobile-screen"></i>
                </div>
                <div class="preview-header">
                    <div class="flex items-center gap-2">
                        <span class="preview-title">ÍπÄÌïôÏÉù</span>
                        <span class="preview-badge">Student</span>
                    </div>
                    <div class="text-[10px] font-bold text-indigo-500 border border-indigo-200 px-2 py-0.5 rounded-full">Target Tier</div>
                </div>
                <div class="preview-stage-box">
                    <div id="preview-stage" class="w-40 h-40 relative flex items-center justify-center"></div>
                </div>
                <div class="flex justify-between items-end mb-1 mt-2">
                    <span class="text-xs font-bold text-slate-400">Next Tier</span>
                    <div class="text-xs font-bold text-slate-600">1,036 / 3,000</div>
                </div>
                <div class="preview-bar-bg"><div class="preview-bar-fill"></div></div>
            </div>
            <div class="absolute bottom-4 right-4 text-[10px] text-slate-500 bg-slate-900/50 px-2 py-1 rounded">DRAG to Move / CLICK to Edit</div>
        </div>
    </div>

    <div id="market-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center p-4 bg-slate-900 border-b border-slate-700 shrink-0">
                <h2 class="text-lg font-black text-white"><i class="fa-solid fa-cart-shopping text-pink-500 mr-2"></i>ASSET MARKET</h2>
                <button onclick="closeModal('market-modal')" class="text-slate-400 hover:text-white text-xl"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="market-header custom-scroll">
                <div class="market-tab active" onclick="switchMarketTab('face')">üòÄ ÌëúÏ†ï</div>
                <div class="market-tab" onclick="switchMarketTab('animal')">üê∂ ÎèôÎ¨º</div>
                <div class="market-tab" onclick="switchMarketTab('icon')">üëë ÏïÑÏù¥ÏΩò</div>
                <div class="market-tab" onclick="switchMarketTab('object')">üíé ÏÇ¨Î¨º</div>
                <div class="market-tab" onclick="switchMarketTab('food')">üçî ÏùåÏãù</div>
                <div class="market-tab" onclick="switchMarketTab('symbol')">‚ù§Ô∏è Í∏∞Ìò∏</div>
            </div>
            <div id="market-grid" class="market-grid custom-scroll flex-1 bg-slate-900"></div>
        </div>
    </div>
    <div id="library-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center p-4 bg-slate-900 border-b border-slate-700 shrink-0">
                <h2 class="text-lg font-black text-white"><i class="fa-solid fa-folder-open text-emerald-500 mr-2"></i>EMBLEM REPOSITORY</h2>
                <button onclick="closeModal('library-modal')" class="text-slate-400 hover:text-white text-xl"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="library-list" class="flex-1 overflow-y-auto p-4 bg-slate-900 custom-scroll space-y-2"></div>
        </div>
    </div>

    <script>
        let layers = []; let selectedId = null; 
        let isDragging = false; let dragTargetId = null;

        async function init() {
            window.addEventListener('mousemove', handleGlobalMouseMove);
            window.addEventListener('mouseup', handleGlobalMouseUp);
        }

        // ‚òÖ [NEW] Supabase Storage ÏóÖÎ°úÎìú Î°úÏßÅ (ÌïµÏã¨!)
        async function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const loading = document.getElementById('loading-overlay');
            loading.style.display = 'flex'; // Î°úÎî© ÏãúÏûë

            try {
                // 1. ÌååÏùºÎ™Ö Ïú†ÎãàÌÅ¨ÌïòÍ≤å ÏÉùÏÑ± (Ï∂©Îèå Î∞©ÏßÄ)
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
                const filePath = `${fileName}`; // Ìè¥Îçî ÏóÜÏù¥ Î£®Ìä∏Ïóê Ï†ÄÏû• (ÌïÑÏöîÏãú 'folder/filename' Í∞ÄÎä•)

                // 2. Î≤ÑÌÇ∑Ïóê ÏóÖÎ°úÎìú ('emblem_assets' Î≤ÑÌÇ∑Ïù¥ Ï°¥Ïû¨Ìï¥Ïïº Ìï®!)
                const { data, error } = await _supabase.storage
                    .from('emblem_assets')
                    .upload(filePath, file);

                if (error) throw error;

                // 3. Í≥µÍ∞ú URL Í∞ÄÏ†∏Ïò§Í∏∞
                const { data: { publicUrl } } = _supabase.storage
                    .from('emblem_assets')
                    .getPublicUrl(filePath);

                // 4. URLÏùÑ Î†àÏù¥Ïñ¥ Ïª®ÌÖêÏ∏†Î°ú ÏÇ¨Ïö©
                addLayer('image', publicUrl, 'custom');

            } catch (e) {
                console.error(e);
                alert("ÏóÖÎ°úÎìú Ïã§Ìå®!\nSupabaseÏóê 'emblem_assets' Î≤ÑÌÇ∑Ïù¥ ÏûàÎäîÏßÄ, Public ÏÑ§Ï†ïÏù¥ ÎêòÏñ¥ÏûàÎäîÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.\n\nÏóêÎü¨: " + e.message);
            } finally {
                loading.style.display = 'none'; // Î°úÎî© ÎÅù
                input.value = ''; // Ï¥àÍ∏∞Ìôî
            }
        }

        function addLayer(type, content, subType='emoji') {
            const id = Date.now().toString();
            const layer = { 
                id, type, content, subType, x: 50, y: 50, 
                style: { size: type==='image'?150:(type==='bg'?300:100), color: '#ffffff', texture: 'none' },
                anim: {
                    spin: { on: false, axis: 'z', speed: 10 },
                    orbit: { on: false, radius: 100, speed: 20 },
                    vital: { on: false, type: 'pulse', speed: 10 },
                    fx: { on: false, type: 'fire', speed: 10 }
                }
            };
            if(type==='text') layer.style.color='#fbbf24';
            layers.push(layer); 
            if(document.getElementById('market-modal')) document.getElementById('market-modal').style.display='none';
            renderAll(); selectLayer(id);
        }

        function renderAll() {
            renderStage();
            renderPreview();
            renderLayerList();
        }

        function renderStage() {
            const stage = document.getElementById('stage');
            stage.innerHTML = '';
            layers.forEach(l => {
                const root = createObjDOM(l, 'edit');
                root.addEventListener('mousedown', (e) => { e.stopPropagation(); e.preventDefault(); selectLayer(l.id); isDragging = true; dragTargetId = l.id; });
                root.style.pointerEvents = "auto";
                if(l.id === selectedId) root.classList.add('selected');
                stage.appendChild(root);
            });
        }

        function renderPreview() {
            const stage = document.getElementById('preview-stage');
            stage.innerHTML = '';
            const scaleFactor = 0.45; 
            layers.forEach(l => {
                const root = createObjDOM(l, 'preview', scaleFactor);
                stage.appendChild(root);
            });
        }

        function renderLayerList() {
            const list = document.getElementById('layer-list');
            list.innerHTML = '';
            
            const reversedLayers = [...layers].map((l, idx) => ({...l, originalIndex: idx})).reverse();

            reversedLayers.forEach(l => {
                const item = document.createElement('div');
                const isSelected = l.id === selectedId;
                item.className = `p-2 rounded border cursor-pointer flex items-center justify-between mb-1 ${isSelected ? 'bg-slate-700 border-pink-500' : 'bg-slate-800 border-slate-700 hover:border-slate-500'}`;
                item.onclick = () => selectLayer(l.id);
                
                let label = '';
                if(l.type === 'image') label = '<span class="text-pink-400 font-bold"><i class="fa-solid fa-image"></i> IMG</span>';
                else if(l.type === 'text') label = `<span class="text-yellow-400 font-bold">T</span> ${l.content}`;
                else label = `<span class="text-white">${l.content}</span>`;

                item.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden w-2/3">
                        ${label}
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="event.stopPropagation(); moveLayer('${l.id}', 1)" class="text-slate-500 hover:text-white px-1" title="ÏïûÏúºÎ°ú(ÏúÑÎ°ú)"><i class="fa-solid fa-arrow-up"></i></button>
                        <button onclick="event.stopPropagation(); moveLayer('${l.id}', -1)" class="text-slate-500 hover:text-white px-1" title="Îí§Î°ú(ÏïÑÎûòÎ°ú)"><i class="fa-solid fa-arrow-down"></i></button>
                        <button onclick="event.stopPropagation(); deleteLayerById('${l.id}')" class="text-slate-500 hover:text-red-400 px-1 ml-1"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function moveLayer(id, dir) {
            const idx = layers.findIndex(l => l.id === id);
            if (idx === -1) return;
            const newIdx = idx + dir;
            if (newIdx < 0 || newIdx >= layers.length) return;
            [layers[idx], layers[newIdx]] = [layers[newIdx], layers[idx]];
            renderAll();
        }

        function deleteLayerById(id) {
            layers = layers.filter(l => l.id !== id);
            if(selectedId === id) {
                selectedId = null;
                document.getElementById('prop-panel').classList.add('hidden');
            }
            renderAll();
        }

        function createObjDOM(l, mode, scale=1.0) {
            const root = document.createElement('div');
            root.className = 'obj-root';
            root.id = mode === 'edit' ? `obj-${l.id}` : `prev-${l.id}`;
            root.style.left = `${l.x}%`;
            root.style.top = `${l.y}%`;

            const orbit = document.createElement('div'); orbit.className = 'obj-orbit';
            if(l.anim.orbit.on) { orbit.style.setProperty('--orbit-r', `${l.anim.orbit.radius * scale}px`); orbit.style.animation = `orbit-cw ${l.anim.orbit.speed/5}s linear infinite`; }

            const vital = document.createElement('div'); vital.className = 'obj-vital';
            if(l.anim.vital.on) { vital.style.animation = `${l.anim.vital.type} ${l.anim.vital.speed/10}s infinite ease-in-out`; }

            const fx = document.createElement('div'); fx.className = 'obj-fx';
            if(l.anim.fx.on) { fx.style.animation = `${l.anim.fx.type} ${l.anim.fx.speed/10}s infinite`; }

            const spin = document.createElement('div'); spin.className = 'obj-spin';
            if(l.anim.spin.on) { spin.style.animation = `spin-${l.anim.spin.axis} ${l.anim.spin.speed/5}s linear infinite`; }

            const core = document.createElement('div');
            core.className = 'obj-core';
            
            if (l.type === 'image') {
                const img = document.createElement('img');
                img.src = l.content;
                img.style.width = `${l.style.size * scale}px`;
                img.style.height = 'auto';
                core.appendChild(img);
            } else {
                core.style.fontSize = `${l.style.size * scale}px`;
                if(l.style.texture !== 'none') {
                     core.style.color='transparent'; core.style.backgroundClip='text'; core.style.webkitBackgroundClip='text';
                     if(l.style.texture==='gold') core.style.backgroundImage='linear-gradient(135deg, #fef08a, #d97706)';
                     else if(l.style.texture==='magma') core.style.backgroundImage='linear-gradient(0deg, #ef4444, #000)';
                     else if(l.style.texture==='silver') core.style.backgroundImage='linear-gradient(135deg, #e2e8f0, #64748b)';
                     else if(l.style.texture==='neon') core.style.backgroundImage='linear-gradient(90deg, #22d3ee, #a855f7)';
                } else { core.style.color = l.style.color; }

                if(l.type==='icon') core.innerHTML = `<i class="${l.content}"></i>`;
                else core.innerText = l.content;
                if(l.type==='text') core.style.fontFamily = "'Black Han Sans', sans-serif";
            }

            spin.appendChild(core); fx.appendChild(spin); vital.appendChild(fx); orbit.appendChild(vital); root.appendChild(orbit);
            return root;
        }

        function updateAnim(group, key, val) {
            if(!selectedId) return;
            const l = layers.find(x => x.id === selectedId);
            if(l) { l.anim[group][key] = val; renderAll(); }
        }
        function updateProp(key, val) {
            if(!selectedId) return;
            const l = layers.find(x => x.id === selectedId);
            if(l) { if(key==='content') l.content = val; else l.style[key] = val; renderAll(); }
        }
        function applyTexture(t) { updateProp('texture', t); }

        function selectLayer(id) {
            selectedId = id; 
            renderAll(); 
            const l = layers.find(x => x.id === id);
            const p = document.getElementById('prop-panel');
            if(l) {
                p.classList.remove('hidden');
                if(l.type === 'image') {
                    document.getElementById('p-color').parentElement.parentElement.classList.add('hidden');
                    document.getElementById('texture-control').parentElement.classList.add('hidden');
                    document.getElementById('text-control').classList.add('hidden');
                } else {
                    document.getElementById('p-color').parentElement.parentElement.classList.remove('hidden');
                    document.getElementById('p-color').value = l.style.color;
                    if(l.type === 'text') {
                        document.getElementById('text-control').classList.remove('hidden');
                        document.getElementById('p-text').value = l.content;
                        document.getElementById('texture-control').classList.remove('hidden');
                    } else {
                        document.getElementById('text-control').classList.add('hidden');
                        document.getElementById('texture-control').classList.remove('hidden');
                    }
                }
                document.getElementById('p-size').value = l.style.size;
                document.getElementById('anim-spin-on').checked = l.anim.spin.on;
                document.getElementById('anim-spin-axis').value = l.anim.spin.axis;
                document.getElementById('anim-spin-speed').value = 51 - l.anim.spin.speed;
                document.getElementById('anim-orbit-on').checked = l.anim.orbit.on;
                document.getElementById('anim-orbit-radius').value = l.anim.orbit.radius;
                document.getElementById('anim-orbit-speed').value = 51 - l.anim.orbit.speed; 
                document.getElementById('anim-vital-on').checked = l.anim.vital.on;
                document.getElementById('anim-vital-type').value = l.anim.vital.type;
                document.getElementById('anim-vital-speed').value = 21 - l.anim.vital.speed;
                document.getElementById('anim-fx-on').checked = l.anim.fx.on;
                document.getElementById('anim-fx-type').value = l.anim.fx.type;
                document.getElementById('anim-fx-speed').value = 21 - l.anim.fx.speed;
            } else p.classList.add('hidden');
        }

        const assetData = {
            face: ['üòÄ','üòé','üíÄ','üî•','üí©','üëë','üíé','üèÜ','‚ù§Ô∏è','üöÄ','üëΩ','üëª','ü§°','üëπ','üë∫','ü§ñ'],
            animal: ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß'],
            icon: ['fa-solid fa-crown','fa-solid fa-trophy','fa-solid fa-medal','fa-solid fa-star','fa-solid fa-bolt','fa-solid fa-fire','fa-solid fa-skull','fa-solid fa-dragon','fa-solid fa-rocket','fa-solid fa-heart','fa-solid fa-certificate','fa-solid fa-radiation','fa-solid fa-biohazard','fa-solid fa-eye','fa-solid fa-hand-fist','fa-solid fa-diamond','fa-solid fa-chess-king','fa-solid fa-yin-yang'],
            object: ['üëì','üï∂','üíç','üí£','üéà','üéâ','üíä','üíâ','ü©∏','üß¨','üî≠','üî¨','üõ°','üó°','‚öî','üèπ'],
            food: ['üçé','üçå','üçâ','üçá','üçì','üçî','üçü','üçï','üå≠','üçø','üç©','üç™','üéÇ','üç´','üç¨','üç≠'],
            symbol: ['‚òÆ','‚úù','‚ò™','üïâ','‚ò∏','‚ú°','üîØ','üïé','‚òØ','‚ò¶','üõê','‚õé','‚ôà','‚ôâ','‚ôä','‚ôã']
        };
        function openMarket() { document.getElementById('market-modal').style.display='flex'; switchMarketTab('face'); }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function switchMarketTab(tab) {
            document.querySelectorAll('.market-tab').forEach(t => t.classList.remove('active')); event.target.classList.add('active');
            const grid = document.getElementById('market-grid'); grid.innerHTML = '';
            const items = assetData[tab] || assetData.face;
            if(tab === 'icon') items.forEach(i => grid.innerHTML += `<div class="market-item" onclick="addLayer('icon', '${i}')"><i class="${i}"></i></div>`);
            else items.forEach(e => grid.innerHTML += `<div class="market-item" onclick="addLayer('emoji', '${e}')">${e}</div>`);
        }

        async function saveToLibrary() {
            if(layers.length===0) return alert("Empty!");
            const name = prompt("Name:"); if(!name) return;
            const layersToSave = JSON.parse(JSON.stringify(layers));
            if(layersToSave.length > 0) layersToSave[0]._signature = 'SIG-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);
            const { error } = await _supabase.from('emblem_library').insert({ name: name, layers: layersToSave });
            if(error) alert("Error: " + error.message); else alert("Saved!");
        }

        async function openLibraryModal() {
            document.getElementById('library-modal').style.display='flex';
            const list = document.getElementById('library-list'); 
            list.innerHTML = '<div class="text-white text-center py-4">Loading & Migrating...</div>';
            let { data: libData } = await _supabase.from('emblem_library').select('*').order('created_at', {ascending:false});
            const updates = [];
            if(libData) {
                for(const item of libData) {
                    if(item.layers && item.layers.length > 0 && !item.layers[0]._signature) {
                        const newLayers = JSON.parse(JSON.stringify(item.layers));
                        newLayers[0]._signature = 'LEGACY-' + item.id + '-' + Date.now(); 
                        updates.push(_supabase.from('emblem_library').update({ layers: newLayers }).eq('id', item.id));
                        item.layers = newLayers;
                    }
                }
            }
            if(updates.length > 0) await Promise.all(updates);
            const { data: tiers } = await _supabase.from('tier_rules').select('tier_name, emblem_json');
            list.innerHTML = '';
            if(libData) {
                libData.forEach(item => {
                    const itemJson = JSON.stringify(item.layers);
                    let usedTier = null;
                    if(tiers) {
                        for(const t of tiers) {
                            if(t.emblem_json && t.emblem_json.layers) {
                                if(JSON.stringify(t.emblem_json.layers) === itemJson) {
                                    usedTier = t.tier_name;
                                    break;
                                }
                            }
                        }
                    }
                    let btnHtml = '';
                    if(usedTier) {
                        btnHtml = `<div class="text-[10px] text-red-400 font-bold bg-red-900/30 px-2 py-1 rounded border border-red-500/50">‚õî ${usedTier} ÏÇ¨Ïö© Ï§ë</div>`;
                    } else {
                        btnHtml = `<button onclick="event.stopPropagation(); deleteLibraryItem('${item.id}')" class="text-slate-500 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>`;
                    }
                    list.innerHTML += `
                        <div class="library-item" onclick="loadFromLibrary('${item.id}')">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded bg-slate-700 flex items-center justify-center text-xl">üé®</div>
                                <div>
                                    <div class="font-bold text-white text-sm hover:text-pink-400 transition">${item.name}</div>
                                    <div class="text-[10px] text-slate-400">${new Date(item.created_at).toLocaleDateString()}</div>
                                </div>
                            </div>
                            ${btnHtml}
                        </div>
                    `;
                });
            }
        }

        async function loadFromLibrary(id) {
            if(!confirm("Load? (Unsaved work will be lost)")) return;
            const { data } = await _supabase.from('emblem_library').select('*').eq('id', id).single();
            if(data) { layers = data.layers; closeModal('library-modal'); selectedId = null; document.getElementById('prop-panel').classList.add('hidden'); renderAll(); }
        }

        async function deleteLibraryItem(id) { 
            if(!confirm("Really Delete?")) return; 
            await _supabase.from('emblem_library').delete().eq('id', id); 
            openLibraryModal();
        }

        function handleGlobalMouseMove(e) {
            if (!isDragging || !dragTargetId) return;
            const stageWrapper = document.getElementById('stage-wrapper');
            const rect = stageWrapper.getBoundingClientRect();
            let x = ((e.clientX - rect.left) / rect.width) * 100;
            let y = ((e.clientY - rect.top) / rect.height) * 100;
            const l = layers.find(layer => layer.id === dragTargetId);
            if (l) { l.x = x; l.y = y; renderAll(); }
        }
        function handleGlobalMouseUp(e) { if (isDragging) { isDragging = false; dragTargetId = null; } }
        function addTextLayer() { const txt=document.getElementById('quick-text').value||"TIER"; addLayer('text', txt); document.getElementById('quick-text').value=''; }
        function deleteLayer() { if(!selectedId)return; layers=layers.filter(l=>l.id!==selectedId); selectedId=null; document.getElementById('prop-panel').classList.add('hidden'); renderAll(); }
        function clearCanvas() { if(confirm("Clear?")) { layers=[]; selectedId=null; document.getElementById('prop-panel').classList.add('hidden'); renderAll(); } }

        init();
    </script>
</body>
</html>