<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹œì¦Œ ê´€ë¦¬ ì»¨íŠ¸ë¡¤ íƒ€ì›Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Orbitron:wght@900&family=Rubik+Glitch&family=Cinzel:wght@900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; padding: 2rem; user-select: none; }
        
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tab-btn { padding: 12px 24px; font-weight: 800; color: #94a3b8; border-bottom: 3px solid transparent; transition: all 0.2s; cursor: pointer; white-space: nowrap; }
        .tab-btn:hover { color: #6366f1; }
        .tab-btn.active { color: #4f46e5; border-bottom-color: #4f46e5; }
        
        /* ì— ë¸”ëŸ¼ ë Œë”ë§ ì—”ì§„ CSS (í•™ìƒ í˜ì´ì§€ì™€ ë™ì¼) */
        .render-obj { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: all 0.3s; pointer-events: none; display: flex; align-items: center; justify-content: center; }
        @keyframes spin-self { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes orbit { from { transform: rotate(0deg) translateX(var(--orbit-radius)) rotate(0deg); } to { transform: rotate(360deg) translateX(var(--orbit-radius)) rotate(-360deg); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 100% { transform: translate(0,0) rotate(0); } }
        @keyframes glitch { 0% { clip-path: inset(50% 0 30% 0); transform: translate(-5px,0); } 100% { clip-path: inset(0 0 0 0); transform: translate(0); } }
        
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ (í•™ìƒ ì¹´ë“œ ìŠ¤íƒ€ì¼ ë³µì œ) */
        #preview-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .student-card-preview { background: white; width: 400px; padding: 24px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); position: relative; overflow: hidden; }
        
        /* í‹°ì–´ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .tier-card { transition: all 0.2s; border: 2px solid #e2e8f0; background: white; }
        .insert-zone { height: 24px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; cursor: pointer; margin: 4px 0; position: relative; }
        .insert-zone:hover { opacity: 1; }
        .insert-line { position: absolute; width: 100%; height: 2px; background: #e0e7ff; z-index: 0; }
        .plus-circle { width: 24px; height: 24px; background: #4f46e5; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(79, 70, 229, 0.4); z-index: 1; transform: scale(0.8); transition: transform 0.2s; }
        .insert-zone:hover .plus-circle { transform: scale(1.1); }
        .xp-input { background: transparent; border-bottom: 2px solid #cbd5e1; text-align: center; font-family: monospace; font-weight: bold; width: 80px; transition: 0.2s; }
        .xp-input:focus { outline: none; border-color: #4f46e5; color: #4f46e5; }
    </style>
</head>
<body>
    <script src="config.js"></script>

    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-end mb-6">
            <div>
                <h2 class="text-3xl font-black text-slate-800 flex items-center gap-2">
                    <i class="fa-solid fa-trophy text-amber-500"></i> ì‹œì¦Œ ê´€ë¦¬ ì»¨íŠ¸ë¡¤ íƒ€ì›Œ
                </h2>
                <p class="text-sm text-slate-500 mt-2 font-bold">í˜„ì¬ ì‹œì¦Œ: <span id="current-season-display" class="text-indigo-600">ë¡œë”© ì¤‘...</span> <span id="status-badge" class="px-2 py-0.5 rounded text-[10px] bg-slate-200 text-slate-500">UNKNOWN</span></p>
            </div>
        </div>

        <div class="flex border-b border-slate-200 mb-8 overflow-x-auto pb-1">
            <button onclick="switchTab('control')" class="tab-btn active" id="tab-control">âš™ï¸ ì‹œì¦Œ í†µì œì‹¤</button>
            <button onclick="switchTab('tier')" class="tab-btn" id="tab-tier">ğŸ“Š ì‹œì¦Œ í‹°ì–´ ê´€ë¦¬</button>
            <button onclick="switchTab('users')" class="tab-btn" id="tab-users">ğŸ‘¥ ì‹œì¦Œ ì°¸ì—¬ì</button>
            <button onclick="switchTab('emblem')" class="tab-btn text-pink-600 font-black" id="tab-emblem">ğŸ¨ ì— ë¸”ëŸ¼ ì œì‘ & ë°°í¬</button>
            <button onclick="switchTab('event')" class="tab-btn" id="tab-event">ğŸ‰ í‹°ì–´ ì´ë²¤íŠ¸</button>
            <button onclick="switchTab('notice')" class="tab-btn" id="tab-notice">ğŸ“¢ ì‹œì¦Œ ê³µì§€</button>
            <div class="tooltip-wrap">
                <button onclick="switchTab('award')" class="tab-btn" id="tab-award">ğŸ† ì‹œìƒì‹ (ì¢…ë£Œ í›„)</button>
            </div>
        </div>

        <div id="view-control" class="tab-view animate-fade-in">
            <div class="grid grid-cols-2 gap-8">
                <div class="bg-white p-8 rounded-2xl border border-indigo-100 shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fa-solid fa-play text-9xl text-indigo-500"></i></div>
                    <h3 class="text-xl font-bold text-slate-800 mb-4">ğŸš€ ìƒˆ ì‹œì¦Œ ì‹œì‘</h3>
                    <p class="text-sm text-slate-500 mb-6">ì „êµìƒì˜ 'ì‹œì¦Œ XP'ê°€ 0ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</p>
                    <div class="flex gap-2">
                        <input type="text" id="new-season-name" placeholder="ì˜ˆ: 2025 Spring Season" class="flex-1 bg-slate-50 border rounded-xl px-4 py-3 font-bold">
                        <button onclick="startSeason()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg active:scale-95">ì‹œì‘</button>
                    </div>
                </div>
                <div class="bg-white p-8 rounded-2xl border border-red-100 shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fa-solid fa-lock text-9xl text-red-500"></i></div>
                    <h3 class="text-xl font-bold text-slate-800 mb-4">ğŸ”’ ì‹œì¦Œ ì¢…ë£Œ</h3>
                    <p class="text-sm text-slate-500 mb-6">ì‹œì¦Œì„ ì¢…ë£Œí•˜ê³  ë°ì´í„°ë¥¼ ë™ê²°í•©ë‹ˆë‹¤.</p>
                    <button onclick="endSeasonStep1()" id="btn-end-season" class="w-full bg-slate-800 hover:bg-slate-900 text-white py-4 rounded-xl font-bold shadow-lg">ì‹œì¦Œ ì¢…ë£Œ (ì ê¸ˆ)</button>
                </div>
            </div>
        </div>

        <div id="view-tier" class="tab-view hidden">
            <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="font-black text-slate-800 text-xl">ë“±ê¸‰ë³„ XP êµ¬ê°„ ì„¤ì •</h3>
                    <button onclick="verifyTiers()" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg font-bold hover:bg-slate-200">ê²€ì¦</button>
                </div>
                <div id="tier-list-container" class="space-y-1 mb-8"></div>
                <button onclick="saveTiers()" id="btn-save-tier" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 disabled:opacity-50" disabled>ì €ì¥ ë° ì ìš©</button>
            </div>
        </div>

        <div id="view-users" class="tab-view hidden">
            <div class="bg-white p-10 rounded-2xl shadow-sm border border-slate-200 text-center relative overflow-hidden group hover:border-indigo-300 transition">
                <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center text-4xl mx-auto mb-6 group-hover:scale-110 transition duration-500">ğŸ‘¥</div>
                <h3 class="text-2xl font-black text-slate-800 mb-2">ì‹œì¦Œ ì°¸ì—¬ì & ì‹¬íŒ ê´€ë¦¬</h3>
                <button onclick="window.open('manager_season_users.html', '_blank', 'width=1000,height=800')" class="bg-slate-800 hover:bg-black text-white px-8 py-4 rounded-2xl font-bold shadow-xl active:scale-95 mx-auto">ê´€ë¦¬ì†Œ ì…ì¥í•˜ê¸°</button>
            </div>
        </div>

        <div id="view-emblem" class="tab-view hidden">
            
            <div class="bg-slate-900 rounded-2xl p-6 mb-6 flex justify-between items-center shadow-lg relative overflow-hidden">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20"></div>
                <div class="relative z-10">
                    <h3 class="text-xl font-black text-white flex items-center gap-2">
                        <i class="fa-solid fa-industry text-pink-500"></i> ì— ë¸”ëŸ¼ ì œì‘ì†Œ (Factory)
                    </h3>
                    <p class="text-xs text-slate-400 mt-1">ìƒˆë¡œìš´ ë””ìì¸ì„ ì—°êµ¬í•˜ê³  ì €ì¥ê³ ì— ë³´ê´€í•˜ì„¸ìš”.</p>
                </div>
                <button onclick="openEmblemEditor()" class="relative z-10 bg-gradient-to-r from-pink-600 to-purple-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition">
                    <i class="fa-solid fa-hammer mr-2"></i> ì œì‘ì†Œ ì…ì¥í•˜ê¸°
                </button>
            </div>

            <div class="flex gap-6 h-[600px]">
                <div class="w-1/3 bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col">
                    <h4 class="font-bold text-slate-700 mb-4 border-b pb-2">1. ë§¤ì¹­ ì„¤ì • (Match)</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">ì ìš©í•  í‹°ì–´ (Tier)</label>
                            <select id="assign-tier-select" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold outline-none focus:border-indigo-500"></select>
                        </div>
                        <div class="flex items-center justify-center py-2 text-slate-300"><i class="fa-solid fa-arrow-down"></i></div>
                        <div class="flex-1 overflow-y-auto custom-scroll bg-slate-50 rounded-xl p-2 border border-slate-200">
                            <label class="block text-xs font-bold text-slate-500 mb-2 px-2">ë³´ê´€í•¨ (Library) - ìµœì‹ ìˆœ</label>
                            <div id="library-list" class="space-y-2">
                                </div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col">
                    <h4 class="font-bold text-slate-700 mb-4 border-b pb-2 flex justify-between items-center">
                        <span>2. ë°°í¬ ëŒ€ê¸° ëª©ë¡ (Cart)</span>
                        <span id="cart-count" class="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded-full">0ê±´</span>
                    </h4>
                    
                    <div id="cart-list" class="flex-1 overflow-y-auto custom-scroll space-y-2 bg-slate-50 rounded-xl p-4 border border-slate-100 mb-4">
                        <div class="text-center py-20 text-slate-400 text-sm">
                            ì™¼ìª½ì—ì„œ í‹°ì–´ì™€ ì— ë¸”ëŸ¼ì„ ì„ íƒí•˜ì—¬<br>ì¶”ê°€í•´ì£¼ì„¸ìš”.
                        </div>
                    </div>

                    <button onclick="deployAll()" class="w-full py-4 bg-slate-800 text-white rounded-xl font-bold shadow-lg hover:bg-black transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-rocket"></i> ì „êµìƒì—ê²Œ ì¦‰ì‹œ ë°°í¬ (Deploy All)
                    </button>
                </div>
            </div>
        </div>

        <div id="view-event" class="tab-view hidden"><div class="bg-white p-10 rounded-2xl shadow-sm text-center">Coming Soon</div></div>
        <div id="view-notice" class="tab-view hidden"><div class="bg-white p-6 rounded-2xl shadow-sm"><textarea id="notice-content" class="w-full h-32 border rounded p-4 mb-2"></textarea><button onclick="saveNotice()" class="bg-indigo-600 text-white px-4 py-2 rounded">ì „ì†¡</button></div></div>
        <div id="view-award" class="tab-view hidden"><div class="bg-white p-6 rounded-2xl shadow-sm">ì‹œìƒì‹ ì¤€ë¹„ì¤‘</div></div>

    </div>

    <div id="preview-modal">
        <div class="student-card-preview group">
            <button onclick="document.getElementById('preview-modal').style.display='none'" class="absolute top-4 right-4 text-slate-300 hover:text-slate-500 z-50"><i class="fa-solid fa-xmark text-xl"></i></button>
            
            <div class="absolute top-0 right-0 p-10 opacity-5 pointer-events-none"><i class="fa-solid fa-crown text-9xl"></i></div>
            
            <div class="flex justify-between items-start relative z-10 mb-4">
                <div>
                    <div class="flex items-center gap-2">
                        <h2 class="text-2xl font-black text-slate-800">ê¹€í•™ìƒ</h2>
                        <span class="bg-slate-100 text-slate-500 text-[10px] px-2 py-0.5 rounded-full font-bold border border-slate-200">Preview</span>
                    </div>
                    <p class="text-xs font-bold text-slate-400 mt-1"><i class="fa-solid fa-layer-group"></i> Total Lv.99</p>
                </div>
                <div class="text-right">
                    <div class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider">Target Tier</div>
                    <div class="font-black text-slate-800" id="preview-tier-name">Gold</div>
                </div>
            </div>

            <div class="relative w-full h-48 flex items-center justify-center my-2 z-10">
                <div id="preview-stage" class="w-40 h-40 relative flex items-center justify-center">
                    </div>
            </div>

            <div class="relative z-10">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-xs font-bold text-slate-400">Next Tier</span>
                    <div class="text-right"><span class="text-lg font-black text-indigo-600">750</span> XP</div>
                </div>
                <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden shadow-inner">
                    <div class="h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 w-[75%]"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSeason = null;
        let tiers = [];
        let assignmentCart = []; // ì¥ë°”êµ¬ë‹ˆ { tierName, emblemId, emblemData, emblemName }

        // íƒ­ ì „í™˜
        function switchTab(id) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`tab-${id}`).classList.add('active');
            document.getElementById(`view-${id}`).classList.remove('hidden');
            
            if(id === 'emblem') loadEmblemTab();
        }

        async function init() {
            // ì‹œì¦Œ & í‹°ì–´ ë¡œë“œ (ê¸°ì¡´ ë¡œì§)
            const { data: seasons } = await _supabase.from('seasons').select('*').eq('is_current', true).maybeSingle();
            currentSeason = seasons;
            if(seasons) document.getElementById('current-season-display').innerText = seasons.season_name;
            else document.getElementById('current-season-display').innerText = "ì—†ìŒ";

            const { data: tr } = await _supabase.from('tier_rules').select('*').order('min_xp');
            tiers = tr || [];
            renderTiers(); // ê¸°ì¡´ í‹°ì–´ ê´€ë¦¬ íƒ­ìš©
        }

        // --- â˜… ì— ë¸”ëŸ¼ ì œì‘ & ë°°í¬ íƒ­ ë¡œì§ â˜… ---
        function openEmblemEditor() {
            window.open('editor_emblem.html', '_blank', 'width=1400,height=900,left=100,top=50');
        }

        async function loadEmblemTab() {
            // 1. í‹°ì–´ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì±„ìš°ê¸°
            const sel = document.getElementById('assign-tier-select');
            sel.innerHTML = '<option value="">í‹°ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            tiers.forEach(t => sel.innerHTML += `<option value="${t.tier_name}">${t.tier_name}</option>`);

            // 2. ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª©ë¡ ì±„ìš°ê¸° (ìµœì‹ ìˆœ)
            const list = document.getElementById('library-list');
            list.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-spinner fa-spin text-slate-400"></i></div>';
            
            // updated_atì´ ìˆìœ¼ë©´ ê·¸ê±¸ë¡œ, ì—†ìœ¼ë©´ created_atìœ¼ë¡œ ì •ë ¬
            const { data: lib, error } = await _supabase
                .from('emblem_library')
                .select('*')
                .order('created_at', { ascending: false }); // í…Œì´ë¸”ì— updated_atì´ ìˆë‹¤ë©´ ê·¸ê±¸ ì“°ì„¸ìš”. ì¼ë‹¨ created_at ê¸°ì¤€.

            list.innerHTML = '';
            if(!lib || lib.length === 0) {
                list.innerHTML = '<div class="text-center text-xs text-slate-400 py-4">ì €ì¥ëœ ì— ë¸”ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì œì‘ì†Œì—ì„œ ë§Œë“¤ì–´ë³´ì„¸ìš”.</div>';
                return;
            }

            lib.forEach(item => {
                // í´ë¦­í•˜ë©´ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ì‹œë„
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-3 bg-white border border-slate-200 rounded-lg cursor-pointer hover:border-pink-500 hover:shadow-md transition group";
                div.onclick = () => addToCart(item);
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded bg-slate-100 flex items-center justify-center text-lg">ğŸ¨</div>
                        <div>
                            <div class="font-bold text-slate-700 text-sm group-hover:text-pink-600">${item.name}</div>
                            <div class="text-[10px] text-slate-400">${new Date(item.created_at).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-plus text-slate-300 group-hover:text-pink-500"></i>
                `;
                list.appendChild(div);
            });
        }

        function addToCart(emblemItem) {
            const tierName = document.getElementById('assign-tier-select').value;
            if(!tierName) return alert("ë¨¼ì € ì ìš©í•  í‹°ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

            // ì´ë¯¸ ì¥ë°”êµ¬ë‹ˆì— í•´ë‹¹ í‹°ì–´ê°€ ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°
            const existingIdx = assignmentCart.findIndex(x => x.tierName === tierName);
            if(existingIdx >= 0) {
                if(!confirm(`ì´ë¯¸ [${tierName}] í‹°ì–´ì— ëŒ€í•œ ì„¤ì •ì´ ì¥ë°”êµ¬ë‹ˆì— ìˆìŠµë‹ˆë‹¤.\në®ì–´ì”Œìš°ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                assignmentCart[existingIdx] = { tierName, emblemId: emblemItem.id, emblemName: emblemItem.name, emblemData: emblemItem.layers };
            } else {
                assignmentCart.push({ tierName, emblemId: emblemItem.id, emblemName: emblemItem.name, emblemData: emblemItem.layers });
            }
            renderCart();
        }

        function removeFromCart(idx) {
            assignmentCart.splice(idx, 1);
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cart-list');
            const countBadge = document.getElementById('cart-count');
            
            countBadge.innerText = `${assignmentCart.length}ê±´`;
            container.innerHTML = '';

            if(assignmentCart.length === 0) {
                container.innerHTML = `<div class="text-center py-20 text-slate-400 text-sm">ì™¼ìª½ì—ì„œ í‹°ì–´ì™€ ì— ë¸”ëŸ¼ì„ ì„ íƒí•˜ì—¬<br>ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>`;
                return;
            }

            assignmentCart.forEach((item, idx) => {
                container.innerHTML += `
                    <div class="bg-white p-3 rounded-lg border border-slate-200 shadow-sm flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="bg-slate-800 text-white text-[10px] font-bold px-2 py-1 rounded">${item.tierName}</span>
                            <i class="fa-solid fa-arrow-right text-slate-300 text-xs"></i>
                            <span class="font-bold text-indigo-600 text-sm">${item.emblemName}</span>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="previewCartItem(${idx})" class="w-8 h-8 rounded hover:bg-slate-100 text-slate-500 hover:text-indigo-600" title="ë¯¸ë¦¬ë³´ê¸°"><i class="fa-solid fa-eye"></i></button>
                            <button onclick="removeFromCart(${idx})" class="w-8 h-8 rounded hover:bg-slate-100 text-slate-500 hover:text-red-500" title="ì‚­ì œ"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        // â˜… ì‹¤ì „ ë¯¸ë¦¬ë³´ê¸° (í•™ìƒ í™”ë©´ ë³µì œ) â˜…
        function previewCartItem(idx) {
            const item = assignmentCart[idx];
            document.getElementById('preview-tier-name').innerText = item.tierName;
            document.getElementById('preview-modal').style.display = 'flex';
            
            // ë Œë”ë§ ì‹¤í–‰
            renderEmblemPreview(item.emblemData);
        }

        function renderEmblemPreview(layers) {
            const stage = document.getElementById('preview-stage');
            stage.innerHTML = ''; 

            const sorted = [...layers].sort((a,b) => a.zIndex - b.zIndex);
            // í•™ìƒ ë©”ì¸í™”ë©´ê³¼ ë™ì¼í•œ ìŠ¤ì¼€ì¼ íŒ©í„° ì ìš© (0.55)
            const scaleFactor = 0.55; 

            sorted.forEach(l => {
                const el = document.createElement('div');
                el.className = `render-obj`;
                
                // Anim (ì—ë””í„° ì½”ë“œ ë³µë¶™)
                if(l.style.anim) { // New Nested Structure Check
                    if(l.style.anim.spin && l.style.anim.spin.on) el.style.animation = `spin-self ${l.style.anim.spin.speed || '3s'} linear infinite`;
                    // ... (ë³µì¡í•œ ì¤‘ì²© êµ¬ì¡°ëŠ” ì—ë””í„° V6 ê¸°ì¤€ì´ë©´ ë³„ë„ ì²˜ë¦¬ í•„ìš”í•˜ì§€ë§Œ, V5 ê¸°ì¤€ì´ë©´ ì•„ë˜ ë¡œì§)
                }
                // V5 Simple Logic (í˜¸í™˜ì„±)
                if(l.style.anim === 'spin-self') el.style.animation = 'spin-self 3s linear infinite';
                else if(l.style.anim === 'orbit') { el.style.setProperty('--orbit-radius', '100px'); el.style.animation = 'orbit 4s linear infinite'; }
                else if(l.style.anim !== 'none' && typeof l.style.anim === 'string') el.style.animation = `${l.style.anim} 1s infinite`;

                el.style.color = l.style.color;
                el.style.width = l.type === 'bg' ? '100%' : 'auto';
                el.style.height = l.type === 'bg' ? '100%' : 'auto';
                el.style.fontSize = l.type === 'text' ? `${(l.style.size/5) * scaleFactor}px` : `${(l.style.size/3) * scaleFactor}px`;
                
                if(l.type === 'bg') { el.style.width = '100%'; el.style.height = '100%'; el.style.borderRadius = '50%'; }
                
                el.style.transform = `translate(-50%, -50%) rotate(${l.style.rotate}deg) scale(${l.type==='bg'?1 : l.style.size/100})`;
                
                // Texture Logic
                if(l.style.texture !== 'none') {
                    el.style.color='transparent'; el.style.backgroundClip='text'; el.style.webkitBackgroundClip='text';
                    if(l.style.texture==='gold') el.style.backgroundImage='linear-gradient(135deg, #fef08a, #d97706)';
                    else if(l.style.texture==='magma') el.style.backgroundImage='linear-gradient(0deg, #ef4444, #000)';
                    else if(l.style.texture==='silver') el.style.backgroundImage='linear-gradient(135deg, #e2e8f0, #64748b)';
                    else if(l.style.texture==='neon') el.style.backgroundImage='linear-gradient(90deg, #22d3ee, #a855f7)';
                } else { el.style.color = l.style.color; }

                if(l.type === 'icon') el.innerHTML = `<i class="${l.content}"></i>`;
                else if(l.type === 'text') { el.innerText = l.content; el.style.fontFamily = "'Black Han Sans', sans-serif"; }
                else el.innerText = l.content;

                stage.appendChild(el);
            });
        }

        async function deployAll() {
            if(assignmentCart.length === 0) return alert("ë°°í¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
            if(!confirm(`ì´ ${assignmentCart.length}ê°œì˜ í‹°ì–´ ì„¤ì •ì„ ì „êµìƒì—ê²Œ ë°°í¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            // ìˆœì°¨ ì—…ë°ì´íŠ¸ (Batch Logic)
            try {
                for (const item of assignmentCart) {
                    const { error } = await _supabase.from('tier_rules')
                        .update({ emblem_json: { mode: 'advanced', layers: item.emblemData } })
                        .eq('tier_name', item.tierName);
                    if(error) throw error;
                }
                alert("ğŸ‰ ë°°í¬ ì™„ë£Œ! ëª¨ë“  í•™ìƒë“¤ì˜ í™”ë©´ì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                assignmentCart = [];
                renderCart();
                loadEmblemTab(); // ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
            } catch(e) {
                alert("ë°°í¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            }
        }

        // --- (ê¸°ì¡´ ì‹œì¦Œ/í‹°ì–´ ê´€ë¦¬ í•¨ìˆ˜ë“¤: startSeason, saveTiers ë“±ì€ ê·¸ëŒ€ë¡œ ìœ ì§€) ---
        // (ì½”ë“œ ê¸¸ì´ìƒ ìƒëµí•˜ì§€ë§Œ, íŒŒì¼ì—ëŠ” í¬í•¨ë˜ì–´ì•¼ í•¨. ìœ„ìª½ ì½”ë“œ ë¸”ë¡ì—ì„œ ê¸°ì¡´ í•¨ìˆ˜ë“¤ ì‚¬ìš©)
        async function startSeason() { /*...*/ }
        function endSeasonStep1() { /*...*/ }
        function renderTiers() { /*...*/ }
        function getInsertBtn(i) { return `<div class="insert-zone" onclick="addTier(${i})"><div class="insert-line"></div><div class="plus-circle">+</div></div>`; }
        function addTier(i) { let s=0; if(i>0) s=tiers[i-1].max_xp+1; tiers.splice(i,0,{tier_name:'New', min_xp:s, max_xp:s+1000}); renderTiers(); }
        function delTier(i) { if(confirm("ì‚­ì œ?")) { tiers.splice(i,1); renderTiers(); } }
        function updTier(i,k,v) { tiers[i][k]=k==='tier_name'?v:parseInt(v); document.getElementById('btn-save-tier').disabled=false; document.getElementById('btn-save-tier').classList.remove('opacity-50'); }
        function verifyTiers() { alert("ê²€ì¦ ì™„ë£Œ"); renderTiers(); document.getElementById('btn-save-tier').disabled=false; document.getElementById('btn-save-tier').classList.remove('opacity-50'); }
        async function saveTiers() { /* ê¸°ì¡´ ì €ì¥ ë¡œì§ */ }
        async function saveNotice() { /* ... */ }

        init();
    </script>
</body>
</html>