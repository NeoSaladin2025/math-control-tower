<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <link rel="manifest" href="site.webmanifest">
    
    <link rel="apple-touch-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‚˜ì˜ í•™ìŠµ ê³µê°„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Orbitron:wght@900&family=Rubik+Glitch&family=Bangers&family=Exo+2:ital,wght@1,900&family=Nosifer&family=Creepster&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f8fafc; color: #334151; user-select: none; }
        ::-webkit-scrollbar { width: 6px; height: 6px; } /* ê°€ë¡œ ìŠ¤í¬ë¡¤ë°” ì¶”ê°€ */
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .elite-card { background: white; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #f1f5f9; transition: transform 0.2s; }
        .elite-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        .gift-blink { animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .inbox-blink { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } }

        /* V13.5 CHAOS ENGINE CSS */
        .emblem-stage-container { perspective: 1000px; overflow: visible !important; z-index: 20; }
        .obj-root { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; width: 0; height: 0; }
        .effect-wrapper { position: absolute; display: flex; align-items: center; justify-content: center; transform-style: preserve-3d; will-change: transform, filter; width: 0; height: 0; }
        .obj-orbit, .obj-spin { position: absolute; display: flex; align-items: center; justify-content: center; transform-style: preserve-3d; will-change: transform; }
        .obj-core { position: relative; display: flex; align-items: center; justify-content: center; text-align: center; line-height: 1; white-space: nowrap; mix-blend-mode: normal; }
        .obj-core img { max-width: none; pointer-events: none; }
        
        @keyframes orbit-cw { from { transform: rotate(0deg) translateX(var(--orbit-r)) rotate(0deg); } to { transform: rotate(360deg) translateX(var(--orbit-r)) rotate(-360deg); } }
        @keyframes spin-z { from { transform: rotateZ(0deg); } to { transform: rotateZ(360deg); } }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 100%; max-width: 450px; border-radius: 20px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-height: 80vh; display: flex; flex-direction: column; }
        .loader { border: 3px solid #f1f5f9; border-top: 3px solid #6366f1; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* [Elite Logic] ìˆ™ì œ ë¯¸ì œì¶œ ì‹œ ë¬´ì‹œë¬´ì‹œí•œ íš¨ê³¼ */
        @keyframes scary-pulse { 
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); border-color: #f87171; transform: scale(1); } 
            50% { box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); border-color: #ef4444; transform: scale(1.05); } 
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); border-color: #f87171; transform: scale(1); } 
        }
        .homework-scary { 
            animation: scary-pulse 0.8s infinite !important; 
            background-color: #fee2e2 !important; 
            color: #dc2626 !important;
            border: 2px solid #ef4444 !important;
            z-index: 50;
        }
        .homework-badge {
            position: absolute; top: -8px; right: -8px; background: #dc2626; color: white;
            font-size: 11px; font-weight: 900; padding: 3px 7px; border-radius: 99px; border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); z-index: 60;
        }

        /* [NEW] Resizable Popup Style */
        .resizable-popup {
            width: 80vw; /* ê¸°ë³¸ ë„“ê²Œ */
            height: 85vh; /* ê¸°ë³¸ ê¸¸ê²Œ */
            max-width: 98vw;
            max-height: 98vh;
            min-width: 320px;
            min-height: 400px;
            resize: both; /* â˜… í¬ê¸° ì¡°ì ˆ í™œì„±í™” */
            overflow: auto; /* â˜… ìŠ¤í¬ë¡¤ë°” í™œì„±í™” */
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid #cbd5e1;
        }
    </style>
</head>
<body class="pb-20">
    <script src="config.js"></script>

    <nav class="glass-nav fixed top-0 w-full h-16 z-50 px-5 flex justify-between items-center bg-white/90 backdrop-blur border-b border-slate-200">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-slate-800 rounded-lg flex items-center justify-center text-white font-black">B</div>
            <span class="font-bold text-slate-700 tracking-tighter">Beyond Math</span>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="openFeedbackList()" id="btn-feed" class="w-9 h-9 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center relative"><i class="fa-solid fa-bell"></i></button>
            <button onclick="logout()" class="w-9 h-9 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </nav>

    <div id="emoji-modal" class="fixed inset-0 z-[120] bg-black/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-[280px] rounded-3xl p-6 shadow-2xl text-center">
            <h4 class="font-black text-slate-800 mb-4">ìˆ™ì œí•¨ ì´ëª¨ì§€ ë³€ê²½</h4>
            <div class="grid grid-cols-4 gap-3 mb-6">
                <button onclick="saveEmoji('ğŸ“¢')" class="text-2xl hover:scale-125 transition">ğŸ“¢</button>
                <button onclick="saveEmoji('ğŸ”¥')" class="text-2xl hover:scale-125 transition">ğŸ”¥</button>
                <button onclick="saveEmoji('â­')" class="text-2xl hover:scale-125 transition">â­</button>
                <button onclick="saveEmoji('ğŸ€')" class="text-2xl hover:scale-125 transition">ğŸ€</button>
                <button onclick="saveEmoji('ğŸ’–')" class="text-2xl hover:scale-125 transition">ğŸ’–</button>
                <button onclick="saveEmoji('ğŸ±')" class="text-2xl hover:scale-125 transition">ğŸ±</button>
                <button onclick="saveEmoji('ğŸ¯')" class="text-2xl hover:scale-125 transition">ğŸ¯</button>
                <button onclick="saveEmoji('ğŸš€')" class="text-2xl hover:scale-125 transition">ğŸš€</button>
            </div>
            <button onclick="closeEmojiModal()" class="text-xs font-bold text-slate-400 underline">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="detail-modal" class="fixed inset-0 z-[10000] bg-black/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100 opacity-100">
            <div id="dm-header" class="p-5 border-b border-slate-100 bg-white flex justify-between items-start">
                <div>
                    <span id="dm-badge" class="text-[10px] font-black px-2 py-1 rounded bg-slate-100 text-slate-500 mb-2 inline-block">CATEGORY</span>
                    <h3 id="dm-title" class="font-black text-lg text-slate-800 leading-tight">Title</h3>
                    <p id="dm-date" class="text-xs text-slate-400 font-bold mt-1">Date</p>
                </div>
                <button onclick="closeDetailModal()" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:text-slate-600 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="dm-body" class="p-6 overflow-y-auto max-h-[50vh] text-sm font-medium text-slate-600 leading-relaxed whitespace-pre-wrap">
                Content goes here...
            </div>
            <div id="dm-footer" class="p-4 bg-slate-50 border-t border-slate-100 flex gap-2">
                </div>
        </div>
    </div>

    <div id="homework-popup-modal" class="fixed inset-0 z-[150] bg-black/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="resizable-popup">
            <div class="absolute top-2 right-2 z-50 flex gap-2">
                <div class="bg-slate-800/80 text-white text-[10px] px-2 py-1 rounded backdrop-blur pointer-events-none">â†˜ ë“œë˜ê·¸í•˜ì—¬ í¬ê¸° ì¡°ì ˆ</div>
                <button onclick="closeHomeworkPopup()" class="w-8 h-8 bg-white/90 rounded-full text-slate-500 hover:text-red-500 flex items-center justify-center shadow-sm backdrop-blur transition border border-slate-200"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <iframe id="homework-iframe" src="" class="w-full h-full border-none"></iframe>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal-content">
            <div id="modal-header" class="p-5 border-b flex justify-between items-center shrink-0 bg-white">
                <h3 class="font-bold text-lg text-slate-800" id="modal-title">ëª©ë¡</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl transition">Ã—</button>
            </div>
            <div id="modal-body" class="p-0 overflow-y-auto flex-1 bg-slate-50 custom-scroll"></div>
        </div>
    </div>
    
    <div id="withdraw-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex justify-center items-center p-6">
        <div class="bg-white w-full max-w-[320px] rounded-[32px] p-8 text-center shadow-2xl">
            <div class="w-16 h-16 bg-amber-100 text-amber-600 rounded-2xl flex items-center justify-center text-2xl mx-auto mb-4"><i class="fa-solid fa-hand-holding-dollar"></i></div>
            <h3 class="text-xl font-black text-slate-800">CP ì¶œê¸ˆ ì‹ ì²­</h3>
            <p class="text-[10px] text-slate-400 font-bold uppercase mt-1 leading-tight">100ì› ë‹¨ìœ„ë¡œ ì‹ ì²­ ê°€ëŠ¥</p>
            <div class="mt-6 space-y-4 text-left">
                <div class="bg-slate-50 p-4 rounded-2xl">
                    <label class="text-[10px] text-slate-400 font-bold block mb-1">WITHDRAWAL AMOUNT</label>
                    <input type="number" id="withdraw-input" placeholder="0" class="w-full bg-transparent border-b-2 border-slate-200 py-2 text-lg font-black text-slate-800 outline-none focus:border-amber-500">
                </div>
                <button id="btn-check" onclick="checkWithdraw()" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl text-sm transition">ê¸ˆì•¡ í™•ì¸</button>
                <button id="btn-send" onclick="sendWithdraw()" disabled class="w-full bg-amber-500 text-white font-black py-4 rounded-2xl text-sm hidden">ì‹ ì²­ ì „ì†¡í•˜ê¸°</button>
            </div>
            <button onclick="closeWithdrawModal()" class="mt-6 text-slate-300 font-bold text-xs underline">ì°½ ë‹«ê¸°</button>
        </div>
    </div>

    <div id="pw-modal" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all scale-100">
            <h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
            <div class="space-y-4 mb-6">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="cur-pw" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="í˜„ì¬ ë¹„ë²ˆ ì…ë ¥"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="new-pw" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ìƒˆ ë¹„ë²ˆ ì…ë ¥"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input type="password" id="cfm-pw" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="í•œ ë²ˆ ë” ì…ë ¥"></div>
            </div>
            <div class="flex gap-3">
                <button onclick="closePwModal()" class="flex-1 bg-slate-200 text-slate-600 py-3 rounded-xl font-bold text-sm hover:bg-slate-300 transition">ì·¨ì†Œ</button>
                <button onclick="submitPasswordChange()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold text-sm hover:bg-indigo-700 shadow-lg transition">ë³€ê²½í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div class="max-w-[1400px] mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6 pt-20 px-5">
        
        <div class="lg:col-span-3 space-y-6">
            <div class="elite-card p-6 relative overflow-visible">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-baseline gap-2">
                            <h2 class="text-2xl font-black text-slate-800" id="s-name">--</h2>
                            <span class="text-[10px] font-bold text-slate-400">Lv.<span id="s-total-lv">0</span></span>
                        </div>
                        <div class="text-[10px] font-bold text-indigo-500 mt-1" id="s-season-name">Loading Season...</div>
                    </div>
                    <div class="text-right">
                        <div class="text-[11px] font-black text-slate-700" id="tier-display-name">--</div>
                        <div class="text-[9px] text-slate-400 font-bold" id="xp-remain">ë‚¨ì€ XP: --</div>
                    </div>
                </div>
                <div class="relative w-full h-40 flex items-center justify-center my-4 emblem-stage-container">
                    <div id="emblem-stage" class="w-32 h-32 relative flex items-center justify-center transition-transform hover:scale-110 duration-500"></div>
                </div>
                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between text-[10px] font-bold mb-1">
                            <span class="text-slate-400">ì‹œì¦Œ í˜„ì¬ê²½í—˜ì¹˜</span>
                            <span class="text-indigo-600"><span id="s-season-xp">0</span> / <span id="s-max-xp">0</span> XP</span>
                        </div>
                        <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden shadow-inner">
                            <div id="xp-bar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-600 w-0 transition-all duration-1000"></div>
                        </div>
                    </div>

                    <div class="py-2">
                        <button onclick="location.href='student_emblem_custom.html'" 
                                class="w-full bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 hover:from-indigo-500 hover:to-pink-400 text-white font-black py-3 rounded-xl shadow-[0_4px_15px_rgba(124,58,237,0.3)] transform active:scale-95 transition-all flex items-center justify-center gap-2 border border-white/10">
                            <i class="fa-solid fa-wand-magic-sparkles text-sm"></i>
                            <span class="text-xs font-['Orbitron'] tracking-wider">CUSTOM EMBLEM</span>
                            <div class="bg-black/20 px-2 py-0.5 rounded text-[9px] font-normal border border-white/10">100 CP</div>
                        </button>
                    </div>

                    <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div>
                            <span class="text-[11px] font-bold text-slate-500 block">í˜„ì¬ ìì‚° (CP)</span>
                            <div class="flex items-center gap-1 font-black text-amber-500">
                                <span id="s-cp">0</span><span class="text-[10px]">P</span>
                            </div>
                        </div>
                        <button onclick="openWithdrawModal()" class="bg-indigo-600 text-white text-[10px] font-black px-3 py-2 rounded-lg hover:bg-indigo-500 transition shadow-sm">ì¶œê¸ˆ ì‹ ì²­</button>
                    </div>
                </div>
            </div>
            <div class="elite-card p-4 flex flex-col items-center">
                <div class="relative h-48 w-full"><canvas id="statChart"></canvas></div>
            </div>
        </div>

        <div class="lg:col-span-5 space-y-6">
            <div class="grid grid-cols-3 gap-4">
                <button onclick="openSpecialList()" id="btn-gift" class="elite-card p-4 flex flex-col items-center justify-center gap-2 hover:bg-pink-50 transition border-l-4 border-l-pink-500 relative">
                    <span class="text-2xl">ğŸ</span>
                    <div class="text-[11px] font-bold text-slate-700">íŠ¹ë³„ ê³¼ì œí•¨</div>
                    <span id="badge-gift" class="hidden absolute top-2 right-2 bg-red-500 text-white text-[9px] px-1.5 rounded-full animate-bounce">0</span>
                </button>

                <button id="btn-homework-inbox-main" 
                        onclick="openHomeworkPopup()" 
                        oncontextmenu="event.preventDefault(); openEmojiModal();"
                        class="elite-card p-4 flex flex-col items-center justify-center gap-2 hover:bg-slate-50 transition border-l-4 border-l-slate-400 relative">
                    <span id="homework-inbox-emoji" class="text-2xl">ğŸ“¢</span>
                    <div class="text-[11px] font-bold text-slate-700">ìˆ™ì œ ì•Œë¦¼í•¨</div>
                    <span id="badge-homework-inbox" class="hidden homework-badge">0</span>
                    <div class="absolute bottom-1 right-1 opacity-20 text-[6px]">long-press</div>
                </button>

                <button onclick="openFeedbackList()" id="btn-feed-stat" class="elite-card p-4 flex flex-col items-center justify-center gap-2 hover:bg-blue-50 transition border-l-4 border-l-blue-500 relative">
                    <span class="text-2xl">ğŸ“¬</span>
                    <div class="text-[11px] font-bold text-slate-700">ë©”ì‹œì§€í•¨</div>
                    <span id="badge-feed" class="hidden absolute top-2 right-2 bg-blue-500 text-white text-[9px] px-1.5 rounded-full animate-bounce">0</span>
                </button>
            </div>
            
            <div onclick="location.href='student_homework.html'" class="elite-card bg-gradient-to-r from-indigo-600 to-purple-700 p-6 text-white cursor-pointer relative overflow-hidden group shadow-lg shadow-indigo-200 h-40 flex flex-col justify-center">
                <span id="badge-regular" class="hidden absolute top-3 right-3 bg-red-500 text-white font-bold text-[10px] px-2 py-0.5 rounded-full z-20 shadow-md animate-pulse border border-white/20">0</span>
                <div class="relative z-10 flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-black mb-1 group-hover:translate-x-1 transition">ğŸ“ ì •ê·œ ìˆ™ì œ ë³´ê´€í•¨</h2>
                        <p class="text-indigo-100 text-xs opacity-90">ì˜¤ëŠ˜ì˜ í•™ìŠµ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ì„¸ìš”.</p>
                    </div>
                    <div class="text-5xl group-hover:scale-110 transition duration-500 rotate-12">ğŸš€</div>
                </div>
            </div>

            <div onclick="location.href='student_homework_request.html'" class="elite-card bg-gradient-to-r from-emerald-500 to-teal-600 p-6 text-white cursor-pointer relative overflow-hidden group shadow-lg shadow-emerald-200 h-32 flex flex-col justify-center">
                <span id="badge-request" class="hidden absolute top-3 right-3 bg-red-500 text-white font-bold text-[10px] px-2 py-0.5 rounded-full z-20 shadow-md animate-pulse border border-white/20">0</span>
                <div class="relative z-10 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-black mb-1 group-hover:translate-x-1 transition">ğŸ™‹â€â™‚ï¸ ìš”ì²­ ê³¼ì œ ë³´ê´€í•¨</h2>
                        <p class="text-emerald-100 text-xs opacity-90">ë‚´ê°€ ìš”ì²­í•œ ë¬¸ì œë“¤ì„ í’€ì–´ë³´ì„¸ìš”.</p>
                    </div>
                    <div class="text-4xl group-hover:scale-110 transition duration-500 -rotate-12">âœ¨</div>
                </div>
            </div>

            <div onclick="window.open('student_sns.html', '_blank')" class="elite-card bg-white p-5 cursor-pointer hover:border-pink-300 transition group flex items-center justify-between border-l-4 border-l-pink-500">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-pink-100 flex items-center justify-center text-2xl text-pink-600 group-hover:scale-110 transition">ğŸ“¸</div>
                    <div>
                        <h3 class="font-bold text-slate-800">Academy-Gram ì…ì¥</h3>
                        <p class="text-xs text-slate-500">ì¹œêµ¬ë“¤ê³¼ ì†Œí†µí•˜ê³  ì¸ì¦ìƒ·ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
                    </div>
                </div>
                <i class="fa-solid fa-arrow-right text-slate-300 group-hover:text-pink-500 transition"></i>
            </div>
        </div>

        <div class="lg:col-span-4 space-y-6">
            <div class="elite-card p-5 h-[calc(100vh-100px)] flex flex-col">
                <h3 class="font-bold text-slate-700 text-sm mb-3 flex items-center gap-2"><span>ğŸ“š</span> ë‚˜ì˜ ë¬¸ì œì§‘ ë³´ê´€í•¨</h3>
                <div id="book-list" class="flex-1 space-y-3 overflow-y-auto custom-scroll pr-1">
                    <div class="text-center py-10"><div class="loader"></div></div>
                </div>
            </div>
            <div class="text-center pb-4 flex justify-center gap-4">
                <button onclick="openPwModal()" class="text-xs text-slate-400 hover:text-indigo-500 underline flex items-center gap-1">ğŸ”’ ë¹„ë²ˆë³€ê²½</button>
                <span class="text-xs text-slate-300">|</span>
                <button onclick="logout()" class="text-xs text-slate-400 hover:text-red-500 underline">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>

    <script>
        const user = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!user) location.href = 'index.html';
        
        let myRadarChart = null;
        let currentUserData = null;

        window.addEventListener('message', (event) => { if (event.data === 'mission_complete') location.reload(); });
        function logout() { sessionStorage.clear(); location.href = 'index.html'; }

        // --- ì´ëª¨ì§€ ì»¤ìŠ¤í…€ ë¡œì§ ---
        function openEmojiModal() { document.getElementById('emoji-modal').classList.remove('hidden'); }
        function closeEmojiModal() { document.getElementById('emoji-modal').classList.add('hidden'); }
        function saveEmoji(emoji) {
            localStorage.setItem(`emoji_${user.username}`, emoji);
            document.getElementById('homework-inbox-emoji').innerText = emoji;
            closeEmojiModal();
        }
        function loadSavedEmoji() {
            const saved = localStorage.getItem(`emoji_${user.username}`);
            if(saved) document.getElementById('homework-inbox-emoji').innerText = saved;
        }

        // ë¡±í”„ë ˆìŠ¤ ê°ì§€ (ëª¨ë°”ì¼ìš©)
        let longPressTimer;
        const mainBtn = document.getElementById('btn-homework-inbox-main');
        mainBtn.addEventListener('mousedown', () => { longPressTimer = setTimeout(openEmojiModal, 800); });
        mainBtn.addEventListener('mouseup', () => clearTimeout(longPressTimer));
        mainBtn.addEventListener('touchstart', () => { longPressTimer = setTimeout(openEmojiModal, 800); });
        mainBtn.addEventListener('touchend', () => clearTimeout(longPressTimer));

        async function init() { 
            loadSavedEmoji();
            await loadUserInfo(); 
            loadBooks(); 
            checkNotifications(); 
            checkHomeworkInbox(); 
            setInterval(checkNotifications, 30000);
            setInterval(checkHomeworkInbox, 30000); 
        }

        // --- â˜… [NEW] Popup Control Functions â˜… ---
        function openHomeworkPopup() {
            const iframe = document.getElementById('homework-iframe');
            iframe.src = 'student_homework_inbox.html';
            document.getElementById('homework-popup-modal').classList.remove('hidden');
        }

        function closeHomeworkPopup() {
            document.getElementById('homework-popup-modal').classList.add('hidden');
            document.getElementById('homework-iframe').src = ''; // ë¦¬ì†ŒìŠ¤ í•´ì œ
            checkHomeworkInbox(); // ë‹«ì„ ë•Œ ë°°ì§€ ê°±ì‹  (ìˆ™ì œ í–ˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ)
        }

        // --- â˜… [Elite Logic] ìˆ™ì œ ì•Œë¦¼í•¨ ì „ìš© ì²´í¬ (ë¯¸ì œì¶œ ê°ì§€) â˜… ---
        async function checkHomeworkInbox() {
            const btn = document.getElementById('btn-homework-inbox-main');
            const badge = document.getElementById('badge-homework-inbox');
            
            // ë¯¸ì œì¶œ(status: pending or incomplete) ì¡°íšŒ
            const { count, error } = await _supabase.from('homework_messages')
                .select('*', { count: 'exact', head: true })
                .eq('student_id', user.username)
                .or('status.eq.pending,status.eq.incomplete');

            if (!error && count > 0) {
                // ë¬´ì‹œë¬´ì‹œí•œ í•ë¹› ë§¥ë™ íš¨ê³¼ ë° ë¯¸ì œì¶œ ê°œìˆ˜ í‘œì‹œ
                btn.classList.add('homework-scary');
                btn.classList.remove('hover:bg-slate-50', 'border-l-slate-400');
                badge.innerText = count;
                badge.classList.remove('hidden');
            } else {
                btn.classList.remove('homework-scary');
                btn.classList.add('hover:bg-slate-50', 'border-l-slate-400');
                badge.classList.add('hidden');
                badge.innerText = '0';
            }
        }

        // --- â˜… [MODIFIED] í†µí•© ì•Œë¦¼ ì²´í¬ (ìˆ™ì œ ë©”ì‹œì§€ ì œì™¸) â˜… ---
        async function checkNotifications() {
            const { count: gift } = await _supabase.from('assignments').select('*', { count: 'exact', head: true }).eq('student_id', user.username).eq('is_special', true).eq('status', 'assigned');
            if(gift > 0) { document.getElementById('badge-gift').innerText=gift; document.getElementById('badge-gift').classList.remove('hidden'); }
            
            // â˜… [ìˆ˜ì •ë¨] ìˆ™ì œ ë©”ì‹œì§€(homework_messages) ì œì™¸ (í”¼ë“œë°±/ì‹œì¦Œë§Œ ì¹´ìš´íŠ¸)
            const { count: f1 } = await _supabase.from('student_solutions').select('*', { count: 'exact', head: true }).eq('student_id', user.username).neq('status', 'pending').eq('is_read', false);
            const { count: f2 } = await _supabase.from('season_messages').select('*', { count: 'exact', head: true }).eq('student_id', user.username).eq('is_read', false);
            
            const total = (f1 || 0) + (f2 || 0); // homework_messages ì œê±°ë¨
            
            if(total > 0) { document.getElementById('badge-feed').innerText=total; document.getElementById('badge-feed').classList.remove('hidden'); document.getElementById('btn-feed').classList.add('inbox-blink'); }
            else { document.getElementById('badge-feed').classList.add('hidden'); document.getElementById('btn-feed').classList.remove('inbox-blink'); }
            
            const { count: regularCount } = await _supabase.from('assignments').select('*', { count: 'exact', head: true }).eq('student_id', user.username).eq('is_special', false).eq('is_request', false).eq('status', 'assigned');
            if(regularCount > 0) { document.getElementById('badge-regular').innerText = regularCount; document.getElementById('badge-regular').classList.remove('hidden'); }
            else { document.getElementById('badge-regular').classList.add('hidden'); }
            
            const { count: requestCount } = await _supabase.from('assignments').select('*', { count: 'exact', head: true }).eq('student_id', user.username).eq('is_request', true).eq('status', 'assigned');
            if(requestCount > 0) { document.getElementById('badge-request').innerText = requestCount; document.getElementById('badge-request').classList.remove('hidden'); }
            else { document.getElementById('badge-request').classList.add('hidden'); }
        }

        async function loadUserInfo() {
            try {
                const { data: userData, error: userErr } = await _supabase.from('users').select('*').eq('username', user.username).single();
                if(userErr || !userData) throw new Error("ìœ ì € ì •ë³´ ë¡œë“œ ì‹¤íŒ¨");
                currentUserData = userData;
                document.getElementById('s-name').innerText = userData.name;
                document.getElementById('s-total-lv').innerText = Math.floor((userData.total_xp || 0) / 1000);
                document.getElementById('s-cp').innerText = (userData.cp || 0).toLocaleString();
                document.getElementById('s-season-xp').innerText = (userData.season_xp || 0).toLocaleString();
                const { data: season } = await _supabase.from('seasons').select('*').eq('is_current', true).maybeSingle();
                document.getElementById('s-season-name').innerText = season ? `â—ˆ ${season.season_name}` : 'ì‹œì¦Œ ì¤€ë¹„ì¤‘';
                const { data: allTiers } = await _supabase.from('tier_rules').select('*').order('min_xp');
                const myXp = userData.season_xp || 0; // [CHECKED] Season XP Used
                let currentTier = allTiers?.find(t => myXp >= t.min_xp && myXp <= t.max_xp);
                if (currentTier) {
                    document.getElementById('tier-display-name').innerText = currentTier.tier_name;
                    document.getElementById('s-max-xp').innerText = currentTier.max_xp.toLocaleString();
                    document.getElementById('xp-remain').innerText = `ë‹¤ìŒ í‹°ì–´ê¹Œì§€: ${(currentTier.max_xp - myXp).toLocaleString()} XP`;
                    let progress = Math.min(100, (myXp / currentTier.max_xp) * 100);
                    setTimeout(() => { document.getElementById('xp-bar').style.width = `${progress}%`; }, 300);
                    if (currentTier.emblem_json && currentTier.emblem_json.layers) { renderEmblem(currentTier.emblem_json.layers, 0.4); }
                }
                loadChart(userData.stats || {});
            } catch (e) { console.error(e); }
        }

        function renderEmblem(layers, scaleFactor=0.4) {
            const stage = document.getElementById('emblem-stage');
            stage.innerHTML = ''; 
            const sorted = [...layers].sort((a,b) => (a.zIndex || 0) - (b.zIndex || 0));
            sorted.forEach(l => {
                const root = document.createElement('div'); root.className = 'obj-root'; root.style.left = '50%'; root.style.top = '50%'; 
                const orbit = document.createElement('div'); orbit.className = 'obj-orbit';
                if(l.anim.orbit.on) { orbit.style.setProperty('--orbit-r', `${l.anim.orbit.radius * scaleFactor}px`); orbit.style.animation = `orbit-cw ${l.anim.orbit.speed/5}s linear infinite`; }
                let currentContainer = orbit;
                if(l.anim.vital && l.anim.vital.length > 0) {
                    let vitals = typeof l.anim.vital[0] === 'string' ? l.anim.vital.map(t=>({type:t, speed:10})) : l.anim.vital;
                    vitals.forEach(e => { const wrapper = document.createElement('div'); wrapper.className = 'effect-wrapper'; const speed = (21 - (e.speed || 10)) / 10; wrapper.style.animation = `${e.type} ${speed}s infinite ease-in-out`; currentContainer.appendChild(wrapper); currentContainer = wrapper; });
                }
                const spin = document.createElement('div'); spin.className = 'obj-spin';
                if(l.anim.spin.on) { spin.style.animation = `spin-${l.anim.spin.axis} ${l.anim.spin.speed/5}s linear infinite`; }
                currentContainer.appendChild(spin);
                const core = document.createElement('div'); core.className = 'obj-core';
                if (l.type === 'image') { const img = document.createElement('img'); img.src = l.content; img.style.width = `${l.style.size * scaleFactor}px`; img.style.height = 'auto'; core.appendChild(img); } else {
                    core.style.fontSize = `${l.style.size * scaleFactor}px`;
                    if(l.style.texture !== 'none') { core.style.color='transparent'; core.style.backgroundClip='text'; core.style.webkitBackgroundClip='text'; if(l.style.texture==='gold') core.style.backgroundImage='linear-gradient(135deg, #fef08a, #d97706)'; } else { core.style.color = l.style.color; }
                    if(l.type==='icon') core.innerHTML = `<i class="${l.content}"></i>`; else if(l.type==='text') { core.innerText = l.content; core.style.fontFamily = "'Black Han Sans', sans-serif"; } else core.innerText = l.content;
                }
                spin.appendChild(core); root.appendChild(orbit); stage.appendChild(root);
            });
        }

        function openModal(title) { document.getElementById('modal-overlay').style.display='flex'; document.getElementById('modal-title').innerText=title; }
        function closeModal() { document.getElementById('modal-overlay').style.display='none'; checkNotifications(); }
        function openPwModal() { document.getElementById('pw-modal').classList.remove('hidden'); }
        function closePwModal() { document.getElementById('pw-modal').classList.add('hidden'); }
        function loadChart(s) { const ctx = document.getElementById('statChart').getContext('2d'); if(myRadarChart) myRadarChart.destroy(); myRadarChart = new Chart(ctx, { type: 'radar', data: { labels: ['ì—°ì‚°','ë…í•´','ì¶”ë¡ ','íŒ¨í„´','ì†ë„','ì•ˆì •','ì‹¤í–‰','íƒœë„'], datasets: [{ data: [s.calc||0, s.read||0, s.logic||0, s.pat||0, s.tmp||0, s.stb||0, s.exec||0, s.att||0], backgroundColor: 'rgba(99, 102, 241, 0.2)', borderColor: '#4f46e5', pointRadius: 2 }] }, options: { scales: { r: { suggestedMin: 0, suggestedMax: 10, ticks: { display: false } } }, plugins: { legend: { display: false } }, maintainAspectRatio: false } }); }
        
        async function loadBooks() {
            const { data } = await _supabase.from('student_books').select(`workbook_id, workbooks ( id, title, total_problems, grade_level )`).eq('student_id', user.username).order('created_at', { ascending: false });
            const list = document.getElementById('book-list'); if (!data || data.length === 0) { list.innerHTML = `<div class="text-center text-xs text-slate-400 py-4">êµì¬ ì—†ìŒ</div>`; return; }
            list.innerHTML = data.map(item => `<div class="bg-white p-4 rounded-2xl border-2 border-slate-100 flex flex-col gap-3 shadow-sm hover:border-indigo-200 transition group"><div class="flex items-center gap-3"><div class=\"w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center font-bold border border-indigo-100 shadow-sm\"><i class=\"fa-solid fa-book\"></i></div><div class=\"flex-1 min-w-0\"><div class=\"font-bold text-slate-800 text-sm truncate\">${item.workbooks.title}</div><div class=\"text-[10px] text-slate-400 font-medium\">ìë™í™” ì„¤ì • ëŒ€ê¸°ì¤‘</div></div></div><div class=\"flex gap-2 mt-1\"><button onclick=\"requestHomework(${item.workbook_id}, '${item.workbooks.title}')\" class=\"flex-1 py-2.5 rounded-xl text-xs font-bold bg-white border-2 border-indigo-100 text-indigo-600 shadow-[0_3px_0_#e0e7ff] active:shadow-none active:translate-y-[3px]\"><span>ğŸ™‹â€â™‚ï¸</span> ê³¼ì œ ìš”ì²­</button><button onclick=\"openSelfXray(${item.workbook_id})\" class=\"flex-1 py-2.5 rounded-xl text-xs font-bold bg-white border-2 border-rose-100 text-rose-500 shadow-[0_3px_0_#ffe4e6] active:shadow-none active:translate-y-[3px]\"><span>ğŸ©º</span> ì§„ë‹¨</button></div></div>`).join('');
        }

        // --- â˜… [MODIFIED] í†µí•© ë©”ì‹œì§€í•¨ ë¡œì§ (ìˆ™ì œ ë©”ì‹œì§€ ì œì™¸) â˜… ---
        async function openFeedbackList() {
            openModal('ğŸ“¬ í†µí•© ë©”ì‹œì§€í•¨'); 
            const body = document.getElementById('modal-body'); 
            body.innerHTML = '<div class="loader m-6"></div>';
            
            const { data: solutions } = await _supabase.from('student_solutions').select('*').eq('student_id', user.username).neq('status', 'pending');
            const { data: seasonMsgs } = await _supabase.from('season_messages').select('*').eq('student_id', user.username);
            
            const all = [ 
                ...(solutions || []).map(m => ({ ...m, cat: 'ìˆ™ì œí”¼ë“œë°±', title: `ğŸ“ í”¼ë“œë°± (No.${m.problem_num})`, content: m.teacher_feedback || 'ë‚´ìš© ì—†ìŒ' })), 
                ...(seasonMsgs || []).map(m => ({ ...m, cat: 'ì‹œì¦Œ', title: 'ğŸ† ì‹œì¦Œ ì•Œë¦¼', content: m.message }))
            ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            if (all.length === 0) { body.innerHTML = '<div class="text-center py-10 text-slate-400">ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
            
            body.innerHTML = all.map(m => {
                const isRead = m.is_read; 
                const dateStr = new Date(m.created_at).toLocaleDateString();
                const bgClass = !isRead ? (m.cat==='ìˆ™ì œí”¼ë“œë°±'?'bg-blue-50/30':(m.cat==='ì‹œì¦Œ'?'bg-indigo-50/30':'bg-teal-50/30')) : '';
                const safeContent = (m.content || '').replace(/'/g, "\\'").replace(/\n/g, '\\n');
                return `<div class="p-4 border-b hover:bg-slate-50 transition cursor-pointer ${bgClass}" onclick="openMessageDetail('${m.cat}', ${m.id}, '${m.title}', '${safeContent}', '${m.created_at}')">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-black text-slate-500">${m.title}</span>
                        <span class="text-[10px] text-slate-400">${dateStr}</span>
                    </div>
                    <div class="text-sm font-bold text-slate-700 whitespace-pre-wrap line-clamp-2">${m.content}</div>
                </div>`;
            }).join('');
        }

        async function openMessageDetail(cat, id, title, content, date) {
            markRead(cat, id);
            document.getElementById('dm-badge').innerText = cat.toUpperCase();
            document.getElementById('dm-badge').className = 'text-[10px] font-black px-2 py-1 rounded bg-slate-100 text-slate-500 mb-2 inline-block';
            document.getElementById('dm-title').innerText = title;
            document.getElementById('dm-date').innerText = new Date(date).toLocaleString();
            document.getElementById('dm-body').innerText = content;
            document.getElementById('dm-footer').innerHTML = `<button onclick="deleteMsgAndClose('${cat}', ${id})" class="w-full bg-slate-200 hover:bg-red-100 hover:text-red-500 text-slate-500 font-bold py-3 rounded-xl transition">ğŸ—‘ï¸ ì‚­ì œí•˜ê¸°</button>`;
            document.getElementById('detail-modal').classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.add('hidden');
            checkNotifications();
        }

        async function markRead(cat, id) { 
            let table = 'student_solutions'; if (cat === 'ì‹œì¦Œ') table = 'season_messages'; 
            await _supabase.from(table).update({ is_read: true }).eq('id', id); 
            checkNotifications(); 
        }

        async function deleteMsgAndClose(cat, id) {
            if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            let table = 'student_solutions'; if (cat === 'ì‹œì¦Œ') table = 'season_messages'; 
            const { error } = await _supabase.from(table).delete().eq('id', id); 
            if(error) alert(error.message); 
            else { closeDetailModal(); openFeedbackList(); }
        }

        init();
    </script>
</body>
</html>