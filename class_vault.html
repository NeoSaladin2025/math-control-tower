<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f8fafc; overflow: hidden; height: 100vh; display: flex; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .class-item.active { background-color: #eef2ff; border-color: #6366f1; color: #4f46e5; transform: scale(1.02); }
        iframe { width: 100%; height: 100%; border: none; border-radius: 20px; }
    </style>
</head>
<body class="p-6 gap-6">
    <script src="config.js"></script>

    <aside class="w-64 flex flex-col shrink-0">
        <h3 class="font-black text-slate-800 mb-4 flex items-center gap-2">
            <i class="fa-solid fa-folder-tree text-indigo-500"></i> 수업 선택
        </h3>
        <div id="class-list" class="flex-1 overflow-y-auto custom-scroll space-y-2 pr-2">
            <div class="p-10 text-center text-slate-400 text-xs animate-pulse">로딩 중...</div>
        </div>
    </aside>

    <main class="flex-1 bg-white rounded-3xl shadow-2xl border border-slate-200 flex flex-col relative overflow-hidden">
        <div id="vault-empty" class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 z-10">
            <i class="fa-solid fa-brands fa-google-drive text-7xl mb-4 opacity-10"></i>
            <p class="font-bold">왼쪽에서 수업을 선택하면 비밀 금고가 열립니다.</p>
        </div>

        <div id="vault-header" class="hidden px-8 py-6 border-b flex justify-between items-center bg-white z-20">
            <div>
                <h2 id="current-class-name" class="text-xl font-black text-slate-800">수업 자료실</h2>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Google Drive Integrated Vault</p>
            </div>
            <button onclick="openConfigModal()" class="bg-slate-100 hover:bg-slate-200 text-slate-500 font-black px-4 py-2 rounded-xl text-xs transition">
                <i class="fa-solid fa-gear mr-1"></i> 폴더 연동 설정
            </button>
        </div>

        <div id="drive-container" class="flex-1 hidden z-10 p-4">
            <div id="no-folder-msg" class="hidden h-full flex flex-col items-center justify-center text-slate-400">
                <i class="fa-solid fa-circle-exclamation text-4xl mb-2"></i>
                <p class="text-sm font-bold">연동된 구글 폴더가 없습니다.</p>
                <button onclick="openConfigModal()" class="mt-4 text-indigo-600 underline text-xs font-bold">지금 설정하기</button>
            </div>
            <iframe id="drive-iframe" src="" allow="autoplay"></iframe>
        </div>
    </main>

    <div id="config-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 hidden flex justify-center items-center">
        <div class="bg-white w-[400px] rounded-3xl p-8 shadow-2xl transform transition-all scale-100">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-2xl mx-auto mb-4">
                    <i class="fa-brands fa-google-drive"></i>
                </div>
                <h3 class="text-xl font-black text-slate-800">구글 폴더 연동</h3>
                <p class="text-xs text-slate-400 mt-1 font-bold">해당 수업 전용 폴더 ID를 입력해 주세요.</p>
            </div>
            
            <input type="text" id="inp-folder-id" placeholder="Google Folder ID (URL 아님)" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 text-sm font-bold text-slate-800 outline-none focus:border-indigo-500 transition mb-6">
            
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-500 font-bold py-4 rounded-2xl hover:bg-slate-200 transition">닫기</button>
                <button onclick="updateFolderId()" class="flex-1 bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-200 hover:bg-indigo-500 transition">연동하기</button>
            </div>
        </div>
    </div>

    <script>
        let classes = [], currentCid = null;

        async function init() {
            const { data } = await _supabase.from('classes').select('*').order('id');
            classes = data || [];
            renderClassList();
        }

        function renderClassList() {
            const list = document.getElementById('class-list');
            list.innerHTML = classes.map(c => `
                <div onclick="selectClass(${c.id})" id="cls-${c.id}" class="class-item bg-white border border-slate-100 p-4 rounded-2xl cursor-pointer transition group hover:border-indigo-300">
                    <div class="text-[9px] font-bold text-slate-400 group-hover:text-indigo-400 mb-1 uppercase">${c.day_of_week} / ${c.time_slot}</div>
                    <div class="font-black text-slate-700 truncate">${c.name}</div>
                </div>
            `).join('');
        }

        async function selectClass(cid) {
            currentCid = cid;
            const cls = classes.find(c => c.id === cid);
            
            document.querySelectorAll('.class-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`cls-${cid}`).classList.add('active');
            
            document.getElementById('vault-empty').classList.add('hidden');
            document.getElementById('vault-header').classList.remove('hidden');
            document.getElementById('drive-container').classList.remove('hidden');
            document.getElementById('current-class-name').innerText = `[${cls.name}] 자료실`;

            const iframe = document.getElementById('drive-iframe');
            const noMsg = document.getElementById('no-folder-msg');

            if(cls.google_folder_id) {
                noMsg.classList.add('hidden');
                iframe.classList.remove('hidden');
                // ★ 구글 드라이브 임베드 마법의 주소 ★
                iframe.src = `https://drive.google.com/embeddedfolderview?id=${cls.google_folder_id}#list`;
            } else {
                iframe.classList.add('hidden');
                noMsg.classList.remove('hidden');
            }
        }

        function openConfigModal() {
            const cls = classes.find(c => c.id === currentCid);
            document.getElementById('inp-folder-id').value = cls.google_folder_id || '';
            document.getElementById('config-modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('config-modal').classList.add('hidden'); }

        async function updateFolderId() {
            const folderId = document.getElementById('inp-folder-id').value.trim();
            if(!folderId) return alert("ID를 입력해 주십시오!");

            const { error } = await _supabase.from('classes').update({ google_folder_id: folderId }).eq('id', currentCid);
            if(error) alert("연동 실패: " + error.message);
            else {
                alert("✅ 구글 드라이브와 연동 완료!");
                closeModal();
                const idx = classes.findIndex(c => c.id === currentCid);
                classes[idx].google_folder_id = folderId;
                selectClass(currentCid);
            }
        }

        init();
    </script>
</body>
</html>