<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§ì¶¤í˜• ì·¨ì•½ì  ê³µëµ (Special Assignment)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* [Dark Theme & Scrollbar] */
        body { background-color: #0f172a; color: #cbd5e1; font-family: 'Pretendard', sans-serif; overflow: hidden; height: 100vh; user-select: none; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* [Layout: Glass Panels] */
        .glass-panel { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); display: flex; flex-direction: column; }
        .section-header { padding: 12px 16px; background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; font-weight: 800; display: flex; justify-content: space-between; align-items: center; letter-spacing: 0.5px; }

        /* [Grid & Tiles] */
        .problem-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; padding: 16px; }
        .tile { aspect-ratio: 1; border-radius: 10px; cursor: pointer; position: relative; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #334155; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 800; background: #1e293b; color: #64748b; }
        .tile:hover { transform: scale(1.1); z-index: 10; border-color: white; color: white; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5); }
        .tile.selected { border: 2px solid #db2777; background: #831843; color: #fbcfe8; box-shadow: 0 0 15px rgba(219, 39, 119, 0.5); }
        
        /* [Theme Colors] */
        .theme-high { background: linear-gradient(135deg, rgba(88, 28, 135, 0.4), rgba(59, 7, 100, 0.4)); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 12px; padding: 10px; }
        .theme-sub { background: linear-gradient(135deg, rgba(6, 78, 59, 0.4), rgba(2, 44, 34, 0.4)); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 10px; }
        .theme-norm { background: linear-gradient(135deg, rgba(30, 58, 138, 0.4), rgba(23, 37, 84, 0.4)); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 10px; }

        /* [Baskets] */
        .basket-zone { min-height: 40px; padding: 6px; display: flex; flex-wrap: wrap; gap: 6px; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px dashed rgba(255,255,255,0.2); margin-top: 8px; align-items: center; }
        .tag-item { display: flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; cursor: default; animation: fadeIn 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .tag-item i { cursor: pointer; opacity: 0.6; transition: 0.2s; } .tag-item i:hover { opacity: 1; transform: scale(1.2); color: #ffadad; }
        
        .tag-high { background: #7e22ce; color: #f3e8ff; border: 1px solid #a855f7; }
        .tag-sub { background: #047857; color: #d1fae5; border: 1px solid #10b981; }
        .tag-norm { background: #1d4ed8; color: #dbeafe; border: 1px solid #3b82f6; }
        .tag-scope { background: #0f766e; color: #ccfbf1; border: 1px solid #14b8a6; }
        .tag-time-input { background: #c2410c; color: #ffedd5; border: 1px solid #fb923c; padding: 2px 8px; display: flex; align-items: center; gap: 4px; }

        /* [Inputs] */
        .big-input { background: #020617; border: 1px solid #475569; color: white; padding: 8px 12px; border-radius: 8px; font-size: 14px; outline: none; transition: 0.2s; font-weight: bold; }
        .big-input:focus { border-color: #f472b6; box-shadow: 0 0 0 2px rgba(244, 114, 182, 0.2); }
        .big-select { background: #020617; border: 1px solid #475569; color: white; padding: 8px; border-radius: 8px; font-size: 14px; outline: none; cursor: pointer; font-weight: bold; }
        
        /* [CRITICAL FIX: TITLE INPUT CURSOR] */
        .title-input { 
            width: 100%; 
            background: rgba(0,0,0,0.3); 
            border: 1px solid #475569; 
            color: white; 
            padding: 10px; 
            border-radius: 8px; 
            font-size: 15px; 
            font-weight: bold; 
            outline: none;
            /* Force interaction */
            pointer-events: auto !important;
            user-select: text !important;
            z-index: 9999;
            cursor: text;
        }
        .title-input:focus { border-color: #f472b6; background: rgba(0,0,0,0.5); }
        
        .tiny-input { width: 40px; background: rgba(0,0,0,0.3); border: none; border-bottom: 1px solid #ffedd5; color: white; text-align: center; font-weight: bold; outline: none; pointer-events: auto; }
        .tiny-input:focus { background: rgba(0,0,0,0.5); border-color: white; }

        /* [Tooltip & Modal] */
        #xray-tooltip { display: none; position: fixed; z-index: 9999; background: rgba(15, 23, 42, 0.98); border: 2px solid #6366f1; border-radius: 12px; padding: 16px; width: 300px; pointer-events: none; backdrop-filter: blur(10px); box-shadow: 0 20px 50px rgba(0,0,0,0.6); }
        .tooltip-img { width: 100%; border-radius: 6px; margin-bottom: 12px; border: 1px solid #334155; background: white; min-height: 120px; object-fit: contain; }
        .stat-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 6px; color: #94a3b8; border-bottom: 1px solid #334155; padding-bottom: 4px; }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(8px); animation: fadeIn 0.2s; }
        .modal-card { background: #1e293b; width: 600px; border-radius: 20px; border: 1px solid #475569; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8); overflow: hidden; transform: scale(0.95); animation: zoomIn 0.2s forwards; }

        .time-btn { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: bold; background: #334155; color: #cbd5e1; transition: 0.2s; cursor: pointer; border: 1px solid transparent; display: flex; align-items: center; gap: 4px; }
        .time-btn:hover { background: #475569; color: white; transform: translateY(-1px); }
        .time-btn:active { transform: translateY(0); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { to { transform: scale(1); } }
    </style>
</head>
<body class="flex flex-col h-screen p-5 gap-5 bg-slate-950">

    <script src="config.js"></script>

    <div id="xray-tooltip">
        <div id="xray-header" class="text-indigo-400 font-bold text-sm mb-3 text-center border-b border-indigo-900/50 pb-2">No. 0000</div>
        <img id="xray-img" class="tooltip-img" src="" alt="Preview">
        <div class="space-y-1">
            <div class="stat-row"><span>ë‹¨ì›</span><span id="x-chap" class="font-bold text-white text-right truncate w-40">-</span></div>
            <div class="stat-row"><span>ìœ í˜•</span><span id="x-type" class="font-bold text-slate-300">-</span></div>
            <div class="stat-row"><span>ì˜¤ë‹µ / ì§ˆë¬¸</span><span class="font-bold text-white"><span id="x-wrong" class="text-red-400">0</span> / <span id="x-quest" class="text-yellow-400">0</span></span></div>
            <div class="stat-row"><span>ì •ë‹µë¥ </span><span id="x-acc" class="font-bold text-emerald-400">0%</span></div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="bg-slate-900 p-5 border-b border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-white text-xl"><i class="fa-solid fa-file-signature mr-2 text-pink-500"></i>ìµœì¢… ìŠ¹ì¸ í™•ì¸</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <div class="space-y-4">
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
                        <div>
                            <p class="text-xs text-slate-400 mb-1">ìˆ™ì œ ì œëª©</p>
                            <div id="modal-title" class="text-lg font-bold text-white tracking-wide">ì œëª© ì—†ìŒ</div>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-slate-400 mb-1">ì œì¶œ ê¸°í•œ (Deadline)</p>
                            <div id="modal-deadline" class="text-lg font-black text-orange-400">00.00 00:00</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 text-center">
                            <p class="text-xs text-slate-400">ì¶œì œ ë¬¸í•­ ìˆ˜</p>
                            <div class="text-2xl font-black text-pink-400 mt-1"><span id="modal-count">0</span> <span class="text-sm font-normal text-slate-500">ë¬¸í•­</span></div>
                        </div>
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 text-center">
                            <p class="text-xs text-slate-400">ë³´ìƒ / ì°¨ê°</p>
                            <div class="text-lg font-black text-emerald-400 mt-1">XP: <span id="modal-rw-xp-disp">0</span> / <span class="text-red-400" id="modal-pn-xp-disp">0</span></div>
                            <div class="text-xs text-slate-500">CP: <span id="modal-rw-cp-disp" class="text-emerald-400">0</span> / <span id="modal-pn-cp-disp" class="text-red-400">0</span></div>
                        </div>
                    </div>
                </div>
                <p class="text-sm text-center text-slate-500 pt-2 font-bold">ìœ„ ë‚´ìš©ìœ¼ë¡œ ìŠ¤í˜ì…œ ê³¼ì œë¥¼ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            </div>
            <div class="p-5 bg-slate-900 border-t border-slate-700 flex gap-4">
                <button onclick="closeModal()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 py-4 rounded-xl font-bold text-base transition">ìˆ˜ì •í•˜ê¸°</button>
                <button onclick="finalCreate()" class="flex-1 bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white py-4 rounded-xl font-bold text-base shadow-lg shadow-pink-900/30 transition transform active:scale-95">ğŸš€ ì „ì†¡ ìŠ¹ì¸</button>
            </div>
        </div>
    </div>

    <header class="flex justify-between items-center bg-slate-800 p-4 rounded-2xl border border-slate-700 shadow-xl shrink-0 h-18">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-xl bg-pink-600 flex items-center justify-center text-white text-2xl shadow-lg"><i class="fa-solid fa-crosshairs"></i></div>
            <div>
                <h1 class="font-bold text-xl text-white tracking-tight">ë§ì¶¤í˜• ì·¨ì•½ì  ê³µëµ <span class="text-sm text-pink-400 font-normal ml-2">Special Mission v8.0</span></h1>
                <p class="text-xs text-slate-400">í•™ìƒì˜ ë°ì´í„°ë¥¼ ì •ë°€ ë¶„ì„í•˜ì—¬ ë§ì¶¤í˜• ê³¼ì œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
            </div>
        </div>
        <button onclick="window.close()" class="bg-slate-700 hover:bg-slate-600 text-slate-300 px-5 py-2.5 rounded-xl text-sm font-bold transition">ë‹«ê¸°</button>
    </header>

    <div class="flex flex-1 gap-5 min-h-0">
        
        <div class="w-[42%] flex flex-col gap-5 overflow-y-auto custom-scroll pr-1">
            
            <div class="glass-panel shrink-0">
                <div class="section-header text-orange-400"><span class="flex items-center gap-2 text-base"><i class="fa-solid fa-pen-to-square"></i>ê¸°ë³¸ ì •ë³´ ì„¤ì •</span></div>
                <div class="p-4 space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 mb-1 block ml-1">ìˆ™ì œ ì œëª©</label>
                        <input type="text" id="assign-title" class="title-input" placeholder="ì˜ˆ: ì·¨ì•½ì  ê³µëµ (2025.12.16)" onmousedown="event.stopPropagation()">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 mb-1 block ml-1">ì œì¶œ ê¸°í•œ (ë°ë“œë¼ì¸)</label>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <div onclick="addDeadlineInput('day')" class="time-btn hover:text-orange-300"><i class="fa-solid fa-calendar-plus"></i> ì¼(Day) ì¶”ê°€</div>
                            <div onclick="addDeadlineInput('hour')" class="time-btn hover:text-orange-300"><i class="fa-solid fa-hourglass-start"></i> ì‹œê°„(Hour) ì¶”ê°€</div>
                            <div onclick="resetDeadline()" class="time-btn bg-slate-700 text-red-300 ml-auto"><i class="fa-solid fa-rotate-left"></i> ì´ˆê¸°í™”</div>
                        </div>
                        <div id="deadline-basket" class="basket-zone border-orange-500/30">
                            <div id="deadline-empty" class="w-full text-center text-slate-500 text-xs italic py-2">ë²„íŠ¼ì„ ëˆŒëŸ¬ ê¸°í•œ(ì¼/ì‹œê°„)ì„ ì¶”ê°€í•˜ì„¸ìš”</div>
                        </div>
                        <div class="text-right mt-2 text-sm text-orange-400 font-black tracking-wide" id="preview-date">ì˜ˆìƒ ë§ˆê°: <span class="text-slate-500">ì„¤ì • ì•ˆë¨</span></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 shrink-0">
                <div class="glass-panel">
                    <div class="section-header text-teal-400 text-sm"><span class="flex items-center gap-2"><i class="fa-solid fa-map"></i>ì¶œì œ ë²”ìœ„</span></div>
                    <div class="p-3 space-y-2">
                        <select id="chapter-select" class="big-select w-full text-xs" onchange="addChapterScope()"><option value="">ğŸ“‚ ë‹¨ì› ì¶”ê°€...</option></select>
                        <div id="scope-basket" class="basket-zone border-teal-500/30 min-h-[50px]"></div>
                    </div>
                </div>
                <div class="glass-panel">
                    <div class="section-header text-yellow-400 text-sm"><span class="flex items-center gap-2"><i class="fa-solid fa-coins"></i>ë³´ìƒ/ì°¨ê°</span></div>
                    <div class="p-3 space-y-2">
                        <div class="flex gap-2 items-center"><span class="text-[10px] w-8 text-emerald-400 font-bold">XPë³´ìƒ</span><input type="number" id="rw-xp" class="big-input flex-1 text-right h-8 text-xs" value="50" onmousedown="event.stopPropagation()"></div>
                        <div class="flex gap-2 items-center"><span class="text-[10px] w-8 text-emerald-400 font-bold">CPë³´ìƒ</span><input type="number" id="rw-cp" class="big-input flex-1 text-right h-8 text-xs" value="10" onmousedown="event.stopPropagation()"></div>
                        <div class="h-px bg-slate-600 my-1"></div>
                        <div class="flex gap-2 items-center"><span class="text-[10px] w-8 text-red-400 font-bold">XPì°¨ê°</span><input type="number" id="pn-xp" class="big-input flex-1 text-right h-8 text-xs" value="100" onmousedown="event.stopPropagation()"></div>
                        <div class="flex gap-2 items-center"><span class="text-[10px] w-8 text-red-400 font-bold">CPì°¨ê°</span><input type="number" id="pn-cp" class="big-input flex-1 text-right h-8 text-xs" value="5" onmousedown="event.stopPropagation()"></div>
                    </div>
                </div>
            </div>

            <div class="glass-panel flex-1 min-h-[400px]">
                <div class="section-header text-indigo-400"><span class="flex items-center gap-2 text-base"><i class="fa-solid fa-filter"></i>ìœ í˜•ë³„ í•„í„°</span><button onclick="analyze()" class="bg-pink-600 hover:bg-pink-500 text-white text-xs px-4 py-1.5 rounded-lg shadow font-bold animate-pulse">ì¶”ì¶œ ì‹¤í–‰</button></div>
                <div class="p-4 space-y-4 overflow-y-auto custom-scroll flex-1">
                    <div class="theme-high"><div class="flex justify-between items-center mb-2"><span class="text-xs font-black text-purple-300">ğŸ† 1ë“±ê¸‰</span><div class="flex gap-2"><label class="text-[10px] text-purple-200"><input type="radio" name="logic-high" value="OR" checked> OR</label><label class="text-[10px] text-purple-200"><input type="radio" name="logic-high" value="AND"> AND</label></div></div><div class="flex gap-1"><select id="metric-high" class="big-select flex-1 text-[10px] h-8 p-1"><option value="wrong">ì˜¤ë‹µ (â‰¥)</option><option value="quest">ì§ˆë¬¸ (â‰¥)</option><option value="acc">ì •ë‹µë¥  (â‰¤)</option></select><input type="number" id="val-high" class="big-input w-12 text-center h-8 p-1" value="1" onmousedown="event.stopPropagation()"><button onclick="addFilter('high')" class="bg-purple-600 text-white w-8 h-8 rounded"><i class="fa-solid fa-plus"></i></button></div><div id="basket-high" class="basket-zone mt-2 min-h-[30px]"></div></div>
                    <div class="theme-sub"><div class="flex justify-between items-center mb-2"><span class="text-xs font-black text-emerald-300">âœï¸ ì„œìˆ í˜•</span><div class="flex gap-2"><label class="text-[10px] text-emerald-200"><input type="radio" name="logic-sub" value="OR" checked> OR</label><label class="text-[10px] text-emerald-200"><input type="radio" name="logic-sub" value="AND"> AND</label></div></div><div class="flex gap-1"><select id="metric-sub" class="big-select flex-1 text-[10px] h-8 p-1"><option value="wrong">ì˜¤ë‹µ (â‰¥)</option><option value="quest">ì§ˆë¬¸ (â‰¥)</option><option value="acc">ì •ë‹µë¥  (â‰¤)</option></select><input type="number" id="val-sub" class="big-input w-12 text-center h-8 p-1" value="1" onmousedown="event.stopPropagation()"><button onclick="addFilter('sub')" class="bg-emerald-600 text-white w-8 h-8 rounded"><i class="fa-solid fa-plus"></i></button></div><div id="basket-sub" class="basket-zone mt-2 min-h-[30px]"></div></div>
                    <div class="theme-norm"><div class="flex justify-between items-center mb-2"><span class="text-xs font-black text-blue-300">ğŸ§© ì¼ë°˜í˜•</span><div class="flex gap-2"><label class="text-[10px] text-blue-200"><input type="radio" name="logic-norm" value="OR" checked class="accent-blue-500"> OR</label><label class="text-[10px] text-blue-200"><input type="radio" name="logic-norm" value="AND" class="accent-blue-500"> AND</label></div></div><div class="flex gap-1"><select id="metric-norm" class="big-select flex-1 text-[10px] h-8 p-1"><option value="wrong">ì˜¤ë‹µ (â‰¥)</option><option value="quest">ì§ˆë¬¸ (â‰¥)</option><option value="acc">ì •ë‹µë¥  (â‰¤)</option></select><input type="number" id="val-norm" class="big-input w-12 text-center h-8 p-1" value="2" onmousedown="event.stopPropagation()"><button onclick="addFilter('norm')" class="bg-blue-600 text-white w-8 h-8 rounded"><i class="fa-solid fa-plus"></i></button></div><div id="basket-norm" class="basket-zone mt-2 min-h-[30px]"></div></div>
                </div>
            </div>
        </div>

        <div class="flex-1 glass-panel flex flex-col overflow-hidden relative">
            <div class="section-header text-slate-200 py-4 px-5">
                <span class="flex items-center gap-3 text-lg"><i class="fa-solid fa-list-check"></i>ì¶”ì¶œ ê²°ê³¼ í™•ì¸</span>
                <div class="flex items-center gap-4 bg-black/30 px-4 py-2 rounded-xl border border-slate-600">
                    <div class="text-right"><div class="text-[10px] text-slate-400 uppercase font-bold">Total</div><div class="text-2xl font-black text-pink-500 leading-none"><span id="sel-cnt-total">0</span><span class="text-sm text-slate-500 ml-1">ê°œ</span></div></div>
                    <div class="w-px h-8 bg-slate-600"></div>
                    <div class="flex gap-4 text-xs font-bold"><div class="text-center"><div class="text-purple-400 mb-0.5">1ë“±ê¸‰</div><span id="sel-cnt-high" class="text-white text-lg">0</span></div><div class="text-center"><div class="text-emerald-400 mb-0.5">ì„œìˆ í˜•</div><span id="sel-cnt-sub" class="text-white text-lg">0</span></div><div class="text-center"><div class="text-blue-400 mb-0.5">ì¼ë°˜</div><span id="sel-cnt-norm" class="text-white text-lg">0</span></div></div>
                    <button onclick="clearSelection()" class="ml-2 text-xs text-slate-500 hover:text-white underline">ì´ˆê¸°í™”</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto custom-scroll bg-[#0b1120] p-5 space-y-6">
                <div id="res-group-high" class="hidden animate-[fadeIn_0.3s]"><div class="text-xs font-black text-purple-400 mb-2 border-b border-purple-900/50 pb-1 flex justify-between"><span>HIGH RANK (1ë“±ê¸‰)</span> <span id="disp-cnt-high">0</span></div><div id="grid-high" class="problem-grid bg-purple-900/5 rounded-xl border border-purple-900/30"></div></div>
                <div id="res-group-sub" class="hidden animate-[fadeIn_0.3s]"><div class="text-xs font-black text-emerald-400 mb-2 border-b border-emerald-900/50 pb-1 flex justify-between"><span>SUBJECTIVE (ì„œìˆ í˜•)</span> <span id="disp-cnt-sub">0</span></div><div id="grid-sub" class="problem-grid bg-emerald-900/5 rounded-xl border border-emerald-900/30"></div></div>
                <div id="res-group-norm" class="hidden animate-[fadeIn_0.3s]"><div class="text-xs font-black text-blue-400 mb-2 border-b border-blue-900/50 pb-1 flex justify-between"><span>NORMAL (ì¼ë°˜)</span> <span id="disp-cnt-norm">0</span></div><div id="grid-norm" class="problem-grid bg-blue-900/5 rounded-xl border border-blue-900/30"></div></div>
                <div id="result-msg" class="h-full flex flex-col items-center justify-center text-slate-500 opacity-40"><i class="fa-solid fa-filter-circle-xmark text-6xl mb-4"></i><span class="text-lg font-bold">ì¡°ê±´ ì„¤ì • í›„ 'ì¶”ì¶œ ì‹¤í–‰'ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</span></div>
            </div>
            <div class="p-4 border-t border-slate-700 bg-slate-800/80 flex justify-end backdrop-blur-sm">
                <button onclick="confirmAssignment()" class="bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white font-bold px-8 py-3 rounded-xl shadow-lg shadow-pink-900/40 text-sm flex items-center gap-3 transition transform active:scale-95"><i class="fa-solid fa-paper-plane"></i> ìŠ¤í˜ì…œ ìˆ™ì œ ìƒì„±</button>
            </div>
        </div>
    </div>

    <script>
        // --- Init & Config ---
        const urlParams = new URLSearchParams(window.location.search);
        // decodeURIComponent is automatically handled by URLSearchParams for simple cases, but explicit handling is safer if encoding is weird
        const STUDENT_ID_RAW = urlParams.get('sid');
        const STUDENT_ID = decodeURIComponent(STUDENT_ID_RAW); // Force decode just in case
        const WORKBOOK_ID = urlParams.get('wbid');
        
        if(!window._supabase) console.error("Supabase Client Not Initialized. Check config.js");
        if(!STUDENT_ID || !WORKBOOK_ID) { alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤."); window.close(); }

        let fullMetadata = [], fullProgress = {};
        let scopeBasket = new Set(), filters = { high: [], sub: [], norm: [] };
        let selectedProblems = new Set(), problemTypes = {};
        let deadlineItems = []; 
        let resolvedUUID = null; 

        // Attach global functions
        window.finalCreate = finalCreate;
        window.confirmAssignment = confirmAssignment;
        window.addDeadlineInput = addDeadlineInput;
        window.resetDeadline = resetDeadline;
        window.removeDeadlineItem = removeDeadlineItem;
        window.updateDeadlineValue = updateDeadlineValue;
        window.addChapterScope = addChapterScope;
        window.addFilter = addFilter;
        window.analyze = analyze;
        window.clearSelection = clearSelection;
        window.closeModal = closeModal;

        init();
        async function init() {
            const today = new Date();
            const dateStr = `${today.getFullYear()}.${today.getMonth()+1}.${today.getDate()}`;
            document.getElementById('assign-title').value = `ì·¨ì•½ì  ê³µëµ: ${STUDENT_ID} (${dateStr})`;
            updatePreviewDate();

            try {
                // [EVE'S DIRECT LOOKUP]
                // 1. UUID ì°¾ê¸° ë¡œì§ ì œê±° (DBì— UUIDê°€ ì—†ìœ¼ë¯€ë¡œ ë¶ˆê°€ëŠ¥)
                // 2. ê·¸ëƒ¥ 'username' (í•œê¸€ ID)ì´ ì‹ë³„ìë¼ê³  ë¯¿ê³  ê°„ë‹¤.
                // 3. ëŒ€ì‹ , ì´ ì•„ì´ë””ê°€ ì§„ì§œ ì¡´ì¬í•˜ëŠ”ì§€ 'users' í…Œì´ë¸”ì˜ 'username' ì»¬ëŸ¼ìœ¼ë¡œ í™•ì¸ë§Œ í•œë‹¤.
                
                console.log(`[Eve] Verifying User: ${STUDENT_ID}`);

                // users í…Œì´ë¸”ì—ì„œ usernameì´ STUDENT_IDì¸ í–‰ì´ ìˆëŠ”ì§€ í™•ì¸ (ë°ì´í„°ëŠ” ì•ˆ ê°€ì ¸ì™€ë„ ë¨, countë§Œ)
                const { count, error } = await _supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .eq('username', STUDENT_ID);

                if (count > 0) {
                    // ì¡´ì¬í•¨!
                    resolvedUUID = STUDENT_ID; // ì´ì œë¶€í„° ì´ í•œê¸€ IDë¥¼ UUIDì²˜ëŸ¼ ì“´ë‹¤ (ë³€ìˆ˜ëª…ë§Œ UUIDê³  ê°’ì€ í•œê¸€ID)
                    console.log(`[Eve] User Verified. Using ID: ${resolvedUUID}`);
                } else {
                    // ì—†ìŒ!
                    resolvedUUID = null;
                    console.warn(`[Eve] User Not Found: ${STUDENT_ID}`);
                    alert(`ê²½ê³ : í•™ìƒ ì•„ì´ë”” [${STUDENT_ID}]ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní•™ìƒ ê´€ë¦¬ ë©”ë‰´ì—ì„œ ë“±ë¡ ì—¬ë¶€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                }

                // 4. ë°ì´í„° ë¡œë“œ (resolvedUUIDê°€ í•œê¸€ IDì„)
                const [metaRes, progRes] = await Promise.all([
                    _supabase.from('problem_metadata').select('*').eq('workbook_id', WORKBOOK_ID).order('problem_num', {ascending: true}),
                    _supabase.from('student_progress').select('*').eq('student_id', resolvedUUID || 'DUMMY').eq('workbook_id', WORKBOOK_ID)
                ]);
                
                if(metaRes.error) throw metaRes.error; 
                fullMetadata = metaRes.data;
                if(progRes.data) progRes.data.forEach(p => fullProgress[p.problem_num] = p);
                
                buildChapterTree(fullMetadata);
            } catch(e) { console.error("Init Error:", e); }
        }

        // --- Deadline Logic ---
        function addDeadlineInput(type) {
            const id = Date.now(); deadlineItems.push({ id, type, value: 0 });
            const basket = document.getElementById('deadline-basket'); document.getElementById('deadline-empty').style.display = 'none';
            const tag = document.createElement('div'); tag.className = 'tag-item tag-time-input animate-[fadeIn_0.2s]'; tag.id = `time-tag-${id}`;
            const label = type === 'day' ? 'ì¼' : 'ì‹œê°„'; const icon = type === 'day' ? 'calendar-day' : 'clock';
            tag.innerHTML = `<i class="fa-solid fa-${icon} text-orange-200"></i><span class="text-[10px] font-bold text-orange-100">${label}</span><input type="number" class="tiny-input" min="0" placeholder="0" oninput="updateDeadlineValue(${id}, this.value)" onmousedown="event.stopPropagation()"><i class="fa-solid fa-xmark ml-1 hover:text-white" onclick="removeDeadlineItem(${id})"></i>`;
            basket.appendChild(tag);
        }
        function updateDeadlineValue(id, val) { const item = deadlineItems.find(i => i.id === id); if(item) { item.value = parseInt(val) || 0; updatePreviewDate(); } }
        function removeDeadlineItem(id) { deadlineItems = deadlineItems.filter(i => i.id !== id); document.getElementById(`time-tag-${id}`).remove(); if(deadlineItems.length === 0) document.getElementById('deadline-empty').style.display = 'block'; updatePreviewDate(); }
        function resetDeadline() { deadlineItems = []; document.getElementById('deadline-basket').innerHTML = '<div id="deadline-empty" class="w-full text-center text-slate-500 text-xs italic py-2">ë²„íŠ¼ì„ ëˆŒëŸ¬ ê¸°í•œ(ì¼/ì‹œê°„)ì„ ì¶”ê°€í•˜ì„¸ìš”</div>'; updatePreviewDate(); }
        function updatePreviewDate() {
            let totalMinutes = 0; deadlineItems.forEach(item => { if(item.type === 'day') totalMinutes += item.value * 1440; if(item.type === 'hour') totalMinutes += item.value * 60; });
            const displayEl = document.getElementById('preview-date');
            if(totalMinutes === 0) { displayEl.innerHTML = `ì˜ˆìƒ ë§ˆê°: <span class="text-slate-500">ì„¤ì • ì•ˆë¨</span>`; return; }
            const now = new Date(); now.setMinutes(now.getMinutes() + totalMinutes);
            const str = now.toLocaleString('ko-KR', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            displayEl.innerHTML = `ì˜ˆìƒ ë§ˆê°: <span class="text-white">${str}</span> <span class="text-[10px] text-slate-400">(${totalMinutes >= 60 ? Math.floor(totalMinutes/60)+'ì‹œê°„ '+(totalMinutes%60)+'ë¶„' : totalMinutes+'ë¶„'})</span>`;
        }

        // --- Core Logic ---
        function buildChapterTree(list) { 
            let chapters = new Map(), lastMaj=null;
            list.forEach(m => {
                if(m.chapter_major) lastMaj=m; else if(lastMaj) { m.chapter_major=lastMaj.chapter_major; m.chapter_major_title_ko=lastMaj.chapter_major_title_ko; m.chapter_minor=lastMaj.chapter_minor; m.chapter_title_ko=lastMaj.chapter_title_ko; }
                const mk = m.chapter_major||999, nk = m.chapter_minor||999;
                if(!chapters.has(mk)) chapters.set(mk, {title: m.chapter_major_title_ko||'ê¸°íƒ€', minors: new Map()});
                chapters.get(mk).minors.set(nk, m.chapter_title_ko||'ê¸°íƒ€');
                m._chapKey = `${mk}_${nk}`;
                if(m.difficulty?.includes('high')) problemTypes[m.problem_num]='high'; else if(m.is_subjective) problemTypes[m.problem_num]='sub'; else problemTypes[m.problem_num]='norm';
            });
            const sel = document.getElementById('chapter-select');
            [...chapters.entries()].sort((a,b)=>a[0]-b[0]).forEach(([mk, mo]) => {
                const grp = document.createElement('optgroup'); grp.label = `${mk}. ${mo.title}`;
                [...mo.minors.entries()].sort((a,b)=>a[0]-b[0]).forEach(([nk, mt]) => {
                    const opt = document.createElement('option'); opt.value = `${mk}_${nk}`; opt.text = `${mk}-${nk}. ${mt}`; grp.appendChild(opt);
                });
                sel.appendChild(grp);
            });
        }
        function addChapterScope() { const sel = document.getElementById('chapter-select'); const val = sel.value; if(!val) return; if(scopeBasket.has(val)) return; scopeBasket.add(val); const tag = document.createElement('div'); tag.className = 'tag-item tag-scope'; tag.innerHTML = `<span>${sel.options[sel.selectedIndex].text}</span> <i class="fa-solid fa-xmark" onclick="removeScope('${val}', this)"></i>`; document.getElementById('scope-basket').appendChild(tag); sel.value = ""; }
        function removeScope(val, el) { scopeBasket.delete(val); el.parentElement.remove(); }
        function addFilter(cat) { const metric = document.getElementById(`metric-${cat}`).value; const val = parseInt(document.getElementById(`val-${cat}`).value); const id = `${cat}-${metric}-${val}`; if(filters[cat].some(f=>f.id===id)) return; const text = document.getElementById(`metric-${cat}`).selectedOptions[0].text.split(' ')[0]; const suffix = metric==='acc'?'%':'íšŒ'; filters[cat].push({id, metric, value: val}); const tag = document.createElement('div'); tag.className = `tag-item tag-${cat}`; tag.innerHTML = `<span>${text} ${val}${suffix}</span> <i class="fa-solid fa-xmark" onclick="removeFilter('${cat}','${id}',this)"></i>`; document.getElementById(`basket-${cat}`).appendChild(tag); }
        function removeFilter(cat, id, el) { filters[cat] = filters[cat].filter(f=>f.id!==id); el.parentElement.remove(); }
        
        function analyze() { 
            if(scopeBasket.size===0) return alert("ì¶œì œ ë²”ìœ„ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
            if(!resolvedUUID) return alert("í•™ìƒì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); // ê°„ë‹¨ ì²´í¬
            ['high','sub','norm'].forEach(k=>{ document.getElementById(`grid-${k}`).innerHTML=''; document.getElementById(`res-group-${k}`).classList.add('hidden'); });
            document.getElementById('result-msg').classList.add('hidden');
            let counts = {high:0, sub:0, norm:0}; selectedProblems.clear();
            fullMetadata.forEach(m => {
                if(!scopeBasket.has(m._chapKey)) return;
                const type = problemTypes[m.problem_num]; const activeFilters = filters[type]; if(activeFilters.length===0) return;
                const p = fullProgress[m.problem_num]; if(!p) return;
                const w = p.wrong_count||0, q = p.question_count||0, acc = ((p.correct_count||0)+w)>0 ? Math.round((p.correct_count||0)/((p.correct_count||0)+w)*100) : 0;
                let matches = 0;
                activeFilters.forEach(f => { if((f.metric==='wrong'&&w>=f.value) || (f.metric==='quest'&&q>=f.value) || (f.metric==='acc'&&acc<=f.value)) matches++; });
                const logic = document.querySelector(`input[name="logic-${type}"]:checked`).value;
                if((logic==='OR'&&matches>0) || (logic==='AND'&&matches===activeFilters.length)) { renderTile(type, m, p); selectedProblems.add(m.problem_num); counts[type]++; }
            });
            ['high','sub','norm'].forEach(k=>{ if(counts[k]>0) { document.getElementById(`res-group-${k}`).classList.remove('hidden'); document.getElementById(`disp-cnt-${k}`).innerText = counts[k] + " ê°œ"; } });
            if(selectedProblems.size===0) document.getElementById('result-msg').classList.remove('hidden');
            updateCounts();
        }
        function renderTile(type, m, p) { 
            const tile = document.createElement('div'); tile.className = 'tile selected'; tile.dataset.num = m.problem_num; tile.innerText = m.problem_num; tile.dataset.type = type; tile.dataset.chap = `${m.chapter_major_title_ko||''} > ${m.chapter_title_ko||''}`; tile.dataset.wrong = p.wrong_count||0; tile.dataset.quest = p.question_count||0; const t = (p.correct_count||0)+(p.wrong_count||0); tile.dataset.acc = t>0?Math.round((p.correct_count||0)/t*100):0; tile.onclick = () => { const n = parseInt(tile.dataset.num); if(selectedProblems.has(n)) { selectedProblems.delete(n); tile.classList.remove('selected'); tile.style.opacity = '0.4'; } else { selectedProblems.add(n); tile.classList.add('selected'); tile.style.opacity = '1'; } updateCounts(); }; tile.onmouseenter = (e) => { const tip = document.getElementById('xray-tooltip'); const img = document.getElementById('xray-img'); img.src = `${SUPABASE_URL}/storage/v1/object/public/problems/${WORKBOOK_ID}/${m.problem_num.toString().padStart(4,'0')}.webp`; document.getElementById('xray-header').innerText = `No. ${m.problem_num}`; document.getElementById('x-chap').innerText = tile.dataset.chap; document.getElementById('x-type').innerText = type==='high'?'1ë“±ê¸‰':(type==='sub'?'ì„œìˆ í˜•':'ì¼ë°˜'); document.getElementById('x-wrong').innerText = tile.dataset.wrong; document.getElementById('x-quest').innerText = tile.dataset.quest; document.getElementById('x-acc').innerText = tile.dataset.acc+'%'; const r = tile.getBoundingClientRect(); let left = r.right+15; if(left+300 > window.innerWidth) left = r.left-310; let top = r.top-80; if(top<10) top=10; if(top+200 > window.innerHeight) top = window.innerHeight-210; tip.style.left = left+'px'; tip.style.top = top+'px'; tip.style.display='block'; }; tile.onmouseleave = () => document.getElementById('xray-tooltip').style.display='none'; document.getElementById(`grid-${type}`).appendChild(tile); }
        function updateCounts() { let c={high:0, sub:0, norm:0}; selectedProblems.forEach(n=>{ c[problemTypes[n]]++; }); document.getElementById('sel-cnt-total').innerText = selectedProblems.size; ['high','sub','norm'].forEach(k=>document.getElementById(`sel-cnt-${k}`).innerText = c[k]); }
        function clearSelection() { selectedProblems.clear(); document.querySelectorAll('.tile').forEach(t=>{t.classList.remove('selected'); t.style.opacity='0.4'}); updateCounts(); }

        // --- Confirmation & Creation ---
        function confirmAssignment() { 
            if(selectedProblems.size===0) return alert("ì„ íƒëœ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.");
            if(deadlineItems.length===0 && document.getElementById('preview-date').innerText.includes('ì„¤ì • ì•ˆë¨')) return alert("ì œì¶œ ê¸°í•œì„ ì„¤ì •í•´ì£¼ì„¸ìš”.");
            const title = document.getElementById('assign-title').value; if(!title.trim()) return alert("ìˆ™ì œ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            
            // [EVE] ì „ì†¡ ì§ì „ ID ì¬í™•ì¸
            if(!resolvedUUID) return alert(`í•™ìƒì„ ì‹ë³„í•  ìˆ˜ ì—†ì–´ ì „ì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);

            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-deadline').innerText = document.getElementById('preview-date').innerText.replace('ì˜ˆìƒ ë§ˆê°: ', '');
            document.getElementById('modal-count').innerText = selectedProblems.size;
            document.getElementById('modal-rw-xp-disp').innerText = document.getElementById('rw-xp').value; 
            document.getElementById('modal-rw-cp-disp').innerText = document.getElementById('rw-cp').value;
            document.getElementById('modal-pn-xp-disp').innerText = document.getElementById('pn-xp').value;
            document.getElementById('modal-pn-cp-disp').innerText = document.getElementById('pn-cp').value;
            document.getElementById('confirm-modal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('confirm-modal').style.display = 'none'; }

        async function finalCreate() {
            const btn = document.querySelector('#confirm-modal button:last-child');
            btn.innerText = "ë°ì´í„° ì „ì†¡ ì¤‘..."; btn.disabled = true;
            
            let targetUUID = resolvedUUID; 
            
            if (!targetUUID) {
                alert("ID ì˜¤ë¥˜: ì „ì†¡í•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
                btn.innerText = "ğŸš€ ì „ì†¡ ìŠ¹ì¸"; btn.disabled = false;
                return;
            }

            let totalMinutes = 0;
            deadlineItems.forEach(item => {
                if(item.type === 'day') totalMinutes += item.value * 1440;
                if(item.type === 'hour') totalMinutes += item.value * 60;
            });
            const now = new Date(); now.setMinutes(now.getMinutes() + totalMinutes);

            try {
                // â˜… [EVE] ëª¨ë“ˆí™”ëœ ìƒˆ í•¨ìˆ˜ í˜¸ì¶œ
                // ê¸°ì¡´ 'create_assignment_teacher'ê°€ ì•„ë‹Œ 'create_assignment_special'ì„ ì‚¬ìš©
                const payload = {
                    p_student_id: targetUUID, 
                    p_workbook_id: parseInt(WORKBOOK_ID),
                    p_title: document.getElementById('modal-title').innerText,
                    p_problem_list: Array.from(selectedProblems).sort((a,b)=>a-b),
                    p_deadline: now.toISOString(),
                    // â˜… ìŠ¤í˜ì…œ ë°ì´í„° 4í˜•ì œ ì „ì†¡ â˜…
                    p_reward_xp: parseInt(document.getElementById('modal-rw-xp-disp').innerText), 
                    p_reward_cp: parseInt(document.getElementById('modal-rw-cp-disp').innerText), 
                    p_penalty_xp: parseInt(document.getElementById('modal-pn-xp-disp').innerText), 
                    p_penalty_cp: parseInt(document.getElementById('modal-pn-cp-disp').innerText)
                };

                // ìƒˆë¡œìš´ RPC í•¨ìˆ˜ í˜¸ì¶œ!
                const { error } = await _supabase.rpc('create_assignment_special', payload); 
                if(error) throw error;
                
                alert("âœ… ìŠ¤í˜ì…œ ê³¼ì œê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                window.close();
            } catch(e) {
                console.error(e);
                alert("ì „ì†¡ ì‹¤íŒ¨: " + e.message);
                btn.innerText = "ğŸš€ ì „ì†¡ ìŠ¹ì¸"; btn.disabled = false;
            }
        }
    </script>
</body>
</html>