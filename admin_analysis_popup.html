<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë§ì¶¤í˜• ë¬¸ì œ ì¶”ì¶œ ì„¼í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background: #0f172a; color: #cbd5e1; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: #0f172a; }

        .panel { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 12px; display: flex; flex-direction: column; }
        .inp-dark { background: #0f172a; border: 1px solid #475569; color: white; padding: 4px; border-radius: 4px; width: 50px; text-align: center; font-weight: bold; font-size: 13px; }
        .inp-dark:focus { border-color: #6366f1; outline: none; }
        .inp-range { width: 60px; }

        .range-tag { background: #064e3b; border: 1px solid #059669; color: #6ee7b7; padding: 4px 8px; border-radius: 4px; font-size: 12px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
        
        .prob-item { cursor: pointer; transition: all 0.1s; border: 1px solid #334155; background: #1e293b; color: #94a3b8; font-size: 13px; display: flex; align-items: center; justify-content: center; height: 40px; border-radius: 6px; }
        .prob-item:hover { border-color: #6366f1; color: white; background: #312e81; transform: scale(1.05); z-index: 10; }
        .prob-item:active { transform: scale(0.95); }
        .prob-item.in-basket { border-color: #ef4444; background: #450a0a; color: #fca5a5; opacity: 0.6; }

        .basket-item { cursor: pointer; background: #312e81; border: 1px solid #4f46e5; color: white; font-size: 13px; display: flex; align-items: center; justify-content: center; height: 36px; border-radius: 6px; }
        .basket-item:hover { background: #ef4444; border-color: #ef4444; }

        /* â˜… NEW: ì´ˆê±°ëŒ€ í’€ë°œê¸° íŒì—… (Full Screen Preview) */
        #preview-popup { 
            display: none; position: fixed; z-index: 9999; 
            border: 4px solid #6366f1; background: white; border-radius: 16px; 
            box-shadow: 0 0 100px rgba(0,0,0,0.9); pointer-events: none; 
            overflow: hidden; 
            /* í™”ë©´ ì¤‘ì•™ ì •ë ¬ & ìµœëŒ€ ì‚¬ì´ì¦ˆ */
            left: 50%; top: 50%; transform: translate(-50%, -50%);
            width: auto; height: auto;
            max-width: 95vw; max-height: 95vh; /* í™”ë©´ì˜ 95%ê¹Œì§€ í™•ì¥ */
            min-width: 300px; /* ë„ˆë¬´ ì‘ì•„ì§€ì§€ ì•Šê²Œ */
        }
        #preview-popup img { 
            width: 100%; height: 100%; 
            object-fit: contain; /* ë¹„ìœ¨ ìœ ì§€í•˜ë©° ê½‰ ì±„ìš°ê¸° */
            display: block; background: white; 
        }
        
        /* íˆ´íŒ */
        .tooltip-box { display: none; position: absolute; bottom: 100%; right: 0; width: 220px; background: rgba(15, 23, 42, 0.95); color: #cbd5e1; padding: 8px; border-radius: 6px; font-size: 11px; z-index: 50; border: 1px solid #475569; text-align: left; line-height: 1.4; margin-bottom: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .has-tooltip:hover .tooltip-box { display: block; }

        .or-divider { display: flex; align-items: center; justify-content: center; font-size: 10px; color: #64748b; margin: 6px 0; }
        .or-divider::before, .or-divider::after { content: ''; flex: 1; height: 1px; background: #334155; margin: 0 4px; }

        .type-radio { accent-color: #fbbf24; } 
        .type-radio-pt { accent-color: #ec4899; }
    </style>
</head>
<body class="text-sm">

    <script src="config.js"></script>

    <div id="preview-popup">
        <div class="bg-indigo-600 text-white text-sm font-bold p-3 text-center" id="prev-title">No. 0</div>
        <img id="prev-img" src="">
    </div>

    <div class="bg-slate-900 border-b border-slate-700 p-4 flex flex-col gap-4 shrink-0 h-1/2 min-h-[350px] overflow-y-auto custom-scroll">
        <div class="flex justify-between items-center shrink-0">
            <div>
                <h1 class="text-lg md:text-xl font-bold text-white flex items-center gap-2">
                    <span class="text-indigo-400">ğŸ¯</span> ë§ì¶¤í˜• ì·¨ì•½ì  ê³µëµ
                </h1>
                <p class="text-[11px] text-slate-500"><span id="target-info" class="font-bold text-slate-300">í•™ìƒ</span>ì˜ í•™ìŠµ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¬¸ì œë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.</p>
                <p class="md:hidden text-[10px] text-pink-400 mt-1">* ëª¨ë°”ì¼: ë¬¸ì œë¥¼ ê¾¹~ ëˆ„ë¥´ë©´ í¬ê²Œ ë³´ê¸°</p>
            </div>
            <div class="flex gap-2">
                <button onclick="executeHunt()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold px-5 py-2 rounded-lg shadow-lg flex items-center gap-2 transition transform active:scale-95">
                    <span>ğŸ”</span> ë¬¸ì œ ì¶”ì¶œ
                </button>
                <button onclick="window.close()" class="bg-slate-700 text-slate-300 px-3 py-2 rounded hover:bg-slate-600 text-xs">ë‹«ê¸°</button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-4 h-full">
            <div class="md:w-1/4 panel min-h-[150px] border-l-4 border-l-emerald-600">
                <div class="flex justify-between items-center mb-3 border-b border-slate-700 pb-2">
                    <span class="font-bold text-emerald-400 text-xs">â‘  ë¬¸ì œ ë²”ìœ„ ì„¤ì • (í•„ìˆ˜)</span>
                </div>
                <div class="flex gap-1 items-center mb-3">
                    <input type="number" id="input-start" class="inp-dark inp-range" placeholder="ì‹œì‘"> 
                    <span class="text-slate-500">~</span> 
                    <input type="number" id="input-end" class="inp-dark inp-range" placeholder="ë">
                    <button onclick="addRange()" class="ml-1 bg-emerald-700 text-white text-xs px-3 py-1 rounded hover:bg-emerald-600 font-bold">ì¶”ê°€</button>
                </div>
                <div id="active-ranges" class="flex-1 overflow-y-auto space-y-1 bg-slate-900/50 p-1 rounded border border-slate-700">
                    <div class="text-center text-[10px] text-slate-600 py-4" id="range-empty-msg">ë²”ìœ„ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>
                </div>
            </div>

            <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-2">
                <div class="panel border-l-4 border-l-purple-500">
                    <div class="flex items-center justify-between mb-3 border-b border-slate-700 pb-2">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="use-high" checked class="w-4 h-4 accent-purple-500"><span class="font-bold text-purple-400 text-sm">ğŸ† 1ë“±ê¸‰</span></label>
                        <label class="flex items-center gap-1 cursor-pointer has-tooltip"><input type="checkbox" id="h-new" class="accent-purple-400"><span class="text-[10px] text-purple-200">âœ¨ ë¯¸í•™ìŠµ ë¬¸ì œë§Œ</span><div class="tooltip-box">ì²´í¬ ì‹œ, ê¸°ì¡´ í•„í„° ì¡°ê±´ì„ ë¬´ì‹œí•˜ê³  <strong>í•œ ë²ˆë„ í’€ì§€ ì•Šì€ ìƒˆ ë¬¸ì œ</strong>ë§Œ ì¶”ì¶œí•©ë‹ˆë‹¤.</div></label>
                    </div>
                    <div class="space-y-1 flex-1 overflow-y-auto pr-1 text-xs">
                        <div class="flex justify-between items-center"><span class="text-slate-300">ëˆ„ì  ì˜¤ë‹µ</span><div><input type="number" id="h-wrong" class="inp-dark" value="1"> <span class="text-slate-500">íšŒ ì´ìƒ</span></div></div>
                        <div class="or-divider">ë˜ëŠ” (OR)</div>
                        <div class="flex justify-between items-center"><span class="text-slate-300">ëˆ„ì  ì§ˆë¬¸</span><div><input type="number" id="h-quest" class="inp-dark" value="1"> <span class="text-slate-500">íšŒ ì´ìƒ</span></div></div>
                        <div class="or-divider">ë˜ëŠ” (OR)</div>
                        <div class="flex justify-between items-center"><span class="text-slate-300">ì •ë‹µë¥ </span><div><input type="number" id="h-acc" class="inp-dark" value="100"> <span class="text-slate-500">% ì´í•˜</span></div></div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-slate-700 text-right has-tooltip relative">
                        <label class="inline-flex items-center gap-1 cursor-pointer"><input type="checkbox" id="h-and" class="accent-purple-500"><span class="text-[11px] text-purple-300 font-bold">ì¡°ê±´ êµì°¨ ì ìš© (AND)</span><span class="text-[10px] text-slate-500 bg-slate-800 rounded-full w-4 h-4 flex items-center justify-center border border-slate-600">?</span></label>
                        <div class="tooltip-box">ì²´í¬ ì‹œ, ìœ„ ì¡°ê±´ë“¤ì„ <strong>ëª¨ë‘ ë™ì‹œì— ë§Œì¡±</strong>í•˜ëŠ” ë¬¸ì œë§Œ ì—„ì„ í•˜ì—¬ ì¶”ì¶œí•©ë‹ˆë‹¤.</div>
                    </div>
                </div>
                <div class="panel border-l-4 border-l-teal-500">
                    <div class="flex items-center justify-between mb-3 border-b border-slate-700 pb-2">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="use-sub" checked class="w-4 h-4 accent-teal-500"><span class="font-bold text-teal-400 text-sm">âœï¸ ì„œìˆ í˜•</span></label>
                        <label class="flex items-center gap-1 cursor-pointer has-tooltip"><input type="checkbox" id="s-new" class="accent-teal-400"><span class="text-[10px] text-teal-200">âœ¨ ë¯¸í•™ìŠµ ë¬¸ì œë§Œ</span><div class="tooltip-box">ì²´í¬ ì‹œ, <strong>ì•„ì§ í’€ì§€ ì•Šì€ ìƒˆ ë¬¸ì œ</strong>ë§Œ ì¶”ì¶œí•©ë‹ˆë‹¤.</div></label>
                    </div>
                    <div class="space-y-1 flex-1 overflow-y-auto pr-1 text-xs">
                        <div class="flex justify-between items-center"><span class="text-slate-300">ëˆ„ì  ì˜¤ë‹µ</span><div><input type="number" id="s-wrong" class="inp-dark" value="1"> <span class="text-slate-500">íšŒ ì´ìƒ</span></div></div>
                        <div class="or-divider">ë˜ëŠ” (OR)</div>
                        <div class="flex justify-between items-center"><span class="text-slate-300">ëˆ„ì  ì§ˆë¬¸</span><div><input type="number" id="s-quest" class="inp-dark" value="1"> <span class="text-slate-500">íšŒ ì´ìƒ</span></div></div>
                        <div class="or-divider">ë˜ëŠ” (OR)</div>
                        <div class="flex justify-between items-center"><span class="text-slate-300">ì •ë‹µë¥ </span><div><input type="number" id="s-acc" class="inp-dark" value="100"> <span class="text-slate-500">% ì´í•˜</span></div></div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-slate-700 text-right has-tooltip relative">
                        <label class="inline-flex items-center gap-1 cursor-pointer"><input type="checkbox" id="s-and" class="accent-teal-500"><span class="text-[11px] text-teal-300 font-bold">ì¡°ê±´ êµì°¨ ì ìš© (AND)</span><span class="text-[10px] text-slate-500 bg-slate-800 rounded-full w-4 h-4 flex items-center justify-center border border-slate-600">?</span></label>
                        <div class="tooltip-box">ì²´í¬ ì‹œ, ìœ„ ì¡°ê±´ë“¤ì„ <strong>ëª¨ë‘ ë™ì‹œì— ë§Œì¡±</strong>í•˜ëŠ” ë¬¸ì œë§Œ ì—„ì„ í•˜ì—¬ ì¶”ì¶œí•©ë‹ˆë‹¤.</div>
                    </div>
                </div>
                <div class="panel border-l-4 border-l-blue-500">
                    <div class="flex items-center justify-between mb-3 border-b border-slate-700 pb-2">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="use-norm" checked class="w-4 h-4 accent-blue-500"><span class="font-bold text-blue-400 text-sm">ğŸ§© ì¼ë°˜í˜•</span></label>
                        <label class="flex items-center gap-1 cursor-pointer has-tooltip"><input type="checkbox" id="n-new" class="accent-blue-400"><span class="text-[10px] text-blue-200">âœ¨ ë¯¸í•™ìŠµ ë¬¸ì œë§Œ</span><div class="tooltip-box">ì²´í¬ ì‹œ, <strong>ì•„ì§ í’€ì§€ ì•Šì€ ìƒˆ ë¬¸ì œ</strong>ë§Œ ì¶”ì¶œí•©ë‹ˆë‹¤.</div></label>
                    </div>
                    <div class="space-y-1 flex-1 overflow-y-auto pr-1 text-xs">
                        <div class="flex justify-between items-center"><span class="text-slate-300">ëˆ„ì  ì˜¤ë‹µ</span><div><input type="number" id="n-wrong" class="inp-dark" value="2"> <span class="text-slate-500">íšŒ ì´ìƒ</span></div></div>
                        <div class="or-divider">ë˜ëŠ” (OR)</div>
                        <div class="flex justify-between items-center"><span class="text-slate-300">ëˆ„ì  ì§ˆë¬¸</span><div><input type="number" id="n-quest" class="inp-dark" value="1"> <span class="text-slate-500">íšŒ ì´ìƒ</span></div></div>
                        <div class="or-divider">ë˜ëŠ” (OR)</div>
                        <div class="flex justify-between items-center"><span class="text-slate-300">ì •ë‹µë¥ </span><div><input type="number" id="n-acc" class="inp-dark" value="80"> <span class="text-slate-500">% ì´í•˜</span></div></div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-slate-700 text-right has-tooltip relative">
                        <label class="inline-flex items-center gap-1 cursor-pointer"><input type="checkbox" id="n-and" class="accent-blue-500"><span class="text-[11px] text-blue-300 font-bold">ì¡°ê±´ êµì°¨ ì ìš© (AND)</span><span class="text-[10px] text-slate-500 bg-slate-800 rounded-full w-4 h-4 flex items-center justify-center border border-slate-600">?</span></label>
                        <div class="tooltip-box">ì²´í¬ ì‹œ, ìœ„ ì¡°ê±´ë“¤ì„ <strong>ëª¨ë‘ ë™ì‹œì— ë§Œì¡±</strong>í•˜ëŠ” ë¬¸ì œë§Œ ì—„ì„ í•˜ì—¬ ì¶”ì¶œí•©ë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-1 flex overflow-hidden">
        <div class="flex-1 p-4 border-r border-slate-700 flex flex-col bg-slate-800/50">
            <h3 class="font-bold text-slate-400 text-sm mb-2 flex justify-between items-center">
                <span>ğŸ” ì¶”ì¶œ ê²°ê³¼ <span id="res-cnt" class="text-white ml-2">0</span>ë¬¸í•­</span>
                <span class="text-[10px] text-slate-500 hidden md:inline">í´ë¦­í•˜ì—¬ ë‹´ê¸° / ë§ˆìš°ìŠ¤ ì˜¬ë ¤ì„œ í™•ì¸</span>
            </h3>
            <div id="result-grid" class="flex-1 overflow-y-auto grid grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-2 content-start p-1 custom-scroll">
                <div class="col-span-full text-center py-20 text-slate-600 flex flex-col items-center gap-2">
                    <span class="text-2xl opacity-50">ğŸ“¡</span>
                    <span>ë²”ìœ„ì™€ ì¡°ê±´ì„ ì„¤ì •í•˜ê³ <br>'ë¬¸ì œ ì¶”ì¶œ' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</span>
                </div>
            </div>
        </div>

        <div class="w-1/3 md:w-1/4 p-4 flex flex-col bg-[#162032] border-l border-slate-700">
            <h3 class="font-bold text-indigo-400 text-sm mb-2 flex justify-between items-center">
                <span>ğŸ›’ ì¶œì œ ë°”êµ¬ë‹ˆ</span>
                <span class="bg-indigo-900 text-indigo-200 px-2 rounded-full text-xs" id="basket-cnt">0</span>
            </h3>
            <div id="basket-grid" class="flex-1 overflow-y-auto grid grid-cols-3 md:grid-cols-4 gap-2 content-start p-2 mb-4 border border-slate-600 rounded bg-[#0f172a] custom-scroll shadow-inner"></div>
            <button onclick="openSpecialOptions()" class="bg-gradient-to-r from-red-600 to-pink-700 text-white font-bold py-3 rounded-xl shadow-lg hover:scale-[1.02] transition active:scale-95 flex flex-col items-center justify-center gap-1">
                <span class="text-sm">ğŸ’€ ìŠ¤í˜ì…œ ìˆ™ì œ ìƒì„±</span>
                <span class="text-[10px] opacity-80">(ì˜µì…˜ ì„¤ì •)</span>
            </button>
        </div>
    </div>

    <div id="spec-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 p-6 rounded-xl border-2 border-red-500 w-full max-w-md shadow-2xl animate-[fadeIn_0.2s]">
            <h2 class="text-xl font-bold text-red-500 mb-4 flex items-center gap-2"><span>ğŸ’€</span> ìŠ¤í˜ì…œ ê³¼ì œ ì˜µì…˜ ì„¤ì •</h2>
            <div class="space-y-4 text-sm">
                <div>
                    <label class="block text-slate-400 mb-1 font-bold">ê³¼ì œ ì œëª©</label>
                    <input type="text" id="sp-title" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white focus:border-red-500 outline-none" value="íŠ¹ë³„ ë³´ì¶© í•™ìŠµ (ê¸°í•œ ì—„ìˆ˜)">
                </div>
                <div>
                    <label class="block text-slate-400 mb-1 font-bold">â° ì œì¶œ ë§ˆê°ì¼ (Time Attack)</label>
                    <input type="datetime-local" id="sp-deadline" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white focus:border-red-500 outline-none"><p class="text-[10px] text-slate-500 mt-1">* ê¸°í•œ ì´ˆê³¼ ì‹œ 2ì¼ê°„ ìœ ì˜ˆ í›„ ì œì¶œ ë¶ˆê°€ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-emerald-900/20 p-3 rounded border border-emerald-800">
                        <div class="font-bold text-emerald-400 mb-2 text-xs flex justify-between items-center"><span>ğŸ¥• ì„±ê³µ ë³´ìƒ</span></div>
                        <div class="flex gap-2 mb-2 text-[10px] justify-center"><label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="rew_type" value="point" checked class="type-radio-pt"> <span class="text-pink-300">Point</span></label><label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="rew_type" value="xp" class="type-radio"> <span class="text-yellow-300">XP</span></label></div>
                        <div class="flex justify-between mb-1 items-center"><span class="text-xs text-slate-400">ì§€ê¸‰ëŸ‰</span><input type="number" id="sp-rew-val" class="inp-dark w-12 border-emerald-700" value="5"></div>
                    </div>
                    <div class="bg-red-900/20 p-3 rounded border border-red-800">
                        <div class="font-bold text-red-400 mb-2 text-xs flex justify-between items-center"><span>ğŸ©¸ ì‹¤íŒ¨ íŒ¨ë„í‹°</span></div>
                        <div class="flex gap-2 mb-2 text-[10px] justify-center"><label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="pen_type" value="point" checked class="type-radio-pt"> <span class="text-pink-300">Point</span></label><label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="pen_type" value="xp" class="type-radio"> <span class="text-yellow-300">XP</span></label></div>
                        <div class="flex justify-between mb-1 items-center"><span class="text-xs text-slate-400">ì‚­ê°ëŸ‰</span><input type="number" id="sp-pen-val" class="inp-dark w-12 border-red-700" value="3"></div>
                    </div>
                </div>
                <label class="flex items-center gap-3 cursor-pointer bg-slate-900 p-3 rounded border border-slate-600 hover:border-slate-400"><input type="checkbox" id="sp-img-req" checked class="w-5 h-5 accent-red-500"> <span class="text-slate-300 font-bold text-xs">ğŸ“¸ í’€ì´ ê³¼ì • ì¸ì¦ í•„ìˆ˜ (ì—°ìŠµì¥ ì´¬ì˜)</span></label>
            </div>
            <div class="flex gap-3 mt-6"><button onclick="createAssignment()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-95">ê³„ì•½ ì²´ê²° (ìƒì„±)</button><button onclick="document.getElementById('spec-modal').classList.add('hidden')" class="bg-slate-700 hover:bg-slate-600 text-white px-4 rounded-lg font-bold">ì·¨ì†Œ</button></div>
        </div>
    </div>

    <script>
        // â˜… ì‚¬ìš©ì í™•ì¸ (ì„¸ì…˜)
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!currentUser) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); window.close(); }

        const params = new URLSearchParams(window.location.search);
        const sId = params.get('sid'); const wbId = params.get('wbid');
        const wbTitle = decodeURIComponent(params.get('title') || 'ë¬¸ì œì§‘'); const sName = decodeURIComponent(params.get('name') || 'í•™ìƒ');
        if(!sId || !wbId) { alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤."); window.close(); }
        document.getElementById('target-info').innerText = `${sName} - [${wbTitle}]`;

        let basket = new Set();
        let metaData = [];
        let progressData = {};
        let activeRanges = [];
        let pressTimer = null;

        function addRange() {
            const start = parseInt(document.getElementById('input-start').value);
            const end = parseInt(document.getElementById('input-end').value);
            if (isNaN(start) || isNaN(end) || start > end) return alert("ì˜¬ë°”ë¥¸ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            activeRanges.push({s: start, e: end});
            renderRanges();
            document.getElementById('input-start').value = ''; document.getElementById('input-end').value = '';
        }
        function removeRange(index) { activeRanges.splice(index, 1); renderRanges(); }
        function renderRanges() {
            const container = document.getElementById('active-ranges');
            if (activeRanges.length === 0) { container.innerHTML = '<div class="text-center text-[10px] text-slate-600 py-4" id="range-empty-msg">ë²”ìœ„ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>'; return; }
            container.innerHTML = activeRanges.map((r, idx) => `<div class="range-tag"><span>${r.s} ~ ${r.e}ë²ˆ</span><button onclick="removeRange(${idx})" class="text-emerald-300 hover:text-white font-bold ml-2">âœ•</button></div>`).join('');
        }

        async function loadData() {
            const [mRes, pRes] = await Promise.all([
                _supabase.from('problem_metadata').select('*').eq('workbook_id', wbId),
                _supabase.from('student_progress').select('*').eq('student_id', sId).eq('workbook_id', wbId)
            ]);
            metaData = mRes.data || [];
            if(pRes.data) pRes.data.forEach(p => progressData[p.problem_num] = p);
        }
        loadData();

        function executeHunt() {
            if (activeRanges.length === 0) return alert("ì£¼ì¸ë‹˜, ë²”ìœ„ë¥¼ ì„¤ì •í•´ì£¼ì…”ì•¼ ì¶”ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            
            const ranges = activeRanges;
            const getConf = (pfx) => ({
                use: document.getElementById(`use-${pfx}`).checked,
                newOnly: document.getElementById(`${pfx[0]}-new`).checked,
                wrong: parseInt(document.getElementById(`${pfx[0]}-wrong`).value)||0,
                quest: parseInt(document.getElementById(`${pfx[0]}-quest`).value)||0,
                acc: parseInt(document.getElementById(`${pfx[0]}-acc`).value)||100,
                and: document.getElementById(`${pfx[0]}-and`).checked
            });
            const cHigh = getConf('high'), cSub = getConf('sub'), cNorm = getConf('norm');

            const grid = document.getElementById('result-grid');
            grid.innerHTML = '';
            let results = [];

            metaData.forEach(m => {
                const num = m.problem_num;
                if (!ranges.some(r => num >= r.s && num <= r.e)) return;
                const p = progressData[num];
                let c = cNorm;
                if (m.difficulty === 'high_rank') c = cHigh; else if (m.is_subjective) c = cSub;
                if (!c.use) return;

                let hit = false;
                if (c.newOnly) { if (!p) hit = true; } 
                else if (p) {
                    const w = p.wrong_count || 0; const q = p.question_count || 0;
                    const total = (p.correct_count||0) + w;
                    const acc = total > 0 ? ((p.correct_count||0)/total)*100 : 0;
                    if (c.and) { if (w >= c.wrong && q >= c.quest && (total>0 && acc <= c.acc)) hit = true; }
                    else { if (w >= c.wrong || q >= c.quest || (total>0 && acc <= c.acc)) hit = true; }
                }

                if (hit) results.push(num);
            });

            results.sort((a, b) => a - b);
            
            document.getElementById('res-cnt').innerText = results.length;
            if (results.length === 0) { grid.innerHTML = '<div class="col-span-full text-center py-20 text-slate-500">ì¡°ê±´ì— ë§ëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

            results.forEach(num => {
                const isInBasket = basket.has(num);
                const div = document.createElement('div');
                div.className = `prob-item ${isInBasket ? 'in-basket' : ''}`;
                div.innerText = num;
                div.onclick = () => toggleBasket(num);
                div.onmouseenter = (e) => showPreview(e, num);
                div.onmouseleave = hidePreview;
                div.addEventListener('touchstart', (e) => { pressTimer = setTimeout(() => showMobilePreview(num), 600); });
                div.addEventListener('touchend', (e) => { clearTimeout(pressTimer); hidePreview(); });
                div.addEventListener('touchmove', () => clearTimeout(pressTimer));
                grid.appendChild(div);
            });
        }

        function toggleBasket(num) {
            if (basket.has(num)) basket.delete(num); else basket.add(num);
            renderBasket(); executeHunt(); 
        }

        function renderBasket() {
            const grid = document.getElementById('basket-grid');
            grid.innerHTML = '';
            Array.from(basket).sort((a,b)=>a-b).forEach(num => {
                const div = document.createElement('div');
                div.className = 'basket-item';
                div.innerText = num;
                div.onclick = () => toggleBasket(num);
                grid.appendChild(div);
            });
            document.getElementById('basket-cnt').innerText = basket.size;
        }

        function showPreview(e, num) {
            if('ontouchstart' in window) return;
            const pop = document.getElementById('preview-popup');
            const padded = num.toString().padStart(4, '0');
            document.getElementById('prev-title').innerText = `No. ${num}`;
            document.getElementById('prev-img').src = `${SUPABASE_URL}/storage/v1/object/public/problems/${wbId}/${padded}.webp`;
            
            pop.style.transform = 'translate(-50%, -50%)'; 
            pop.style.left = '50%'; pop.style.top = '50%'; 
            pop.style.display = 'block';
        }

        function showMobilePreview(num) {
            const pop = document.getElementById('preview-popup');
            const padded = num.toString().padStart(4, '0');
            document.getElementById('prev-title').innerText = `No. ${num} (ë¯¸ë¦¬ë³´ê¸°)`;
            document.getElementById('prev-img').src = `${SUPABASE_URL}/storage/v1/object/public/problems/${wbId}/${padded}.webp`;
            pop.style.transform = 'translate(-50%, -50%)';
            pop.style.left = '50%'; pop.style.top = '50%';
            pop.style.display = 'block';
        }

        function hidePreview() { document.getElementById('preview-popup').style.display = 'none'; }

        function openSpecialOptions() {
            if (basket.size === 0) return alert("ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById('spec-modal').classList.remove('hidden');
            const tmr = new Date(); tmr.setDate(tmr.getDate() + 1); tmr.setHours(23,59,0,0);
            document.getElementById('sp-deadline').value = tmr.toISOString().slice(0,16);
        }

        async function createAssignment() {
            const title = document.getElementById('sp-title').value;
            const deadlineVal = document.getElementById('sp-deadline').value;
            if(!deadlineVal) return alert("ë°ë“œë¼ì¸ì„ ì„¤ì •í•´ì£¼ì„¸ìš”!");
            const deadline = new Date(deadlineVal).toISOString();
            
            const rewVal = parseInt(document.getElementById('sp-rew-val').value);
            const penVal = parseInt(document.getElementById('sp-pen-val').value);
            const rewType = document.querySelector('input[name="rew_type"]:checked').value;
            const penType = document.querySelector('input[name="pen_type"]:checked').value;
            
            const list = Array.from(basket).sort((a,b)=>a-b);

            const payload = {
                student_id: sId, workbook_id: parseInt(wbId),
                title: title, type: 'special', status: 'assigned',
                problem_list: list, review_list: list,
                is_special: true, deadline: deadline,
                reward_points: rewVal, penalty_points: penVal,
                reward_type: rewType, penalty_type: penType,
                teacher_id: currentUser.username, 
                created_at: new Date()
            };

            const { error } = await _supabase.from('assignments').insert([payload]);
            if(error) alert("ìƒì„± ì‹¤íŒ¨: "+error.message);
            else { alert("ğŸ˜ˆ ê³„ì•½ì´ ì²´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!"); window.close(); }
        }
    </script>
</body>
</html>