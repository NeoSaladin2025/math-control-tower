<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <link rel="manifest" href="site.webmanifest">
    
    <link rel="apple-touch-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³¼ì œ ì¶œì œ ë° ê´€ë¦¬ (Assignment Manager)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #2563eb; cursor: pointer; margin-top: -6px; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e5e7eb; border-radius: 2px; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pulse-btn { animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

    <script src="config.js"></script>

    <div class="max-w-7xl mx-auto bg-white rounded-lg shadow-md p-8 border border-gray-200">
        <h1 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
            <span>ğŸ“</span> ê³¼ì œ ì¶œì œ ë° ê´€ë¦¬ (Assignment Manager)
        </h1>
        
        <div class="flex gap-4 mb-8 border-b pb-2">
            <button onclick="location.href='teacher_main.html'" class="text-sm text-gray-500 hover:text-blue-600 font-medium">ğŸ  ëŒ€ì‹œë³´ë“œ í™ˆ</button>
            <span class="text-gray-300">|</span>
            <span class="text-sm font-bold text-blue-600 border-b-2 border-blue-600 pb-2">ê³¼ì œ ìƒì„±</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
            
            <div class="md:col-span-4 flex flex-col gap-4">
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 flex-1">
                    <h2 class="text-sm font-bold mb-3 text-gray-700">Step 1. ëŒ€ìƒ í•™ìƒ ì„ íƒ</h2>
                    <div class="mb-3">
                        <select id="grade-filter" onchange="loadStudents()" class="w-full text-xs border border-gray-300 rounded p-2 bg-white">
                            <option value="all">ì „ì²´ í•™ë…„</option>
                            <option value="ê³ 1">ê³ 1</option><option value="ê³ 2">ê³ 2</option><option value="ê³ 3">ê³ 3</option>
                            <option value="ì¤‘1">ì¤‘1</option><option value="ì¤‘2">ì¤‘2</option><option value="ì¤‘3">ì¤‘3</option>
                        </select>
                    </div>
                    <div id="student-list" class="bg-white border border-gray-300 rounded h-48 overflow-y-auto p-2 text-sm">
                        <div class="text-center py-4"><div class="loader"></div></div>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 flex-1">
                    <h2 class="text-sm font-bold mb-3 text-gray-700">Step 2. êµì¬ ì„ íƒ</h2>
                    <div id="workbook-list" class="bg-white border border-gray-300 rounded h-48 overflow-y-auto p-2 text-sm">
                        <div class="text-center py-4"><div class="loader"></div></div>
                    </div>
                </div>
            </div>

            <div class="md:col-span-8 bg-white border border-gray-300 rounded-lg p-6 relative">
                <h2 class="text-lg font-bold mb-4 text-gray-800 border-b pb-2">Step 3. ê³¼ì œ ë²”ìœ„ ë° ìœ í˜• ì„¤ì •</h2>

                <div class="mb-5">
                    <label class="block text-xs font-bold text-gray-500 mb-1">ê³¼ì œ ì œëª©</label>
                    <input type="text" id="assign-title" placeholder="ì˜ˆ: 12ì›” 10ì¼ ì •ê¸° ê³¼ì œ" class="w-full p-2.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <div id="resolved-question-area" class="hidden mb-5 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="font-bold text-blue-800 text-xs mb-2 flex items-center gap-2">
                        <span>ğŸ“Œ ê¸ˆì¼ ì§€ë„ ì™„ë£Œëœ ë¬¸í•­ (ì²´í¬ ì‹œ ë³µìŠµ ê³¼ì œì— í¬í•¨)</span>
                    </h3>
                    <div id="active-q-list" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-1"></div>
                </div>

                <div class="bg-gray-50 p-4 rounded border border-gray-200 mb-5">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-xs font-bold text-gray-600">ğŸ¯ ì§„ë„ ë²”ìœ„ ì„¤ì •</label>
                        <button onclick="addRangeInput()" class="text-xs bg-gray-600 text-white px-3 py-1.5 rounded hover:bg-gray-700 transition">+ êµ¬ê°„ ì¶”ê°€</button>
                    </div>
                    <div id="range-container" class="space-y-2 max-h-32 overflow-y-auto pr-2">
                        <div class="flex gap-2 items-center range-row">
                            <input type="number" class="range-start w-1/2 p-2 border border-gray-300 rounded text-center text-sm" placeholder="ì‹œì‘ ë²ˆí˜¸" oninput="resetAnalysisState()">
                            <span class="text-gray-400">~</span>
                            <input type="number" class="range-end w-1/2 p-2 border border-gray-300 rounded text-center text-sm" placeholder="ë ë²ˆí˜¸" oninput="resetAnalysisState()">
                            <button onclick="removeRange(this)" class="text-gray-400 hover:text-red-500 font-bold px-2">Ã—</button>
                        </div>
                    </div>
                </div>

                <button id="analyze-btn" onclick="analyzeData()" class="w-full bg-blue-600 text-white py-2.5 rounded-lg mb-4 text-sm font-bold hover:bg-blue-700 shadow-sm transition pulse-btn">
                    ğŸ” êµ¬ê°„ ë°ì´í„° ë¶„ì„ ì‹¤í–‰
                </button>

                <div id="mixing-panel" class="hidden opacity-50 pointer-events-none transition-all duration-300">
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="border border-purple-100 bg-purple-50 rounded p-3">
                            <div class="text-xs font-bold text-purple-700 mb-2">ğŸ† 1ë“±ê¸‰ / Cë‹¨ê³„</div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-600">ì˜¤ë‹µ ë³µìŠµ (ê°€ìš©:<span id="cnt-rev-high">0</span>)</span>
                                <input type="number" id="in-rev-high" class="w-16 text-center border rounded text-xs p-1 bg-white" placeholder="0">
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-600">ì‹ ê·œ (ê°€ìš©:<span id="cnt-new-high">0</span>)</span>
                                <input type="number" id="in-new-high" class="w-16 text-center border rounded text-xs p-1 bg-white" placeholder="0">
                            </div>
                        </div>
                        <div class="border border-green-100 bg-green-50 rounded p-3">
                            <div class="text-xs font-bold text-green-700 mb-2">âœï¸ ì„œìˆ í˜•</div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-600">ì˜¤ë‹µ ë³µìŠµ (ê°€ìš©:<span id="cnt-rev-sub">0</span>)</span>
                                <input type="number" id="in-rev-sub" class="w-16 text-center border rounded text-xs p-1 bg-white" placeholder="0">
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-600">ì‹ ê·œ (ê°€ìš©:<span id="cnt-new-sub">0</span>)</span>
                                <input type="number" id="in-new-sub" class="w-16 text-center border rounded text-xs p-1 bg-white" placeholder="0">
                            </div>
                        </div>
                    </div>

                    <div class="border border-blue-100 bg-blue-50 rounded p-3 mb-6">
                        <div class="flex justify-between mb-3">
                            <div class="text-xs font-bold text-blue-900">ğŸ§© ì¼ë°˜ ìœ í˜• (ëŒ€í‘œ/í„°í”„/ì¼ë°˜)</div>
                            <div class="text-xs text-gray-500">
                                ê°€ìš© ìì›: <span class="text-red-600 font-bold" id="cnt-rev-norm">0</span>(ì˜¤ë‹µ) / <span class="text-blue-600 font-bold" id="cnt-new-norm">0</span>(ì‹ ê·œ)
                            </div>
                        </div>
                        <div class="flex items-center gap-4 mb-2">
                            <span class="text-xs font-bold text-gray-700">ì¶œì œ ë¬¸í•­ ìˆ˜:</span>
                            <input type="number" id="total-norm" value="20" class="w-20 p-1 border rounded text-center text-sm font-bold" oninput="updateSliderUI()">
                        </div>
                        <div class="relative pt-4 pb-1">
                            <input type="range" id="norm-slider" min="0" max="100" value="50" oninput="updateSliderUI()">
                            <div class="flex justify-between text-[10px] font-bold mt-1 text-gray-600">
                                <span>ì˜¤ë‹µ ë¹„ìœ¨ <span id="lbl-rev-norm">50%</span></span>
                                <span>ì§„ë„ ë¹„ìœ¨ <span id="lbl-new-norm">50%</span></span>
                            </div>
                            <div class="text-center text-xs text-gray-500 mt-2 font-medium" id="lbl-norm-detail">(-ë¬¸ + -ë¬¸)</div>
                        </div>
                    </div>

                    <button onclick="previewAssignment()" class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold text-sm shadow hover:bg-gray-900 transition">
                        ğŸ“‘ ì¶œì œ ë‚´ì—­ í™•ì¸ (Preview)
                    </button>
                    
                    <div id="final-confirm-area" class="hidden mt-6 bg-white border-2 border-blue-500 p-5 rounded-lg shadow-lg">
                        <h3 class="text-base font-bold text-center mb-4 border-b pb-2 text-gray-800">ğŸ§¾ ê³¼ì œ ì¶œì œ ìš”ì•½ì„œ</h3>
                        
                        <div id="selected-q-info" class="mb-4 bg-yellow-50 p-2 rounded text-xs text-yellow-800 hidden border border-yellow-200">
                            âœ“ í•„ìˆ˜ í¬í•¨ ì§ˆë¬¸: <span id="sel-q-nums" class="font-bold">-</span>
                        </div>

                        <div class="text-sm space-y-2 mb-6 text-gray-700">
                            <div class="flex justify-between"><span>â€¢ 1ë“±ê¸‰/Cë‹¨ê³„:</span> <span id="rpt-high" class="font-bold">0ë¬¸</span></div>
                            <div class="flex justify-between"><span>â€¢ ì„œìˆ í˜•:</span> <span id="rpt-sub" class="font-bold">0ë¬¸</span></div>
                            <div class="flex justify-between"><span>â€¢ ì¼ë°˜ ìœ í˜•:</span> <span id="rpt-norm" class="font-bold">0ë¬¸</span></div>
                            <div class="border-t border-gray-200 my-2"></div>
                            <div class="flex justify-between text-base font-bold text-blue-700"><span>ì´ ë¬¸í•­ ìˆ˜:</span> <span id="rpt-total">0ë¬¸</span></div>
                            <div class="text-xs text-gray-500 text-right" id="rpt-detail">(ë³µìŠµ 0 + ì‹ ê·œ 0)</div>
                            <div class="text-center mt-3 text-xs text-gray-400 bg-gray-100 p-2 rounded">
                                â€» ë³µìŠµ ë¬¸ì œ(í•„ìˆ˜ ì§ˆë¬¸ + ì˜¤ë‹µ)ëŠ” ì¶œë ¥ ëª©ë¡ì— ìë™ ë¶„ë¥˜ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤.
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="cancelConfirm()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded font-bold text-sm hover:bg-gray-300">ì·¨ì†Œ</button>
                            <button onclick="finalSend()" class="flex-[2] bg-blue-600 text-white py-3 rounded font-bold text-sm hover:bg-blue-700 transition shadow">
                                ğŸš€ ê³¼ì œ ì „ì†¡ í™•ì •
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        let pools = { norm: { rev: [], new: [] }, high: { rev: [], new: [] }, sub:  { rev: [], new: [] } };
        let mandatoryQuestions = []; 
        let finalPayloadCache = null;

        // â˜… í˜„ì¬ ì‚¬ìš©ì í™•ì¸ (í•„ìˆ˜)
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!currentUser) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            location.href = 'index.html';
        }

        async function init() { loadStudents(); loadWorkbooks(); }
        init();

        function addRangeInput() {
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center range-row mt-2';
            div.innerHTML = `<input type="number" class="range-start w-1/2 p-2 border border-gray-300 rounded text-center text-sm" placeholder="ì‹œì‘" oninput="resetAnalysisState()"><span class="text-gray-400">~</span><input type="number" class="range-end w-1/2 p-2 border border-gray-300 rounded text-center text-sm" placeholder="ë" oninput="resetAnalysisState()"><button onclick="removeRange(this)" class="text-gray-400 hover:text-red-500 font-bold px-2">Ã—</button>`;
            document.getElementById('range-container').appendChild(div);
            resetAnalysisState();
        }
        function removeRange(btn) { btn.parentElement.remove(); resetAnalysisState(); }
        function resetAnalysisState() {
            document.getElementById('mixing-panel').classList.add('hidden', 'opacity-50', 'pointer-events-none');
            document.getElementById('final-confirm-area').classList.add('hidden');
            const btn = document.getElementById('analyze-btn');
            btn.innerText = "ğŸ” ë³€ê²½ ê°ì§€! ì¬ë¶„ì„ í•„ìš”";
            btn.classList.remove('bg-green-600'); btn.classList.add('bg-blue-600', 'pulse-btn');
        }

        async function loadStudents() {
            const filter = document.getElementById('grade-filter').value;
            let query = _supabase.from('users').select('*').eq('role', 'student');
            if(filter !== 'all') query = query.eq('grade', filter);
            const { data } = await query;
            const container = document.getElementById('student-list');
            if(!data || data.length === 0) { container.innerHTML = '<p class="text-gray-400 text-center py-4">í•™ìƒ ë°ì´í„° ì—†ìŒ</p>'; return; }
            container.innerHTML = data.map(s => `<label class="flex items-center gap-2 p-2 hover:bg-gray-50 border-b cursor-pointer"><input type="checkbox" name="target-student" value="${s.username}" class="accent-blue-600" onchange="checkResolvedQuestions()"><div class="text-xs font-bold text-gray-700">${s.name} <span class="text-gray-400 font-normal">(${s.grade})</span></div></label>`).join('');
        }

        async function loadWorkbooks() {
            const { data } = await _supabase.from('workbooks').select('*').order('created_at', {ascending: false});
            const container = document.getElementById('workbook-list');
            if(!data || data.length === 0) { container.innerHTML = '<p class="text-gray-400 text-center py-4">ë“±ë¡ëœ êµì¬ ì—†ìŒ</p>'; return; }
            container.innerHTML = data.map(wb => `<label class="flex items-center gap-2 p-2 hover:bg-gray-50 border-b cursor-pointer"><input type="radio" name="target-workbook" value="${wb.id}" class="accent-purple-600" onchange="checkResolvedQuestions()"><div class="text-xs font-bold text-gray-700">${wb.title}</div></label>`).join('');
        }

        async function checkResolvedQuestions() {
            const studentIds = Array.from(document.querySelectorAll('input[name="target-student"]:checked')).map(cb => cb.value);
            const wbRadio = document.querySelector('input[name="target-workbook"]:checked');
            const area = document.getElementById('resolved-question-area');
            const list = document.getElementById('active-q-list');

            if(studentIds.length === 0 || !wbRadio) { area.classList.add('hidden'); return; }
            const wbId = wbRadio.value;
            const today = new Date().toISOString().split('T')[0];

            const { data } = await _supabase
                .from('student_progress')
                .select('problem_num')
                .in('student_id', studentIds)
                .eq('workbook_id', wbId)
                .gte('resolved_at', today + ' 00:00:00'); 

            if(!data || data.length === 0) { area.classList.add('hidden'); return; }

            const qNums = [...new Set(data.map(d => d.problem_num))].sort((a,b)=>a-b);
            list.innerHTML = qNums.map(n => `<label class="flex items-center gap-1 bg-white border border-blue-300 px-2 py-1 rounded cursor-pointer hover:bg-blue-50 shadow-sm"><input type="checkbox" name="active-q" value="${n}" class="accent-blue-600"><span class="text-xs font-bold text-gray-800">${n}ë²ˆ</span></label>`).join('');
            area.classList.remove('hidden');
        }

        async function analyzeData() {
            const studentIds = Array.from(document.querySelectorAll('input[name="target-student"]:checked')).map(cb => cb.value);
            const wbRadio = document.querySelector('input[name="target-workbook"]:checked');
            if(studentIds.length === 0 || !wbRadio) return alert("í•™ìƒê³¼ êµì¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            const wbId = wbRadio.value;
            
            let ranges = [];
            document.querySelectorAll('.range-row').forEach(row => {
                const s = parseInt(row.querySelector('.range-start').value);
                const e = parseInt(row.querySelector('.range-end').value);
                if(!isNaN(s) && !isNaN(e) && s <= e) ranges.push({start:s, end:e});
            });
            if(ranges.length === 0) return alert("ì¶œì œ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            mandatoryQuestions = Array.from(document.querySelectorAll('input[name="active-q"]:checked')).map(cb => parseInt(cb.value));

            const btn = document.getElementById('analyze-btn');
            btn.innerText = "ë°ì´í„° ë¶„ì„ ì¤‘..."; btn.disabled = true;

            try {
                const minStart = Math.min(...ranges.map(r=>r.start));
                const maxEnd = Math.max(...ranges.map(r=>r.end));

                const { data: metaData } = await _supabase.from('problem_metadata').select('problem_num, difficulty, is_subjective').eq('workbook_id', wbId).gte('problem_num', minStart).lte('problem_num', maxEnd);
                let metaMap = {};
                if(metaData) metaData.forEach(m => metaMap[m.problem_num] = m);

                const targetStudent = studentIds[0];
                const { data: progressData } = await _supabase.from('student_progress').select('problem_num, last_result').eq('student_id', targetStudent).eq('workbook_id', wbId).gte('problem_num', minStart).lte('problem_num', maxEnd);

                let wrongMap = {}; 
                if(progressData) progressData.forEach(p => { 
                    if(p.last_result === 'wrong') wrongMap[p.problem_num] = true;
                });

                pools = { norm: { rev: [], new: [] }, high: { rev: [], new: [] }, sub: { rev: [], new: [] } };

                ranges.forEach(range => {
                    for(let i=range.start; i<=range.end; i++) {
                        const meta = metaMap[i];
                        if(!meta) continue; 

                        if (mandatoryQuestions.includes(i)) continue;

                        let status = null;
                        if (wrongMap[i]) status = 'rev'; // ì˜¤ë‹µì´ë©´ ë³µìŠµ í’€
                        else if (!progressData.find(p => p.problem_num === i)) status = 'new'; // ê¸°ë¡ ì—†ìœ¼ë©´ ì‹ ê·œ í’€

                        if (status) {
                            if(meta.difficulty === 'high_rank') pools.high[status].push(i);
                            else if (meta.is_subjective) pools.sub[status].push(i);
                            else pools.norm[status].push(i);
                        }
                    }
                });

                document.getElementById('cnt-rev-high').innerText = pools.high.rev.length;
                document.getElementById('cnt-new-high').innerText = pools.high.new.length;
                document.getElementById('cnt-rev-sub').innerText = pools.sub.rev.length;
                document.getElementById('cnt-new-sub').innerText = pools.sub.new.length;
                document.getElementById('cnt-rev-norm').innerText = pools.norm.rev.length;
                document.getElementById('cnt-new-norm').innerText = pools.norm.new.length;

                document.getElementById('mixing-panel').classList.remove('hidden', 'opacity-50', 'pointer-events-none');
                updateSliderUI();
                
                btn.innerText = "âœ… ë¶„ì„ ì™„ë£Œ (ì„¤ì • ë³€ê²½ ì‹œ ì¬ë¶„ì„ í•„ìš”)";
                btn.classList.remove('bg-blue-600', 'pulse-btn'); btn.classList.add('bg-green-600');
                btn.disabled = false;

            } catch(e) { alert("ë¶„ì„ ì˜¤ë¥˜: " + e.message); btn.innerText = "ğŸ” ì¬ì‹œë„"; btn.disabled = false; }
        }

        function updateSliderUI() {
            const total = parseInt(document.getElementById('total-norm').value) || 0;
            const ratio = parseInt(document.getElementById('norm-slider').value);
            const cntNew = Math.round(total * (ratio / 100));
            const cntRev = total - cntNew;
            document.getElementById('lbl-rev-norm').innerText = (100-ratio) + "%";
            document.getElementById('lbl-new-norm').innerText = ratio + "%";
            document.getElementById('lbl-norm-detail').innerHTML = `ë³µìŠµ <b class="text-red-600">${cntRev}</b> + ì‹ ê·œ <b class="text-blue-600">${cntNew}</b>`;
        }

        function previewAssignment() {
            const reqHighRev = parseInt(document.getElementById('in-rev-high').value) || 0;
            const reqHighNew = parseInt(document.getElementById('in-new-high').value) || 0;
            const reqSubRev = parseInt(document.getElementById('in-rev-sub').value) || 0;
            const reqSubNew = parseInt(document.getElementById('in-new-sub').value) || 0;
            const totalNorm = parseInt(document.getElementById('total-norm').value) || 0;
            const ratio = parseInt(document.getElementById('norm-slider').value);
            const reqNormNew = Math.round(totalNorm * (ratio / 100));
            const reqNormRev = totalNorm - reqNormNew;

            let mandNorm = [], mandHigh = [], mandSub = [];
            mandatoryQuestions.forEach(q => {
                if(pools.high.rev.includes(q) || pools.high.new.includes(q)) mandHigh.push(q);
                else if(pools.sub.rev.includes(q) || pools.sub.new.includes(q)) mandSub.push(q);
                else mandNorm.push(q);
            });

            function pickWithMandatory(pool, mandatory, count) {
                let available = pool.filter(n => !mandatory.includes(n));
                for (let i = available.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [available[i], available[j]] = [available[j], available[i]]; }
                const needMore = Math.max(0, count - mandatory.length);
                return [...mandatory, ...available.slice(0, needMore)];
            }
            function pickSimple(pool, count) { return pool.slice(0, count); }

            let reviewList = [];
            reviewList.push(...pickWithMandatory(pools.high.rev, mandHigh, reqHighRev));
            reviewList.push(...pickWithMandatory(pools.sub.rev, mandSub, reqSubRev));
            reviewList.push(...pickWithMandatory(pools.norm.rev, mandNorm, reqNormRev));
            
            let newList = [];
            newList.push(...pickSimple(pools.high.new, reqHighNew));
            newList.push(...pickSimple(pools.sub.new, reqSubNew));
            newList.push(...pickSimple(pools.norm.new, reqNormNew));

            let fullList = [...reviewList, ...newList].sort((a,b) => a-b);
            reviewList.sort((a,b) => a-b);

            const totalQ = fullList.length;
            if(totalQ === 0) return alert("ì¶œì œí•  ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.");

            document.getElementById('rpt-high').innerText = `${reqHighRev + reqHighNew}ë¬¸`;
            document.getElementById('rpt-sub').innerText = `${reqSubRev + reqSubNew}ë¬¸`;
            document.getElementById('rpt-norm').innerText = `${reqNormRev + reqNormNew}ë¬¸`;
            document.getElementById('rpt-total').innerText = `${totalQ}ë¬¸í•­`;
            document.getElementById('rpt-detail').innerText = `(ë³µìŠµ ${reviewList.length} + ì‹ ê·œ ${newList.length})`;
            
            const qInfo = document.getElementById('selected-q-info');
            const qNums = document.getElementById('sel-q-nums');
            if(mandatoryQuestions.length > 0) {
                qInfo.classList.remove('hidden');
                qNums.innerText = mandatoryQuestions.join(', ') + "ë²ˆ";
            } else { qInfo.classList.add('hidden'); }

            const studentIds = Array.from(document.querySelectorAll('input[name="target-student"]:checked')).map(cb => cb.value);
            const wbId = document.querySelector('input[name="target-workbook"]:checked').value;
            const title = document.getElementById('assign-title').value;

            // â˜… [ë³´ì•ˆ íŒ¨ì¹˜] teacher_id ë¶ˆí•„ìš” (í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ì²˜ë¦¬í•˜ê±°ë‚˜ ì„¸ì…˜ ì‚¬ìš©)
            finalPayloadCache = studentIds.map(sId => ({
                student_id: sId, 
                workbook_id: parseInt(wbId), 
                title: title, 
                problem_list: fullList, 
                // review_list: reviewList, // í…Œì´ë¸” êµ¬ì¡°ìƒ review_list ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸ í•„ìš” (ì—†ìœ¼ë©´ ì œê±°)
                // ë‚˜ë¨¸ì§€ëŠ” RPCì—ì„œ ì²˜ë¦¬
            }));

            document.getElementById('final-confirm-area').classList.remove('hidden');
            document.getElementById('final-confirm-area').scrollIntoView({behavior: 'smooth'});
        }

        function cancelConfirm() { document.getElementById('final-confirm-area').classList.add('hidden'); }

        // â˜… [ë³´ì•ˆ íŒ¨ì¹˜ ì™„ë£Œ] RPC í•¨ìˆ˜ í˜¸ì¶œë¡œ ë³€ê²½ â˜…
        async function finalSend() {
            if(!finalPayloadCache) return alert("ë°ì´í„° ì˜¤ë¥˜");
            const btn = document.querySelector('button[onclick="finalSend()"]');
            btn.innerText = "ì „ì†¡ ì¤‘..."; btn.disabled = true;
            
            try {
                // ì—¬ëŸ¬ ê±´ì˜ ìˆ™ì œ ì „ì†¡ì„ ë³‘ë ¬ë¡œ ì²˜ë¦¬
                const promises = finalPayloadCache.map(payload => 
                    _supabase.rpc('create_assignment_teacher', {
                        p_student_id: payload.student_id,
                        p_workbook_id: payload.workbook_id,
                        p_title: payload.title,
                        p_problem_list: payload.problem_list,
                        p_deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7ì¼ í›„
                        p_is_special: false, // ê¸°ë³¸ê°’ false
                        p_reward_points: 20 // ê¸°ë³¸ ë³´ìƒ í¬ì¸íŠ¸ (í•„ìš”ì‹œ UI ì¶”ê°€)
                    })
                );

                const results = await Promise.all(promises);
                
                // ì—ëŸ¬ ì²´í¬
                results.forEach(res => { if(res.error) throw res.error; });

                // ì™„ë£Œ í™”ë©´
                const confirmArea = document.getElementById('final-confirm-area');
                confirmArea.innerHTML = `
                    <div class="text-center py-6">
                        <div class="text-4xl mb-2">ğŸ‰</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">ìˆ™ì œ ì „ì†¡ ì™„ë£Œ!</h3>
                        <p class="text-sm text-gray-500 mb-6">í•™ìƒë“¤ì—ê²Œ ì•Œë¦¼ì´ ê°”ì–´ìš”. ë³µìŠµ í”„ë¦°íŠ¸ë¥¼ ë½‘ìœ¼ì‹œê² ì–´ìš”?</p>
                        
                        <div class="flex gap-2 justify-center">
                            <button onclick="location.reload()" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300">
                                ì²˜ìŒìœ¼ë¡œ
                            </button>
                            <button onclick="alert('ìˆ™ì œ ëª©ë¡ í˜ì´ì§€ì—ì„œ ì¸ì‡„í•´ì£¼ì„¸ìš”.')" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 shadow-lg flex items-center gap-2">
                                <span>ğŸ–¨ï¸</span> í™•ì¸
                            </button>
                        </div>
                    </div>
                `;
            } catch(e) { 
                alert("ì „ì†¡ ì‹¤íŒ¨: " + e.message); 
                btn.innerText = "ğŸš€ ê³¼ì œ ì „ì†¡ í™•ì •"; btn.disabled = false; 
            }
        }
    </script>
</body>
</html>