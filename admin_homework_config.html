<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <link rel="manifest" href="site.webmanifest">
    
    <link rel="apple-touch-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <title>í•™ìŠµ ìë™í™” ì„¤ì •</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background: #f8fafc; color: #334155; }
        
        /* ìŠ¬ë¼ì´ë” (ì •ìˆ™í•œ ë¸”ë£¨) */
        .slider { -webkit-appearance: none; width: 100%; height: 6px; background: #cbd5e1; border-radius: 5px; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #4f46e5; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .slider::-webkit-slider-thumb:hover { transform: scale(1.1); }

        /* íŒ¨ë„ ìŠ¤íƒ€ì¼ (ê¹”ë”í•œ ì¹´ë“œ) */
        .panel { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        /* ì…ë ¥ì¹¸ */
        .inp-num { background: #f1f5f9; border: 1px solid #cbd5e1; color: #334155; text-align: center; border-radius: 4px; padding: 2px; width: 50px; font-weight: bold; font-size: 12px; }
        .inp-num:focus { border-color: #4f46e5; outline: none; bg: white; }

        /* ìŠ¤í¬ë¡¤ë°” */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="p-6 h-screen flex flex-col overflow-hidden">

    <script src="config.js"></script>

    <div class="flex justify-between items-end border-b border-slate-200 pb-4 shrink-0 mb-4">
        <div>
            <div class="text-xs font-bold text-indigo-600 uppercase tracking-wide mb-1">Configuration</div>
            <h1 class="text-2xl font-bold text-slate-800">âš™ï¸ í•™ìŠµ ìë™í™” ë° ì¶œì œ ì˜µì…˜</h1>
            <p class="text-slate-500 text-xs mt-1"><span id="target-info" class="font-bold text-indigo-700">í•™ìƒ</span> ë§ì¶¤í˜• í•™ìŠµ ë¡œì§ ì„¤ì •</p>
        </div>
        <button onclick="window.close()" class="text-slate-400 hover:text-slate-600 text-sm font-medium">ë‹«ê¸°</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1 overflow-hidden">
        
        <div class="flex flex-col h-full overflow-y-auto custom-scroll pr-2">
            <h2 class="text-sm font-bold text-slate-700 border-b border-slate-200 pb-2 mb-3 sticky top-0 bg-[#f8fafc] z-10 flex items-center gap-2">
                <span>ğŸ“‚</span> ìë™ ì¶œì œ ë¬¸í•­ ìˆ˜ ë° ë¹„ìœ¨
            </h2>
            
            <div class="panel border-l-4 border-indigo-500">
                <div class="flex justify-between mb-2"><span class="font-bold text-indigo-700 text-sm">ğŸ† 1ë“±ê¸‰ (High Rank)</span><div class="text-xs text-slate-500">ë¬¸í•­ ìˆ˜ <input type="number" id="cnt-high" class="inp-num" value="3" oninput="calcAll()"></div></div>
                <input type="range" id="ratio-high" class="slider" min="0" max="100" value="50" oninput="calcAll()">
                <div class="text-center text-[11px] mt-2 text-slate-500 flex justify-between">
                    <span>ğŸ”„ ë³µìŠµ <b id="res-high-rev" class="text-indigo-600">0</b></span>
                    <span id="lbl-ratio-high" class="font-bold text-slate-400">50%</span>
                    <span>ğŸ†• ì‹ ê·œ <b id="res-high-new" class="text-blue-500">0</b></span>
                </div>
            </div>
            <div class="panel border-l-4 border-emerald-500">
                <div class="flex justify-between mb-2"><span class="font-bold text-emerald-700 text-sm">âœï¸ ì„œìˆ í˜• (Subjective)</span><div class="text-xs text-slate-500">ë¬¸í•­ ìˆ˜ <input type="number" id="cnt-sub" class="inp-num" value="2" oninput="calcAll()"></div></div>
                <input type="range" id="ratio-sub" class="slider" min="0" max="100" value="50" oninput="calcAll()">
                <div class="text-center text-[11px] mt-2 text-slate-500 flex justify-between">
                    <span>ğŸ”„ ë³µìŠµ <b id="res-sub-rev" class="text-emerald-600">0</b></span>
                    <span id="lbl-ratio-sub" class="font-bold text-slate-400">50%</span>
                    <span>ğŸ†• ì‹ ê·œ <b id="res-sub-new" class="text-blue-500">0</b></span>
                </div>
            </div>
            <div class="panel border-l-4 border-slate-500">
                <div class="flex justify-between mb-2"><span class="font-bold text-slate-700 text-sm">ğŸ§© ì¼ë°˜í˜• (Normal)</span><div class="text-xs text-slate-500">ë¬¸í•­ ìˆ˜ <input type="number" id="cnt-norm" class="inp-num" value="15" oninput="calcAll()"></div></div>
                <input type="range" id="ratio-norm" class="slider" min="0" max="100" value="50" oninput="calcAll()">
                <div class="text-center text-[11px] mt-2 text-slate-500 flex justify-between">
                    <span>ğŸ”„ ë³µìŠµ <b id="res-norm-rev" class="text-slate-600">0</b></span>
                    <span id="lbl-ratio-norm" class="font-bold text-slate-400">50%</span>
                    <span>ğŸ†• ì‹ ê·œ <b id="res-norm-new" class="text-blue-500">0</b></span>
                </div>
            </div>
        </div>

        <div class="flex flex-col h-full overflow-y-auto custom-scroll pr-2">
            <h2 class="text-sm font-bold text-amber-600 border-b border-slate-200 pb-2 mb-3 sticky top-0 bg-[#f8fafc] z-10 flex items-center gap-2">
                <span>ğŸ</span> ì˜¤ë‹µ ì¸ì¦(ê¸°íŠ¹ë†€ì´) ìê²© ê¸°ì¤€
            </h2>
            <p class="text-[10px] text-slate-400 mb-2 pl-1">* ê° ìœ í˜•ë³„ë¡œ <strong>í•˜ë‚˜ ì´ìƒì˜ ì¡°ê±´(OR)</strong>ì„ ì¶©ì¡±í•´ì•¼ ì¸ì¦ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

            <div class="panel border-l-4 border-indigo-500">
                <div class="flex items-center gap-2 mb-3 border-b border-slate-100 pb-2">
                    <input type="checkbox" id="gh-active" class="w-4 h-4 accent-indigo-600" checked>
                    <span class="font-bold text-indigo-700 text-sm">ğŸ† 1ë“±ê¸‰ ì¡°ê±´</span>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-xs text-slate-600 items-center"><span>ğŸ¤¬ ëˆ„ì  ì˜¤ë‹µ íšŸìˆ˜</span><div><input type="number" id="gh-wrong" class="inp-num" value="1"> íšŒ ì´ìƒ</div></div>
                    <div class="flex justify-between text-xs text-slate-600 items-center"><span>ğŸ™‹â€â™‚ï¸ ëˆ„ì  ì§ˆë¬¸ íšŸìˆ˜</span><div><input type="number" id="gh-quest" class="inp-num" value="1"> íšŒ ì´ìƒ</div></div>
                    <div class="flex justify-between text-xs text-slate-600 items-center">
                        <span>ğŸ“‰ ì •ë‹µë¥  í•˜í•œ</span>
                        <div class="flex items-center gap-1">
                            <span class="text-[9px] text-slate-400">(ì‹œë„ <input type="number" id="gh-try" class="inp-num w-6 h-5 text-[9px] bg-white" value="1">â†‘)</span>
                            <input type="number" id="gh-acc" class="inp-num" value="100"> % ì´í•˜
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel border-l-4 border-emerald-500">
                <div class="flex items-center gap-2 mb-3 border-b border-slate-100 pb-2">
                    <input type="checkbox" id="gs-active" class="w-4 h-4 accent-emerald-600" checked>
                    <span class="font-bold text-emerald-700 text-sm">âœï¸ ì„œìˆ í˜• ì¡°ê±´</span>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-xs text-slate-600 items-center"><span>ğŸ¤¬ ëˆ„ì  ì˜¤ë‹µ íšŸìˆ˜</span><div><input type="number" id="gs-wrong" class="inp-num" value="1"> íšŒ ì´ìƒ</div></div>
                    <div class="flex justify-between text-xs text-slate-600 items-center"><span>ğŸ™‹â€â™‚ï¸ ëˆ„ì  ì§ˆë¬¸ íšŸìˆ˜</span><div><input type="number" id="gs-quest" class="inp-num" value="1"> íšŒ ì´ìƒ</div></div>
                    <div class="flex justify-between text-xs text-slate-600 items-center">
                        <span>ğŸ“‰ ì •ë‹µë¥  í•˜í•œ</span>
                        <div class="flex items-center gap-1">
                            <span class="text-[9px] text-slate-400">(ì‹œë„ <input type="number" id="gs-try" class="inp-num w-6 h-5 text-[9px] bg-white" value="1">â†‘)</span>
                            <input type="number" id="gs-acc" class="inp-num" value="100"> % ì´í•˜
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel border-l-4 border-slate-500">
                <div class="flex items-center gap-2 mb-3 border-b border-slate-100 pb-2">
                    <input type="checkbox" id="gn-active" class="w-4 h-4 accent-slate-600" checked>
                    <span class="font-bold text-slate-700 text-sm">ğŸ§© ì¼ë°˜í˜• ì¡°ê±´ (ì—„ê²©)</span>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-xs text-slate-600 items-center"><span>ğŸ¤¬ ëˆ„ì  ì˜¤ë‹µ íšŸìˆ˜</span><div><input type="number" id="gn-wrong" class="inp-num" value="2"> íšŒ ì´ìƒ</div></div>
                    <div class="flex justify-between text-xs text-slate-600 items-center"><span>ğŸ™‹â€â™‚ï¸ ëˆ„ì  ì§ˆë¬¸ íšŸìˆ˜</span><div><input type="number" id="gn-quest" class="inp-num" value="1"> íšŒ ì´ìƒ</div></div>
                    <div class="flex justify-between text-xs text-slate-600 items-center">
                        <span>ğŸ“‰ ì •ë‹µë¥  í•˜í•œ</span>
                        <div class="flex items-center gap-1">
                            <span class="text-[9px] text-slate-400">(ì‹œë„ <input type="number" id="gn-try" class="inp-num w-6 h-5 text-[9px] bg-white" value="2">â†‘)</span>
                            <input type="number" id="gn-acc" class="inp-num" value="80"> % ì´í•˜
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <button onclick="saveConfig()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3.5 rounded-lg text-sm shadow-lg transition transform active:scale-[0.98] mt-4 shrink-0 flex justify-center items-center gap-2">
        <span>ğŸ’¾</span> ì„¤ì • ì €ì¥ ë° ì ìš© (Apply)
    </button>

    <script>
        const params = new URLSearchParams(window.location.search);
        const sId = params.get('sid');
        const wbId = params.get('wbid');
        const wbTitle = decodeURIComponent(params.get('title') || 'ë¬¸ì œì§‘');
        const sName = decodeURIComponent(params.get('name') || 'í•™ìƒ');

        if(!sId || !wbId) { alert("ì˜ëª»ëœ ì ‘ê·¼"); window.close(); }
        document.getElementById('target-info').innerText = `${sName} - [${wbTitle}]`;

        async function load() {
            const { data } = await _supabase.from('homework_configs').select('*').eq('student_id', sId).eq('workbook_id', wbId).single();
            if(data) {
                document.getElementById('cnt-high').value = data.cnt_high; document.getElementById('ratio-high').value = data.ratio_high;
                document.getElementById('cnt-sub').value = data.cnt_sub; document.getElementById('ratio-sub').value = data.ratio_sub;
                document.getElementById('cnt-norm').value = data.cnt_norm; document.getElementById('ratio-norm').value = data.ratio_norm;
                
                document.getElementById('gh-active').checked = data.gh_active; document.getElementById('gh-wrong').value = data.gh_wrong; document.getElementById('gh-quest').value = data.gh_quest; document.getElementById('gh-acc').value = data.gh_acc; document.getElementById('gh-try').value = data.gh_try;
                document.getElementById('gs-active').checked = data.gs_active; document.getElementById('gs-wrong').value = data.gs_wrong; document.getElementById('gs-quest').value = data.gs_quest; document.getElementById('gs-acc').value = data.gs_acc; document.getElementById('gs-try').value = data.gs_try;
                document.getElementById('gn-active').checked = data.gn_active; document.getElementById('gn-wrong').value = data.gn_wrong; document.getElementById('gn-quest').value = data.gn_quest; document.getElementById('gn-acc').value = data.gn_acc; document.getElementById('gn-try').value = data.gn_try;
            }
            calcAll();
        }

        function calcAll() { calc('high'); calc('sub'); calc('norm'); }
        function calc(type) {
            const cnt = parseInt(document.getElementById(`cnt-${type}`).value) || 0;
            const ratio = parseInt(document.getElementById(`ratio-${type}`).value);
            const rev = Math.round(cnt * (ratio / 100)); const fresh = cnt - rev;
            document.getElementById(`lbl-ratio-${type}`).innerText = `${ratio}%`;
            document.getElementById(`res-${type}-rev`).innerText = rev; document.getElementById(`res-${type}-new`).innerText = fresh;
        }

        async function saveConfig() {
            const payload = {
                student_id: sId, workbook_id: parseInt(wbId),
                cnt_high: parseInt(document.getElementById('cnt-high').value), ratio_high: parseInt(document.getElementById('ratio-high').value),
                cnt_sub: parseInt(document.getElementById('cnt-sub').value), ratio_sub: parseInt(document.getElementById('ratio-sub').value),
                cnt_norm: parseInt(document.getElementById('cnt-norm').value), ratio_norm: parseInt(document.getElementById('ratio-norm').value),
                gh_active: document.getElementById('gh-active').checked, gh_wrong: parseInt(document.getElementById('gh-wrong').value), gh_quest: parseInt(document.getElementById('gh-quest').value), gh_acc: parseInt(document.getElementById('gh-acc').value), gh_try: parseInt(document.getElementById('gh-try').value),
                gs_active: document.getElementById('gs-active').checked, gs_wrong: parseInt(document.getElementById('gs-wrong').value), gs_quest: parseInt(document.getElementById('gs-quest').value), gs_acc: parseInt(document.getElementById('gs-acc').value), gs_try: parseInt(document.getElementById('gs-try').value),
                gn_active: document.getElementById('gn-active').checked, gn_wrong: parseInt(document.getElementById('gn-wrong').value), gn_quest: parseInt(document.getElementById('gn-quest').value), gn_acc: parseInt(document.getElementById('gn-acc').value), gn_try: parseInt(document.getElementById('gn-try').value),
                updated_at: new Date()
            };
            const { error } = await _supabase.from('homework_configs').upsert(payload, { onConflict: 'student_id, workbook_id' });
            if(error) alert("ì €ì¥ ì‹¤íŒ¨: " + error.message); else { alert("âœ… ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); window.close(); }
        }
        load();
    </script>
</body>
</html>