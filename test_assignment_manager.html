<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>진단평가 배정 및 관리 - Elite Secretary v4.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="config.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Noto+Sans+KR:wght@300;400;700&display=swap');

        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Tabs */
        .tab-btn {
            padding: 16px 24px;
            font-weight: 700;
            color: #64748b;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #cbd5e1;
            background: rgba(255, 255, 255, 0.02);
        }

        .tab-btn.active {
            color: #818cf8;
            border-bottom-color: #818cf8;
            background: rgba(129, 140, 248, 0.05);
        }

        /* Glass Panel */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        /* Scrollbar */
        .pro-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .pro-scroll::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        .pro-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        /* List Items */
        .list-item {
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.02);
        }

        .list-item:hover {
            background: rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .list-item.selected {
            background: rgba(99, 102, 241, 0.2);
            border-color: #6366f1;
        }

        /* Buttons */
        .diff-btn {
            background: #1e293b;
            border: 1px solid #334155;
            color: #94a3b8;
            transition: 0.2s;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .diff-btn:hover {
            background: #334155;
            color: white;
        }

        .diff-btn.active {
            background: #4f46e5;
            border-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #4338ca);
            color: white;
            font-weight: 700;
            transition: 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        /* Round Card (Management) */
        .round-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.3s;
        }

        .round-card.locked {
            opacity: 0.3;
            pointer-events: none;
            filter: grayscale(1);
            background: #0f172a;
            border-style: dashed;
        }

        .round-card.completed {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }

        .round-card.active {
            border-color: #6366f1;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.1);
            background: rgba(99, 102, 241, 0.05);
        }
    </style>
</head>

<body>

    <div
        class="h-16 bg-slate-900/90 border-b border-slate-700 flex items-center px-8 justify-between shrink-0 backdrop-blur-sm z-50">
        <div class="flex gap-6">
            <div class="tab-btn active" onclick="setTab('assign')" id="btn-tab-assign">
                <i class="fa-solid fa-paper-plane mr-2"></i>시험지 배정
            </div>
            <div class="tab-btn" onclick="setTab('manage')" id="btn-tab-manage">
                <i class="fa-solid fa-list-check mr-2"></i>진도 관리
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div
                class="text-[10px] text-slate-500 font-mono tracking-widest uppercase bg-slate-800 px-3 py-1 rounded-full">
                System Ready (Fixed)
            </div>
        </div>
    </div>

    <div class="flex-1 p-6 overflow-hidden relative">

        <div id="view-assign" class="flex gap-6 h-full transition-opacity duration-300">
            <div class="w-1/3 glass-panel p-5">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-xs font-bold text-slate-400 uppercase">1. Target</span>
                    <span id="assign-cnt"
                        class="text-xs text-indigo-400 font-bold bg-indigo-500/10 px-2 py-0.5 rounded">0명 선택</span>
                </div>
                <select id="sel-class-assign" onchange="loadStudents('assign', this.value)"
                    class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-white mb-4 outline-none">
                    <option value="">반 선택 (Class)...</option>
                </select>
                <div class="flex-1 border border-slate-700/50 rounded-xl bg-slate-900/30 overflow-hidden relative">
                    <div id="list-stu-assign" class="absolute inset-0 pro-scroll overflow-y-auto p-2 space-y-1">
                        <div class="text-center text-xs text-slate-600 py-10">반을 선택해주세요.</div>
                    </div>
                </div>
                <div class="mt-3 px-1">
                    <label class="flex items-center gap-2 text-xs text-slate-400 cursor-pointer hover:text-white">
                        <input type="checkbox" onclick="toggleAllAssign(this)" class="accent-indigo-500"> 전체 선택
                    </label>
                </div>
            </div>

            <div class="w-1/3 glass-panel p-5">
                <div class="text-xs font-bold text-slate-400 uppercase mb-4">2. Workbook (Skeleton)</div>
                <div class="flex flex-col gap-2 mb-4">
                    <select id="sel-cat-assign" onchange="loadWorkbooks(this.value)"
                        class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-white outline-none">
                        <option value="">대분류 (Category)...</option>
                    </select>
                </div>
                <div class="flex-1 border border-slate-700/50 rounded-xl bg-slate-900/30 overflow-hidden relative">
                    <div id="list-workbook-assign" class="absolute inset-0 pro-scroll overflow-y-auto p-2 space-y-1">
                        <div class="text-center text-xs text-slate-600 py-10">카테고리를 선택하세요.</div>
                    </div>
                </div>
            </div>

            <div class="w-1/3 glass-panel p-5 border-l-4 border-indigo-500 relative">
                <div class="text-xs font-bold text-slate-400 uppercase mb-6">3. Difficulty & Execute</div>

                <div class="mb-8">
                    <label class="block text-xs font-bold text-slate-300 mb-3">난이도 (Difficulty)</label>
                    <div class="grid grid-cols-5 gap-2">
                        <button onclick="setDiff('하', this)" class="diff-btn py-3 rounded-lg">하</button>
                        <button onclick="setDiff('중하', this)" class="diff-btn py-3 rounded-lg">중하</button>
                        <button onclick="setDiff('중', this)" class="diff-btn py-3 rounded-lg">중</button>
                        <button onclick="setDiff('중상', this)" class="diff-btn py-3 rounded-lg">중상</button>
                        <button onclick="setDiff('상', this)" class="diff-btn py-3 rounded-lg">상</button>
                    </div>
                    <input type="hidden" id="val-diff">
                </div>

                <div class="bg-slate-800/80 rounded-xl p-5 space-y-3 mb-6 border border-slate-700">
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">선택 교재</span>
                        <span id="summ-wb" class="text-white font-bold truncate max-w-[140px] text-right">-</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">총 회차</span>
                        <span id="summ-rounds" class="text-emerald-400 font-bold">-</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">설정 난이도</span>
                        <span id="summ-diff" class="text-indigo-400 font-bold">-</span>
                    </div>
                </div>

                <button onclick="runAssign()"
                    class="w-full py-4 btn-primary rounded-xl shadow-lg flex items-center justify-center gap-2 text-sm mt-auto">
                    <i class="fa-solid fa-bolt"></i> 배정 실행 (Confirm)
                </button>
            </div>
        </div>

        <div id="view-manage" class="hidden gap-6 h-full">
            <div class="w-1/4 glass-panel p-5">
                <div class="text-xs font-bold text-slate-400 uppercase mb-4">Select Student</div>
                <select id="sel-class-manage" onchange="loadStudents('manage', this.value)"
                    class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-white mb-4 outline-none">
                    <option value="">반 선택...</option>
                </select>
                <div class="flex-1 border border-slate-700/50 rounded-xl bg-slate-900/30 overflow-hidden relative">
                    <div id="list-stu-manage" class="absolute inset-0 pro-scroll overflow-y-auto p-2 space-y-1">
                        <div class="text-center text-xs text-slate-600 py-10">반을 선택해주세요.</div>
                    </div>
                </div>
            </div>

            <div class="w-3/4 glass-panel p-6 bg-slate-900/80">
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-700">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-chart-line text-emerald-400"></i> 진도 관리 대시보드
                    </h2>
                    <div id="dash-info" class="hidden flex items-center gap-3">
                        <span id="dash-title"
                            class="text-white font-bold text-sm bg-slate-800 px-3 py-1 rounded-lg border border-slate-700"></span>
                        <span id="dash-diff"
                            class="text-indigo-400 font-bold text-xs bg-indigo-900/30 px-2 py-1 rounded border border-indigo-500/30"></span>
                        <button onclick="doAction('delete')"
                            class="ml-4 text-xs text-red-500 hover:text-red-400 underline">
                            <i class="fa-solid fa-trash"></i> 배정 취소
                        </button>
                    </div>
                </div>

                <div id="dash-board" class="flex-1 pro-scroll overflow-y-auto pr-2">
                    <div class="h-full flex flex-col items-center justify-center text-slate-500 opacity-60">
                        <i class="fa-regular fa-folder-open text-5xl mb-4"></i>
                        <p class="text-sm">학생을 선택하면 진행 중인 교재가 표시됩니다.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        /**
         * [Elite Secretary Logic - Daughter #4 Fixed]
         * - Robust data fetching for dashboard.
         * - Prevents crashes on duplicate data.
         * - Shows data even if status is not 'in_progress'.
         */

        let assignData = { students: new Set(), wbId: null, wbTitle: null, roundCount: 0 };
        let manageData = { currentRecId: null };

        document.addEventListener('DOMContentLoaded', () => {
            const check = setInterval(() => { if (typeof _supabase !== 'undefined') { clearInterval(check); initApp(); } }, 100);
        });

        function setTab(mode) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-tab-${mode}`).classList.add('active');
            document.getElementById('view-assign').className = mode === 'assign' ? 'flex gap-6 h-full' : 'hidden';
            document.getElementById('view-manage').className = mode === 'manage' ? 'flex gap-6 h-full' : 'hidden';
        }

        async function initApp() {
            // Load Classes
            const { data: cls } = await _supabase.from('classes').select('id, name').order('name');
            if (cls) {
                const h = '<option value="">반 선택 (Class)...</option>' + cls.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                document.getElementById('sel-class-assign').innerHTML = h;
                document.getElementById('sel-class-manage').innerHTML = h;
            }
            // Load Categories
            const { data: cat } = await _supabase.from('test_category').select('*').order('name');
            if (cat) {
                document.getElementById('sel-cat-assign').innerHTML = '<option value="">대분류 (Category)...</option>' + cat.map(c => `<option value="${c.test_id}">${c.name}</option>`).join('');
            }
        }

        /* --- ASSIGNMENT LOGIC --- */
        async function loadWorkbooks(catId) {
            const cont = document.getElementById('list-workbook-assign');
            cont.innerHTML = '<div class="text-center py-10 text-xs text-slate-500"><i class="fa-solid fa-spinner fa-spin"></i></div>';
            if (!catId) return cont.innerHTML = '';

            const { data } = await _supabase.from('test_master')
                .select('id, title, grade, semester')
                .eq('test_id', catId)
                .order('updated_at', { ascending: false });

            if (data && data.length > 0) {
                cont.innerHTML = data.map(wb => `
                    <div class="list-item bg-slate-800/50" onclick="pickWorkbook('${wb.id}', '${wb.title}', this)">
                        <div class="flex-1">
                            <div class="text-sm font-bold text-slate-200"><i class="fa-solid fa-book mr-2 text-indigo-400"></i>${wb.title}</div>
                            <div class="text-[10px] text-slate-500">${wb.grade || ''} ${wb.semester || ''}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                cont.innerHTML = '<div class="text-center py-10 text-xs text-slate-500">교재가 없습니다.</div>';
            }
        }

        async function pickWorkbook(id, title, el) {
            document.querySelectorAll('#list-workbook-assign .list-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');

            const { count } = await _supabase.from('test_papers')
                .select('*', { count: 'exact', head: true })
                .eq('test_master_id', id);

            assignData.wbId = id;
            assignData.wbTitle = title;
            assignData.roundCount = count || 0;

            document.getElementById('summ-wb').innerText = title;
            document.getElementById('summ-rounds').innerText = `${count || 0}회차`;
        }

        function setDiff(val, el) {
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('val-diff').value = val;
            document.getElementById('summ-diff').innerText = val;
        }

        async function loadStudents(mode, cid) {
            const list = document.getElementById(mode === 'assign' ? 'list-stu-assign' : 'list-stu-manage');
            list.innerHTML = '<div class="text-center py-10 text-xs text-slate-500"><i class="fa-solid fa-spinner fa-spin"></i></div>';

            if (!cid) return;

            // [수정 포인트] 사장님이 새로 주신 테이블 로직을 적용했어요! 아으응!
            // assignment_and_class_logic 테이블에서 해당 반(class_id)이 포함된 활성 학생만 가져옵니다.
            const { data, error } = await _supabase
                .from('assignment_and_class_logic')
                .select('student_id, class_settings')
                .eq('is_active', true); // 활성화된 학생만 

            if (error) {
                console.error("학생 리스트 로드 실패:", error);
                list.innerHTML = '<div class="text-center py-10 text-xs text-red-500">데이터 로드 실패</div>';
                return;
            }

            // class_settings JSON 내부에서 사장님이 선택한 cid가 있는지 검사해서 필터링해요.
            const filteredData = data.filter(item => {
                try {
                    const settings = typeof item.class_settings === 'string'
                        ? JSON.parse(item.class_settings)
                        : item.class_settings;
                    return settings.some(s => s.class_id === cid);
                } catch (e) { return false; }
            });

            if (filteredData && filteredData.length > 0) {
                list.innerHTML = filteredData.map(m => `
                    <div class="list-item flex items-center gap-3 bg-slate-800/50" onclick="${mode === 'assign' ? `toggleStu('${m.student_id}', this)` : `loadDash('${m.student_id}', this)`}">
                        <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-400">${m.student_id.charAt(0).toUpperCase()}</div>
                        <div class="text-sm text-slate-200 font-bold">${m.student_id}</div>
                        ${mode === 'assign' ? '<div class="w-4 h-4 rounded border border-slate-600 chk-indicator flex items-center justify-center text-[10px]"><i class="fa-solid fa-check hidden text-white"></i></div>' : '<i class="fa-solid fa-chevron-right text-[10px] text-slate-600"></i>'}
                    </div>`).join('');
            } else {
                list.innerHTML = '<div class="text-center py-10 text-xs text-slate-500">이 반에 소속된 학생이 없습니다.</div>';
            }
        }

        function toggleStu(sid, el) {
            const ind = el.querySelector('.chk-indicator'); const icon = ind.querySelector('i');
            if (assignData.students.has(sid)) { assignData.students.delete(sid); el.classList.remove('selected'); ind.classList.remove('bg-indigo-500', 'border-indigo-500'); icon.classList.add('hidden'); }
            else { assignData.students.add(sid); el.classList.add('selected'); ind.classList.add('bg-indigo-500', 'border-indigo-500'); icon.classList.remove('hidden'); }
            document.getElementById('assign-cnt').innerText = `${assignData.students.size}명 선택`;
        }

        function toggleAllAssign(chk) {
            document.querySelectorAll('#list-stu-assign .list-item').forEach(i => {
                const isSel = i.classList.contains('selected');
                if ((chk.checked && !isSel) || (!chk.checked && isSel)) i.click();
            });
        }

        async function runAssign() {
            const diff = document.getElementById('val-diff').value;
            if (assignData.students.size === 0 || !assignData.wbId || !diff) return alert("설정을 완료해주세요.");
            if (assignData.roundCount === 0) return alert("해당 교재에 생성된 시험지 팩(Round)이 없습니다.\n셋째 딸에게 가서 팩을 먼저 만드세요.");

            if (!confirm(`[${assignData.wbTitle}]\n난이도: ${diff}\n학생 ${assignData.students.size}명에게 배정합니까?`)) return;

            const { data, error } = await _supabase.rpc('rpc_assignment_pencil_and_eraser', {
                p_action: 'assign',
                p_student_ids: Array.from(assignData.students),
                p_test_master_id: assignData.wbId, // 교재 ID 전달
                p_pack_title: assignData.wbTitle,
                p_difficulty: diff
            });

            if (error) alert(error.message);
            else { alert(data.message); location.reload(); }
        }

        /* --- MANAGEMENT LOGIC (FIXED) --- */
        async function loadDash(sid, el) {
            document.querySelectorAll('#list-stu-manage .list-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');

            const board = document.getElementById('dash-board');
            board.innerHTML = '<div class="h-full flex items-center justify-center"><i class="fa-solid fa-spinner fa-spin text-2xl text-slate-600"></i></div>';

            console.log(`[Debug] Loading dashboard for student: ${sid}`);

            // [FIXED] .single() 대신 limit(1)을 사용하고, 상태 조건을 제거하여 최신 배정 기록을 무조건 찾음
            const { data: rec, error } = await _supabase.from('test_assignment_records')
                .select('*')
                .eq('student_id', sid)
                // .eq('status', 'in_progress') // 이 조건을 제거하여 'completed'여도 보이게 함
                .order('created_at', { ascending: false }) // 가장 최신 것
                .limit(1)
                .maybeSingle();

            if (error) {
                console.error("DB Error:", error);
                board.innerHTML = `<div class="p-6 text-center text-red-400 text-sm">DB 읽기 실패: ${error.message}</div>`;
                return;
            }

            if (!rec) {
                console.log("No record found.");
                board.innerHTML = '<div class="h-full flex flex-col items-center justify-center text-slate-500 opacity-60"><i class="fa-regular fa-circle-check text-5xl mb-4 text-emerald-500"></i><p>배정된 교재가 없습니다.</p></div>';
                document.getElementById('dash-info').classList.add('hidden');
                return;
            }

            console.log("Record found:", rec);
            manageData.currentRecId = rec.id;
            document.getElementById('dash-info').classList.remove('hidden');
            document.getElementById('dash-title').innerText = rec.pack_title;
            document.getElementById('dash-diff').innerText = rec.difficulty;

            // Get total rounds for this workbook
            const { count } = await _supabase.from('test_papers')
                .select('*', { count: 'exact', head: true })
                .eq('test_master_id', rec.test_master_id);
            const totalRounds = count || 0;

            let html = '<div class="space-y-3 pt-2">';
            for (let i = 1; i <= totalRounds; i++) {
                const isCur = (i === rec.current_round);
                const isPast = (i < rec.current_round);
                const hist = rec.history_log?.[i] || {};

                let cardClass = isCur ? 'active' : (isPast ? 'completed' : 'locked');
                let content = '';

                if (isPast) {
                    content = `<span class="text-emerald-500 text-xs font-bold flex items-center gap-1"><i class="fa-solid fa-check"></i> 통과 (${hist.passed_at?.substring(5, 10) || ''})</span>`;
                } else if (isCur) {
                    // 수료 상태(completed)면 현재 라운드도 통과로 표시 가능하나, 일단 로직 유지
                    if (rec.status === 'completed') {
                        cardClass = 'completed';
                        content = `<span class="text-emerald-500 text-xs font-bold flex items-center gap-1"><i class="fa-solid fa-check"></i> 수료 완료</span>`;
                    } else {
                        content = `
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-slate-400">재시험: <b class="text-white">${hist.try_count || 0}</b>회</span>
                                <button onclick="doAction('retest')" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs text-white transition">재시험</button>
                                <button onclick="doAction('pass')" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-500 rounded text-xs text-white font-bold shadow-lg shadow-indigo-500/30 transition">통과</button>
                            </div>`;
                    }
                } else {
                    content = `<span class="text-slate-600 text-xs flex items-center gap-1"><i class="fa-solid fa-lock"></i> 잠김</span>`;
                }

                html += `
                    <div class="round-card ${cardClass}">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center text-lg font-black ${isCur ? 'text-indigo-400' : 'text-slate-600'}">${i}</div>
                            <div>
                                <div class="text-sm font-bold text-slate-200">${rec.pack_title} - ${i}회차</div>
                            </div>
                        </div>
                        <div>${content}</div>
                    </div>`;
            }
            board.innerHTML = html + '</div>';
        }

        async function doAction(act) {
            if (!manageData.currentRecId) return;

            let msg = "처리하시겠습니까?";
            if (act === 'pass') msg = "통과 처리하시겠습니까?\n(다음 회차가 열립니다)";
            if (act === 'delete') msg = "정말 배정을 취소하시겠습니까?\n기록이 삭제됩니다.";

            if (!confirm(msg)) return;

            const { data, error } = await _supabase.rpc('rpc_assignment_pencil_and_eraser', {
                p_action: act,
                p_record_id: manageData.currentRecId
            });

            if (error) alert(error.message);
            else {
                if (data.status === 'completed') alert(data.message);
                const sel = document.querySelector('#list-stu-manage .list-item.selected');
                if (sel) sel.click(); // Refresh UI
            }
        }
    </script>
</body>

</html>